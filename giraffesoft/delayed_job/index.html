<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>GitHub Documentation - giraffesoft/delayed_job</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/giraffesoft/commits/delayed_job/master" rel="alternate" title="Recent Commits to delayed_job:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<style type="text/css">
  #repo_menu { border-bottom: 5px solid #ccc; margin-bottom: 1.5em; }
  #repo_sub_menu { display: none; }
</style>
    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
        <div id="main">
      <div id="header" class="">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/giraffesoft/delayed_job/tree/">Source</a></li>
            <li class=""><a href="http://github.com/giraffesoft/delayed_job/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/giraffesoft/delayed_job/network">Network</a></li>            
            <li class=""><a href="http://github.com/giraffesoft/delayed_job/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/giraffesoft/delayed_job">Wiki</a></li>
            <li class=""><a href="http://github.com/giraffesoft/delayed_job/graphs">Graphs</a></li>                    
            <li class="active"><a href="http://docs.github.com/giraffesoft/delayed_job">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/giraffesoft">giraffesoft</a> / <b><a href="http://github.com/giraffesoft/delayed_job/tree">delayed_job</a></b>        
                <a id="namespaces_button" rel="giraffesoft/delayed_job" href="#">
                  <img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/>
                </a>
                <a id="methods_button" rel="giraffesoft/delayed_job" href="#">
                  <img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/>
                </a>

                <script type="text/javascript">          
                $('#namespaces_button').click(function(){
                  var url="/"+$(this).attr('rel')+"/namespaces/";
                  $.gitbox(url);
                  return false;
                });

                $('#methods_button').click(function(){
                  var url="/"+$(this).attr('rel')+"/methods/";
                  $.gitbox(url);
                  return false;
                });
                </script>
                
              </div>
            </div>

            <div class="meta">
              <table>
                <tbody>
                  <tr>
                    <td class="label">Description:</td>
                    <td><span id="repository_description" rel="http://github.com/giraffesoft/delayed_job/edit/update" class="">No description available</span></td>
                  </tr>              
                </tbody>
              </table>
            </div>
          </div>
                                        
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>Delayed::Job</h1>


	<p>Delated_job (or DJ) encapsulates the common pattern of asynchronously executing longer tasks in the background.</p>


	<p>It is a direct extraction from Shopify where the job table is responsible for a multitude of core tasks. Amongst those tasks are:</p>


	<ul>
	<li>sending massive newsletters</li>
		<li>image resizing</li>
		<li>http downloads</li>
		<li>updating smart collections</li>
		<li>updating solr, our search server, after product changes</li>
		<li>batch imports </li>
		<li>spam checks</li>
	</ul>


	<h2>Changes</h2>


	<ul>
	<li>1.6 Renamed locked_until to locked_at. We now store when we start a given job instead of how long it will be locked by the worker. This allows us to get a reading on how long a job took to execute.                    </li>
		<li>1.5 Job runners can now be run in parallel. Two new database columns are needed: locked_until and locked_by. This allows us to use pessimistic locking, which enables us to run as many worker processes as we need to speed up queue processing.</li>
		<li>1.0 Initial release</li>
	</ul>


	<h2>Setup</h2>


	<p>The library evolves around a delayed_jobs table which looks as follows: </p>


	<pre class="code"><span class='create_table identifier id'>create_table</span> <span class='symbol val'>:delayed_jobs</span><span class='comma token'>,</span> <span class='symbol val'>:force</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='table identifier id'>table</span><span class='bitor op'>|</span>
  <span class='table identifier id'>table</span><span class='dot token'>.</span><span class='integer identifier id'>integer</span>  <span class='symbol val'>:priority</span><span class='comma token'>,</span> <span class='symbol val'>:default</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>0</span>
  <span class='table identifier id'>table</span><span class='dot token'>.</span><span class='integer identifier id'>integer</span>  <span class='symbol val'>:attempts</span><span class='comma token'>,</span> <span class='symbol val'>:default</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>0</span>
  <span class='table identifier id'>table</span><span class='dot token'>.</span><span class='text identifier id'>text</span>     <span class='symbol val'>:handler</span>
  <span class='table identifier id'>table</span><span class='dot token'>.</span><span class='string identifier id'>string</span>   <span class='symbol val'>:last_error</span>
  <span class='table identifier id'>table</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='symbol val'>:run_at</span>
  <span class='table identifier id'>table</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='symbol val'>:locked_at</span>
  <span class='table identifier id'>table</span><span class='dot token'>.</span><span class='string identifier id'>string</span>   <span class='symbol val'>:locked_by</span>
  <span class='table identifier id'>table</span><span class='dot token'>.</span><span class='timestamps identifier id'>timestamps</span>
<span class='end end kw'>end</span>
</pre>


	<h2>Usage</h2>


	<p>Jobs are simple ruby objects with a method called perform. Any object which responds to perform can be stuffed into the jobs table.
Job objects are serialized to yaml so that they can later be resurrected by the job runner. </p>


	<pre class="code"><span class='class class kw'>class</span> <span class='NewsletterJob constant id'>NewsletterJob</span> <span class='lt op'>&lt;</span> <span class='Struct constant id'>Struct</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='symbol val'>:text</span><span class='comma token'>,</span> <span class='symbol val'>:emails</span><span class='rparen token'>)</span>
  <span class='def def kw'>def</span> <span class='perform identifier id'>perform</span>
    <span class='emails identifier id'>emails</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='e identifier id'>e</span><span class='bitor op'>|</span> <span class='NewsletterMailer constant id'>NewsletterMailer</span><span class='dot token'>.</span><span class='deliver_text_to_email identifier id'>deliver_text_to_email</span><span class='lparen token'>(</span><span class='text identifier id'>text</span><span class='comma token'>,</span> <span class='e identifier id'>e</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>    
<span class='end end kw'>end</span>
</pre>


	<pre class="code"><span class='Delayed constant id'>Delayed</span><span class='colon2 op'>::</span><span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='enqueue identifier id'>enqueue</span> <span class='NewsletterJob constant id'>NewsletterJob</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>'lorem ipsum...'</span><span class='comma token'>,</span> <span class='Customers constant id'>Customers</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='collect identifier id'>collect</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='symbol val'>:email</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
</pre>


	<p>There is also a second way to get jobs in the queue: send_later. </p>


	<pre class="code"><span class='BatchImporter constant id'>BatchImporter</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='Shop constant id'>Shop</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='integer val'>1</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='send_later identifier id'>send_later</span><span class='lparen token'>(</span><span class='symbol val'>:import_massive_csv</span><span class='comma token'>,</span> <span class='massive_csv identifier id'>massive_csv</span><span class='rparen token'>)</span>
</pre>


	<p>This will simply create a Delayed::PerformableMethod job in the jobs table which serializes all the parameters you pass to it. There are some special smarts for active record objects
which are stored as their text representation and loaded from the database fresh when the job is actually run later.</p>


	<h2>Running the jobs</h2>


	<p>You can invoke <code>rake jobs:work</code> which will start working off jobs. You can cancel the rake task with <code>CTRL-C</code>.</p>


	<p>You can also run by writing a simple <code>script/job_runner</code>, and invoking it externally:</p>


<pre class="code">
  <span class='comment val'>#!/usr/bin/env ruby</span>
  <span class='require identifier id'>require</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='__FILE__ __file__ kw'>__FILE__</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>'/../config/environment'</span>

  <span class='Delayed constant id'>Delayed</span><span class='colon2 op'>::</span><span class='Worker constant id'>Worker</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='dot token'>.</span><span class='start identifier id'>start</span>  
</pre>

	<h3>Cleaning up</h3>


	<p>You can invoke <code>rake jobs:clear</code> to delete all jobs in the queue.</p>
</div>
          </div>
        </div>
      </div>  
                  
      <div id="footer">
        <div class="site">
          <div class="info">
            <div class="links">
              <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
              <a href="http://github.com/blog">Blog</a> |
              <a href="http://support.github.com/">Support</a> |
              <a href="http://github.com/training">Training</a> |
              <a href="http://github.com/contact">Contact</a> |
              <a href="http://groups.google.com/group/github/">Google Group</a> |
              <a href="http://develop.github.com/">API</a> |
              <a href="http://twitter.com/github">Status</a>
            </div>
            <div class="company">
              <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
              is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
            </div>
          </div>
          <div class="sponsor">
            <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
            <div>
              Hosting provided by our<br> partners at Engine Yard
            </div>
          </div>
        </div>
      </div>
      
      <div id="coming_soon" style="display: none;">
        This feature is coming soon.  Sit tight!
      </div>

      <div id="facebox" style="display: none;">       
        <div class="popup">         
          <table>           
            <tbody>             
              <tr>               
                <td class="tl"></td>
                <td class="b"></td>
                <td class="tr"></td>             
              </tr>             
            <tr>               
              <td class="b"></td>               
              <td class="body">                 
                <div class="content"></div>                 
                <div class="footer">                   
                  <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
                </div>               
              </td>               
              <td class="b"></td>             
            </tr>             
            <tr>               
              <td class="bl"></td>
              <td class="b"></td>
              <td class="br"></td>             
            </tr>           
          </tbody>         
        </table>       
      </div>     
    </div>

  </body>
</html>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>Overbryd's acts_as_xapian - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/Overbryd/commits/acts_as_xapian/master" rel="alternate" title="Recent Commits to acts_as_xapian:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("Overbryd", "acts_as_xapian", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("Overbryd", "acts_as_xapian", "dc3517c66b18dbf66733aac3ba436c7bf4ffcab8", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/tree/">Source</a></li>
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/network">Network</a></li>            
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/Overbryd/acts_as_xapian">Wiki</a></li>
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/graphs">Graphs</a></li>                    
            <li class="active"><a href="/Overbryd/acts_as_xapian">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/Overbryd">Overbryd</a> / <b><a href="http://github.com/Overbryd/acts_as_xapian/tree">acts_as_xapian</a></b>        
                <a id="namespaces_button" rel="Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <p>Do patch this file if there is documentation missing / wrong. It&#8217;s called<br />
<span class="caps">README</span>.txt and is in git, using Textile formatting. The wiki page is just<br />
copied from the <span class="caps">README</span>.txt file.</p>
<p>Contents<br />
====</p>
<ul>
	<li>a. Introduction to acts_as_xapian</li>
	<li>b. Installation</li>
	<li>c. Comparison to acts_as_solr (as on 24 April 2008)</li>
	<li>d. Documentation &#8211; indexing</li>
	<li>e. Documentation &#8211; querying</li>
	<li>f. Configuration</li>
	<li>g. Performance</li>
	<li>h. Support</li>
</ul>
<p>a. Introduction to acts_as_xapian<br />
=========</p>
<p><a href="http://www.xapian.org">Xapian</a> is a full text search engine library which has<br />
Ruby bindings. acts_as_xapian adds support for it to Rails. It is an<br />
alternative to acts_as_solr, acts_as_ferret, Ultrasphinx, acts_as_indexed,<br />
acts_as_searchable or acts_as_tsearch.</p>
<p>acts_as_xapian is deployed in production on these websites.</p>
<ul>
	<li><a href="http://www.whatdotheyknow.com">WhatDoTheyKnow</a></li>
	<li><a href="http://www.mindbites.com">MindBites</a></li>
</ul>
<p>The section &#8220;c. Comparison to acts_as_solr&#8221; below will give you an idea of <br />
acts_as_xapian&#8217;s features.</p>
<p>acts_as_xapian was started by Francis Irving in May 2008 for search and email<br />
alerts in WhatDoTheyKnow, and so was supported by <a href="http://www.mysociety.org">mySociety</a> <br />
and initially paid for by the <a href="http://www.jrrt.org.uk/jrsstct.htm"><span class="caps">JRSST</span> Charitable Trust</a></p>
<b>Installation<br />
===</b><p>Retrieve the plugin directly from the git version control system by running<br />
this command within your Rails app.</p>
git clone git://github.com/frabcus/acts_as_xapian.git vendor/plugins/acts_as_xapian
<p>Xapian 1.0.5 and associated Ruby bindings are also required.</p>
<p>Debian or Ubuntu &#8211; install the packages libxapian15 and libxapian-ruby1.8.</p>
<p>Mac <span class="caps">OSX</span> &#8211; follow the instructions for installing from source on <br />
the <a href="http://xapian.org/docs/install.html">Installing Xapian</a> page &#8211; you need the<br />
Xapian library and bindings (you don&#8217;t need Omega).</p>
<p>There is no Ruby Gem for Xapian, it would be great if you could make one!</p>
<p>c. Comparison to acts_as_solr (as on 24 April 2008)<br />
=========</p>
<ul>
	<li>Offline indexing only mode &#8211; which is a minus if you want changes<br />
immediately reflected in the search index, and a plus if you were going to<br />
have to implement your own offline indexing anyway.</li>
</ul>
<ul>
	<li>Collapsing &#8211; the equivalent of SQL&#8217;s &#8220;group by&#8221;. You can specify a field<br />
to collapse on, and only the most relevant result from each value of that<br />
field is returned. Along with a count of how many there are in total.<br />
acts_as_solr doesn&#8217;t have this.</li>
</ul>
<ul>
	<li>No highlighting &#8211; Xapian can&#8217;t return you text highlighted with a search<br />
query. You can try and make do with TextHelper::highlight (combined with<br />
words_to_highlight below). I found the highlighting in acts_as_solr didn&#8217;t<br />
really understand the query anyway.</li>
</ul>
<ul>
	<li>Date range searching &#8211; this exists in acts_as_solr, but I found it<br />
wasn&#8217;t documented well enough, and was hard to get working.</li>
</ul>
<ul>
	<li>Spelling correction &#8211; &#8220;did you mean?&#8221; built in and just works.</li>
</ul>
<ul>
	<li>Similar documents &#8211; acts_as_xapian has a simple command to find other models<br />
that are like a specified model.</li>
</ul>
<ul>
	<li>Multiple models &#8211; acts_as_xapian searches multiple types of model if you<br />
like, returning them mixed up together by relevancy. This is like<br />
multi_solr_search, only it is the default mode of operation and is properly<br />
supported.</li>
</ul>
<ul>
	<li>No daemons &#8211; However, if you have more than one web server, you&#8217;ll need to<br />
work out how to use <a href="http://xapian.org/docs/remote.html">Xapian&#8217;s remote backend</a>.</li>
</ul>
<ul>
	<li>One layer &#8211; full-powered Xapian is called directly from the Ruby, without<br />
Solr getting in the way whenever you want to use a new feature from Lucene.</li>
</ul>
<ul>
	<li>No Java &#8211; an advantage if you&#8217;re more used to working in the rest of the<br />
open source world. acts_as_xapian, it&#8217;s pure Ruby and C++.</li>
</ul>
<ul>
	<li>Xapian&#8217;s awesome email list &#8211; the kids over at <br />
<a href="http://lists.xapian.org/mailman/listinfo/xapian-discuss">xapian-discuss</a><br />
are super helpful. Useful if you need to extend and improve acts_as_xapian. The<br />
Ruby bindings are mature and well maintained as part of Xapian.</li>
</ul>
<p>d. Documentation &#8211; indexing<br />
=======</p>
<p>Xapian is an <strong>offline indexing</strong> search library &#8211; only one process can have the<br />
Xapian database open for writing at once, and others that try meanwhile are<br />
unceremoniously kicked out. For this reason, acts_as_xapian does not support<br />
immediate writing to the database when your models change.</p>
<p>Instead, there is a ActsAsXapianJob model which stores which models need<br />
updating or deleting in the search index. A rake task &#8216;xapian:update_index&#8217;<br />
then performs the updates since last change. You can run it on a cron job, or<br />
similar.</p>
<p>Here&#8217;s how to add indexing to your Rails app:</p>
<p>1. Put acts_as_xapian in your models that need search indexing. e.g.</p>
acts_as_xapian :texts =&gt; [ :name, :short_name ],
:values =&gt; [ [ :created_at, 0, &#8220;created_at&#8221;, :date ] ],
:terms =&gt; [ [ :variety, &#8216;V&#8217;, &#8220;variety&#8221; ] ]
<p>Options must include:</p>
<ul>
	<li>:texts, an array of fields for indexing with full text search. <br />
e.g. :texts =&gt; [ :title, :body ]</li>
</ul>
<ul>
	<li>:values, things which have a range of values for sorting, or for collapsing. <br />
Specify an array quadruple of [ field, identifier, prefix, type ] where
	<ul>
		<li>identifier is an arbitary numeric identifier for use in the Xapian database</li>
		<li>prefix is the part to use in search queries that goes before the :</li>
		<li>type can be any of :string, :number or :date</li>
	</ul></li>
</ul>
<p>e.g. :values =&gt; [ [ :created_at, 0, &#8220;created_at&#8221;, :date ],<br />
[ :size, 1, &#8220;size&#8221;, :string ] ]</p>
<ul>
	<li>:terms, things which come with a prefix (before a :) in search queries. <br />
Specify an array triple of [ field, char, prefix ] where
	<ul>
		<li>char is an arbitary single upper case char used in the Xapian database, just<br />
pick any single uppercase character, but use a different one for each prefix.</li>
		<li>prefix is the part to use in search queries that goes before the :<br />
For example, if you were making Google and indexing to be able to later do a<br />
query like &#8220;site:www.whatdotheyknow.com&#8221;, then the prefix would be &#8220;site&#8221;.</li>
	</ul></li>
</ul>
<p>e.g. :terms =&gt; [ [ :variety, &#8216;V&#8217;, &#8220;variety&#8221; ] ]<br />
        <br />
A &#8216;field&#8217; is a symbol referring to either an attribute or a function which<br />
returns the text, date or number to index. Both &#8216;identifier&#8217; and &#8216;char&#8217; must be<br />
the same for the same prefix in different models.</p>
<p>Options may include:</p>
<ul>
	<li>:eager_load, added as an :include clause when looking up search results in<br />
database</li>
	<li>:if, either an attribute or a function which if returns false means the<br />
object isn&#8217;t indexed</li>
</ul>
<p>2. Generate a database migration to create the ActsAsXapianJob model:</p>
script/generate acts_as_xapian
rake db:migrate
<p>3. Call &#8216;rake xapian:rebuild_index models=&#8220;ModelName1 ModelName2&#8221;&#8217; to build the index<br />
the first time (you must specify all your indexed models). It&#8217;s put in a<br />
development/test/production dir in acts_as_xapian/xapiandbs. See f. Configuration <br />
below if you want to change this.</p>
<p>4. Then from a cron job or a daemon, or by hand regularly!, call &#8216;rake xapian:update_index&#8217;</p>
<p>e. Documentation &#8211; querying<br />
=======</p>
<p>Testing indexing<br />
<del>-</del>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</p>
<p>If you just want to test indexing is working, you&#8217;ll find this rake task<br />
useful (it has more options, see tasks/xapian.rake)</p>
rake xapian:query models=&#8220;PublicBody User&#8221; query=&#8220;moo&#8221;
<p>Performing a query<br />
<del>-</del>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</p>
<p>To perform a query from code call ActsAsXapian::Search.new. This takes in turn:</p>
<ul>
	<li>model_classes &#8211; list of models to search, e.g. [PublicBody, InfoRequestEvent]</li>
	<li>query_string &#8211; Google like syntax, see below</li>
</ul>
<p>And then a hash of options:</p>
<ul>
	<li>:offset &#8211; Offset of first result (default 0)</li>
	<li>:limit &#8211; Number of results per page</li>
	<li>:sort_by_prefix &#8211; Optionally, prefix of value to sort by, otherwise sort by relevance</li>
	<li>:sort_by_ascending &#8211; Default true (documents with higher values better/earlier), set to false for descending sort</li>
	<li>:collapse_by_prefix &#8211; Optionally, prefix of value to collapse by (i.e. only return most relevant result from group)</li>
</ul>
<p>Google like query syntax is as described in <br />
    <a href="http://www.xapian.org/docs/queryparser.html">Xapian::QueryParser Syntax</a><br />
Queries can include prefix:value parts, according to what you indexed in the<br />
acts_as_xapian part above. You can also say things like model:InfoRequestEvent <br />
to constrain by model in more complex ways than the :model parameter, or<br />
modelid:InfoRequestEvent-100 to only find one specific object.</p>
<p>Returns an ActsAsXapian::Search object. Useful methods are:</p>
<ul>
	<li>description &#8211; a techy one, to check how the query has been parsed</li>
	<li>matches_estimated &#8211; a guesstimate at the total number of hits</li>
	<li>spelling_correction &#8211; the corrected query string if there is a correction, otherwise nil</li>
	<li>words_to_highlight &#8211; list of words for you to highlight, perhaps with TextHelper::highlight</li>
	<li>results &#8211; an array of hashes each containing:
	<ul>
		<li>:model &#8211; your Rails model, this is what you most want!</li>
		<li>:weight &#8211; relevancy measure</li>
		<li>:percent &#8211; the weight as a %, 0 meaning the item did not match the query at all</li>
		<li>:collapse_count &#8211; number of results with the same prefix, if you specified collapse_by_prefix</li>
	</ul></li>
</ul>
<p>Finding similar models<br />
<del>-</del>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</p>
<p>To find models that are similar to a given set of models call ActsAsXapian::Similar.new. This takes:</p>
<ul>
	<li>model_classes &#8211; list of model classes to return models from within</li>
	<li>models &#8211; list of models that you want to find related ones to</li>
</ul>
<p>Returns an ActsAsXapian::Similar object. Has all methods from ActsAsXapian::Search above, except<br />
for words_to_highlight. In addition has:</p>
<ul>
	<li>important_terms &#8211; the terms extracted from the input models, that were used to search for output<br />
You need the results methods to get the similar models.</li>
</ul>
<p>f. Configuration<br />
====</p>
<p>If you want to customise the configuration of acts_as_xapian, it will look for<br />
a file called &#8216;xapian.yml&#8217; under RAILS_ROOT/config. As is familiar from the<br />
format of the database.yml file, separate :development, :test and :production<br />
sections are expected.</p>
<p>The following options are available:</p>
<ul>
	<li>base_db_path &#8211; specifies the directory, relative to RAILS_ROOT, in which <br />
acts_as_xapian stores its search index databases. Default is the directory<br />
xapiandbs within the acts_as_xapian directory.</li>
</ul>
<p>g. Performance<br />
======</p>
<p>On development sites, acts_as_xapian automatically logs the time taken to do<br />
searches.  The time displayed is for the Xapian parts of the query; the Rails<br />
database model lookups will be logged separately by ActiveRecord. Example:</p>
Xapian query (0.00029s) Search: hello
<p>To enable this, and other performance logging, on a production site,<br />
temporarily add this to the end of your config/environment.rb</p>
ActiveRecord::Base.logger = Logger.new(<span class="caps">STDOUT</span>)
<p>h. Support<br />
==</p>
<p>Please ask any questions on the <br />
<a href="http://groups.google.com/group/acts_as_xapian">acts_as_xapian Google Group</a></p>
<p>The official home page and repository for acts_as_xapian are the<br />
<a href="http://github.com/frabcus/acts_as_xapian/wikis">acts_as_xapian github page</a></p>
<p>For more details about anything, see source code in lib/acts_as_xapian.rb</p>
<p>Merging source instructions &#8220;Using git for collaboration&#8221; here:<br />
http://www.kernel.org/pub/software/scm/git/docs/gittutorial.html</p>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>Overbryd's acts_as_xapian - Module: ActsAsXapian - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/Overbryd/commits/acts_as_xapian/master" rel="alternate" title="Recent Commits to acts_as_xapian:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("Overbryd", "acts_as_xapian", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("Overbryd", "acts_as_xapian", "dc3517c66b18dbf66733aac3ba436c7bf4ffcab8", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/tree/">Source</a></li>
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/network">Network</a></li>            
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/Overbryd/acts_as_xapian">Wiki</a></li>
            <li class=""><a href="http://github.com/Overbryd/acts_as_xapian/graphs">Graphs</a></li>                    
            <li class="active"><a href="/Overbryd/acts_as_xapian">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/Overbryd">Overbryd</a> / <b><a href="http://github.com/Overbryd/acts_as_xapian/tree">acts_as_xapian</a></b>        
                <a id="namespaces_button" rel="Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section module ActsAsXapian">
  <h1>Module: ActsAsXapian</h1>
  <div class="section constants">
  
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Class Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#bindings_available-class_method">bindings_available</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Module level variables XXX must be some kind of cattr_accessor that can do
this better.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#config-class_method">config</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#db-class_method">db</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#db_path-class_method">db_path</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#enquire-class_method">enquire</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#init-class_method">init</span><span class='args'>(classname = nil, options = nil)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Initialisation.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#init_query_parser-class_method">init_query_parser</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Make a new query parser.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#prepare_environment-class_method">prepare_environment</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Reads the config file (if any) and sets up the path to the database
we&#8217;ll be using.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#query_parser-class_method">query_parser</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#readable_init-class_method">readable_init</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Opens / reopens the db for reading XXX we perhaps don&#8217;t need to
rebuild database and enquire and queryparser - but db.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#rebuild_index-class_method">rebuild_index</span><span class='args'>(model_classes, verbose = false)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
You must specify <b>all</b> the models here, this totally rebuilds the
Xapian database.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#stemmer-class_method">stemmer</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#term_generator-class_method">term_generator</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#update_index-class_method">update_index</span><span class='args'>(flush = false, verbose = false)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Update index with any changes needed, call this offline.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#values_by_prefix-class_method">values_by_prefix</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#writable_db-class_method">writable_db</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#writable_init-class_method">writable_init</span><span class='args'>(suffix = &quot;&quot;)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Class Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>bindings_available</h3>
</div><div id="bindings_available-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>bindings_available</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Module level variables XXX must be some kind of cattr_accessor that can do
this better
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 27</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L27">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">27
28
29</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='bindings_available identifier id'>bindings_available</span>
    <span class='$acts_as_xapian_bindings_available gvar id'>$acts_as_xapian_bindings_available</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>config</h3>
</div><div id="config-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>config</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 66</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L66">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">66
67
68</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='config identifier id'>config</span>
  <span class='@@config ivar id'>@@config</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>db</h3>
</div><div id="db-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>db</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 42</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L42">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">42
43
44</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='db identifier id'>db</span>
    <span class='@@db ivar id'>@@db</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>db_path</h3>
</div><div id="db_path-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>db_path</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 45</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L45">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">45
46
47</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='db_path identifier id'>db_path</span>
    <span class='@@db_path ivar id'>@@db_path</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>enquire</h3>
</div><div id="enquire-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>enquire</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 57</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L57">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">57
58
59</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='enquire identifier id'>enquire</span>
    <span class='@@enquire ivar id'>@@enquire</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>init</h3>
</div><div id="init-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>init</span><span class='args'>(classname = nil, options = nil)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Initialisation
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 72</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L72">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">72
73
74
75
76
77</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='init identifier id'>init</span><span class='lparen token'>(</span><span class='classname identifier id'>classname</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='rparen token'>)</span>
    <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='classname identifier id'>classname</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
        <span class='comment val'># store class and options for use later, when we open the db in readable_init</span>
        <span class='@@init_values ivar id'>@@init_values</span><span class='dot token'>.</span><span class='push identifier id'>push</span><span class='lparen token'>(</span><span class='lbrack token'>[</span><span class='classname identifier id'>classname</span><span class='comma token'>,</span><span class='options identifier id'>options</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>init_query_parser</h3>
</div><div id="init_query_parser-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>init_query_parser</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Make a new query parser
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 135</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L135">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='init_query_parser identifier id'>init_query_parser</span>
    <span class='comment val'># for queries</span>
    <span class='@@query_parser ivar id'>@@query_parser</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='QueryParser constant id'>QueryParser</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
    <span class='@@query_parser ivar id'>@@query_parser</span><span class='dot token'>.</span><span class='stemmer identifier id'>stemmer</span> <span class='assign token'>=</span> <span class='@@stemmer ivar id'>@@stemmer</span>
    <span class='@@query_parser ivar id'>@@query_parser</span><span class='dot token'>.</span><span class='stemming_strategy identifier id'>stemming_strategy</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='QueryParser constant id'>QueryParser</span><span class='colon2 op'>::</span><span class='STEM_SOME constant id'>STEM_SOME</span>
    <span class='@@query_parser ivar id'>@@query_parser</span><span class='dot token'>.</span><span class='database identifier id'>database</span> <span class='assign token'>=</span> <span class='@@db ivar id'>@@db</span>
    <span class='@@query_parser ivar id'>@@query_parser</span><span class='dot token'>.</span><span class='default_op identifier id'>default_op</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='Query constant id'>Query</span><span class='colon2 op'>::</span><span class='OP_AND constant id'>OP_AND</span>

    <span class='@@terms_by_capital ivar id'>@@terms_by_capital</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
    <span class='@@values_by_number ivar id'>@@values_by_number</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
    <span class='@@values_by_prefix ivar id'>@@values_by_prefix</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
    <span class='@@value_ranges_store ivar id'>@@value_ranges_store</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

    <span class='for for kw'>for</span> <span class='init_value_pair identifier id'>init_value_pair</span> <span class='in in kw'>in</span> <span class='@@init_values ivar id'>@@init_values</span>
        <span class='classname identifier id'>classname</span> <span class='assign token'>=</span> <span class='init_value_pair identifier id'>init_value_pair</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
        <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='init_value_pair identifier id'>init_value_pair</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span>

        <span class='comment val'># go through the various field types, and tell query parser about them,</span>
        <span class='comment val'># and error check them - i.e. check for consistency between models</span>
        <span class='@@query_parser ivar id'>@@query_parser</span><span class='dot token'>.</span><span class='add_boolean_prefix identifier id'>add_boolean_prefix</span><span class='lparen token'>(</span><span class='string val'>&quot;model&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;M&quot;</span><span class='rparen token'>)</span>
        <span class='@@query_parser ivar id'>@@query_parser</span><span class='dot token'>.</span><span class='add_boolean_prefix identifier id'>add_boolean_prefix</span><span class='lparen token'>(</span><span class='string val'>&quot;modelid&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;I&quot;</span><span class='rparen token'>)</span>
        <span class='if if kw'>if</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:terms</span><span class='rbrack token'>]</span>
          <span class='for for kw'>for</span> <span class='term identifier id'>term</span> <span class='in in kw'>in</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:terms</span><span class='rbrack token'>]</span>
              <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Use up to 3 single capital letters for term code&quot;</span> <span class='if if_mod kw'>if</span> <span class='not not kw'>not</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='match identifier id'>match</span><span class='lparen token'>(</span><span class='regexp val'>/^[A-Z]{1,3}$/</span><span class='rparen token'>)</span>
              <span class='raise identifier id'>raise</span> <span class='string val'>&quot;M and I are reserved for use as the model/id term&quot;</span> <span class='if if_mod kw'>if</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>&quot;M&quot;</span> <span class='or or kw'>or</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>&quot;I&quot;</span>
              <span class='raise identifier id'>raise</span> <span class='string val'>&quot;model and modelid are reserved for use as the model/id prefixes&quot;</span> <span class='if if_mod kw'>if</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>&quot;model&quot;</span> <span class='or or kw'>or</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>&quot;modelid&quot;</span>
              <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Z is reserved for stemming terms&quot;</span> <span class='if if_mod kw'>if</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>&quot;Z&quot;</span>
              <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Already have code '&quot;</span> <span class='plus op'>+</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='string val'>&quot;' in another model but with different prefix '&quot;</span> <span class='plus op'>+</span> <span class='@@terms_by_capital ivar id'>@@terms_by_capital</span><span class='lbrack token'>[</span><span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='string val'>&quot;'&quot;</span> <span class='if if_mod kw'>if</span> <span class='@@terms_by_capital ivar id'>@@terms_by_capital</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span> <span class='@@terms_by_capital ivar id'>@@terms_by_capital</span><span class='lbrack token'>[</span><span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span> <span class='neq op'>!=</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span>
              <span class='@@terms_by_capital ivar id'>@@terms_by_capital</span><span class='lbrack token'>[</span><span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span>
              <span class='@@query_parser ivar id'>@@query_parser</span><span class='dot token'>.</span><span class='add_prefix identifier id'>add_prefix</span><span class='lparen token'>(</span><span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='term identifier id'>term</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
        <span class='if if kw'>if</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:values</span><span class='rbrack token'>]</span>
          <span class='for for kw'>for</span> <span class='value identifier id'>value</span> <span class='in in kw'>in</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:values</span><span class='rbrack token'>]</span>
              <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Value index '&quot;</span><span class='plus op'>+</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='plus op'>+</span><span class='string val'>&quot;' must be an integer, is &quot;</span> <span class='plus op'>+</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='if if_mod kw'>if</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='class identifier id'>class</span> <span class='neq op'>!=</span> <span class='float val'>1</span><span class='dot token'>.</span><span class='class identifier id'>class</span>
              <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Already have value index '&quot;</span> <span class='plus op'>+</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='plus op'>+</span> <span class='string val'>&quot;' in another model but with different prefix '&quot;</span> <span class='plus op'>+</span> <span class='@@values_by_number ivar id'>@@values_by_number</span><span class='lbrack token'>[</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='plus op'>+</span> <span class='string val'>&quot;'&quot;</span> <span class='if if_mod kw'>if</span> <span class='@@values_by_number ivar id'>@@values_by_number</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span> <span class='@@values_by_number ivar id'>@@values_by_number</span><span class='lbrack token'>[</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span> <span class='neq op'>!=</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span>

              <span class='comment val'># date types are special, mark them so the first model they're seen for</span>
              <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='@@values_by_number ivar id'>@@values_by_number</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
                  <span class='if if kw'>if</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>3</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='symbol val'>:date</span> 
                      <span class='value_range identifier id'>value_range</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='DateValueRangeProcessor constant id'>DateValueRangeProcessor</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
                  <span class='elsif elsif kw'>elsif</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>3</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='symbol val'>:string</span> 
                      <span class='value_range identifier id'>value_range</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='StringValueRangeProcessor constant id'>StringValueRangeProcessor</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
                  <span class='elsif elsif kw'>elsif</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>3</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='symbol val'>:number</span>
                      <span class='value_range identifier id'>value_range</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='NumberValueRangeProcessor constant id'>NumberValueRangeProcessor</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
                  <span class='else else kw'>else</span>
                      <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Unknown value type '&quot;</span> <span class='plus op'>+</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>3</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='plus op'>+</span> <span class='string val'>&quot;'&quot;</span>
                  <span class='end end kw'>end</span>

                  <span class='@@query_parser ivar id'>@@query_parser</span><span class='dot token'>.</span><span class='add_valuerangeprocessor identifier id'>add_valuerangeprocessor</span><span class='lparen token'>(</span><span class='value_range identifier id'>value_range</span><span class='rparen token'>)</span>

                  <span class='comment val'># stop it being garbage collected, as</span>
                  <span class='comment val'># add_valuerangeprocessor ref is outside Ruby's GC</span>
                  <span class='@@value_ranges_store ivar id'>@@value_ranges_store</span><span class='dot token'>.</span><span class='push identifier id'>push</span><span class='lparen token'>(</span><span class='value_range identifier id'>value_range</span><span class='rparen token'>)</span> 
              <span class='end end kw'>end</span>

              <span class='@@values_by_number ivar id'>@@values_by_number</span><span class='lbrack token'>[</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span>
              <span class='@@values_by_prefix ivar id'>@@values_by_prefix</span><span class='lbrack token'>[</span><span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>2</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>prepare_environment</h3>
</div><div id="prepare_environment-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>prepare_environment</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Reads the config file (if any) and sets up the path to the database
we&#8217;ll be using
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 80</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L80">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='prepare_environment identifier id'>prepare_environment</span>
  <span class='return return kw'>return</span> <span class='unless unless_mod kw'>unless</span> <span class='@@db_path ivar id'>@@db_path</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>

  <span class='comment val'># barf if we can't figure out the environment</span>
  <span class='environment identifier id'>environment</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='ENV constant id'>ENV</span><span class='lbrack token'>[</span><span class='string val'>'RAILS_ENV'</span><span class='rbrack token'>]</span> <span class='or or kw'>or</span> <span class='RAILS_ENV constant id'>RAILS_ENV</span><span class='rparen token'>)</span>
  <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Set RAILS_ENV, so acts_as_xapian can find the right Xapian database&quot;</span> <span class='if if_mod kw'>if</span> <span class='not not kw'>not</span> <span class='environment identifier id'>environment</span>

  <span class='comment val'># check for a config file</span>
  <span class='config_file identifier id'>config_file</span> <span class='assign token'>=</span> <span class='RAILS_ROOT constant id'>RAILS_ROOT</span> <span class='plus op'>+</span> <span class='string val'>&quot;/config/xapian.yml&quot;</span>
  <span class='@@config ivar id'>@@config</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span><span class='lparen token'>(</span><span class='config_file identifier id'>config_file</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='YAML constant id'>YAML</span><span class='dot token'>.</span><span class='load_file identifier id'>load_file</span><span class='lparen token'>(</span><span class='config_file identifier id'>config_file</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='environment identifier id'>environment</span><span class='rbrack token'>]</span> <span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

  <span class='comment val'># figure out where the DBs should go</span>
  <span class='if if kw'>if</span> <span class='config identifier id'>config</span><span class='lbrack token'>[</span><span class='string val'>'base_db_path'</span><span class='rbrack token'>]</span>
    <span class='db_parent_path identifier id'>db_parent_path</span> <span class='assign token'>=</span> <span class='RAILS_ROOT constant id'>RAILS_ROOT</span> <span class='plus op'>+</span> <span class='string val'>&quot;/&quot;</span> <span class='plus op'>+</span> <span class='config identifier id'>config</span><span class='lbrack token'>[</span><span class='string val'>'base_db_path'</span><span class='rbrack token'>]</span>
  <span class='else else kw'>else</span>
    <span class='db_parent_path identifier id'>db_parent_path</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='__FILE__ __file__ kw'>__FILE__</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>'../xapiandbs/'</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># make the directory for the xapian databases to go in</span>
  <span class='Dir constant id'>Dir</span><span class='dot token'>.</span><span class='mkdir identifier id'>mkdir</span><span class='lparen token'>(</span><span class='db_parent_path identifier id'>db_parent_path</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span><span class='lparen token'>(</span><span class='db_parent_path identifier id'>db_parent_path</span><span class='rparen token'>)</span>

  <span class='@@db_path ivar id'>@@db_path</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='db_parent_path identifier id'>db_parent_path</span><span class='comma token'>,</span> <span class='environment identifier id'>environment</span><span class='rparen token'>)</span> 

  <span class='comment val'># make some things that don't depend on the db</span>
  <span class='comment val'># XXX this gets made once for each acts_as_xapian. Oh well.</span>
  <span class='@@stemmer ivar id'>@@stemmer</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='Stem constant id'>Stem</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>'english'</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>query_parser</h3>
</div><div id="query_parser-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>query_parser</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 60</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L60">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">60
61
62</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='query_parser identifier id'>query_parser</span>
    <span class='@@query_parser ivar id'>@@query_parser</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>readable_init</h3>
</div><div id="readable_init-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>readable_init</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Opens / reopens the db for reading XXX we perhaps don&#8217;t need to
rebuild database and enquire and queryparser - but db.reopen wasn&#8217;t
enough by itself, so just do everything it&#8217;s easier.
</p>

</div><div class="section tags">
  <h2>Meta Tags</h2>
  <div class="raise">
  <h3>Raises:</h3>
  <dl>
  
    <dt>
      
        <span class='type'>[<tt><a href="ActsAsXapian/NoXapianRubyBindingsError.html" title="NoXapianRubyBindingsError">NoXapianRubyBindingsError</a></tt>]</span>
      
      
      
    </dt>
    <dd>
      <span class='desc'></span>
    </dd>
  
  </dl>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 111</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L111">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='readable_init identifier id'>readable_init</span>
    <span class='raise identifier id'>raise</span> <span class='NoXapianRubyBindingsError constant id'>NoXapianRubyBindingsError</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>&quot;Xapian Ruby bindings not installed&quot;</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='bindings_available identifier id'>bindings_available</span>
    <span class='raise identifier id'>raise</span> <span class='string val'>&quot;acts_as_xapian hasn't been called in any models&quot;</span> <span class='if if_mod kw'>if</span> <span class='@@init_values ivar id'>@@init_values</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    
    <span class='comment val'># if DB is not nil, then we're already initialised, so don't do it again</span>
    <span class='comment val'># XXX we need to reopen the database each time, so Xapian gets changes to it.</span>
    <span class='comment val'># Hopefully in later version of Xapian it will autodetect this, and this can</span>
    <span class='comment val'># be commented back in again.</span>
    <span class='comment val'># return unless @@db.nil?</span>

    <span class='prepare_environment identifier id'>prepare_environment</span>
    
    <span class='comment val'># basic Xapian objects</span>
    <span class='begin begin kw'>begin</span>
        <span class='@@db ivar id'>@@db</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='Database constant id'>Database</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='@@db_path ivar id'>@@db_path</span><span class='rparen token'>)</span>
        <span class='@@enquire ivar id'>@@enquire</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='Enquire constant id'>Enquire</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='@@db ivar id'>@@db</span><span class='rparen token'>)</span>
    <span class='rescue rescue kw'>rescue</span> <span class='IOError constant id'>IOError</span>
        <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Xapian database not opened; have you built it with scripts/rebuild-xapian-index ?&quot;</span>
    <span class='end end kw'>end</span>

    <span class='init_query_parser identifier id'>init_query_parser</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>rebuild_index</h3>
</div><div id="rebuild_index-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>rebuild_index</span><span class='args'>(model_classes, verbose = false)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
You must specify <b>all</b> the models here, this totally rebuilds the
Xapian database. You&#8217;ll want any readers to reopen the database after
this.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 537</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L537">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='rebuild_index identifier id'>rebuild_index</span><span class='lparen token'>(</span><span class='model_classes identifier id'>model_classes</span><span class='comma token'>,</span> <span class='verbose identifier id'>verbose</span> <span class='assign token'>=</span> <span class='false false kw'>false</span><span class='rparen token'>)</span>
    <span class='raise identifier id'>raise</span> <span class='string val'>&quot;when rebuilding all, please call as first and only thing done in process / task&quot;</span> <span class='if if_mod kw'>if</span> <span class='not not kw'>not</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='writable_db identifier id'>writable_db</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>

    <span class='prepare_environment identifier id'>prepare_environment</span>
    
    <span class='comment val'># Delete any existing .new database, and open a new one</span>
    <span class='new_path identifier id'>new_path</span> <span class='assign token'>=</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='db_path identifier id'>db_path</span> <span class='plus op'>+</span> <span class='string val'>&quot;.new&quot;</span>
    <span class='if if kw'>if</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='new_path identifier id'>new_path</span><span class='rparen token'>)</span>
        <span class='raise identifier id'>raise</span> <span class='string val'>&quot;found existing &quot;</span> <span class='plus op'>+</span> <span class='new_path identifier id'>new_path</span> <span class='plus op'>+</span> <span class='string val'>&quot; which is not Xapian flint database, please delete for me&quot;</span> <span class='if if_mod kw'>if</span> <span class='not not kw'>not</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='new_path identifier id'>new_path</span><span class='comma token'>,</span> <span class='string val'>&quot;iamflint&quot;</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
        <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='rm_r identifier id'>rm_r</span><span class='lparen token'>(</span><span class='new_path identifier id'>new_path</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='writable_init identifier id'>writable_init</span><span class='lparen token'>(</span><span class='string val'>&quot;.new&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># Index everything </span>
    <span class='comment val'># XXX not a good place to do this destroy, as unindexed list is lost if</span>
    <span class='comment val'># process is aborted and old database carries on being used. Perhaps do in</span>
    <span class='comment val'># transaction and commit after rename below? Not sure if thenlocking is then bad</span>
    <span class='comment val'># for live website running at same time.</span>
    
    <span class='ActsAsXapianJob constant id'>ActsAsXapianJob</span><span class='dot token'>.</span><span class='destroy_all identifier id'>destroy_all</span> 
    <span class='batch_size identifier id'>batch_size</span> <span class='assign token'>=</span> <span class='integer val'>1000</span>
    <span class='for for kw'>for</span> <span class='model_class identifier id'>model_class</span> <span class='in in kw'>in</span> <span class='model_classes identifier id'>model_classes</span>
      <span class='model_class identifier id'>model_class</span><span class='dot token'>.</span><span class='transaction identifier id'>transaction</span> <span class='do do kw'>do</span>
        <span class='integer val'>0</span><span class='dot token'>.</span><span class='step identifier id'>step</span><span class='lparen token'>(</span><span class='model_class identifier id'>model_class</span><span class='dot token'>.</span><span class='count identifier id'>count</span><span class='comma token'>,</span> <span class='batch_size identifier id'>batch_size</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span>
          <span class='STDOUT constant id'>STDOUT</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span><span class='lparen token'>(</span><span class='dstring node'>&quot;ActsAsXapian: New batch. From #{i} to #{i + batch_size}&quot;</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='verbose identifier id'>verbose</span>
          <span class='models identifier id'>models</span> <span class='assign token'>=</span> <span class='model_class identifier id'>model_class</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:limit</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='batch_size identifier id'>batch_size</span><span class='comma token'>,</span> <span class='symbol val'>:offset</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='i identifier id'>i</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:id</span><span class='rparen token'>)</span>
          <span class='for for kw'>for</span> <span class='model identifier id'>model</span> <span class='in in kw'>in</span> <span class='models identifier id'>models</span>
            <span class='STDOUT constant id'>STDOUT</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span><span class='lparen token'>(</span><span class='dstring node'>&quot;ActsAsXapian.rebuild_index #{model_class} #{model.id}&quot;</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='verbose identifier id'>verbose</span>
            <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='xapian_index identifier id'>xapian_index</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    
    <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='writable_db identifier id'>writable_db</span><span class='dot token'>.</span><span class='flush identifier id'>flush</span>

    <span class='comment val'># Rename into place</span>
    <span class='old_path identifier id'>old_path</span> <span class='assign token'>=</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='db_path identifier id'>db_path</span>
    <span class='temp_path identifier id'>temp_path</span> <span class='assign token'>=</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='db_path identifier id'>db_path</span> <span class='plus op'>+</span> <span class='string val'>&quot;.tmp&quot;</span>
    <span class='if if kw'>if</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='temp_path identifier id'>temp_path</span><span class='rparen token'>)</span>
        <span class='raise identifier id'>raise</span> <span class='string val'>&quot;temporary database found &quot;</span> <span class='plus op'>+</span> <span class='temp_path identifier id'>temp_path</span> <span class='plus op'>+</span> <span class='string val'>&quot; which is not Xapian flint database, please delete for me&quot;</span> <span class='if if_mod kw'>if</span> <span class='not not kw'>not</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='temp_path identifier id'>temp_path</span><span class='comma token'>,</span> <span class='string val'>&quot;iamflint&quot;</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
        <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='rm_r identifier id'>rm_r</span><span class='lparen token'>(</span><span class='temp_path identifier id'>temp_path</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    <span class='if if kw'>if</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='old_path identifier id'>old_path</span><span class='rparen token'>)</span>
        <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='mv identifier id'>mv</span> <span class='old_path identifier id'>old_path</span><span class='comma token'>,</span> <span class='temp_path identifier id'>temp_path</span>
    <span class='end end kw'>end</span>
    <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='mv identifier id'>mv</span> <span class='new_path identifier id'>new_path</span><span class='comma token'>,</span> <span class='old_path identifier id'>old_path</span>

    <span class='comment val'># Delete old database</span>
    <span class='if if kw'>if</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='temp_path identifier id'>temp_path</span><span class='rparen token'>)</span>
        <span class='raise identifier id'>raise</span> <span class='string val'>&quot;old database now at &quot;</span> <span class='plus op'>+</span> <span class='temp_path identifier id'>temp_path</span> <span class='plus op'>+</span> <span class='string val'>&quot; is not Xapian flint database, please delete for me&quot;</span> <span class='if if_mod kw'>if</span> <span class='not not kw'>not</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='temp_path identifier id'>temp_path</span><span class='comma token'>,</span> <span class='string val'>&quot;iamflint&quot;</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
        <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='rm_r identifier id'>rm_r</span><span class='lparen token'>(</span><span class='temp_path identifier id'>temp_path</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># You'll want to restart your FastCGI or Mongrel processes after this,</span>
    <span class='comment val'># so they get the new db</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>stemmer</h3>
</div><div id="stemmer-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>stemmer</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 51</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L51">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">51
52
53</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='stemmer identifier id'>stemmer</span>
    <span class='@@stemmer ivar id'>@@stemmer</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>term_generator</h3>
</div><div id="term_generator-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>term_generator</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 54</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L54">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">54
55
56</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='term_generator identifier id'>term_generator</span>
    <span class='@@term_generator ivar id'>@@term_generator</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>update_index</h3>
</div><div id="update_index-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>update_index</span><span class='args'>(flush = false, verbose = false)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Update index with any changes needed, call this offline. Only call it from
a script that exits - otherwise Xapian&#8217;s writable database
won&#8217;t flush your changes. Specifying flush will reduce performance,
but make sure that each index update is definitely saved to disk before
logging in the database that it has been.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 484</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L484">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='update_index identifier id'>update_index</span><span class='lparen token'>(</span><span class='flush identifier id'>flush</span> <span class='assign token'>=</span> <span class='false false kw'>false</span><span class='comma token'>,</span> <span class='verbose identifier id'>verbose</span> <span class='assign token'>=</span> <span class='false false kw'>false</span><span class='rparen token'>)</span>
    <span class='comment val'># STDOUT.puts(&quot;start of ActsAsXapian.update_index&quot;) if verbose</span>

    <span class='comment val'># Before calling writable_init we have to make sure every model class has been initialized.</span>
    <span class='comment val'># i.e. has had its class code loaded, so acts_as_xapian has been called inside it, and</span>
    <span class='comment val'># we have the info from acts_as_xapian.</span>
    <span class='model_classes identifier id'>model_classes</span> <span class='assign token'>=</span> <span class='ActsAsXapianJob constant id'>ActsAsXapianJob</span><span class='dot token'>.</span><span class='find_by_sql identifier id'>find_by_sql</span><span class='lparen token'>(</span><span class='string val'>&quot;select model from acts_as_xapian_jobs group by model&quot;</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='a identifier id'>a</span><span class='bitor op'>|</span> <span class='a identifier id'>a</span><span class='dot token'>.</span><span class='model identifier id'>model</span><span class='dot token'>.</span><span class='constantize identifier id'>constantize</span><span class='rbrace token'>}</span>
    <span class='comment val'># If there are no models in the queue, then nothing to do</span>
    <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='model_classes identifier id'>model_classes</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='eq op'>==</span> <span class='integer val'>0</span>

    <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='writable_init identifier id'>writable_init</span>

    <span class='ids_to_refresh identifier id'>ids_to_refresh</span> <span class='assign token'>=</span> <span class='ActsAsXapianJob constant id'>ActsAsXapianJob</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='i identifier id'>i</span><span class='dot token'>.</span><span class='id identifier id'>id</span> <span class='rbrace token'>}</span>
    <span class='for for kw'>for</span> <span class='id identifier id'>id</span> <span class='in in kw'>in</span> <span class='ids_to_refresh identifier id'>ids_to_refresh</span>
        <span class='begin begin kw'>begin</span>
            <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span><span class='dot token'>.</span><span class='transaction identifier id'>transaction</span> <span class='do do kw'>do</span>
                <span class='job identifier id'>job</span> <span class='assign token'>=</span> <span class='ActsAsXapianJob constant id'>ActsAsXapianJob</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='id identifier id'>id</span><span class='comma token'>,</span> <span class='symbol val'>:lock</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span><span class='true true kw'>true</span><span class='rparen token'>)</span>
                <span class='STDOUT constant id'>STDOUT</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span><span class='lparen token'>(</span><span class='dstring node'>&quot;ActsAsXapian.update_index #{job.action} #{job.model} #{job.model_id.to_s}&quot;</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='verbose identifier id'>verbose</span>
                <span class='begin begin kw'>begin</span>
                    <span class='if if kw'>if</span> <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='action identifier id'>action</span> <span class='eq op'>==</span> <span class='string val'>'update'</span>
                        <span class='comment val'># XXX Index functions may reference other models, so we could eager load here too?</span>
                        <span class='model identifier id'>model</span> <span class='assign token'>=</span> <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='model identifier id'>model</span><span class='dot token'>.</span><span class='constantize identifier id'>constantize</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='job identifier id'>job</span><span class='dot token'>.</span><span class='model_id identifier id'>model_id</span><span class='rparen token'>)</span> <span class='comment val'># :include =&gt; cls.constantize.xapian_options[:include]</span>
                        <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='xapian_index identifier id'>xapian_index</span>
                    <span class='elsif elsif kw'>elsif</span> <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='action identifier id'>action</span> <span class='eq op'>==</span> <span class='string val'>'destroy'</span>
                        <span class='comment val'># Make dummy model with right id, just for destruction</span>
                        <span class='model identifier id'>model</span> <span class='assign token'>=</span> <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='model identifier id'>model</span><span class='dot token'>.</span><span class='constantize identifier id'>constantize</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
                        <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='id identifier id'>id</span> <span class='assign token'>=</span> <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='model_id identifier id'>model_id</span>
                        <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='xapian_destroy identifier id'>xapian_destroy</span>
                    <span class='else else kw'>else</span>
                        <span class='raise identifier id'>raise</span> <span class='string val'>&quot;unknown ActsAsXapianJob action '&quot;</span> <span class='plus op'>+</span> <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='action identifier id'>action</span> <span class='plus op'>+</span> <span class='string val'>&quot;'&quot;</span>
                    <span class='end end kw'>end</span>
                <span class='rescue rescue kw'>rescue</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='RecordNotFound constant id'>RecordNotFound</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
                  <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='action identifier id'>action</span> <span class='assign token'>=</span> <span class='string val'>'destroy'</span>
                  <span class='retry retry kw'>retry</span>
                <span class='end end kw'>end</span>
                <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='destroy identifier id'>destroy</span>

                <span class='if if kw'>if</span> <span class='flush identifier id'>flush</span>
                    <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='writable_db identifier id'>writable_db</span><span class='dot token'>.</span><span class='flush identifier id'>flush</span>
                <span class='end end kw'>end</span>
            <span class='end end kw'>end</span>
        <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='detail identifier id'>detail</span>
            <span class='comment val'># print any error, and carry on so other things are indexed</span>
            <span class='comment val'># XXX If item is later deleted, this should give up, and it</span>
            <span class='comment val'># won't. It will keep trying (assuming update_index called from</span>
            <span class='comment val'># regular cron job) and mayhap cause trouble.</span>
            <span class='STDERR constant id'>STDERR</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span><span class='lparen token'>(</span><span class='detail identifier id'>detail</span><span class='dot token'>.</span><span class='backtrace identifier id'>backtrace</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot;\n&quot;</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='dstring node'>&quot;\nFAILED ActsAsXapian.update_index job #{id} #{$!}&quot;</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>values_by_prefix</h3>
</div><div id="values_by_prefix-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>values_by_prefix</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 63</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L63">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">63
64
65</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='values_by_prefix identifier id'>values_by_prefix</span>
    <span class='@@values_by_prefix ivar id'>@@values_by_prefix</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>writable_db</h3>
</div><div id="writable_db-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>writable_db</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 48</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L48">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">48
49
50</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='writable_db identifier id'>writable_db</span>
    <span class='@@writable_db ivar id'>@@writable_db</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>writable_init</h3>
</div><div id="writable_init-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>writable_init</span><span class='args'>(suffix = &quot;&quot;)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section tags">
  <h2>Meta Tags</h2>
  <div class="raise">
  <h3>Raises:</h3>
  <dl>
  
    <dt>
      
        <span class='type'>[<tt><a href="ActsAsXapian/NoXapianRubyBindingsError.html" title="NoXapianRubyBindingsError">NoXapianRubyBindingsError</a></tt>]</span>
      
      
      
    </dt>
    <dd>
      <span class='desc'></span>
    </dd>
  
  </dl>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_xapian.rb', line 198</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/Overbryd/acts_as_xapian/blob/dc3517c66b18dbf66733aac3ba436c7bf4ffcab8/lib/acts_as_xapian.rb#L198">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='writable_init identifier id'>writable_init</span><span class='lparen token'>(</span><span class='suffix identifier id'>suffix</span> <span class='assign token'>=</span> <span class='string val'>&quot;&quot;</span><span class='rparen token'>)</span>
    <span class='raise identifier id'>raise</span> <span class='NoXapianRubyBindingsError constant id'>NoXapianRubyBindingsError</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>&quot;Xapian Ruby bindings not installed&quot;</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='ActsAsXapian constant id'>ActsAsXapian</span><span class='dot token'>.</span><span class='bindings_available identifier id'>bindings_available</span>
    <span class='raise identifier id'>raise</span> <span class='string val'>&quot;acts_as_xapian hasn't been called in any models&quot;</span> <span class='if if_mod kw'>if</span> <span class='@@init_values ivar id'>@@init_values</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>

    <span class='comment val'># if DB is not nil, then we're already initialised, so don't do it again</span>
    <span class='return return kw'>return</span> <span class='unless unless_mod kw'>unless</span> <span class='@@writable_db ivar id'>@@writable_db</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    
    <span class='prepare_environment identifier id'>prepare_environment</span>

    <span class='new_path identifier id'>new_path</span> <span class='assign token'>=</span> <span class='@@db_path ivar id'>@@db_path</span> <span class='plus op'>+</span> <span class='suffix identifier id'>suffix</span>
    <span class='raise identifier id'>raise</span> <span class='string val'>&quot;writable_suffix/suffix inconsistency&quot;</span> <span class='if if_mod kw'>if</span> <span class='@@writable_suffix ivar id'>@@writable_suffix</span> <span class='andop op'>&amp;&amp;</span> <span class='@@writable_suffix ivar id'>@@writable_suffix</span> <span class='neq op'>!=</span> <span class='suffix identifier id'>suffix</span>
    <span class='if if kw'>if</span> <span class='@@writable_db ivar id'>@@writable_db</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
        <span class='comment val'># for indexing</span>
        <span class='@@writable_db ivar id'>@@writable_db</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='WritableDatabase constant id'>WritableDatabase</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='new_path identifier id'>new_path</span><span class='comma token'>,</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='DB_CREATE_OR_OPEN constant id'>DB_CREATE_OR_OPEN</span><span class='rparen token'>)</span>
        <span class='@@term_generator ivar id'>@@term_generator</span> <span class='assign token'>=</span> <span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='TermGenerator constant id'>TermGenerator</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='rparen token'>)</span>
        <span class='@@term_generator ivar id'>@@term_generator</span><span class='dot token'>.</span><span class='set_flags identifier id'>set_flags</span><span class='lparen token'>(</span><span class='Xapian constant id'>Xapian</span><span class='colon2 op'>::</span><span class='TermGenerator constant id'>TermGenerator</span><span class='colon2 op'>::</span><span class='FLAG_SPELLING constant id'>FLAG_SPELLING</span><span class='comma token'>,</span> <span class='integer val'>0</span><span class='rparen token'>)</span>
        <span class='@@term_generator ivar id'>@@term_generator</span><span class='dot token'>.</span><span class='database identifier id'>database</span> <span class='assign token'>=</span> <span class='@@writable_db ivar id'>@@writable_db</span>
        <span class='@@term_generator ivar id'>@@term_generator</span><span class='dot token'>.</span><span class='stemmer identifier id'>stemmer</span> <span class='assign token'>=</span> <span class='@@stemmer ivar id'>@@stemmer</span>
        <span class='@@writable_suffix ivar id'>@@writable_suffix</span> <span class='assign token'>=</span> <span class='suffix identifier id'>suffix</span>
    <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
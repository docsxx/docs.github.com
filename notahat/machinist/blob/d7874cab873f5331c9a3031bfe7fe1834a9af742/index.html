<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>notahat's machinist - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/notahat/commits/machinist/master" rel="alternate" title="Recent Commits to machinist:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("notahat", "machinist", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='notahat/machinist/blob/d7874cab873f5331c9a3031bfe7fe1834a9af742' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='notahat/machinist/blob/d7874cab873f5331c9a3031bfe7fe1834a9af742' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("notahat", "machinist", "d7874cab873f5331c9a3031bfe7fe1834a9af742", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/notahat/machinist/tree/">Source</a></li>
            <li class=""><a href="http://github.com/notahat/machinist/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/notahat/machinist/network">Network</a></li>            
            <li class=""><a href="http://github.com/notahat/machinist/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/notahat/machinist">Wiki</a></li>
            <li class=""><a href="http://github.com/notahat/machinist/graphs">Graphs</a></li>                    
            <li class="active"><a href="/notahat/machinist">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/notahat">notahat</a> / <b><a href="http://github.com/notahat/machinist/tree">machinist</a></b>        
                <a id="namespaces_button" rel="notahat/machinist/blob/d7874cab873f5331c9a3031bfe7fe1834a9af742" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="notahat/machinist/blob/d7874cab873f5331c9a3031bfe7fe1834a9af742" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>Machinist</h1>

<p><em>Fixtures aren't fun. Machinist is.</em></p>

<p>Machinist makes it easy to create test data within your tests. It generates data for the fields you don't care about, and constructs any necessary associated objects, leaving you to only specify the fields you <em>do</em> care about in your tests. For example:</p>

<pre class="code"><span class='describe identifier id'>describe</span> <span class='Comment constant id'>Comment</span> <span class='do do kw'>do</span>
  <span class='before identifier id'>before</span> <span class='do do kw'>do</span>
    <span class='comment val'># This will make a Comment, a Post, and a User (the author of</span>
    <span class='comment val'># the Post), and generate values for all their attributes:</span>
    <span class='@comment ivar id'>@comment</span> <span class='assign token'>=</span> <span class='Comment constant id'>Comment</span><span class='dot token'>.</span><span class='make identifier id'>make</span><span class='lparen token'>(</span><span class='symbol val'>:spam</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='it identifier id'>it</span> <span class='string val'>&quot;should not include comments marked as spam in the without_spam named scope&quot;</span> <span class='do do kw'>do</span>
    <span class='Comment constant id'>Comment</span><span class='dot token'>.</span><span class='without_spam identifier id'>without_spam</span><span class='dot token'>.</span><span class='should_not identifier id'>should_not</span> <span class='include identifier id'>include</span><span class='lparen token'>(</span><span class='@comment ivar id'>@comment</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>

<p>You tell Machinist how to do this with blueprints:</p>

<pre class="code"><span class='require identifier id'>require</span> <span class='string val'>'machinist/active_record'</span>
<span class='require identifier id'>require</span> <span class='string val'>'sham'</span>
<span class='require identifier id'>require</span> <span class='string val'>'faker'</span>

<span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span>  <span class='lbrace token'>{</span> <span class='Faker constant id'>Faker</span><span class='colon2 op'>::</span><span class='Name constant id'>Name</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
<span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='email identifier id'>email</span> <span class='lbrace token'>{</span> <span class='Faker constant id'>Faker</span><span class='colon2 op'>::</span><span class='Internet constant id'>Internet</span><span class='dot token'>.</span><span class='email identifier id'>email</span> <span class='rbrace token'>}</span>
<span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='title identifier id'>title</span> <span class='lbrace token'>{</span> <span class='Faker constant id'>Faker</span><span class='colon2 op'>::</span><span class='Lorem constant id'>Lorem</span><span class='dot token'>.</span><span class='sentence identifier id'>sentence</span> <span class='rbrace token'>}</span>
<span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='body identifier id'>body</span>  <span class='lbrace token'>{</span> <span class='Faker constant id'>Faker</span><span class='colon2 op'>::</span><span class='Lorem constant id'>Lorem</span><span class='dot token'>.</span><span class='paragraph identifier id'>paragraph</span> <span class='rbrace token'>}</span>

<span class='User constant id'>User</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='name identifier id'>name</span>
  <span class='email identifier id'>email</span>
<span class='end end kw'>end</span>

<span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='title identifier id'>title</span>
  <span class='author identifier id'>author</span>
  <span class='body identifier id'>body</span>
<span class='end end kw'>end</span>

<span class='Comment constant id'>Comment</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='post identifier id'>post</span>
  <span class='author_name identifier id'>author_name</span>  <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
  <span class='author_email identifier id'>author_email</span> <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='email identifier id'>email</span> <span class='rbrace token'>}</span>
  <span class='body identifier id'>body</span>
<span class='end end kw'>end</span>
</pre>

<h1>Download &amp; Install</h1>

<h3>Installing as a Rails plugin</h3>

<pre class="code"><span class='dot token'>.</span><span class='div op'>/</span><span class='script identifier id'>script</span><span class='div op'>/</span><span class='plugin identifier id'>plugin</span> <span class='install identifier id'>install</span> <span class='git identifier id'>git</span><span class='symbol val'>:/</span><span class='regexp val'>/github.com/n</span><span class='otahat identifier id'>otahat</span><span class='div op'>/</span><span class='machinist identifier id'>machinist</span><span class='dot token'>.</span><span class='git identifier id'>git</span>
</pre>

<h3>Installing as a Gem</h3>

<pre class="code"><span class='sudo identifier id'>sudo</span> <span class='gem identifier id'>gem</span> <span class='install identifier id'>install</span> <span class='notahat identifier id'>notahat</span><span class='minus op'>-</span><span class='machinist identifier id'>machinist</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='source identifier id'>source</span> <span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/gems.github.com
</span></pre>

<h3>Setting up your project</h3>

<p>Create a <code>blueprints.rb</code> file to hold your blueprints in your test (or spec) directory. It should start with:</p>

<pre class="code"><span class='require identifier id'>require</span> <span class='string val'>'machinist/active_record'</span>
<span class='require identifier id'>require</span> <span class='string val'>'sham'</span>
</pre>

<p>Substitute <code>data_mapper</code> for <code>active_record</code> if that's your weapon of choice.</p>

<p>Require <code>blueprints.rb</code> in your <code>test_helper.rb</code> (or <code>spec_helper.rb</code>):</p>

<pre class="code"><span class='require identifier id'>require</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='expand_path identifier id'>expand_path</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='__FILE__ __file__ kw'>__FILE__</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;/blueprints&quot;</span><span class='rparen token'>)</span>
</pre>

<p>Set Sham to reset before each test. In the <code>class Test::Unit::TestCase</code> block in your <code>test_helper.rb</code>, add:</p>

<pre class="code"><span class='setup identifier id'>setup</span> <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='reset identifier id'>reset</span> <span class='rbrace token'>}</span>
</pre>

<p>or, if you're on RSpec, in the <code>Spec::Runner.configure</code> block in your <code>spec_helper.rb</code>, add:</p>

<pre class="code"><span class='config identifier id'>config</span><span class='dot token'>.</span><span class='before identifier id'>before</span><span class='lparen token'>(</span><span class='symbol val'>:each</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='reset identifier id'>reset</span> <span class='rbrace token'>}</span>
</pre>

<h1>Documentation</h1>

<h2>Sham - Generating Attribute Values</h2>

<p>Sham lets you generate random but repeatable unique attributes values.</p>

<p>For example, you could define a way to generate random names as:</p>

<pre class="code"><span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='lbrace token'>{</span> <span class='lparen token'>(</span><span class='float val'>1</span><span class='dot2 op'>..</span><span class='integer val'>10</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='lparen token'>(</span><span class='string val'>'a'</span><span class='dot2 op'>..</span><span class='string val'>'z'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_a identifier id'>to_a</span><span class='dot token'>.</span><span class='rand identifier id'>rand</span> <span class='rbrace token'>}</span> <span class='rbrace token'>}</span>
</pre>

<p>Then, to generate a name, call:</p>

<pre class="code"><span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
</pre>

<p>So why not just define a helper method to do this? Sham ensures two things for you:</p>

<ol>
<li>You get the same sequence of values each time your test is run</li>
<li>You don't get any duplicate values</li>
</ol>


<p>Sham works very well with the excellent <a href="http://faker.rubyforge.org/">Faker gem</a> by Benjamin Curtis. Using this, a much nicer way to generate names is:</p>

<pre class="code"><span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='lbrace token'>{</span> <span class='Faker constant id'>Faker</span><span class='colon2 op'>::</span><span class='Name constant id'>Name</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
</pre>

<p>Sham also supports generating numbered sequences if you prefer.</p>

<pre class="code"><span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='index identifier id'>index</span><span class='bitor op'>|</span> <span class='dstring node'>&quot;Name #{index}&quot;</span> <span class='rbrace token'>}</span>
</pre>

<p>If you want to allow duplicate values for a sham, you can pass the <code>:unique</code> option:</p>

<pre class="code"><span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='coin_toss identifier id'>coin_toss</span><span class='lparen token'>(</span><span class='symbol val'>:unique</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='rand identifier id'>rand</span><span class='lparen token'>(</span><span class='integer val'>2</span><span class='rparen token'>)</span> <span class='eq op'>==</span> <span class='integer val'>0</span> <span class='question op'>?</span> <span class='string val'>'heads'</span> <span class='colon op'>:</span> <span class='string val'>'tails'</span> <span class='rbrace token'>}</span>
</pre>

<p>You can create a bunch of sham definitions in one hit like this:</p>

<pre class="code"><span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='define identifier id'>define</span> <span class='do do kw'>do</span>
  <span class='title identifier id'>title</span> <span class='lbrace token'>{</span> <span class='Faker constant id'>Faker</span><span class='colon2 op'>::</span><span class='Lorem constant id'>Lorem</span><span class='dot token'>.</span><span class='words identifier id'>words</span><span class='lparen token'>(</span><span class='integer val'>5</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>' '</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
  <span class='name identifier id'>name</span>  <span class='lbrace token'>{</span> <span class='Faker constant id'>Faker</span><span class='colon2 op'>::</span><span class='Name constant id'>Name</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
  <span class='body identifier id'>body</span>  <span class='lbrace token'>{</span> <span class='Faker constant id'>Faker</span><span class='colon2 op'>::</span><span class='Lorem constant id'>Lorem</span><span class='dot token'>.</span><span class='paragraphs identifier id'>paragraphs</span><span class='lparen token'>(</span><span class='integer val'>3</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot;\n\n&quot;</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>

<h2>Blueprints - Generating Objects</h2>

<p>A blueprint describes how to generate an object. The idea is that you let the blueprint take care of making up values for attributes that you don't care about in your test, leaving you to focus on the just the things that you're testing.</p>

<p>A simple blueprint might look like this:</p>

<pre class="code"><span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='title identifier id'>title</span>  <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='title identifier id'>title</span> <span class='rbrace token'>}</span>
  <span class='author identifier id'>author</span> <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
  <span class='body identifier id'>body</span>   <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='body identifier id'>body</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>

<p>You can then construct a Post from this blueprint with:</p>

<pre class="code"><span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='make identifier id'>make</span>
</pre>

<p>When you call <code>make</code>, Machinist calls <code>Post.new</code>, then runs through the attributes in your blueprint, calling the block for each attribute to generate a value. The Post is then saved and reloaded. An exception is thrown if Post can't be saved.</p>

<p>You can override values defined in the blueprint by passing a hash to make:</p>

<pre class="code"><span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='make identifier id'>make</span><span class='lparen token'>(</span><span class='symbol val'>:title</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;A Specific Title&quot;</span><span class='rparen token'>)</span>
</pre>

<p>If you don't supply a block for an attribute in the blueprint, Machinist will look for a Sham definition with the same name as the attribute, so you can shorten the above blueprint to:</p>

<pre class="code"><span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='title identifier id'>title</span>
  <span class='author identifier id'>author</span> <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
  <span class='body identifier id'>body</span>
<span class='end end kw'>end</span>
</pre>

<p>If you want to generate an object without saving it to the database, replace <code>make</code> with <code>make_unsaved</code>. (<code>make_unsaved</code> also ensures that any associated objects that need to be generated are not saved. See the section on associations below.)</p>

<p>You can refer to already assigned attributes when constructing a new attribute:</p>

<pre class="code"><span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='title identifier id'>title</span>
  <span class='author identifier id'>author</span> <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='rbrace token'>}</span>
  <span class='body identifier id'>body</span>   <span class='lbrace token'>{</span> <span class='dstring node'>&quot;Post by #{author}&quot;</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>

<h3>Named Blueprints</h3>

<p>Named blueprints let you define variations on an object. For example, suppose some of your Users are administrators:</p>

<pre class="code"><span class='User constant id'>User</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='name identifier id'>name</span>
  <span class='email identifier id'>email</span>
<span class='end end kw'>end</span>

<span class='User constant id'>User</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span><span class='lparen token'>(</span><span class='symbol val'>:admin</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
  <span class='name identifier id'>name</span>  <span class='lbrace token'>{</span> <span class='Sham constant id'>Sham</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='plus op'>+</span> <span class='string val'>&quot; (admin)&quot;</span> <span class='rbrace token'>}</span>
  <span class='admin identifier id'>admin</span> <span class='lbrace token'>{</span> <span class='true true kw'>true</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>

<p>Calling:</p>

<pre class="code"><span class='User constant id'>User</span><span class='dot token'>.</span><span class='make identifier id'>make</span><span class='lparen token'>(</span><span class='symbol val'>:admin</span><span class='rparen token'>)</span>
</pre>

<p>will use the <code>:admin</code> blueprint.</p>

<p>Named blueprints call the default blueprint to set any attributes not specifically provided, so in this example the <code>email</code> attribute will still be generated even for an admin user.</p>

<h3>Belongs_to Associations</h3>

<p>If you're generating an object that belongs to another object, you can generate the associated object like this:</p>

<pre class="code"><span class='Comment constant id'>Comment</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='post identifier id'>post</span> <span class='lbrace token'>{</span> <span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='make identifier id'>make</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>

<p>Calling <code>Comment.make</code> will construct a Comment and its associated Post, and save both.</p>

<p>If you want to override the value for post when constructing the comment, you can do this:</p>

<pre class="code"><span class='post identifier id'>post</span> <span class='assign token'>=</span> <span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='make identifier id'>make</span><span class='lparen token'>(</span><span class='symbol val'>:title</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;A particular title)
comment = Comment.make(:post =&gt; post)
</span></pre>

<p>Machinist will not call the blueprint block for the post attribute, so this won't generate two posts.</p>

<p>Machinist is smart enough to look at the association and work out what sort of object it needs to create, so you can shorten the above blueprint to:</p>

<pre class="code"><span class='Comment constant id'>Comment</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='post identifier id'>post</span>
<span class='end end kw'>end</span>
</pre>

<h3>Other Associations</h3>

<p>For has_many and has_and_belongs_to_many associations, ActiveRecord insists that the object be saved before any associated objects can be saved. That means you can't generate the associated objects from within the blueprint.</p>

<p>The simplest solution is to write a test helper:</p>

<pre class="code"><span class='def def kw'>def</span> <span class='make_post_with_comments identifier id'>make_post_with_comments</span><span class='lparen token'>(</span><span class='attributes identifier id'>attributes</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='post identifier id'>post</span> <span class='assign token'>=</span> <span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='make identifier id'>make</span><span class='lparen token'>(</span><span class='attributes identifier id'>attributes</span><span class='rparen token'>)</span>
  <span class='float val'>3</span><span class='dot token'>.</span><span class='times identifier id'>times</span> <span class='lbrace token'>{</span> <span class='post identifier id'>post</span><span class='dot token'>.</span><span class='comments identifier id'>comments</span><span class='dot token'>.</span><span class='make identifier id'>make</span> <span class='rbrace token'>}</span>
  <span class='post identifier id'>post</span>
<span class='end end kw'>end</span>
</pre>

<p>Note here that you can call <code>make</code> on a has_many association. (This isn't yet supported for DataMapper.)</p>

<p>Make can take a block, into which it passes the constructed object, so the above can be written as:</p>

<pre class="code"><span class='def def kw'>def</span> <span class='make_post_with_comments identifier id'>make_post_with_comments</span>
  <span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='make identifier id'>make</span><span class='lparen token'>(</span><span class='attributes identifier id'>attributes</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='post identifier id'>post</span><span class='bitor op'>|</span>
    <span class='float val'>3</span><span class='dot token'>.</span><span class='times identifier id'>times</span> <span class='lbrace token'>{</span> <span class='post identifier id'>post</span><span class='dot token'>.</span><span class='comments identifier id'>comments</span><span class='dot token'>.</span><span class='make identifier id'>make</span> <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>

<h3>Using Blueprints in Rails Controller Tests</h3>

<p>The <code>plan</code> method behaves like <code>make</code>, except it returns a hash of attributes, and doesn't save the object. This is useful for passing in to controller tests:</p>

<pre class="code"><span class='test identifier id'>test</span> <span class='string val'>&quot;should create post&quot;</span> <span class='do do kw'>do</span>
  <span class='assert_difference identifier id'>assert_difference</span><span class='lparen token'>(</span><span class='string val'>'Post.count'</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='post identifier id'>post</span> <span class='symbol val'>:create</span><span class='comma token'>,</span> <span class='symbol val'>:post</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='plan identifier id'>plan</span>
  <span class='end end kw'>end</span>
  <span class='assert_redirected_to identifier id'>assert_redirected_to</span> <span class='post_path identifier id'>post_path</span><span class='lparen token'>(</span><span class='assigns identifier id'>assigns</span><span class='lparen token'>(</span><span class='symbol val'>:post</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>

<p><code>plan</code> will save any associated objects. In this example, it will create an Author, and it knows that the controller expects an <code>author_id</code> attribute, rather than an <code>author</code> attribute, and makes this translation for you.</p>

<p>You can also call plan on has_many associations, making it easy to test nested controllers:</p>

<pre class="code"><span class='test identifier id'>test</span> <span class='string val'>&quot;should create comment&quot;</span> <span class='do do kw'>do</span>
  <span class='post identifier id'>post</span> <span class='assign token'>=</span> <span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='make identifier id'>make</span>
  <span class='assert_difference identifier id'>assert_difference</span><span class='lparen token'>(</span><span class='string val'>'Comment.count'</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='post identifier id'>post</span> <span class='symbol val'>:create</span><span class='comma token'>,</span> <span class='symbol val'>:post_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='post identifier id'>post</span><span class='dot token'>.</span><span class='id identifier id'>id</span><span class='comma token'>,</span> <span class='symbol val'>:comment</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='post identifier id'>post</span><span class='dot token'>.</span><span class='comments identifier id'>comments</span><span class='dot token'>.</span><span class='plan identifier id'>plan</span>
  <span class='end end kw'>end</span>
  <span class='assert_redirected_to identifier id'>assert_redirected_to</span> <span class='post_comment_path identifier id'>post_comment_path</span><span class='lparen token'>(</span><span class='post identifier id'>post</span><span class='comma token'>,</span> <span class='assigns identifier id'>assigns</span><span class='lparen token'>(</span><span class='symbol val'>:comment</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>

<p>(Calling plan on associations is not yet supported in DataMapper.)</p>

<h3>Blueprints on Plain Old Ruby Objects</h3>

<p>Machinist also works with plain old Ruby objects. Let's say you have a class like:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='Post constant id'>Post</span>
  <span class='attr_accessor identifier id'>attr_accessor</span> <span class='symbol val'>:title</span>
  <span class='attr_accessor identifier id'>attr_accessor</span> <span class='symbol val'>:body</span>
<span class='end end kw'>end</span>
</pre>

<p>You can then do the following in your <code>blueprints.rb</code>:</p>

<pre class="code"><span class='require identifier id'>require</span> <span class='string val'>'machinist/object'</span>

<span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='blueprint identifier id'>blueprint</span> <span class='do do kw'>do</span>
  <span class='title identifier id'>title</span> <span class='string val'>&quot;A title!&quot;</span>
  <span class='body identifier id'>body</span>  <span class='string val'>&quot;A body!&quot;</span>
<span class='end end kw'>end</span>
</pre>

<h1>Community</h1>

<p>You can always find the <a href="http://github.com/notahat/machinist">latest version on GitHub</a>.</p>

<p>If you have questions, check out the <a href="http://groups.google.com/group/machinist-users">Google Group</a>.</p>

<p>File bug reports and feature requests in the <a href="http://github.com/notahat/machinist/issues">issue tracker</a>.</p>

<h2>Contributors</h2>

<p>Machinist is maintained by Pete Yandell (<a href="mailto:pete@notahat.com">pete@notahat.com</a>, <a href="http://twitter.com/notahat">@notahat</a>)</p>

<p>Other contributors include:</p>

<p><a href="http://github.com/yizzreel">Marcos Arias</a>,
<a href="http://github.com/jackdempsey">Jack Dempsey</a>,
<a href="http://github.com/clinton">Clinton Forbes</a>,
<a href="http://github.com/perryn">Perryn Fowler</a>,
<a href="http://github.com/Nielsomat">Niels Ganser</a>,
<a href="http://github.com/jeremygrant">Jeremy Grant</a>,
<a href="http://github.com/gnarg">Jon Guymon</a>,
<a href="http://github.com/yob">James Healy</a>,
<a href="http://github.com/elight">Evan David Light</a>,
<a href="http://github.com/chrislloyd">Chris Lloyd</a>,
<a href="http://github.com/adzap">Adam Meehan</a>,
<a href="http://github.com/kneath">Kyle Neath</a>,
<a href="http://github.com/tjsheehy">T.J. Sheehy</a>,
<a href="http://github.com/knaveofdiamonds">Roland Swingler</a>,
<a href="http://github.com/quamen">Gareth Townsend</a>,
<a href="http://github.com/towski">Matt Wastrodowski</a>,
<a href="http://github.com/ianwhite">Ian White</a></p>

<p>Thanks to Thoughtbot's <a href="http://github.com/thoughtbot/factory_girl/tree/master">Factory Girl</a>. Machinist was written because I loved the idea behind Factory Girl, but I thought the philosophy wasn't quite right, and I hated the syntax.</p>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> Â©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
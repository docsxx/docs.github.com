<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>langalex's couch_potato - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/langalex/commits/couch_potato/master" rel="alternate" title="Recent Commits to couch_potato:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("langalex", "couch_potato", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='langalex/couch_potato/blob/8101af4e804956bc469d76433e5a9c299ebfdd73' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='langalex/couch_potato/blob/8101af4e804956bc469d76433e5a9c299ebfdd73' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("langalex", "couch_potato", "8101af4e804956bc469d76433e5a9c299ebfdd73", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/langalex/couch_potato/tree/">Source</a></li>
            <li class=""><a href="http://github.com/langalex/couch_potato/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/langalex/couch_potato/network">Network</a></li>            
            <li class=""><a href="http://github.com/langalex/couch_potato/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/langalex/couch_potato">Wiki</a></li>
            <li class=""><a href="http://github.com/langalex/couch_potato/graphs">Graphs</a></li>                    
            <li class="active"><a href="/langalex/couch_potato">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/langalex">langalex</a> / <b><a href="http://github.com/langalex/couch_potato/tree">couch_potato</a></b>        
                <a id="namespaces_button" rel="langalex/couch_potato/blob/8101af4e804956bc469d76433e5a9c299ebfdd73" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="langalex/couch_potato/blob/8101af4e804956bc469d76433e5a9c299ebfdd73" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h2>Couch Potato</h2>

<p>... is a persistence layer written in ruby for CouchDB.</p>

<h3>Mission</h3>

<p>The goal of Couch Potato is to create a minimal framework in order to store and retrieve Ruby objects to/from CouchDB and create and query views.</p>

<p>It follows the document/view/querying semantics established by CouchDB and won't try to mimic ActiveRecord behavior in any way as that IS BAD.</p>

<p>Code that uses Couch Potato should be easy to test.</p>

<p>Lastly Couch Potato aims to provide a seamless integration with Ruby on Rails, e.g. routing, form helpers etc.</p>

<h3>Core Features</h3>

<ul>
<li>persisting objects by including the CouchPotato::Persistence module</li>
<li>declarative views with either custom or generated map/reduce functions</li>
<li>extensive spec suite</li>
</ul>

<h3>Installation</h3>

<p>Couch Potato requires Ruby 1.9.</p>

<p>Couch Potato is hosted as a gem on github which you can install like this:</p>

<pre class="code"><span class='sudo identifier id'>sudo</span> <span class='gem identifier id'>gem</span> <span class='source identifier id'>source</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='add identifier id'>add</span> <span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/gems.github.com # if you haven't already
sudo gem install langalex-couch_potato
</span></pre>

<h4>Using with your ruby application:</h4>

<pre class="code"><span class='require identifier id'>require</span> <span class='string val'>'rubygems'</span>
<span class='gem identifier id'>gem</span> <span class='string val'>'langalex-couch_potato'</span>
<span class='require identifier id'>require</span> <span class='string val'>'couch_potato'</span>
<span class='CouchPotato constant id'>CouchPotato</span><span class='colon2 op'>::</span><span class='Config constant id'>Config</span><span class='dot token'>.</span><span class='database_name identifier id'>database_name</span> <span class='assign token'>=</span> <span class='string val'>'name of the db'</span>
</pre>

<p>Alternatively you can download or clone the source repository and then require lib/couch_potato.rb. </p>

<h4>Using with Rails</h4>

<p>Add to your config/environment.rb:</p>

<pre class="code"><span class='config identifier id'>config</span><span class='dot token'>.</span><span class='gem identifier id'>gem</span> <span class='string val'>'langalex-couch_potato'</span><span class='comma token'>,</span> <span class='symbol val'>:lib</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'couch_potato'</span><span class='comma token'>,</span> <span class='symbol val'>:source</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'http://gems.github.com'</span>
</pre>

<p>Then create a config/couchdb.yml:</p>

<pre class="code"><span class='development identifier id'>development</span><span class='colon op'>:</span> <span class='development_db_name identifier id'>development_db_name</span>
<span class='test identifier id'>test</span><span class='colon op'>:</span> <span class='test_db_name identifier id'>test_db_name</span>
<span class='production identifier id'>production</span><span class='colon op'>:</span> <span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/db.server/</span><span class='production_db_name identifier id'>production_db_name</span>
</pre>

<p>Alternatively you can also install Couch Potato directly as a plugin. </p>

<h3>Introduction</h3>

<p>This is a basic tutorial on how to use Couch Potato. If you want to know all the details feel free to read the specs.</p>

<h4>Save, load objects</h4>

<p>First you need a class.</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
<span class='end end kw'>end</span>
</pre>

<p>To make instances of this class persistent include the persistence module:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='include identifier id'>include</span> <span class='CouchPotato constant id'>CouchPotato</span><span class='colon2 op'>::</span><span class='Persistence constant id'>Persistence</span>
<span class='end end kw'>end</span>
</pre>

<p>If you want to store any properties you have to declare them:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='include identifier id'>include</span> <span class='CouchPotato constant id'>CouchPotato</span><span class='colon2 op'>::</span><span class='Persistence constant id'>Persistence</span>

  <span class='property identifier id'>property</span> <span class='symbol val'>:name</span>
<span class='end end kw'>end</span>
</pre>

<p>Properties can be of any type:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='include identifier id'>include</span> <span class='CouchPotato constant id'>CouchPotato</span><span class='colon2 op'>::</span><span class='Persistence constant id'>Persistence</span>

  <span class='property identifier id'>property</span> <span class='symbol val'>:address</span><span class='comma token'>,</span> <span class='symbol val'>:type</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Address constant id'>Address</span>
<span class='end end kw'>end</span>
</pre>

<p>Now you can save your objects. All database operations are encapsulated in the CouchPotato::Database class. This separates your domain logic from the database access logic which makes it easier to write tests and also keeps you models smaller and cleaner.</p>

<pre class="code"><span class='user identifier id'>user</span> <span class='assign token'>=</span> <span class='User constant id'>User</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'joe'</span>
<span class='CouchPotato constant id'>CouchPotato</span><span class='dot token'>.</span><span class='database identifier id'>database</span><span class='dot token'>.</span><span class='save_document identifier id'>save_document</span> <span class='user identifier id'>user</span> <span class='comment val'># or save_document!</span>
</pre>

<p>You can of course also retrieve your instance:</p>

<pre class="code"><span class='CouchPotato constant id'>CouchPotato</span><span class='dot token'>.</span><span class='database identifier id'>database</span><span class='dot token'>.</span><span class='load_document identifier id'>load_document</span> <span class='string val'>&quot;id_of_the_user_document&quot;</span> <span class='comment val'># =&gt; &lt;#User 0x3075&gt;</span>
</pre>

<h4>Properties</h4>

<p>You can access the properties you declared above through normal attribute accessors.</p>

<pre class="code"><span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='comment val'># =&gt; 'joe'</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='assign token'>=</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='geq op'>&gt;=</span><span class='bitand op'>&amp;</span><span class='gt identifier id'>gt</span><span class='semicolon token'>;</span> <span class='lbrack token'>[</span><span class='string val'>'joe'</span><span class='comma token'>,</span> <span class='string val'>'joey'</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:last</span> <span class='assign token'>=</span><span class='bitand op'>&amp;</span><span class='gt identifier id'>gt</span><span class='semicolon token'>;</span> <span class='string val'>'doe'</span><span class='comma token'>,</span> <span class='symbol val'>:middle</span> <span class='assign token'>=</span><span class='bitand op'>&amp;</span><span class='gt identifier id'>gt</span><span class='semicolon token'>;</span> <span class='string val'>'J'</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt; # you can set any ruby object that responds_to :to_json (includes all core objects)
user._id # =&gt; &quot;02097f33a0046123f1ebc0ebb6937269&quot;
user._rev # =&gt; &quot;2769180384&quot;
user.created_at # =&gt; Fri Oct 24 19:05:54 +0200 2008
user.updated_at # =&gt; Fri Oct 24 19:05:54 +0200 2008
user.new? # =&gt; false
</span></pre>

<p>If you want to have properties that don't map to any JSON type, i.e. other than String, Number, Boolean, Hash or Array you have to define the type like this:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='property identifier id'>property</span> <span class='symbol val'>:date_of_birth</span><span class='comma token'>,</span> <span class='symbol val'>:type</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Date constant id'>Date</span>
<span class='end end kw'>end</span>
</pre>

<p>The date_of_birth property is now automatically serialized to JSON and back when storing/retrieving objects.</p>

<h4>Dirty tracking</h4>

<p>CouchPotato tracks the dirty state of attributes in the same way ActiveRecord does:</p>

<pre class="code"><span class='user identifier id'>user</span> <span class='assign token'>=</span> <span class='User constant id'>User</span><span class='dot token'>.</span><span class='create identifier id'>create</span> <span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'joe'</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='comment val'># =&gt; 'joe'</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name_changed? fid id'>name_changed?</span> <span class='comment val'># =&gt; false</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name_was identifier id'>name_was</span> <span class='comment val'># =&gt; nil</span>
</pre>

<p>You can also force a dirty state:</p>

<pre class="code"><span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name identifier id'>name</span> <span class='assign token'>=</span> <span class='string val'>'jane'</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name_changed? fid id'>name_changed?</span> <span class='comment val'># =&gt; true</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name_not_changed identifier id'>name_not_changed</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='name_changed? fid id'>name_changed?</span> <span class='comment val'># =&gt; false</span>
<span class='CouchPotato constant id'>CouchPotato</span><span class='dot token'>.</span><span class='database identifier id'>database</span><span class='dot token'>.</span><span class='save_document identifier id'>save_document</span> <span class='user identifier id'>user</span> <span class='comment val'># does nothing as no attributes are dirty</span>
</pre>

<h4>Object validations</h4>

<p>Couch Potato uses the validatable library for vaidation (http://validatable.rubyforge.org/)\</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='property identifier id'>property</span> <span class='symbol val'>:name</span>
  <span class='validates_presence_of identifier id'>validates_presence_of</span> <span class='symbol val'>:name</span>
<span class='end end kw'>end</span>

<span class='user identifier id'>user</span> <span class='assign token'>=</span> <span class='User constant id'>User</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='valid? fid id'>valid?</span> <span class='comment val'># =&gt; false</span>
<span class='user identifier id'>user</span><span class='dot token'>.</span><span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='on identifier id'>on</span><span class='lparen token'>(</span><span class='symbol val'>:name</span><span class='rparen token'>)</span> <span class='comment val'># =&gt; [:name, 'can't be blank']</span>
</pre>

<h4>Finding stuff</h4>

<p>In order to find data in your CouchDB you have to create a view first. Couch Potato offers you to create and manage those views for you. All you have to do is declare them in your classes:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='include identifier id'>include</span> <span class='CouchPotato constant id'>CouchPotato</span><span class='colon2 op'>::</span><span class='Persistence constant id'>Persistence</span>
  <span class='property identifier id'>property</span> <span class='symbol val'>:name</span>

  <span class='view identifier id'>view</span> <span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:created_at</span>
<span class='end end kw'>end</span>
</pre>

<p>This will create a view called "all" in the "user" design document with a map function that emits "created_at" for every user document.</p>

<pre class="code"><span class='CouchPotato constant id'>CouchPotato</span><span class='dot token'>.</span><span class='database identifier id'>database</span><span class='dot token'>.</span><span class='view identifier id'>view</span> <span class='User constant id'>User</span><span class='dot token'>.</span><span class='all identifier id'>all</span>
</pre>

<p>This will load all user documents in your database sorted by created_at.</p>

<pre class="code"><span class='CouchPotato constant id'>CouchPotato</span><span class='dot token'>.</span><span class='database identifier id'>database</span><span class='dot token'>.</span><span class='view identifier id'>view</span> <span class='User constant id'>User</span><span class='dot token'>.</span><span class='all identifier id'>all</span><span class='lparen token'>(</span><span class='symbol val'>:key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lparen token'>(</span><span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='minus op'>-</span> <span class='integer val'>10</span><span class='rparen token'>)</span><span class='dot2 op'>..</span><span class='lparen token'>(</span><span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='symbol val'>:descending</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
</pre>

<p>Any options you pass in will be passed onto CouchDB.</p>

<p>Composite keys are also possible:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='property identifier id'>property</span> <span class='symbol val'>:name</span>

  <span class='view identifier id'>view</span> <span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:created_at</span><span class='comma token'>,</span> <span class='symbol val'>:name</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>

<p>The creation of views is based on view specification classes (see the CouchPotato::View) module. The above code used the ModelViewSpec class which is used to the simple find model by property searches. For more sophisticated searches you can use other view specifications (either use the built-in or provide your own) by passing a type parameter:</p>

<p>If you have larger structures and you only want to load some attributes you can customize the view you can use the PropertiesViewSpec (the full class name is automatically derived):</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='property identifier id'>property</span> <span class='symbol val'>:name</span>
  <span class='property identifier id'>property</span> <span class='symbol val'>:bio</span>

  <span class='view identifier id'>view</span> <span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:created_at</span><span class='comma token'>,</span> <span class='symbol val'>:properties</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:type</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:properties</span>
<span class='end end kw'>end</span>
</pre>

<p>CouchPotato.database.view(User.everyone).first.name # => "joe"
  CouchPotato.database.view(User.everyone).first.bio # => nil</p>

<p>You can also pass in custom map/reduce functions with the custom view spec:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='view identifier id'>view</span> <span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:map</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;function(doc) { emit(doc.created_at, null)}&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:include_docs</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='comma token'>,</span> <span class='symbol val'>:type</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:custom</span>
<span class='end end kw'>end</span>
</pre>

<p>If you don't want the results to be converted into models the raw view is your friend:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='view identifier id'>view</span> <span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:map</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;function(doc) { emit(doc.created_at, doc.name)}&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:type</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:raw</span>
<span class='end end kw'>end</span>
</pre>

<p>When querying this view you will get the raw data returned by CouchDB which looks something like this: <tt>2, 'rows': [{'value': 'alex', 'key': '2009-01-03 00:02:34 +000', 'id': '75976rgi7546gi02a'</tt>]}</p>

<p>To process this raw data you can also pass in a results filter:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='view identifier id'>view</span> <span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:map</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;function(doc) { emit(doc.created_at, doc.name)}&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:type</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:raw</span><span class='comma token'>,</span> <span class='symbol val'>:results_filter</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lambda identifier id'>lambda</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='results identifier id'>results</span><span class='lbrack token'>[</span><span class='string val'>'rows'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='row identifier id'>row</span><span class='bitor op'>|</span> <span class='row identifier id'>row</span><span class='lbrack token'>[</span><span class='string val'>'value'</span><span class='rbrack token'>]</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;}
end
</span></pre>

<p>In this case querying the view would only return the emitted value for each row.</p>

<h4>Associations</h4>

<p>Not supported. Not sure if they ever will be. You can implement those yourself using views and custom methods on your models.</p>

<h4>Callbacks</h4>

<p>Couch Potato supports the usual lifecycle callbacks known from ActiveRecord:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='include identifier id'>include</span> <span class='CouchPotato constant id'>CouchPotato</span><span class='colon2 op'>::</span><span class='Persistence constant id'>Persistence</span>

  <span class='before_create identifier id'>before_create</span> <span class='symbol val'>:do_something_before_create</span>
  <span class='before_update identifier id'>before_update</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='db identifier id'>db</span><span class='bitor op'>|</span> <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='do_something_on_update identifier id'>do_something_on_update</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;
end
</span></pre>

<p>This will call the method do<em>something</em>before_create before creating an object and run the given lambda before updating one. Lambda callbacks get passed the model as their first argument. Optionally if a lambda declares two arguments it also gets passed the database object. This is useful for creating other objects or querying views. Method callbacks don't receive any arguments by default but will get passed the database if they declare an argument.</p>

<p>Supported callbacks are: :before<em>validation</em>on<em>create, :before</em>validation<em>on_update, :before</em>validation<em>on_save, :before</em>create, :after<em>create, :before</em>update, :after<em>update, :before</em>save, :after<em>save, :before</em>destroy, :after_destroy.</p>

<h4>Testing</h4>

<p>To make testing easier and faster database logic has been put into its own class, which you can replace and stub out in whatever way you want:</p>

<pre class="code"><span class='class class kw'>class</span> <span class='User constant id'>User</span>
  <span class='include identifier id'>include</span> <span class='CouchPotato constant id'>CouchPotato</span><span class='colon2 op'>::</span><span class='Persistence constant id'>Persistence</span>
<span class='end end kw'>end</span>

<span class='comment val'># RSpec</span>
<span class='describe identifier id'>describe</span> <span class='string val'>'save a user'</span> <span class='do do kw'>do</span>
  <span class='it identifier id'>it</span> <span class='string val'>'should save'</span> <span class='do do kw'>do</span>
    <span class='couchrest_db identifier id'>couchrest_db</span> <span class='assign token'>=</span> <span class='stub identifier id'>stub</span> <span class='string val'>'couchrest_db'</span><span class='comma token'>,</span> 
    <span class='database identifier id'>database</span> <span class='assign token'>=</span> <span class='CouchPotato constant id'>CouchPotato</span><span class='colon2 op'>::</span><span class='Database constant id'>Database</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='couchrest_db identifier id'>couchrest_db</span>
    <span class='user identifier id'>user</span> <span class='assign token'>=</span> <span class='User constant id'>User</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
    <span class='couchrest_db identifier id'>couchrest_db</span><span class='dot token'>.</span><span class='should_receive identifier id'>should_receive</span><span class='lparen token'>(</span><span class='symbol val'>:save_doc</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='with identifier id'>with</span><span class='lparen token'>(</span><span class='dot3 op'>...</span><span class='rparen token'>)</span>
    <span class='database identifier id'>database</span><span class='dot token'>.</span><span class='save_document identifier id'>save_document</span> <span class='user identifier id'>user</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>

<p>By creating you own instances of CouchPotato::Database and passing them a fake CouchRest database instance you can completely disconnect your unit tests/spec from the database.</p>

<h3>Helping out</h3>

<p>Please fix bugs, add more specs, implement new features by forking the github repo at http://github.com/langalex/couch_potato.</p>

<p>You can run all the specs by calling 'rake spec<em>unit' and 'rake spec</em>functional' in the root folder of Couch Potato. The specs require a running CouchDB instance at http://localhost:5984</p>

<p>I will only accept patches that are covered by specs - sorry.</p>

<h3>Contact</h3>

<p>If you have any questions/suggestions etc. please contact me at alex at upstream-berlin.com or @langalex on twitter.</p>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
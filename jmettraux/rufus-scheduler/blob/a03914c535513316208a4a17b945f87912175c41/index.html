<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>jmettraux's rufus-scheduler - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/jmettraux/commits/rufus-scheduler/master" rel="alternate" title="Recent Commits to rufus-scheduler:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("jmettraux", "rufus-scheduler", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='jmettraux/rufus-scheduler/blob/a03914c535513316208a4a17b945f87912175c41' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='jmettraux/rufus-scheduler/blob/a03914c535513316208a4a17b945f87912175c41' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("jmettraux", "rufus-scheduler", "a03914c535513316208a4a17b945f87912175c41", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/jmettraux/rufus-scheduler/tree/">Source</a></li>
            <li class=""><a href="http://github.com/jmettraux/rufus-scheduler/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/jmettraux/rufus-scheduler/network">Network</a></li>            
            <li class=""><a href="http://github.com/jmettraux/rufus-scheduler/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/jmettraux/rufus-scheduler">Wiki</a></li>
            <li class=""><a href="http://github.com/jmettraux/rufus-scheduler/graphs">Graphs</a></li>                    
            <li class="active"><a href="/jmettraux/rufus-scheduler">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/jmettraux">jmettraux</a> / <b><a href="http://github.com/jmettraux/rufus-scheduler/tree">rufus-scheduler</a></b>        
                <a id="namespaces_button" rel="jmettraux/rufus-scheduler/blob/a03914c535513316208a4a17b945f87912175c41" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="jmettraux/rufus-scheduler/blob/a03914c535513316208a4a17b945f87912175c41" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>rufus-scheduler</h1>
<p>
rufus-scheduler is a Ruby gem for scheduling pieces of code (jobs). It
understands running a job AT a certain time, IN a certain time, EVERY x
time or simply via a CRON statement.
</p>
<p>
rufus-scheduler is no replacement for cron/at since it runs inside of Ruby.
</p>
<h2>alternatives / complements</h2>
<p>
A list of related Ruby projects :
</p>
<p>
http://github.com/javan/whenever http://github.com/yakischloba/em-timers/
</p>
<p>
More like complements :
</p>
<p>
http://github.com/mojombo/chronic/
http://github.com/hpoydar/chronic_duration
</p>
<h2>installation</h2>
<pre class="code">
  <span class='sudo identifier id'>sudo</span> <span class='gem identifier id'>gem</span> <span class='install identifier id'>install</span> <span class='rufus identifier id'>rufus</span><span class='minus op'>-</span><span class='scheduler identifier id'>scheduler</span>
</pre>
<h2>usage</h2>
<p>
The usage is similar to the one of the old rufus-scheduler. There are a few
differences though.
</p>
<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'rubygems'</span>
  <span class='require identifier id'>require</span> <span class='string val'>'rufus/scheduler'</span>

  <span class='scheduler identifier id'>scheduler</span> <span class='assign token'>=</span> <span class='Rufus constant id'>Rufus</span><span class='colon2 op'>::</span><span class='Scheduler constant id'>Scheduler</span><span class='dot token'>.</span><span class='start_new identifier id'>start_new</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='in identifier id'>in</span> <span class='string val'>'20m'</span> <span class='do do kw'>do</span>
    <span class='puts identifier id'>puts</span> <span class='string val'>&quot;order ristretto&quot;</span>
  <span class='end end kw'>end</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='at identifier id'>at</span> <span class='string val'>'Thu Mar 26 07:31:43 +0900 2009'</span> <span class='do do kw'>do</span>
    <span class='puts identifier id'>puts</span> <span class='string val'>'order pizza'</span>
  <span class='end end kw'>end</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='cron identifier id'>cron</span> <span class='string val'>'0 22 * * 1-5'</span> <span class='do do kw'>do</span>
    <span class='comment val'># every day of the week at 00:22</span>
    <span class='puts identifier id'>puts</span> <span class='string val'>'activate security system'</span>
  <span class='end end kw'>end</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'5m'</span> <span class='do do kw'>do</span>
    <span class='puts identifier id'>puts</span> <span class='string val'>'check blood pressure'</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># ...</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='stop identifier id'>stop</span>
</pre>
<p>
This code summons a plain version of the scheduler, this can be made more
explicit via :
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span> <span class='assign token'>=</span> <span class='Rufus constant id'>Rufus</span><span class='colon2 op'>::</span><span class='Scheduler constant id'>Scheduler</span><span class='colon2 op'>::</span><span class='PlainScheduler constant id'>PlainScheduler</span><span class='dot token'>.</span><span class='start_new identifier id'>start_new</span>
</pre>
<p>
This PlainScheduler accepts a :thread_name option :
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span> <span class='assign token'>=</span> <span class='Rufus constant id'>Rufus</span><span class='colon2 op'>::</span><span class='Scheduler constant id'>Scheduler</span><span class='colon2 op'>::</span><span class='PlainScheduler constant id'>PlainScheduler</span><span class='dot token'>.</span><span class='start_new identifier id'>start_new</span><span class='lparen token'>(</span><span class='symbol val'>:thread_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'my scheduler'</span><span class='rparen token'>)</span>
</pre>
<p>
might be helpful when tracking threads.
</p>
<p>
Note that is there is EventMachine present and running,
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span> <span class='assign token'>=</span> <span class='Rufus constant id'>Rufus</span><span class='colon2 op'>::</span><span class='Scheduler constant id'>Scheduler</span><span class='dot token'>.</span><span class='start_new identifier id'>start_new</span>
</pre>
<p>
will return an instance of Rufus::Scheduler::EmScheduler (leveraging
EventMachine).
</p>
<h2>block parameters</h2>
<p>
Scheduled blocks accept 0 or 1 parameter (this unique parameter is the job
instance itself).
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'5m'</span> <span class='do do kw'>do</span>
    <span class='puts identifier id'>puts</span> <span class='string val'>'check blood pressure'</span>
  <span class='end end kw'>end</span>
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'1y'</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='job identifier id'>job</span><span class='bitor op'>|</span>
    <span class='puts identifier id'>puts</span> <span class='dstring node'>&quot;check cholesterol levels (#{job.job_id})&quot;</span>
  <span class='end end kw'>end</span>
</pre>
<p>
See the class Job for more details :
</p>
<p>
http://rufus.rubyforge.org/rufus-scheduler/classes/Rufus/Scheduler/Job.html
</p>
<h2>the time strings understood by rufus-scheduler</h2>
<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'rubygems'</span>
  <span class='require identifier id'>require</span> <span class='string val'>'rufus/scheduler'</span>

  <span class='p identifier id'>p</span> <span class='Rufus constant id'>Rufus</span><span class='dot token'>.</span><span class='parse_time_string identifier id'>parse_time_string</span> <span class='string val'>'500'</span>      <span class='comment val'># =&gt; 0.5</span>
  <span class='p identifier id'>p</span> <span class='Rufus constant id'>Rufus</span><span class='dot token'>.</span><span class='parse_time_string identifier id'>parse_time_string</span> <span class='string val'>'1000'</span>     <span class='comment val'># =&gt; 1.0</span>
  <span class='p identifier id'>p</span> <span class='Rufus constant id'>Rufus</span><span class='dot token'>.</span><span class='parse_time_string identifier id'>parse_time_string</span> <span class='string val'>'1h'</span>       <span class='comment val'># =&gt; 3600.0</span>
  <span class='p identifier id'>p</span> <span class='Rufus constant id'>Rufus</span><span class='dot token'>.</span><span class='parse_time_string identifier id'>parse_time_string</span> <span class='string val'>'1h10s'</span>    <span class='comment val'># =&gt; 3610.0</span>
  <span class='p identifier id'>p</span> <span class='Rufus constant id'>Rufus</span><span class='dot token'>.</span><span class='parse_time_string identifier id'>parse_time_string</span> <span class='string val'>'1w2d'</span>     <span class='comment val'># =&gt; 777600.0</span>

  <span class='p identifier id'>p</span> <span class='Rufus constant id'>Rufus</span><span class='dot token'>.</span><span class='to_time_string identifier id'>to_time_string</span> <span class='integer val'>60</span>              <span class='comment val'># =&gt; &quot;1m&quot;</span>
  <span class='p identifier id'>p</span> <span class='Rufus constant id'>Rufus</span><span class='dot token'>.</span><span class='to_time_string identifier id'>to_time_string</span> <span class='integer val'>3661</span>            <span class='comment val'># =&gt; &quot;1h1m1s&quot;</span>
  <span class='p identifier id'>p</span> <span class='Rufus constant id'>Rufus</span><span class='dot token'>.</span><span class='to_time_string identifier id'>to_time_string</span> <span class='integer val'>7</span> <span class='mult op'>*</span> <span class='integer val'>24</span> <span class='mult op'>*</span> <span class='integer val'>3600</span>   <span class='comment val'># =&gt; &quot;1w&quot;</span>
</pre>
<h2>:blocking</h2>
<p>
Jobs will, by default, trigger in their own thread. This is usually
desirable since one expects the scheduler to continue scheduling even if a
job is currently running.
</p>
<p>
Jobs scheduled with the :blocking parameter will run in the thread of the
scheduler, blocking it.
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='in identifier id'>in</span> <span class='string val'>'20m'</span><span class='comma token'>,</span> <span class='symbol val'>:blocking</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span> <span class='do do kw'>do</span>
    <span class='puts identifier id'>puts</span> <span class='string val'>&quot;order ristretto&quot;</span>
    <span class='sleep identifier id'>sleep</span> <span class='integer val'>2</span> <span class='mult op'>*</span> <span class='integer val'>60</span>
  <span class='end end kw'>end</span>
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='in identifier id'>in</span> <span class='string val'>'21m'</span> <span class='do do kw'>do</span>
    <span class='puts identifier id'>puts</span> <span class='string val'>&quot;order espresso&quot;</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Hence, our espresso wil come in 22 minutes instead of 21.
</p>
<h2>&#8216;every&#8217; jobs and :first_at / :first_in</h2>
<p>
This job will execute every 3 days, but first time will be in 5 days from
now :
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'3d'</span><span class='comma token'>,</span> <span class='symbol val'>:first_in</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'5d'</span> <span class='do do kw'>do</span>
    <span class='comment val'># do something</span>
  <span class='end end kw'>end</span>
</pre>
<p>
This job will execute every 3 days, starting from Christmas Eve at noon :
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'3d'</span><span class='comma token'>,</span> <span class='symbol val'>:first_at</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'2009/12/24 12:00'</span> <span class='do do kw'>do</span>
    <span class='comment val'># do something</span>
  <span class='end end kw'>end</span>
</pre>
<p>
The chronic gem may help (http://chronic.rubyforge.org/) :
</p>
<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'chronic'</span> <span class='comment val'># sudo gem install chronic</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'3h'</span><span class='comma token'>,</span> <span class='symbol val'>:first_at</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Chronic constant id'>Chronic</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='string val'>'this tuesday 5:00'</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='comment val'># do something starting this tueday</span>
  <span class='end end kw'>end</span>
</pre>
<h2>self unschedule for &#8216;cron&#8217; and &#8216;every&#8217; jobs</h2>
<p>
&#8216;at&#8217; and &#8216;in&#8217; jobs fire once only.
&#8216;cron&#8217; and &#8216;every&#8217; jobs do fire repeatedly, so it
might be useful to stop them.
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'3d'</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='job identifier id'>job</span><span class='bitor op'>|</span>
    <span class='l identifier id'>l</span> <span class='assign token'>=</span> <span class='determine_crop_maturity_level identifier id'>determine_crop_maturity_level</span><span class='lparen token'>(</span><span class='rparen token'>)</span>
    <span class='if if kw'>if</span> <span class='l identifier id'>l</span> <span class='geq op'>&gt;=</span> <span class='integer val'>7</span>
      <span class='puts identifier id'>puts</span> <span class='string val'>&quot;crop is ready.&quot;</span>
      <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='unschedule identifier id'>unschedule</span>
    <span class='else else kw'>else</span>
      <span class='puts identifier id'>puts</span> <span class='string val'>&quot;crop not yet ready...&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
In this example, the &#8216;every&#8217; job will unschedule itself when
the crop is ready.
</p>
<h2>schedulables</h2>
<p>
Sometimes passing a block isn&#8217;t that convenient :
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='JobThing constant id'>JobThing</span>
    <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span> <span class='lparen token'>(</span><span class='relevant_info identifier id'>relevant_info</span><span class='rparen token'>)</span>
      <span class='@ri ivar id'>@ri</span> <span class='assign token'>=</span> <span class='relevant_info identifier id'>relevant_info</span>
    <span class='end end kw'>end</span>
    <span class='def def kw'>def</span> <span class='call identifier id'>call</span> <span class='lparen token'>(</span><span class='job identifier id'>job</span><span class='rparen token'>)</span>
      <span class='do_something_about_it identifier id'>do_something_about_it</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># ...</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='in identifier id'>in</span> <span class='string val'>'3d'</span><span class='comma token'>,</span> <span class='JobThing constant id'>JobThing</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>'http://news.example.com/data_xyz'</span><span class='rparen token'>)</span>
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='in identifier id'>in</span> <span class='string val'>'1w'</span><span class='comma token'>,</span> <span class='JobThing constant id'>JobThing</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>'http://news.example.com/data_abc'</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='symbol val'>:timeout</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'1d'</span>
</pre>
<p>
rufus-scheduler accepts anything that responds to a call method with a
unique parameter (it will pass the job) as a &#8216;schedulable&#8217;.
</p>
<h2>looking up jobs</h2>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='jobs identifier id'>jobs</span>
    <span class='comment val'># returns a map job_id =&gt; job of at/in/every jobs</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='cron_jobs identifier id'>cron_jobs</span>
    <span class='comment val'># idem for cron jobs</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='all_jobs identifier id'>all_jobs</span>
    <span class='comment val'># idem but for every/at/in/cron jobs (all of them)</span>

  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='find_by_tag identifier id'>find_by_tag</span><span class='lparen token'>(</span><span class='t identifier id'>t</span><span class='rparen token'>)</span>
    <span class='comment val'># returns all the jobs with a given tag (passed at schedule time with :tags)</span>
</pre>
<h2>unscheduling jobs</h2>
<p>
The &#8216;scheduling&#8217; methods always return an instance of
Rufus::Scheduler::Job. This object can be used for unscheduling :
</p>
<pre class="code">
  <span class='job identifier id'>job</span> <span class='assign token'>=</span> <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='in identifier id'>in</span> <span class='string val'>'2d'</span><span class='comma token'>,</span> <span class='symbol val'>:tags</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'admin'</span> <span class='do do kw'>do</span>
    <span class='run_backlog_cleaning identifier id'>run_backlog_cleaning</span><span class='lparen token'>(</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># later ...</span>

  <span class='job identifier id'>job</span><span class='dot token'>.</span><span class='unschedule identifier id'>unschedule</span>
    <span class='comment val'># or</span>
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='unschedule identifier id'>unschedule</span><span class='lparen token'>(</span><span class='job identifier id'>job</span><span class='dot token'>.</span><span class='job_id identifier id'>job_id</span><span class='rparen token'>)</span>
</pre>
<h2>tags</h2>
<p>
You can specify tags at schedule time :
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='in identifier id'>in</span> <span class='string val'>'2d'</span><span class='comma token'>,</span> <span class='symbol val'>:tags</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'admin'</span> <span class='do do kw'>do</span>
    <span class='run_backlog_cleaning identifier id'>run_backlog_cleaning</span><span class='lparen token'>(</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'3m'</span><span class='comma token'>,</span> <span class='symbol val'>:tags</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'production'</span> <span class='do do kw'>do</span>
    <span class='check_order_log identifier id'>check_order_log</span><span class='lparen token'>(</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
</pre>
<p>
And later query the scheduler for those jobs :
</p>
<pre class="code">
  <span class='admin_jobs identifier id'>admin_jobs</span> <span class='assign token'>=</span> <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='find_by_tag identifier id'>find_by_tag</span><span class='lparen token'>(</span><span class='string val'>'admin'</span><span class='rparen token'>)</span>
  <span class='production_jobs identifier id'>production_jobs</span> <span class='assign token'>=</span> <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='find_by_tag identifier id'>find_by_tag</span><span class='lparen token'>(</span><span class='string val'>'production'</span><span class='rparen token'>)</span>
</pre>
<h2>timeout</h2>
<p>
One can specify a timeout for the triggering of a job.
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='every identifier id'>every</span> <span class='string val'>'2d'</span><span class='comma token'>,</span> <span class='symbol val'>:timeout</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'40m'</span> <span class='do do kw'>do</span>
    <span class='begin begin kw'>begin</span>
      <span class='run_backlog_cleaning identifier id'>run_backlog_cleaning</span><span class='lparen token'>(</span><span class='rparen token'>)</span>
    <span class='rescue rescue kw'>rescue</span> <span class='Rufus constant id'>Rufus</span><span class='colon2 op'>::</span><span class='Scheduler constant id'>Scheduler</span><span class='colon2 op'>::</span><span class='TimeOutError constant id'>TimeOutError</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='toe identifier id'>toe</span>
      <span class='comment val'># timeout occurred</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
This job will run every two days. If a run takes more than 40 minutes it
will timeout (its thread will receive a TimeOutError).
</p>
<p>
This timeout feature relies on an &#8216;in&#8217; job scheduled at the
moment the main job gets triggered, hence the &#8216;40m&#8217; time string
format.
</p>
<h2>exceptions in jobs</h2>
<p>
By default, when exception occur when a job performs, the error message
will be output to the STDOUT.
</p>
<p>
It&#8217;s easy to customize that behaviour :
</p>
<pre class="code">
  <span class='scheduler identifier id'>scheduler</span> <span class='assign token'>=</span> <span class='Rufus constant id'>Rufus</span><span class='colon2 op'>::</span><span class='Scheduler constant id'>Scheduler</span><span class='colon2 op'>::</span><span class='PlainScheduler constant id'>PlainScheduler</span><span class='dot token'>.</span><span class='start_new identifier id'>start_new</span>
    <span class='comment val'># or</span>
  <span class='comment val'>#scheduler = Rufus::Scheduler::EmScheduler.start_new</span>

  <span class='def def kw'>def</span> <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='handle_exception identifier id'>handle_exception</span> <span class='lparen token'>(</span><span class='job identifier id'>job</span><span class='comma token'>,</span> <span class='exception identifier id'>exception</span><span class='rparen token'>)</span>
    <span class='puts identifier id'>puts</span> <span class='dstring node'>&quot;job #{job.job_id} caught exception '#{exception}'&quot;</span>
  <span class='end end kw'>end</span>
</pre>
<p>
For backward compatibility, overriding #log_exception is still OK :
</p>
<pre class="code">
  <span class='def def kw'>def</span> <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='log_exception identifier id'>log_exception</span> <span class='lparen token'>(</span><span class='exception identifier id'>exception</span><span class='rparen token'>)</span>
    <span class='puts identifier id'>puts</span> <span class='dstring node'>&quot;caught exception '#{exception}'&quot;</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Note that an every job or a cron job will stay scheduled even if it
experiences an exception.
</p>
<h2>frequency</h2>
<p>
The default frequency for the scheduler is 0.330 seconds. This means that
the usual scheduler implementation will wake up, trigger jobs that are to
be triggered and then go back to sleep for 0.330 seconds. Note that this
doesn&#8217;t mean that the scheduler will wake up very 0.330 seconds
(checking and triggering do take time).
</p>
<p>
You can set a different frequency when starting / initializing the
scheduler :
</p>
<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'rubygems'</span>
  <span class='require identifier id'>require</span> <span class='string val'>'rufus/scheduler'</span>

  <span class='scheduler identifier id'>scheduler</span> <span class='assign token'>=</span> <span class='Rufus constant id'>Rufus</span><span class='colon2 op'>::</span><span class='Scheduler constant id'>Scheduler</span><span class='dot token'>.</span><span class='start_new identifier id'>start_new</span><span class='lparen token'>(</span><span class='symbol val'>:frequency</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='float val'>60.0</span><span class='rparen token'>)</span>
    <span class='comment val'># for a lazy scheduler that only wakes up every 60 seconds</span>
</pre>
<h2>usage with EventMachine</h2>
<p>
rufus-scheduler 2.0 can be used in conjunction with EventMachine
(http://github.com/eventmachine/eventmachine/).
</p>
<p>
More and more ruby applications are using EventMachine. This flavour of the
scheduler relies on EventMachine, thus it doesn&#8217;t require a separate
thread like the PlainScheduler does.
</p>
<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'rubygems'</span>
  <span class='require identifier id'>require</span> <span class='string val'>'eventmachine'</span>

  <span class='EM constant id'>EM</span><span class='dot token'>.</span><span class='run identifier id'>run</span> <span class='lbrace token'>{</span>

    <span class='scheduler identifier id'>scheduler</span> <span class='assign token'>=</span> <span class='Rufus constant id'>Rufus</span><span class='colon2 op'>::</span><span class='Scheduler constant id'>Scheduler</span><span class='colon2 op'>::</span><span class='EmScheduler constant id'>EmScheduler</span><span class='dot token'>.</span><span class='start_new identifier id'>start_new</span>

    <span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='in identifier id'>in</span> <span class='string val'>'20m'</span> <span class='do do kw'>do</span>
      <span class='puts identifier id'>puts</span> <span class='string val'>&quot;order ristretto&quot;</span>
    <span class='end end kw'>end</span>
  <span class='rbrace token'>}</span>
</pre>
<h2>tested with</h2>
<p>
ruby 1.8.6, ruby 1.9.1p0 on jruby 1.2.0 it has some tiny issues
(spec/blocking_spec.rb)
</p>
<h2>dependencies</h2>
<p>
the ruby gem &#8216;eventmachine&#8217; if you use
Rufus::Scheduler::EmScheduler, else no other dependencies.
</p>
<h2>mailing list</h2>
<p>
On the rufus-ruby list :
</p>
<p>
http://groups.google.com/group/rufus-ruby
</p>
<h2>issue tracker</h2>
<p>
http://rubyforge.org/tracker/?atid=18584&amp;group_id=4812&amp;func=browse
</p>
<h2>irc</h2>
<pre class="code">
  <span class='irc identifier id'>irc</span><span class='dot token'>.</span><span class='freenode identifier id'>freenode</span><span class='dot token'>.</span><span class='net identifier id'>net</span> <span class='comment val'>#ruote</span>
</pre>
<h2>source</h2>
<p>
http://github.com/jmettraux/rufus-scheduler
</p>
<pre class="code">
  <span class='git identifier id'>git</span> <span class='clone identifier id'>clone</span> <span class='git identifier id'>git</span><span class='symbol val'>:/</span><span class='regexp val'>/github.com/</span><span class='jmettraux identifier id'>jmettraux</span><span class='div op'>/</span><span class='rufus identifier id'>rufus</span><span class='minus op'>-</span><span class='scheduler identifier id'>scheduler</span><span class='dot token'>.</span><span class='git identifier id'>git</span>
</pre>
<h2>credits</h2>
<p>
http://github.com/jmettraux/rufus-scheduler/blob/master/CREDITS.txt
</p>
<h2>authors</h2>
<p>
John Mettraux, jmettraux@gmail.com, http://jmettraux.wordpress.com
</p>
<h2>the rest of Rufus</h2>
<p>
http://rufus.rubyforge.org
</p>
<h2>license</h2>
<p>
MIT
</p>

</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>georgepalmer's couch_foo - Module: CouchFoo::Associations::ClassMethods - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/georgepalmer/commits/couch_foo/master" rel="alternate" title="Recent Commits to couch_foo:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("georgepalmer", "couch_foo", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("georgepalmer", "couch_foo", "13a37f5c452f8ebacb4a9caf0e225911cface3a6", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/tree/">Source</a></li>
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/network">Network</a></li>            
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/georgepalmer/couch_foo">Wiki</a></li>
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/graphs">Graphs</a></li>                    
            <li class="active"><a href="/georgepalmer/couch_foo">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/georgepalmer">georgepalmer</a> / <b><a href="http://github.com/georgepalmer/couch_foo/tree">couch_foo</a></b>        
                <a id="namespaces_button" rel="georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section module CouchFoo_Associations_ClassMethods">
  <h1>Module: CouchFoo::Associations::ClassMethods</h1>
  <div class="section docstring">
  <p>
Associations are a set of macro-like class methods for tying objects
together through foreign keys. They express relationships like
&quot;Project has one Project Manager&quot; or &quot;Project belongs to a
Portfolio&quot;. Each macro adds a number of methods to the class which are
specialized according to the collection or association symbol and the
options hash. It works much the same way as Ruby&#8217;s own <tt>attr*</tt>
methods. Example:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Project constant id'>Project</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='belongs_to identifier id'>belongs_to</span>              <span class='symbol val'>:portfolio</span>
    <span class='has_one identifier id'>has_one</span>                 <span class='symbol val'>:project_manager</span>
    <span class='has_many identifier id'>has_many</span>                <span class='symbol val'>:milestones</span>
    <span class='has_and_belongs_to_many identifier id'>has_and_belongs_to_many</span> <span class='symbol val'>:categories</span>
  <span class='end end kw'>end</span>
</pre>
<p>
The project class now has the following methods (and more) to ease the
traversal and manipulation of its relationships:
</p>
<ul>
<li><tt>Project#portfolio, Project#portfolio=(portfolio),
Project#portfolio.nil?</tt>

</li>
<li><tt>Project#project_manager, Project#project_manager=(project_manager),
Project#project_manager.nil?,</tt>

</li>
<li><tt>Project#milestones.empty?, Project#milestones.size, Project#milestones,
Project#milestones&lt;&lt;(milestone),</tt>
<tt>Project#milestones.delete(milestone),
Project#milestones.find(milestone_id), Project#milestones.find(:all,
options),</tt> <tt>Project#milestones.build, Project#milestones.create</tt>

</li>
<li><tt>Project#categories.empty?, Project#categories.size, Project#categories,
Project#categories&lt;&lt;(category1),</tt>
<tt>Project#categories.delete(category1)</tt>

</li>
</ul>
<h3>Note</h3>
<p>
The current CouchFoo implementation does not include
has_and_belongs_to_many This will be added in a future release along with
an option for using has_many in an inline context, so all the associated
documents are stored in the parent itself rather than in separate records.
</p>
<h3>A word of warning</h3>
<p>
Don&#8217;t create associations that have the same name as instance methods
of CouchFoo::Base. Since the association adds a method with that name to
its model, it will override the inherited method and break things. For
instance, <tt>attributes</tt> and <tt>connection</tt> would be bad choices
for association names.
</p>
<h2>Auto-generated methods</h2>
<h3>Singular associations (one-to-one)</h3>
<pre class="code">
                                    <span class='bitor op'>|</span>            <span class='bitor op'>|</span>  <span class='belongs_to identifier id'>belongs_to</span>  <span class='bitor op'>|</span>
  <span class='generated identifier id'>generated</span> <span class='methods identifier id'>methods</span>                 <span class='bitor op'>|</span> <span class='belongs_to identifier id'>belongs_to</span> <span class='bitor op'>|</span> <span class='symbol val'>:polymorphic</span> <span class='bitor op'>|</span> <span class='has_one identifier id'>has_one</span>
  <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;--------------&lt;tt&gt;---------
  #other                            |     X      |      X       |    X
  #other=(other)                    |     X      |      X       |    X
  #build_other(attributes={})       |     X      |              |    X
  #create_other(attributes={})      |     X      |              |    X
  #other.create!(attributes={})     |            |              |    X
  #other.nil?                       |     X      |      X       |
</span></pre>
<h3>Collection associations (one-to-many / many-to-many)</h3>
<pre class="code">
                                    <span class='bitor op'>|</span>       <span class='bitor op'>|</span>          <span class='bitor op'>|</span> <span class='has_many identifier id'>has_many</span>
  <span class='generated identifier id'>generated</span> <span class='methods identifier id'>methods</span>                 <span class='bitor op'>|</span> <span class='habtm identifier id'>habtm</span> <span class='bitor op'>|</span> <span class='has_many identifier id'>has_many</span> <span class='bitor op'>|</span> <span class='symbol val'>:through</span>
  <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;-------&lt;tt&gt;----------&lt;/</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
  <span class='comment val'>#others                           |   X   |    X     |    X</span>
  <span class='comment val'>#others=(other,other,...)         |   X   |    X     |    X</span>
  <span class='comment val'>#other_ids                        |   X   |    X     |    X</span>
  <span class='comment val'>#other_ids=(id,id,...)            |   X   |    X     |    X</span>
  <span class='comment val'>#others&lt;&lt;                         |   X   |    X     |    X</span>
  <span class='comment val'>#others.push                      |   X   |    X     |    X</span>
  <span class='comment val'>#others.concat                    |   X   |    X     |    X</span>
  <span class='comment val'>#others.build(attributes={})      |   X   |    X     |    X</span>
  <span class='comment val'>#others.create(attributes={})     |   X   |    X     |    X</span>
  <span class='comment val'>#others.create!(attributes={})    |   X   |    X     |    X</span>
  <span class='comment val'>#others.size                      |   X   |    X     |    X</span>
  <span class='comment val'>#others.length                    |   X   |    X     |    X</span>
  <span class='comment val'>#others.count                     |   X   |    X     |    X</span>
  <span class='comment val'>#others.sum(args*,&amp;block)         |   X   |    X     |    X</span>
  <span class='comment val'>#others.empty?                    |   X   |    X     |    X</span>
  <span class='comment val'>#others.clear                     |   X   |    X     |    X</span>
  <span class='comment val'>#others.delete(other,other,...)   |   X   |    X     |    X</span>
  <span class='comment val'>#others.delete_all                |   X   |    X     |</span>
  <span class='comment val'>#others.destroy_all               |   X   |    X     |    X</span>
  <span class='comment val'>#others.find(*args)               |   X   |    X     |    X</span>
  <span class='comment val'>#others.find_first                |   X   |          |</span>
  <span class='comment val'>#others.uniq                      |   X   |    X     |    X</span>
  <span class='comment val'>#others.reset                     |   X   |    X     |    X</span>
</pre>
<h2>Cardinality and associations</h2>
<p>
Couch Foo associations can be used to describe one-to-one, one-to-many and
many-to-many relationships between models. Each model uses an association
to describe its role in the relation. The <tt>belongs_to</tt> association
is always used in the model that has the foreign key.
</p>
<h3>One-to-one</h3>
<p>
Use <tt>has_one</tt> in the base, and <tt>belongs_to</tt> in the associated
model.
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Employee constant id'>Employee</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='has_one identifier id'>has_one</span> <span class='symbol val'>:office</span>
  <span class='end end kw'>end</span>
  <span class='class class kw'>class</span> <span class='Office constant id'>Office</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:employee</span>    <span class='comment val'># foreign key - employee_id</span>
  <span class='end end kw'>end</span>
</pre>
<h3>One-to-many</h3>
<p>
Use <tt>has_many</tt> in the base, and <tt>belongs_to</tt> in the
associated model.
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Manager constant id'>Manager</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:employees</span>
  <span class='end end kw'>end</span>
  <span class='class class kw'>class</span> <span class='Employee constant id'>Employee</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:manager</span>     <span class='comment val'># foreign key - manager_id</span>
  <span class='end end kw'>end</span>
</pre>
<h3>Many-to-many</h3>
<p>
Not implement yet
</p>
<h2>Is it a <tt>belongs_to</tt> or <tt>has_one</tt> association?</h2>
<p>
Both express a 1-1 relationship. The difference is mostly where to place
the foreign key, which goes on the model for the class declaring the
<tt>belongs_to</tt> relationship. Example:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='User constant id'>User</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='comment val'># I reference an account.</span>
    <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:account</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='Account constant id'>Account</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='comment val'># One user references me.</span>
    <span class='has_one identifier id'>has_one</span> <span class='symbol val'>:user</span>
  <span class='end end kw'>end</span>
</pre>
<p>
The properties definitions for these classes could look something like:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='User constant id'>User</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:account_id</span><span class='comma token'>,</span> <span class='Integer constant id'>Integer</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:name</span><span class='comma token'>,</span> <span class='String constant id'>String</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='Account constant id'>Account</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:name</span><span class='comma token'>,</span> <span class='String constant id'>String</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Unsaved objects and associations</h2>
<p>
You can manipulate objects and associations before they are saved to the
database, but there is some special behavior you should be aware of, mostly
involving the saving of associated objects.
</p>
<h3>One-to-one associations</h3>
<ul>
<li>Assigning an object to a <tt>has_one</tt> association automatically saves
that object and the object being replaced (if there is one), in order to
update their primary keys - except if the parent object is unsaved
(<tt>new_record? == true</tt>).

</li>
<li>If either of these saves fail (due to one of the objects being invalid) the
assignment statement returns <tt>false</tt> and the assignment is
cancelled.

</li>
<li>If you wish to assign an object to a <tt>has_one</tt> association without
saving it, use the <tt>association.build</tt> method (documented below).

</li>
<li>Assigning an object to a <tt>belongs_to</tt> association does not save the
object, since the foreign key field belongs on the parent. It does not save
the parent either.

</li>
</ul>
<h3>Collections</h3>
<ul>
<li>Adding an object to a collection (<tt>has_many</tt> or
<tt>has_and_belongs_to_many</tt>) automatically saves that object, except
if the parent object (the owner of the collection) is not yet stored in the
database.

</li>
<li>If saving any of the objects being added to a collection (via <tt>push</tt>
or similar) fails, then <tt>push</tt> returns <tt>false</tt>.

</li>
<li>You can add an object to a collection without automatically saving it by
using the <tt>collection.build</tt> method (documented below).

</li>
<li>All unsaved (<tt>new_record? == true</tt>) members of the collection are
automatically saved when the parent is saved.

</li>
</ul>
<h3>Association callbacks</h3>
<p>
Similar to the normal callbacks that hook into the lifecycle of an Couch
Foo object, you can also define callbacks that get triggered when you add
an object to or remove an object from an association collection. Example:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Project constant id'>Project</span>
    <span class='has_and_belongs_to_many identifier id'>has_and_belongs_to_many</span> <span class='symbol val'>:developers</span><span class='comma token'>,</span> <span class='symbol val'>:after_add</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:evaluate_velocity</span>

    <span class='def def kw'>def</span> <span class='evaluate_velocity identifier id'>evaluate_velocity</span><span class='lparen token'>(</span><span class='developer identifier id'>developer</span><span class='rparen token'>)</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
It&#8217;s possible to stack callbacks by passing them as an array.
Example:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Project constant id'>Project</span>
    <span class='has_and_belongs_to_many identifier id'>has_and_belongs_to_many</span> <span class='symbol val'>:developers</span><span class='comma token'>,</span> <span class='symbol val'>:after_add</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:evaluate_velocity</span><span class='comma token'>,</span> <span class='Proc constant id'>Proc</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='comma token'>,</span> <span class='d identifier id'>d</span><span class='bitor op'>|</span> <span class='p identifier id'>p</span><span class='dot token'>.</span><span class='shipping_date identifier id'>shipping_date</span> <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='rbrace token'>}</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Possible callbacks are: <tt>before_add</tt>, <tt>after_add</tt>,
<tt>before_remove</tt> and <tt>after_remove</tt>.
</p>
<p>
Should any of the <tt>before_add</tt> callbacks throw an exception, the
object does not get added to the collection. Same with the
<tt>before_remove</tt> callbacks; if an exception is thrown the object
doesn&#8217;t get removed.
</p>
<h3>Association extensions</h3>
<p>
The proxy objects that control the access to associations can be extended
through anonymous modules. This is especially beneficial for adding new
finders, creators, and other factory-type methods that are only used as
part of this association. Example:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Account constant id'>Account</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:people</span> <span class='do do kw'>do</span>
      <span class='def def kw'>def</span> <span class='find_or_create_by_name identifier id'>find_or_create_by_name</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
        <span class='first_name identifier id'>first_name</span><span class='comma token'>,</span> <span class='last_name identifier id'>last_name</span> <span class='assign token'>=</span> <span class='name identifier id'>name</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>&quot; &quot;</span><span class='comma token'>,</span> <span class='integer val'>2</span><span class='rparen token'>)</span>
        <span class='find_or_create_by_first_name_and_last_name identifier id'>find_or_create_by_first_name_and_last_name</span><span class='lparen token'>(</span><span class='first_name identifier id'>first_name</span><span class='comma token'>,</span> <span class='last_name identifier id'>last_name</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='person identifier id'>person</span> <span class='assign token'>=</span> <span class='Account constant id'>Account</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:first</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='people identifier id'>people</span><span class='dot token'>.</span><span class='find_or_create_by_name identifier id'>find_or_create_by_name</span><span class='lparen token'>(</span><span class='string val'>&quot;David Heinemeier Hansson&quot;</span><span class='rparen token'>)</span>
  <span class='person identifier id'>person</span><span class='dot token'>.</span><span class='first_name identifier id'>first_name</span> <span class='comment val'># =&gt; &quot;David&quot;</span>
  <span class='person identifier id'>person</span><span class='dot token'>.</span><span class='last_name identifier id'>last_name</span>  <span class='comment val'># =&gt; &quot;Heinemeier Hansson&quot;</span>
</pre>
<p>
If you need to share the same extensions between many associations, you can
use a named extension module. Example:
</p>
<pre class="code">
  <span class='module module kw'>module</span> <span class='FindOrCreateByNameExtension constant id'>FindOrCreateByNameExtension</span>
    <span class='def def kw'>def</span> <span class='find_or_create_by_name identifier id'>find_or_create_by_name</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
      <span class='first_name identifier id'>first_name</span><span class='comma token'>,</span> <span class='last_name identifier id'>last_name</span> <span class='assign token'>=</span> <span class='name identifier id'>name</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>&quot; &quot;</span><span class='comma token'>,</span> <span class='integer val'>2</span><span class='rparen token'>)</span>
      <span class='find_or_create_by_first_name_and_last_name identifier id'>find_or_create_by_first_name_and_last_name</span><span class='lparen token'>(</span><span class='first_name identifier id'>first_name</span><span class='comma token'>,</span> <span class='last_name identifier id'>last_name</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='Account constant id'>Account</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:people</span><span class='comma token'>,</span> <span class='symbol val'>:extend</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='FindOrCreateByNameExtension constant id'>FindOrCreateByNameExtension</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='Company constant id'>Company</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:people</span><span class='comma token'>,</span> <span class='symbol val'>:extend</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='FindOrCreateByNameExtension constant id'>FindOrCreateByNameExtension</span>
  <span class='end end kw'>end</span>
</pre>
<p>
If you need to use multiple named extension modules, you can specify an
array of modules with the <tt>:extend</tt> option. In the case of name
conflicts between methods in the modules, methods in modules later in the
array supercede those earlier in the array. Example:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Account constant id'>Account</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:people</span><span class='comma token'>,</span> <span class='symbol val'>:extend</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='FindOrCreateByNameExtension constant id'>FindOrCreateByNameExtension</span><span class='comma token'>,</span> <span class='FindRecentExtension constant id'>FindRecentExtension</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Some extensions can only be made to work with knowledge of the association
proxy&#8217;s internals. Extensions can access relevant state using
accessors on the association proxy:
</p>
<ul>
<li><tt>proxy_owner</tt> - Returns the object the association is part of.

</li>
<li><tt>proxy_reflection</tt> - Returns the reflection object that describes
the association.

</li>
<li><tt>proxy_target</tt> - Returns the associated object for
<tt>belongs_to</tt> and <tt>has_one</tt>, or the collection of associated
objects for <tt>has_many</tt> and <tt>has_and_belongs_to_many</tt>.

</li>
</ul>
<h3>Association Join Models</h3>
<p>
This is not supported yet
</p>
<h3>Polymorphic Associations</h3>
<p>
Polymorphic associations on models are not restricted on what types of
models they can be associated with. Rather, they specify an interface that
a <tt>has_many</tt> association must adhere to.
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Asset constant id'>Asset</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:attachable</span><span class='comma token'>,</span> <span class='symbol val'>:polymorphic</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='Post constant id'>Post</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:assets</span><span class='comma token'>,</span> <span class='symbol val'>:as</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:attachable</span>         <span class='comment val'># The :as option specifies the polymorphic interface to use.</span>
  <span class='end end kw'>end</span>

  <span class='@asset ivar id'>@asset</span><span class='dot token'>.</span><span class='attachable identifier id'>attachable</span> <span class='assign token'>=</span> <span class='@post ivar id'>@post</span>
</pre>
<p>
This works by using a type property in addition to a foreign key to specify
the associated record. In the Asset example, you&#8217;d need an
<tt>attachable_id</tt> key attribute and an <tt>attachable_type</tt> string
attribute.
</p>
<p>
Using polymorphic associations in combination with inheritance is a little
tricky. In order for the associations to work as expected, ensure that you
store the base model in the type property of the polymorphic association.
To continue with the asset example above, suppose there are guest posts and
member posts that use inheritence. In this case, there must be a
<tt>type</tt> property in the Post model.
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Asset constant id'>Asset</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:attachable</span><span class='comma token'>,</span> <span class='symbol val'>:polymorphic</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>

    <span class='def def kw'>def</span> <span class='attachable_type= identifier id'>attachable_type=</span><span class='lparen token'>(</span><span class='sType identifier id'>sType</span><span class='rparen token'>)</span>
       <span class='super super kw'>super</span><span class='lparen token'>(</span><span class='sType identifier id'>sType</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='dot token'>.</span><span class='classify identifier id'>classify</span><span class='dot token'>.</span><span class='constantize identifier id'>constantize</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='Post constant id'>Post</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='comment val'># because we store &quot;Post&quot; in attachable_type now :dependent =&gt; :destroy will work</span>
    <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:assets</span><span class='comma token'>,</span> <span class='symbol val'>:as</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:attachable</span><span class='comma token'>,</span> <span class='symbol val'>:dependent</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:destroy</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='GuestPost constant id'>GuestPost</span> <span class='lt op'>&lt;</span> <span class='Post constant id'>Post</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='MemberPost constant id'>MemberPost</span> <span class='lt op'>&lt;</span> <span class='Post constant id'>Post</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Caching</h2>
<p>
All of the methods are built on a simple caching principle that will keep
the result of the last query around unless specifically instructed not to.
The cache is even shared across methods to make it even cheaper to use the
macro-added methods without worrying too much about performance at the
first go. Example:
</p>
<pre class="code">
  <span class='project identifier id'>project</span><span class='dot token'>.</span><span class='milestones identifier id'>milestones</span>             <span class='comment val'># fetches milestones from the database</span>
  <span class='project identifier id'>project</span><span class='dot token'>.</span><span class='milestones identifier id'>milestones</span><span class='dot token'>.</span><span class='size identifier id'>size</span>        <span class='comment val'># uses the milestone cache</span>
  <span class='project identifier id'>project</span><span class='dot token'>.</span><span class='milestones identifier id'>milestones</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>      <span class='comment val'># uses the milestone cache</span>
  <span class='project identifier id'>project</span><span class='dot token'>.</span><span class='milestones identifier id'>milestones</span><span class='lparen token'>(</span><span class='true true kw'>true</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='size identifier id'>size</span>  <span class='comment val'># fetches milestones from the database</span>
  <span class='project identifier id'>project</span><span class='dot token'>.</span><span class='milestones identifier id'>milestones</span>             <span class='comment val'># uses the milestone cache</span>
</pre>
<h2>Eager loading of associations</h2>
<p>
Not implemented yet
</p>
<h2>Modules</h2>
<p>
By default, associations will look for objects within the current module
scope. Consider:
</p>
<pre class="code">
  <span class='module module kw'>module</span> <span class='MyApplication constant id'>MyApplication</span>
    <span class='module module kw'>module</span> <span class='Business constant id'>Business</span>
      <span class='class class kw'>class</span> <span class='Firm constant id'>Firm</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
         <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:clients</span>
       <span class='end end kw'>end</span>

      <span class='class class kw'>class</span> <span class='Company constant id'>Company</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span><span class='semicolon token'>;</span> <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
When Firm#clients is called, it will in turn call
<tt>MyApplication::Business::Company.find(firm.id)</tt>. If you want to
associate with a class in another module scope, this can be done by
specifying the complete class name. Example:
</p>
<pre class="code">
  <span class='module module kw'>module</span> <span class='MyApplication constant id'>MyApplication</span>
    <span class='module module kw'>module</span> <span class='Business constant id'>Business</span>
      <span class='class class kw'>class</span> <span class='Firm constant id'>Firm</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span><span class='semicolon token'>;</span> <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='module module kw'>module</span> <span class='Billing constant id'>Billing</span>
      <span class='class class kw'>class</span> <span class='Account constant id'>Account</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
        <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:firm</span><span class='comma token'>,</span> <span class='symbol val'>:class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;MyApplication::Business::Firm&quot;</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Type safety with <tt>CouchFoo::AssociationTypeMismatch</tt></h2>
<p>
If you attempt to assign an object to an association that doesn&#8217;t
match the inferred or specified <tt>:class_name</tt>, you&#8217;ll get an
<tt>CouchFoo::AssociationTypeMismatch</tt>.
</p>
<h2>Options</h2>
<p>
All of the association macros can be specialized through options. This
makes cases more complex than the simple and guessable ones possible.
</p>

</div><div class="section constants">
  
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#belongs_to-instance_method">#belongs_to</span><span class='args'>(association_id, options = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Adds the following methods for retrieval and query for a single associated
object for which this object holds an id: <tt>association</tt> is replaced
with the symbol passed as the first argument, so <tt>belongs_to
:author</tt> would add among others &lt;tt&gt;author.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#has_many-instance_method">#has_many</span><span class='args'>(association_id, options = {}, &amp;extension)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Adds the following methods for retrieval and query of collections of
associated objects: <tt>collection</tt> is replaced with the symbol passed
as the first argument, so <tt>has_many :clients</tt> would add among others
&lt;tt&gt;clients.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#has_one-instance_method">#has_one</span><span class='args'>(association_id, options = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Adds the following methods for retrieval and query of a single associated
object: <tt>association</tt> is replaced with the symbol passed as the
first argument, so <tt>has_one :manager</tt> would add among others
&lt;tt&gt;manager.
</p>

        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>belongs_to</h3>
</div><div id="belongs_to-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>belongs_to</span><span class='args'>(association_id, options = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Adds the following methods for retrieval and query for a single associated
object for which this object holds an id: <tt>association</tt> is replaced
with the symbol passed as the first argument, so <tt>belongs_to
:author</tt> would add among others <tt>author.nil?</tt>.
</p>
<ul>
<li><tt>association(force_reload = false)</tt> - Returns the associated object.
<tt>nil</tt> is returned if none is found.

</li>
<li><tt>association=(associate)</tt> - Assigns the associate object, extracts
the primary key, and sets it as the foreign key.

</li>
<li><tt>association.nil?</tt> - Returns <tt>true</tt> if there is no associated
object.

</li>
<li><tt>build_association(attributes = {})</tt> - Returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key, but has not yet been saved.

</li>
<li><tt>create_association(attributes = {})</tt> - Returns a new object of the
associated type that has been instantiated with <tt>attributes</tt>, linked
to this object through a foreign key, and that has already been saved (if
it passed the validation).

</li>
</ul>
<p>
Example: A Post class declares <tt>belongs_to :author</tt>, which will add:
</p>
<ul>
<li><tt>Post#author</tt> (similar to <tt>Author.find(author_id)</tt>)

</li>
<li><tt>Post#author=(author)</tt> (similar to <tt>post.author_id =
author.id</tt>)

</li>
<li><tt>Post#author?</tt> (similar to <tt>post.author == some_author</tt>)

</li>
<li><tt>Post#author.nil?</tt>

</li>
<li><tt>Post#build_author</tt> (similar to <tt>post.author = Author.new</tt>)

</li>
<li><tt>Post#create_author</tt> (similar to <tt>post.author = Author.new;
post.author.save; post.author</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - Specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt>has_one :author</tt> will by default be linked to the Author class, but
if the real class name is Person, you&#8217;ll have to specify it with this
option.

</li>
<li><tt>:conditions</tt> - Specify the conditions that the associated objects
must meet in order to be included in the results. For example <tt>has_many
:posts, :conditions =&gt; <tt>=&amp;gt; true</tt></tt>. This will also
create published posts with <tt>@blog.posts.create</tt> or
<tt>@blog.posts.build</tt>.

</li>
<li><tt>:foreign_key</tt> - Specify the foreign key used for the association.
By default this is guessed to be the name of the association with an
&quot;_id&quot; suffix. So a class that defines a <tt>belongs_to
:person</tt> association will use &quot;person_id&quot; as the default
<tt>:foreign_key</tt>. Similarly, <tt>belongs_to :favorite_person,
:class_name =&gt; &quot;Person&quot;</tt> will use a foreign key of
&quot;favorite_person_id&quot;.

</li>
<li><tt>:dependent</tt> - If set to <tt>:destroy</tt>, the associated object is
destroyed when this object is. If set to <tt>:delete</tt>, the associated
object is deleted <b>without</b> calling its destroy method. This option
should not be specified when <tt>belongs_to</tt> is used in conjunction
with a <tt>has_many</tt> relationship on another class because of the
potential to leave orphaned records behind.

</li>
<li><tt>:counter_cache</tt> - Caches the number of belonging objects on the
associate class through the use of <tt>increment_counter</tt> and
<tt>decrement_counter</tt>. The counter cache is incremented when an object
of this class is created and decremented when it&#8217;s destroyed. This
requires that a property named <tt>#{document_name}_count</tt> (such as
<tt>comments_count</tt> for a belonging Comment class) is used on the
associate class (such as a Post class). You can also specify a custom
counter cache property by providing a property name instead of a
<tt>true</tt>/<tt>false</tt> value to this option (e.g., <tt>:counter_cache
=&gt; :my_custom_counter</tt>.) When creating a counter cache property, the
database statement or migration must specify a default value of <tt>0</tt>,
failing to do this results in a counter with <tt>NULL</tt> value, which
will never increment. Note: Specifying a counter cache will add it to that
model&#8217;s list of readonly attributes using <tt>attr_readonly</tt>.

</li>
<li><tt>:include</tt> - Specify second-order associations that should be eager
loaded when this object is loaded.

</li>
<li><tt>:polymorphic</tt> - Specify this association is a polymorphic
association by passing <tt>true</tt>. Note: If you&#8217;ve enabled the
counter cache, then you may want to add the counter cache attribute to the
<tt>attr_readonly</tt> list in the associated classes (e.g. <tt>class Post;
attr_readonly :comments_count; end</tt>).

</li>
<li><tt>:readonly</tt> - If true, the associated object is readonly through the
association.

</li>
<li><tt>:validate</tt> - If false, don&#8217;t validate the associated objects
when saving the parent object. <tt>false</tt> by default.

</li>
</ul>
<p>
Option examples:
</p>
<pre class="code">
  <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:firm</span><span class='comma token'>,</span> <span class='symbol val'>:foreign_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;client_of&quot;</span>
  <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:author</span><span class='comma token'>,</span> <span class='symbol val'>:class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;Person&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:foreign_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;author_id&quot;</span>
  <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:valid_coupon</span><span class='comma token'>,</span> <span class='symbol val'>:class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;Coupon&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:foreign_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;coupon_id&quot;</span><span class='comma token'>,</span>
             <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='discounts identifier id'>discounts</span> <span class='assign token'>=</span> <span class='comment val'>#{payments_count}}</span>
  <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:attachable</span><span class='comma token'>,</span> <span class='symbol val'>:polymorphic</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>
  <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:project</span><span class='comma token'>,</span> <span class='symbol val'>:readonly</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>
  <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:post</span><span class='comma token'>,</span> <span class='symbol val'>:counter_cache</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>
</pre>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/couch_foo/associations.rb', line 648</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6/lib/couch_foo/associations.rb#L648">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='belongs_to identifier id'>belongs_to</span><span class='lparen token'>(</span><span class='association_id identifier id'>association_id</span><span class='comma token'>,</span> <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='reflection identifier id'>reflection</span> <span class='assign token'>=</span> <span class='create_belongs_to_reflection identifier id'>create_belongs_to_reflection</span><span class='lparen token'>(</span><span class='association_id identifier id'>association_id</span><span class='comma token'>,</span> <span class='options identifier id'>options</span><span class='rparen token'>)</span>

  <span class='ivar identifier id'>ivar</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;@#{reflection.name}&quot;</span>

  <span class='if if kw'>if</span> <span class='reflection identifier id'>reflection</span><span class='dot token'>.</span><span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:polymorphic</span><span class='rbrack token'>]</span>
    <span class='association_accessor_methods identifier id'>association_accessor_methods</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='comma token'>,</span> <span class='BelongsToPolymorphicAssociation constant id'>BelongsToPolymorphicAssociation</span><span class='rparen token'>)</span>

    <span class='method_name identifier id'>method_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;polymorphic_belongs_to_before_save_for_#{reflection.name}&quot;</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span>
    <span class='define_method identifier id'>define_method</span><span class='lparen token'>(</span><span class='method_name identifier id'>method_name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
      <span class='association identifier id'>association</span> <span class='assign token'>=</span> <span class='instance_variable_get identifier id'>instance_variable_get</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{ivar}&quot;</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='instance_variable_defined? fid id'>instance_variable_defined?</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{ivar}&quot;</span><span class='rparen token'>)</span>

      <span class='if if kw'>if</span> <span class='association identifier id'>association</span> <span class='andop op'>&amp;&amp;</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='target identifier id'>target</span>
        <span class='if if kw'>if</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='new_record? fid id'>new_record?</span>
          <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='save identifier id'>save</span><span class='lparen token'>(</span><span class='true true kw'>true</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>

        <span class='if if kw'>if</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='updated? fid id'>updated?</span>
          <span class='self self kw'>self</span><span class='lbrack token'>[</span><span class='dstring node'>&quot;#{reflection.primary_key_name}&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='id identifier id'>id</span>
          <span class='self self kw'>self</span><span class='lbrack token'>[</span><span class='dstring node'>&quot;#{reflection.options[:foreign_type]}&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    <span class='before_save identifier id'>before_save</span> <span class='method_name identifier id'>method_name</span>
  <span class='else else kw'>else</span>
    <span class='association_accessor_methods identifier id'>association_accessor_methods</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='comma token'>,</span> <span class='BelongsToAssociation constant id'>BelongsToAssociation</span><span class='rparen token'>)</span>
    <span class='association_constructor_method identifier id'>association_constructor_method</span><span class='lparen token'>(</span><span class='symbol val'>:build</span><span class='comma token'>,</span>  <span class='reflection identifier id'>reflection</span><span class='comma token'>,</span> <span class='BelongsToAssociation constant id'>BelongsToAssociation</span><span class='rparen token'>)</span>
    <span class='association_constructor_method identifier id'>association_constructor_method</span><span class='lparen token'>(</span><span class='symbol val'>:create</span><span class='comma token'>,</span> <span class='reflection identifier id'>reflection</span><span class='comma token'>,</span> <span class='BelongsToAssociation constant id'>BelongsToAssociation</span><span class='rparen token'>)</span>

    <span class='method_name identifier id'>method_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;belongs_to_before_save_for_#{reflection.name}&quot;</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span>
    <span class='define_method identifier id'>define_method</span><span class='lparen token'>(</span><span class='method_name identifier id'>method_name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
      <span class='association identifier id'>association</span> <span class='assign token'>=</span> <span class='instance_variable_get identifier id'>instance_variable_get</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{ivar}&quot;</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='instance_variable_defined? fid id'>instance_variable_defined?</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{ivar}&quot;</span><span class='rparen token'>)</span>

      <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='association identifier id'>association</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
        <span class='if if kw'>if</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='new_record? fid id'>new_record?</span>
          <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='save identifier id'>save</span><span class='lparen token'>(</span><span class='true true kw'>true</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>

        <span class='if if kw'>if</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='updated? fid id'>updated?</span>
          <span class='self self kw'>self</span><span class='lbrack token'>[</span><span class='dstring node'>&quot;#{reflection.primary_key_name}&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='id identifier id'>id</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    <span class='before_save identifier id'>before_save</span> <span class='method_name identifier id'>method_name</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># Create the callbacks to update counter cache</span>
  <span class='if if kw'>if</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:counter_cache</span><span class='rbrack token'>]</span>
    <span class='cache_property identifier id'>cache_property</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:counter_cache</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='true true kw'>true</span> <span class='question op'>?</span>
      <span class='dstring node'>&quot;#{self.to_s.demodulize.underscore.pluralize}_count&quot;</span> <span class='colon op'>:</span>
      <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:counter_cache</span><span class='rbrack token'>]</span>

    <span class='method_name identifier id'>method_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;belongs_to_counter_cache_after_create_for_#{reflection.name}&quot;</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span>
    <span class='define_method identifier id'>define_method</span><span class='lparen token'>(</span><span class='method_name identifier id'>method_name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
      <span class='association identifier id'>association</span> <span class='assign token'>=</span> <span class='send identifier id'>send</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{reflection.name}&quot;</span><span class='rparen token'>)</span>
      <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='increment_counter identifier id'>increment_counter</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{cache_property}&quot;</span><span class='comma token'>,</span> <span class='send identifier id'>send</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{reflection.primary_key_name}&quot;</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='end end kw'>end</span>
    <span class='after_create identifier id'>after_create</span> <span class='method_name identifier id'>method_name</span>

    <span class='method_name identifier id'>method_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;belongs_to_counter_cache_before_destroy_for_#{reflection.name}&quot;</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span>
    <span class='define_method identifier id'>define_method</span><span class='lparen token'>(</span><span class='method_name identifier id'>method_name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
      <span class='association identifier id'>association</span> <span class='assign token'>=</span> <span class='send identifier id'>send</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{reflection.name}&quot;</span><span class='rparen token'>)</span>
      <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='decrement_counter identifier id'>decrement_counter</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{cache_property}&quot;</span><span class='comma token'>,</span> <span class='send identifier id'>send</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{reflection.primary_key_name}&quot;</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='end end kw'>end</span>
    <span class='before_destroy identifier id'>before_destroy</span> <span class='method_name identifier id'>method_name</span>

    <span class='module_eval identifier id'>module_eval</span><span class='lparen token'>(</span>
      <span class='dstring node'>&quot;#{reflection.class_name}.send(:attr_readonly,\&quot;#{cache_property}\&quot;.intern) if defined?(#{reflection.class_name}) &amp;&amp; #{reflection.class_name}.respond_to?(:attr_readonly)&quot;</span>
    <span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='add_single_associated_validation_callbacks identifier id'>add_single_associated_validation_callbacks</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:validate</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='true true kw'>true</span>

  <span class='configure_dependency_for_belongs_to identifier id'>configure_dependency_for_belongs_to</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>has_many</h3>
</div><div id="has_many-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>has_many</span><span class='args'>(association_id, options = {}, &amp;extension)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Adds the following methods for retrieval and query of collections of
associated objects: <tt>collection</tt> is replaced with the symbol passed
as the first argument, so <tt>has_many :clients</tt> would add among others
<tt>clients.empty?</tt>.
</p>
<ul>
<li><tt>collection(force_reload = false)</tt> - Returns an array of all the
associated objects. An empty array is returned if none are found.

</li>
<li><tt>collection&lt;&lt;(object, &#8230;)</tt> - Adds one or more objects to
the collection by setting their foreign keys to the collection&#8217;s
primary key.

</li>
<li><tt>collection.delete(object, &#8230;)</tt> - Removes one or more objects
from the collection by setting their foreign keys to <tt>NULL</tt>. This
will also destroy the objects if they&#8217;re declared as
<tt>belongs_to</tt> and dependent on this model.

</li>
<li><tt>collection=objects</tt> - Replaces the collections content by deleting
and adding objects as appropriate.

</li>
<li><tt>collection_singular_ids</tt> - Returns an array of the associated
objects&#8217; ids

</li>
<li><tt>collection_singular_ids=ids</tt> - Replace the collection with the
objects identified by the primary keys in <tt>ids</tt>

</li>
<li><tt>collection.clear</tt> - Removes every object from the collection. This
destroys the associated objects if they are associated with <tt>:dependent
=&gt; :destroy</tt>, deletes them directly from the database if
<tt>:dependent =&gt; :delete_all</tt>, otherwise sets their foreign keys to
<tt>NULL</tt>.

</li>
<li><tt>collection.empty?</tt> - Returns <tt>true</tt> if there are no
associated objects.

</li>
<li><tt>collection.size</tt> - Returns the number of associated objects.

</li>
<li><tt>collection.find</tt> - Finds an associated object according to the same
rules as Base.find.

</li>
<li><tt>collection.build(attributes = {}, &#8230;)</tt> - Returns one or more
new objects of the collection type that have been instantiated with
<tt>attributes</tt> and linked to this object through a foreign key, but
have not yet been saved. *Note:* This only works if an associated object
already exists, not if it&#8217;s <tt>nil</tt>!

</li>
<li><tt>collection.create(attributes = {})</tt> - Returns a new object of the
collection type that has been instantiated with <tt>attributes</tt>, linked
to this object through a foreign key, and that has already been saved (if
it passed the validation). *Note:* This only works if an associated object
already exists, not if it&#8217;s <tt>nil</tt>!

</li>
</ul>
<p>
Example: A Firm class declares <tt>has_many :clients</tt>, which will add:
</p>
<ul>
<li><tt>Firm#clients</tt> (similar to <tt>Clients.find :all, :conditions =&gt;
&quot;firm_id = #{id}&quot;</tt>)

</li>
<li><tt>Firm#clients&lt;&lt;</tt>

</li>
<li><tt>Firm#clients.delete</tt>

</li>
<li><tt>Firm#clients=</tt>

</li>
<li><tt>Firm#client_ids</tt>

</li>
<li><tt>Firm#client_ids=</tt>

</li>
<li><tt>Firm#clients.clear</tt>

</li>
<li><tt>Firm#clients.empty?</tt> (similar to <tt>firm.clients.size == 0</tt>)

</li>
<li><tt>Firm#clients.size</tt> (similar to <tt>Client.count &quot;firm_id =
#{id}&quot;</tt>)

</li>
<li><tt>Firm#clients.find</tt> (similar to <tt>Client.find(id, :conditions
=&gt; &quot;firm_id = #{id}&quot;)</tt>)

</li>
<li><tt>Firm#clients.build</tt> (similar to <tt>Client.new(&quot;firm_id&quot;
=&gt; id)</tt>)

</li>
<li><tt>Firm#clients.create</tt> (similar to <tt>c =
Client.new(&quot;firm_id&quot; =&gt; id); c.save; c</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - Specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt>has_many :products</tt> will by default be linked to the Product class,
but if the real class name is SpecialProduct, you&#8217;ll have to specify
it with this option.

</li>
<li><tt>:conditions</tt> - Specify the conditions that the associated objects
must meet in order to be included in the results. For example <tt>has_many
:posts, :conditions =&gt; <tt>=&amp;gt; true</tt></tt>. This will also
create published posts with <tt>@blog.posts.create</tt> or
<tt>@blog.posts.build</tt>.

</li>
<li><tt>:order</tt> - Specify the order in which the associated objects are
returned by a property to sort on, for example :order =&gt;
:product_weight. See notes in CouchFoo#find when using with :limit

</li>
<li><tt>:dependent</tt> - If set to <tt>:destroy</tt> all the associated
objects are destroyed alongside this object by calling their
<tt>destroy</tt> method. If set to <tt>:delete_all</tt> all associated
objects are deleted <b>without</b> calling their <tt>destroy</tt> method.
If set to <tt>:nullify</tt> all associated objects&#8217; foreign keys are
set to <tt>NULL</tt> <b>without</b> calling their <tt>save</tt> callbacks.
*Warning:* This option is ignored when also using the <tt>:through</tt>
option.

</li>
<li><tt>:extend</tt> - Specify a named module for extending the proxy. See
&quot;Association extensions&quot;.

</li>
<li><tt>:include</tt> - Specify second-order associations that should be eager
loaded when the collection is loaded.

</li>
<li><tt>:limit</tt> - An integer determining the limit on the number of rows
that should be returned. See notes in CouchFoo#find when using with :order

</li>
<li><tt>:offset</tt> - An integer determining the offset from where the rows
should be fetched. So at 5, it would skip the first 4 rows.

</li>
<li><tt>:as</tt> - Specifies a polymorphic interface (See <tt>belongs_to</tt>).

</li>
<li><tt>:through</tt> - Not implemented at the moment

</li>
<li><tt>:source_type</tt> - Specifies type of the source association used by
<tt>has_many :through</tt> queries where the source association is a
polymorphic <tt>belongs_to</tt>.

</li>
<li><tt>:uniq</tt> - If true, duplicates will be omitted from the collection.
Useful in conjunction with <tt>:through</tt>.

</li>
<li><tt>:readonly</tt> - If true, all the associated objects are readonly
through the association.

</li>
<li><tt>:validate</tt> - If false, don&#8217;t validate the associated objects
when saving the parent object. true by default.

</li>
</ul>
<p>
Option examples:
</p>
<pre class="code">
  <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:comments</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:posted_on</span>
  <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:comments</span><span class='comma token'>,</span> <span class='symbol val'>:include</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:author</span>
  <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:people</span><span class='comma token'>,</span> <span class='symbol val'>:class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;Person&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span><span class='deleted identifier id'>deleted</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>0</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;name&quot;</span>
  <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:tracks</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:position</span><span class='comma token'>,</span> <span class='symbol val'>:dependent</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:destroy</span>
  <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:comments</span><span class='comma token'>,</span> <span class='symbol val'>:dependent</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:nullify</span>
  <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:tags</span><span class='comma token'>,</span> <span class='symbol val'>:as</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:taggable</span>
  <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:reports</span><span class='comma token'>,</span> <span class='symbol val'>:readonly</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>
</pre>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/couch_foo/associations.rb', line 494</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6/lib/couch_foo/associations.rb#L494">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">494
495
496
497
498
499
500
501
502
503
504
505
506
507</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='has_many identifier id'>has_many</span><span class='lparen token'>(</span><span class='association_id identifier id'>association_id</span><span class='comma token'>,</span> <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='extension identifier id'>extension</span><span class='rparen token'>)</span>
  <span class='reflection identifier id'>reflection</span> <span class='assign token'>=</span> <span class='create_has_many_reflection identifier id'>create_has_many_reflection</span><span class='lparen token'>(</span><span class='association_id identifier id'>association_id</span><span class='comma token'>,</span> <span class='options identifier id'>options</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='extension identifier id'>extension</span><span class='rparen token'>)</span>
  <span class='configure_dependency_for_has_many identifier id'>configure_dependency_for_has_many</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='rparen token'>)</span>

  <span class='add_multiple_associated_validation_callbacks identifier id'>add_multiple_associated_validation_callbacks</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:validate</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='false false kw'>false</span>
  <span class='add_multiple_associated_save_callbacks identifier id'>add_multiple_associated_save_callbacks</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
  <span class='add_association_callbacks identifier id'>add_association_callbacks</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='reflection identifier id'>reflection</span><span class='dot token'>.</span><span class='options identifier id'>options</span><span class='rparen token'>)</span>

  <span class='comment val'>#if options[:through]</span>
  <span class='comment val'>#  collection_accessor_methods(reflection, HasManyThroughAssociation)</span>
  <span class='comment val'>#else</span>
    <span class='collection_accessor_methods identifier id'>collection_accessor_methods</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='comma token'>,</span> <span class='HasManyAssociation constant id'>HasManyAssociation</span><span class='rparen token'>)</span>
  <span class='comment val'>#end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>has_one</h3>
</div><div id="has_one-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>has_one</span><span class='args'>(association_id, options = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Adds the following methods for retrieval and query of a single associated
object: <tt>association</tt> is replaced with the symbol passed as the
first argument, so <tt>has_one :manager</tt> would add among others
<tt>manager.nil?</tt>.
</p>
<ul>
<li><tt>association(force_reload = false)</tt> - Returns the associated object.
<tt>nil</tt> is returned if none is found.

</li>
<li><tt>association=(associate)</tt> - Assigns the associate object, extracts
the primary key, sets it as the foreign key, and saves the associate
object.

</li>
<li><tt>association.nil?</tt> - Returns <tt>true</tt> if there is no associated
object.

</li>
<li><tt>build_association(attributes = {})</tt> - Returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key, but has not yet been saved.
Note: This ONLY works if an association already exists. It will NOT work if
the association is <tt>nil</tt>.

</li>
<li><tt>create_association(attributes = {})</tt> - Returns a new object of the
associated type that has been instantiated with <tt>attributes</tt>, linked
to this object through a foreign key, and that has already been saved (if
it passed the validation).

</li>
</ul>
<p>
Example: An Account class declares <tt>has_one :beneficiary</tt>, which
will add:
</p>
<ul>
<li><tt>Account#beneficiary</tt> (similar to <tt>Beneficiary.find(:first,
:conditions =&gt; &quot;account_id = #{id}&quot;)</tt>)

</li>
<li><tt>Account#beneficiary=(beneficiary)</tt> (similar to
<tt>beneficiary.account_id = account.id; beneficiary.save</tt>)

</li>
<li><tt>Account#beneficiary.nil?</tt>

</li>
<li><tt>Account#build_beneficiary</tt> (similar to
<tt>Beneficiary.new(&quot;account_id&quot; =&gt; id)</tt>)

</li>
<li><tt>Account#create_beneficiary</tt> (similar to <tt>b =
Beneficiary.new(&quot;account_id&quot; =&gt; id); b.save; b</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - Specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt>has_one :manager</tt> will by default be linked to the Manager class,
but if the real class name is Person, you&#8217;ll have to specify it with
this option.

</li>
<li><tt>:conditions</tt> - Specify the conditions that the associated objects
must meet in order to be included in the results. For example <tt>has_many
:posts, :conditions =&gt; <tt>=&amp;gt; true</tt></tt>. This will also
create published posts with <tt>@blog.posts.create</tt> or
<tt>@blog.posts.build</tt>.

</li>
<li><tt>:order</tt> - Specify the order in which the associated objects are
returned by a property to sort on, for example :order =&gt;
:product_weight. See notes in CouchFoo#find when using with :limit

</li>
<li><tt>:dependent</tt> - If set to <tt>:destroy</tt>, the associated object is
destroyed when this object is. If set to <tt>:delete</tt>, the associated
object is deleted <b>without</b> calling its destroy method. If set to
<tt>:nullify</tt>, the associated object&#8217;s foreign key is set to
<tt>NULL</tt>. Also, association is assigned.

</li>
<li><tt>:foreign_key</tt> - Specify the foreign key used for the association.
By default this is guessed to be the name of this class in lower-case and
&quot;_id&quot; suffixed. So a Person class that makes a <tt>has_one</tt>
association will use &quot;person_id&quot; as the default
<tt>:foreign_key</tt>.

</li>
<li><tt>:include</tt> - Specify second-order associations that should be eager
loaded when this object is loaded.

</li>
<li><tt>:as</tt> - Specifies a polymorphic interface (See <tt>belongs_to</tt>).

</li>
<li><tt>:through</tt> - Not implemented yet

</li>
<li><tt>:source</tt> - Not implemented yet

</li>
<li><tt>:source_type</tt> - Not implemented yet

</li>
<li><tt>:readonly</tt> - If true, the associated object is readonly through the
association.

</li>
<li><tt>:validate</tt> - If false, don&#8217;t validate the associated object
when saving the parent object. <tt>false</tt> by default.

</li>
</ul>
<p>
Option examples:
</p>
<pre class="code">
  <span class='has_one identifier id'>has_one</span> <span class='symbol val'>:credit_card</span><span class='comma token'>,</span> <span class='symbol val'>:dependent</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:destroy</span>  <span class='comment val'># destroys the associated credit card</span>
  <span class='has_one identifier id'>has_one</span> <span class='symbol val'>:credit_card</span><span class='comma token'>,</span> <span class='symbol val'>:dependent</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:nullify</span>  <span class='comment val'># updates the associated records foreign key value to NULL rather than destroying it</span>
  <span class='has_one identifier id'>has_one</span> <span class='symbol val'>:last_comment</span><span class='comma token'>,</span> <span class='symbol val'>:class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;Comment&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:posted_on</span>
  <span class='has_one identifier id'>has_one</span> <span class='symbol val'>:project_manager</span><span class='comma token'>,</span> <span class='symbol val'>:class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;Person&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;role = 'project_manager'&quot;</span>
  <span class='has_one identifier id'>has_one</span> <span class='symbol val'>:attachment</span><span class='comma token'>,</span> <span class='symbol val'>:as</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:attachable</span>
  <span class='has_one identifier id'>has_one</span> <span class='symbol val'>:boss</span><span class='comma token'>,</span> <span class='symbol val'>:readonly</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:true</span>
</pre>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/couch_foo/associations.rb', line 561</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6/lib/couch_foo/associations.rb#L561">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='has_one identifier id'>has_one</span><span class='lparen token'>(</span><span class='association_id identifier id'>association_id</span><span class='comma token'>,</span> <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='comment val'>#if options[:through]</span>
  <span class='comment val'>#  reflection = create_has_one_through_reflection(association_id, options)</span>
  <span class='comment val'>#  association_accessor_methods(reflection, CouchFoo::Associations::HasOneThroughAssociation)</span>
  <span class='comment val'>#else</span>
    <span class='reflection identifier id'>reflection</span> <span class='assign token'>=</span> <span class='create_has_one_reflection identifier id'>create_has_one_reflection</span><span class='lparen token'>(</span><span class='association_id identifier id'>association_id</span><span class='comma token'>,</span> <span class='options identifier id'>options</span><span class='rparen token'>)</span>

    <span class='ivar identifier id'>ivar</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;@#{reflection.name}&quot;</span>

    <span class='method_name identifier id'>method_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;has_one_after_save_for_#{reflection.name}&quot;</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span>
    <span class='define_method identifier id'>define_method</span><span class='lparen token'>(</span><span class='method_name identifier id'>method_name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
      <span class='association identifier id'>association</span> <span class='assign token'>=</span> <span class='instance_variable_get identifier id'>instance_variable_get</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{ivar}&quot;</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='instance_variable_defined? fid id'>instance_variable_defined?</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{ivar}&quot;</span><span class='rparen token'>)</span>

      <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='association identifier id'>association</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='lparen token'>(</span><span class='new_record? fid id'>new_record?</span> <span class='orop op'>||</span> <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='new_record? fid id'>new_record?</span> <span class='orop op'>||</span> <span class='association identifier id'>association</span><span class='lbrack token'>[</span><span class='dstring node'>&quot;#{reflection.primary_key_name}&quot;</span><span class='rbrack token'>]</span> <span class='neq op'>!=</span> <span class='id identifier id'>id</span><span class='rparen token'>)</span>
        <span class='association identifier id'>association</span><span class='lbrack token'>[</span><span class='dstring node'>&quot;#{reflection.primary_key_name}&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='id identifier id'>id</span>
        <span class='association identifier id'>association</span><span class='dot token'>.</span><span class='save identifier id'>save</span><span class='lparen token'>(</span><span class='true true kw'>true</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    <span class='after_save identifier id'>after_save</span> <span class='method_name identifier id'>method_name</span>

    <span class='add_single_associated_validation_callbacks identifier id'>add_single_associated_validation_callbacks</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:validate</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='true true kw'>true</span>
    <span class='association_accessor_methods identifier id'>association_accessor_methods</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='comma token'>,</span> <span class='HasOneAssociation constant id'>HasOneAssociation</span><span class='rparen token'>)</span>
    <span class='association_constructor_method identifier id'>association_constructor_method</span><span class='lparen token'>(</span><span class='symbol val'>:build</span><span class='comma token'>,</span>  <span class='reflection identifier id'>reflection</span><span class='comma token'>,</span> <span class='HasOneAssociation constant id'>HasOneAssociation</span><span class='rparen token'>)</span>
    <span class='association_constructor_method identifier id'>association_constructor_method</span><span class='lparen token'>(</span><span class='symbol val'>:create</span><span class='comma token'>,</span> <span class='reflection identifier id'>reflection</span><span class='comma token'>,</span> <span class='HasOneAssociation constant id'>HasOneAssociation</span><span class='rparen token'>)</span>

    <span class='configure_dependency_for_has_one identifier id'>configure_dependency_for_has_one</span><span class='lparen token'>(</span><span class='reflection identifier id'>reflection</span><span class='rparen token'>)</span>
  <span class='comment val'>#end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
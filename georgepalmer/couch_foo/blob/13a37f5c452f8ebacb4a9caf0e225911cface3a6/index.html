<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>georgepalmer's couch_foo - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/georgepalmer/commits/couch_foo/master" rel="alternate" title="Recent Commits to couch_foo:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("georgepalmer", "couch_foo", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("georgepalmer", "couch_foo", "13a37f5c452f8ebacb4a9caf0e225911cface3a6", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/tree/">Source</a></li>
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/network">Network</a></li>            
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/georgepalmer/couch_foo">Wiki</a></li>
            <li class=""><a href="http://github.com/georgepalmer/couch_foo/graphs">Graphs</a></li>                    
            <li class="active"><a href="/georgepalmer/couch_foo">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/georgepalmer">georgepalmer</a> / <b><a href="http://github.com/georgepalmer/couch_foo/tree">couch_foo</a></b>        
                <a id="namespaces_button" rel="georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="georgepalmer/couch_foo/blob/13a37f5c452f8ebacb4a9caf0e225911cface3a6" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>CouchFoo</h1>
<h2>Introduction</h2>
<p>
CouchDB (http://couchdb.apache.org/) works slightly differently to
relational databases. First, and foremost, it is a document-oriented
database. That is, data is stored in documents each of which have a unique
id that is used to access and modify it. The contents of the documents are
free from structure (or schema free) and bear no relation to one another
(unless you encode that within the documents themselves). So in many ways
documents are like records within a relational database except there are no
tables to keep documents of the same type in.
</p>
<p>
CouchDB interfaces with the external world via a RESTful interface. This
allows document creation, updating, deletion etc. The contents of a
document are specified in JSON so its possible to serialise objects within
the database record efficiently as well as store all the normal types
natively.
</p>
<p>
As a consequence of its free form structure there is no SQL to query the
database. Instead you define (table-oriented) views that emit certain bits
of data from the record and apply conditions, sorting etc to those views.
For example if you were to emit the colour attribute you could find all
documents with a certain colour. This is similar to indexed lookups on a
relational table (both in terms of concept and performance).
</p>
<p>
CouchDB has been designed from the ground up to operate in a distributed
way. It provides robust, incremental replication with bi-directional
conflict detection and resolution. It&#8217;s an excellent choice for
unstructed data, large datasets that need sharding efficiently and
situations where you wish to run local copies of the database.
</p>
<h2>Overview</h2>
<p>
CouchFoo provides an ActiveRecord styled interface to CouchDB. The external
API is nearly identical to ActiveRecord so it should be possible to migrate
your applications quite easily. That said, there are a few minor
differences to the way CouchDB works. In particular:
</p>
<ul>
<li>CouchDB is schema free so property definitions for the document are defined
in the model (like DataMapper)

</li>
<li>:select, :joins, :having, :group, :from and :lock are not available on find
or associations as they don&#8217;t apply (locking is handled as conflict
resolution at insertion time)

</li>
<li>:conditions can only accept a hash and not an array or SQL. For example
:conditions =&gt; <tt>=&amp;gt; &amp;quot;Georgio_1999&amp;quot;</tt>

</li>
<li>:offset is less efficient in CouchDB - there&#8217;s more on this in the
rdoc

</li>
<li>:order is applied after results are retrieved from the database. Therefore
:order cannot be used with :limit without a new option :use_key. This is
explained fully in the quick start guide and CouchFoo#find documentation

</li>
<li>:include isn&#8217;t implemented yet but the finders and associations still
accept the option so you won&#8217;t need to make any code changes

</li>
<li>By default results are ordered by document key. The key uses a UUID scheme
so these don&#8217;t auto-increment and are likely to come out in a
different order to insertion. default_sort can be used on a model to sort
by create date by default and overcome this

</li>
<li>validates_uniqueness_of has had the :case_sensitive option removed

</li>
<li>Because there&#8217;s no SQL there&#8217;s no SQL finder methods

</li>
<li>Timezones, aggregations and fixtures are not yet implemented

</li>
<li>The price of index updating is paid when next accessing the index rather
than the point of insertion. This can be more efficient or less depending
on your application. It may make sense to use an external process to do the
updating for you - see CouchFoo#find for more on this

</li>
<li>On that note, compacting of CouchDB is required to recover space from old
versions of documents and keep performance fast. This can be kicked off in
several ways (see quick start guide)

</li>
</ul>
<p>
It is recommend that you read the quick start and performance sections in
the rdoc for a full overview of differences and points to be aware of when
developing. The Changelog file shows the differences between gem versions
and should be checked when upgrading gem versions.
</p>
<h2>Getting started</h2>
<pre class="code">
  <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span><span class='dot token'>.</span><span class='set_database identifier id'>set_database</span><span class='lparen token'>(</span><span class='symbol val'>:host</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;http://localhost:5984&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:database</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;mydatabase&quot;</span><span class='rparen token'>)</span>
  <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span><span class='dot token'>.</span><span class='logger identifier id'>logger</span> <span class='assign token'>=</span> <span class='Rails constant id'>Rails</span><span class='dot token'>.</span><span class='logger identifier id'>logger</span>
</pre>
<p>
If using with Rails you will need to create an initializer to do this
(until proper integration is added). Also note depending on your version of
CouchDB will depend on the version of the CouchREST gem you will require -
CouchDB 0.9 requires CouchREST greater than 0.2 and CouchDB 0.8 requires
CouchREST between 0.16 and 0.2. You will be warned on CouchFoo
initialization if this is wrong.
</p>
<h2>Examples of usage</h2>
<p>
Basic operations are the same as ActiveRecord:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Address constant id'>Address</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:number</span><span class='comma token'>,</span> <span class='Integer constant id'>Integer</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:street</span><span class='comma token'>,</span> <span class='String constant id'>String</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:postcode</span> <span class='comment val'># Any generic type is fine as long as .to_json and class.from_json(json) can be called on it</span>
  <span class='end end kw'>end</span>

  <span class='address1 identifier id'>address1</span> <span class='assign token'>=</span> <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:number</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>3</span><span class='comma token'>,</span> <span class='symbol val'>:street</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;My Street&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:postcode</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;secret&quot;</span><span class='rparen token'>)</span> <span class='comment val'># Create address</span>
  <span class='address2 identifier id'>address2</span> <span class='assign token'>=</span> <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:number</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>27</span><span class='comma token'>,</span> <span class='symbol val'>:street</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;Another Street&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:postcode</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;secret&quot;</span><span class='rparen token'>)</span>
  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='all identifier id'>all</span> <span class='comment val'># = [address1, address2] or maybe [address2, address1] depending on key generation</span>
  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='first identifier id'>first</span>    <span class='comment val'># = address1 or address2 depending on keys so probably isn't as expected</span>
  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='find_by_street identifier id'>find_by_street</span><span class='lparen token'>(</span><span class='string val'>&quot;My Street&quot;</span><span class='rparen token'>)</span> <span class='comment val'># = address1</span>
</pre>
<p>
As key generation is through a UUID scheme, the order can&#8217;t be
predicted. However you can order the results by default:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Address constant id'>Address</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:number</span><span class='comma token'>,</span> <span class='Integer constant id'>Integer</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:street</span><span class='comma token'>,</span> <span class='String constant id'>String</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:postcode</span> <span class='comment val'># Any generic type is fine as long as .to_json can be called on it</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:created_at</span><span class='comma token'>,</span> <span class='DateTime constant id'>DateTime</span>

    <span class='default_sort identifier id'>default_sort</span> <span class='symbol val'>:created_at</span>
  <span class='end end kw'>end</span>

  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='all identifier id'>all</span> <span class='comment val'># = [address1, address2]</span>
  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='first identifier id'>first</span>    <span class='comment val'># = address1 or address2, sorting is applied after results</span>
  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='lparen token'>(</span><span class='symbol val'>:use_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:created_at</span><span class='rparen token'>)</span> <span class='comment val'># = address1 but at the price of creating a new index</span>
</pre>
<p>
Conditions work slightly differently:
</p>
<pre class="code">
  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:conditions</span> <span class='lbrace token'>{</span><span class='symbol val'>:street</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;My Street&quot;</span><span class='rbrace token'>}</span><span class='rparen token'>)</span> <span class='comment val'># = address1, creates index on :street</span>
  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:conditions</span> <span class='lbrace token'>{</span><span class='symbol val'>:created_at</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;sometime&quot;</span><span class='rbrace token'>}</span><span class='rparen token'>)</span> <span class='comment val'># Uses same index as :use_key =&gt; :created_at</span>
  <span class='Address constant id'>Address</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:use_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:street</span><span class='comma token'>,</span> <span class='symbol val'>:startkey</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'p'</span><span class='rparen token'>)</span> <span class='comment val'># All streets from p in alphabet, reuses the index created 2 lines up</span>
</pre>
<p>
As well as providing support for people using relational databases,
CouchFoo attempts to provide a library for those wanting to use CouchDB as
a document-oriented database:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Document constant id'>Document</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:number</span><span class='comma token'>,</span> <span class='Integer constant id'>Integer</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:street</span><span class='comma token'>,</span> <span class='String constant id'>String</span>

    <span class='view identifier id'>view</span> <span class='symbol val'>:number_ordered</span><span class='comma token'>,</span> <span class='string val'>&quot;function(doc) {emit([doc.number , doc.street], doc); }&quot;</span><span class='comma token'>,</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='symbol val'>:descending</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>
  <span class='end end kw'>end</span>

  <span class='Document constant id'>Document</span><span class='dot token'>.</span><span class='number_ordered identifier id'>number_ordered</span><span class='lparen token'>(</span><span class='symbol val'>:limit</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>75</span><span class='rparen token'>)</span> <span class='comment val'># Will get the last 75 documents in the database ordered by number, street attributes</span>
</pre>
<p>
Associations work as expected but you must to remember to add the
properties required for an association (we&#8217;ll make this automatic
soon):
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='House constant id'>House</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
        <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:windows</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='Window constant id'>Window</span> <span class='lt op'>&lt;</span> <span class='CouchFoo constant id'>CouchFoo</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='property identifier id'>property</span> <span class='symbol val'>:house_id</span><span class='comma token'>,</span> <span class='String constant id'>String</span>
        <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:house</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Credits</h2>
<p>
This gem was inspired some excellent work on CouchPotato, CouchREST,
ActiveCouch and RelaxDB gems. Each offered its own benefits and own
challenges. After hacking with each I couldn&#8217;t get a library was
happy with. So I started with ActiveRecord and modified it to work with
CouchDB. Some areas required more work than others but a lot of features
were achieved for free once the base level of functionality had been
achieved. Credit to DHH, the rails core guys and the CouchDB gems that
inspired this work.
</p>
<h2>What&#8217;s left to do?</h2>
<p>
Please feel free to fork and hit me with a request to merge back in. At the
moment, the following areas need addressing:
</p>
<ul>
<li>Proper integration with rails using a couchdb.yml config file

</li>
<li>Example ruby script for updating indexes as an external process, and the
same for database compacting

</li>
<li>:include for database queries

</li>
<li>Remove dependency from CouchRest - keep support for both CouchDB 0.8 and
0.9 for now. Add support for attachments and log calls to server so know
performance times. General tidy up of database.rb. Add support for etags?

</li>
<li>inline and HABTM inline associations. Also x_id and x_type properties
should be automatically defined

</li>
<li>compatability with willpaginate and friends

</li>
<li>cleanup of associations, reflection, validations classes (were modified in
a rush)

</li>
<li>has_many :through

</li>
<li>Rest of calculations, timezones, aggregations and fixtures

</li>
<li>Diff with AR to check got everything in

</li>
<li>DataMapper interface

</li>
<li>Tool to migrate DB from MySQL to CouchDB

</li>
<li>some kind of generic admin interface where can just browse around data
structure?

</li>
<li>grep of code and doc for records and columns, should be documents and
attributes

</li>
</ul>

</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
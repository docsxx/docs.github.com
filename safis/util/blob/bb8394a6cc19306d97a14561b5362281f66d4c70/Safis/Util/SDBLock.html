<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>safis's util - Class: Safis::Util::SDBLock - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/safis/commits/util/master" rel="alternate" title="Recent Commits to util:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("safis", "util", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='safis/util/blob/bb8394a6cc19306d97a14561b5362281f66d4c70' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='safis/util/blob/bb8394a6cc19306d97a14561b5362281f66d4c70' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("safis", "util", "bb8394a6cc19306d97a14561b5362281f66d4c70", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/safis/util/tree/">Source</a></li>
            <li class=""><a href="http://github.com/safis/util/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/safis/util/network">Network</a></li>            
            <li class=""><a href="http://github.com/safis/util/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/safis/util">Wiki</a></li>
            <li class=""><a href="http://github.com/safis/util/graphs">Graphs</a></li>                    
            <li class="active"><a href="/safis/util">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/safis">safis</a> / <b><a href="http://github.com/safis/util/tree">util</a></b>        
                <a id="namespaces_button" rel="safis/util/blob/bb8394a6cc19306d97a14561b5362281f66d4c70" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="safis/util/blob/bb8394a6cc19306d97a14561b5362281f66d4c70" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section class Safis_Util_SDBLock">
  <h1>Class: Safis::Util::SDBLock</h1>
  <div class="section docstring">
  <p>
A distributed &quot;lock&quot; built on top of SDB
</p>

</div><div class="section constants">
  
</div><div class="section constructor">
<h2>Constructor</h2>
  <div id="initialize-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>initialize</span><span class='args'>(item_name, item_key, consumer, sdb_domain, timeout = 3600.0, acquire_period = 30.0)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Creates a SDBLock that writes to the specified item.
</p>

</div><div class="section tags">
  <h2>Meta Tags</h2>
  <div class="param">
  <h3>Parameters:</h3>
  <dl>
  
    
      <dt>
        <span class='type'>[<tt>String</tt>]</span>
        <span class='name'>item_name</span>
        
      </dt>
      <dd>
        <span class='desc'><p>
The item that we should write the lock to.
</p>
</span>
      </dd>
    
  
    
      <dt>
        <span class='type'>[<tt>String</tt>]</span>
        <span class='name'>item_key</span>
        
      </dt>
      <dd>
        <span class='desc'><p>
The key that should contain lock data.
</p>
</span>
      </dd>
    
  
    
      <dt>
        <span class='type'>[<tt>String</tt>]</span>
        <span class='name'>consumer</span>
        
      </dt>
      <dd>
        <span class='desc'><p>
An identifier that uniquely identifies this consumer.
</p>
</span>
      </dd>
    
  
    
      <dt>
        <span class='type'>[<tt>SDB::Domain</tt>]</span>
        <span class='name'>sdb_domain</span>
        
      </dt>
      <dd>
        <span class='desc'><p>
The SDB domain that the item resides within.
</p>
</span>
      </dd>
    
  
    
      <dt>
        <span class='type'>[<tt>Number</tt>]</span>
        <span class='name'>timeout</span>
        
      </dt>
      <dd>
        <span class='desc'><p>
How long we should wait for a previous lock to expire, in seconds.
</p>
</span>
      </dd>
    
  
    
      <dt>
        <span class='type'>[<tt>Number</tt>]</span>
        <span class='name'>acquire_period</span>
        
      </dt>
      <dd>
        <span class='desc'><p>
How long should we wait for SDB to replicate, in seconds.
</p>
</span>
      </dd>
    
  
  </dl>
</div>
</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/safis/util/sdb_lock.rb', line 34</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/safis/util/blob/bb8394a6cc19306d97a14561b5362281f66d4c70/lib/safis/util/sdb_lock.rb#L34">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">34
35
36
37
38
39
40
41</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='item_name identifier id'>item_name</span><span class='comma token'>,</span> <span class='item_key identifier id'>item_key</span><span class='comma token'>,</span> <span class='consumer identifier id'>consumer</span><span class='comma token'>,</span> <span class='sdb_domain identifier id'>sdb_domain</span><span class='comma token'>,</span> <span class='timeout identifier id'>timeout</span> <span class='assign token'>=</span> <span class='float val'>3600.0</span><span class='comma token'>,</span> <span class='acquire_period identifier id'>acquire_period</span> <span class='assign token'>=</span> <span class='float val'>30.0</span><span class='rparen token'>)</span>
  <span class='@item_name ivar id'>@item_name</span>      <span class='assign token'>=</span> <span class='item_name identifier id'>item_name</span>
  <span class='@item_key ivar id'>@item_key</span>       <span class='assign token'>=</span> <span class='item_key identifier id'>item_key</span>
  <span class='@consumer ivar id'>@consumer</span>       <span class='assign token'>=</span> <span class='consumer identifier id'>consumer</span>
  <span class='@domain ivar id'>@domain</span>         <span class='assign token'>=</span> <span class='sdb_domain identifier id'>sdb_domain</span>
  <span class='@acquire_period ivar id'>@acquire_period</span> <span class='assign token'>=</span> <span class='acquire_period identifier id'>acquire_period</span>
  <span class='@timeout ivar id'>@timeout</span>        <span class='assign token'>=</span> <span class='timeout identifier id'>timeout</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#remotely_locked-3F-instance_method">#remotely_locked?</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Is this locked by another consumer?.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#try_lock-instance_method">#try_lock</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Attempts to acquire a lock.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#unlock-instance_method">#unlock</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>remotely_locked?</h3>
</div><div id="remotely_locked-3F-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>remotely_locked?</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Is this locked by another consumer?
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/safis/util/sdb_lock.rb', line 94</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/safis/util/blob/bb8394a6cc19306d97a14561b5362281f66d4c70/lib/safis/util/sdb_lock.rb#L94">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='remotely_locked? fid id'>remotely_locked?</span>
  <span class='existing identifier id'>existing</span> <span class='assign token'>=</span> <span class='@domain ivar id'>@domain</span><span class='dot token'>.</span><span class='get identifier id'>get</span><span class='lparen token'>(</span><span class='@item_name ivar id'>@item_name</span><span class='comma token'>,</span> <span class='@item_key ivar id'>@item_key</span><span class='rparen token'>)</span>
  
  <span class='return return kw'>return</span> <span class='false false kw'>false</span> <span class='if if_mod kw'>if</span> <span class='existing identifier id'>existing</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='lbrack token'>[</span><span class='@item_name ivar id'>@item_name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='or or kw'>or</span> <span class='existing identifier id'>existing</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='lbrack token'>[</span><span class='@item_name ivar id'>@item_name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='@item_key ivar id'>@item_key</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
  
  <span class='comment val'># parse this as a YAML block</span>
  <span class='begin begin kw'>begin</span>
    <span class='lock_data_string identifier id'>lock_data_string</span> <span class='assign token'>=</span> <span class='existing identifier id'>existing</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='lbrack token'>[</span><span class='@item_name ivar id'>@item_name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='@item_key ivar id'>@item_key</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
    <span class='lock_data identifier id'>lock_data</span>        <span class='assign token'>=</span> <span class='YAML constant id'>YAML</span><span class='dot token'>.</span><span class='load identifier id'>load</span><span class='lparen token'>(</span><span class='lock_data_string identifier id'>lock_data_string</span><span class='rparen token'>)</span>
    <span class='lock_expiry identifier id'>lock_expiry</span>      <span class='assign token'>=</span> <span class='lock_data identifier id'>lock_data</span><span class='lbrack token'>[</span><span class='symbol val'>:timestamp</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='@timeout ivar id'>@timeout</span>
    
    <span class='comment val'># do we own the lock, or has it expired?</span>
    <span class='if if kw'>if</span> <span class='lparen token'>(</span> <span class='lock_data identifier id'>lock_data</span><span class='lbrack token'>[</span><span class='symbol val'>:consumer</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='@consumer ivar id'>@consumer</span> <span class='or or kw'>or</span> <span class='lock_expiry identifier id'>lock_expiry</span> <span class='lt op'>&lt;</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span> <span class='rparen token'>)</span> <span class='then then kw'>then</span>
      <span class='return return kw'>return</span> <span class='false false kw'>false</span>
    <span class='end end kw'>end</span>
    
  <span class='rescue rescue kw'>rescue</span> <span class='Exception constant id'>Exception</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='err identifier id'>err</span>
    <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='dstring node'>&quot;Unable to parse remote lock: #{err}&quot;</span><span class='comma token'>,</span> <span class='lock_data_string identifier id'>lock_data_string</span>
    <span class='comment val'># we don't want to be stuck</span>
    <span class='return return kw'>return</span> <span class='false false kw'>false</span>
  <span class='end end kw'>end</span>
  
  <span class='return return kw'>return</span> <span class='true true kw'>true</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>try_lock</h3>
</div><div id="try_lock-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>try_lock</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Attempts to acquire a lock.
</p>
<p>
PLEASE NOTE: This makes the assumption that all the consumer&#8217;s clocks
are relatively in sync! If a consumer has previously acquired this lock,
but hasn&#8217;t release it yet, we will override that lock if it took
longer than the timeout (according to our local clock).
</p>
<p>
This writes to SDB, indicating that this consumer intends to perform the
lock. It then waits for the amount of time specified by the acquire_period,
in hopes that SDB has fully replicated in that time. Finally, the lock
checks the current value in SDB. If the value is the one we placed there,
we have acquired the lock.
</p>
<p>
If the lock could not be acquired, this raises a LockAcquireError.
</p>

</div><div class="section tags">
  <h2>Meta Tags</h2>
  <div class="raise">
  <h3>Raises:</h3>
  <dl>
  
    <dt>
      
        <span class='type'>[<tt><a href="SDBLock/LockAcquireError.html" title="LockAcquireError">LockAcquireError</a></tt>]</span>
      
      
      
    </dt>
    <dd>
      <span class='desc'></span>
    </dd>
  
  </dl>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/safis/util/sdb_lock.rb', line 55</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/safis/util/blob/bb8394a6cc19306d97a14561b5362281f66d4c70/lib/safis/util/sdb_lock.rb#L55">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='try_lock identifier id'>try_lock</span>
    <span class='comment val'># Does someone have this lock?</span>
    <span class='raise identifier id'>raise</span> <span class='LockAcquireError constant id'>LockAcquireError</span><span class='comma token'>,</span> <span class='string val'>'Another consumer already has this lock.'</span> <span class='if if_mod kw'>if</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='remotely_locked? fid id'>remotely_locked?</span>
    
    <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;Attempting to acquire lock: #{@item_name}/#{@item_key}&quot;</span>
    
    <span class='lock_data identifier id'>lock_data</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span>
      <span class='symbol val'>:timestamp</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='comma token'>,</span>
      <span class='symbol val'>:consumer</span>  <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@consumer ivar id'>@consumer</span><span class='comma token'>,</span>
    <span class='rbrace token'>}</span>
    <span class='@current_lock ivar id'>@current_lock</span> <span class='assign token'>=</span> <span class='lock_data identifier id'>lock_data</span><span class='dot token'>.</span><span class='to_yaml identifier id'>to_yaml</span>
    
    <span class='@domain ivar id'>@domain</span><span class='dot token'>.</span><span class='replace identifier id'>replace</span><span class='lparen token'>(</span><span class='@item_name ivar id'>@item_name</span><span class='comma token'>,</span> <span class='@item_key ivar id'>@item_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@current_lock ivar id'>@current_lock</span><span class='rparen token'>)</span>
    
    <span class='comment val'># Then sleep</span>
    <span class='sleep_until identifier id'>sleep_until</span> <span class='assign token'>=</span> <span class='lock_data identifier id'>lock_data</span><span class='lbrack token'>[</span><span class='symbol val'>:timestamp</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='@acquire_period ivar id'>@acquire_period</span>
    <span class='while while kw'>while</span> <span class='lparen token'>(</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span> <span class='lt op'>&lt;</span> <span class='sleep_until identifier id'>sleep_until</span> <span class='rparen token'>)</span> <span class='do do kw'>do</span>
      <span class='remainder identifier id'>remainder</span> <span class='assign token'>=</span> <span class='sleep_until identifier id'>sleep_until</span> <span class='minus op'>-</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span>
      <span class='sleep identifier id'>sleep</span><span class='lparen token'>(</span><span class='remainder identifier id'>remainder</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    
    <span class='comment val'># do we still have the lock?</span>
    <span class='raise identifier id'>raise</span> <span class='LockAcquireError constant id'>LockAcquireError</span><span class='comma token'>,</span> <span class='string val'>'Another consumer overrode our lock.'</span> <span class='if if_mod kw'>if</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='remotely_locked? fid id'>remotely_locked?</span>
    
    <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;Successfully acquired lock: #{@item_name}/#{@item_key}&quot;</span>
    
    <span class='comment val'># for chaining</span>
    <span class='return return kw'>return</span> <span class='self self kw'>self</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='unlock identifier id'>unlock</span>
    <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='dstring node'>&quot;Releasing lock: #{@item_name}/#{@item_key}&quot;</span>
    
    <span class='@domain ivar id'>@domain</span><span class='dot token'>.</span><span class='delete identifier id'>delete</span><span class='lparen token'>(</span><span class='@item_name ivar id'>@item_name</span><span class='comma token'>,</span> <span class='@item_key ivar id'>@item_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@current_lock ivar id'>@current_lock</span><span class='rparen token'>)</span>
    
    <span class='@current_lock ivar id'>@current_lock</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='end end kw'>end</span>
  
  <span class='comment val'># Is this locked by another consumer?</span>
  <span class='def def kw'>def</span> <span class='remotely_locked? fid id'>remotely_locked?</span>
    <span class='existing identifier id'>existing</span> <span class='assign token'>=</span> <span class='@domain ivar id'>@domain</span><span class='dot token'>.</span><span class='get identifier id'>get</span><span class='lparen token'>(</span><span class='@item_name ivar id'>@item_name</span><span class='comma token'>,</span> <span class='@item_key ivar id'>@item_key</span><span class='rparen token'>)</span>
    
    <span class='return return kw'>return</span> <span class='false false kw'>false</span> <span class='if if_mod kw'>if</span> <span class='existing identifier id'>existing</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='lbrack token'>[</span><span class='@item_name ivar id'>@item_name</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='or or kw'>or</span> <span class='existing identifier id'>existing</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='lbrack token'>[</span><span class='@item_name ivar id'>@item_name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='@item_key ivar id'>@item_key</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    
    <span class='comment val'># parse this as a YAML block</span>
    <span class='begin begin kw'>begin</span>
      <span class='lock_data_string identifier id'>lock_data_string</span> <span class='assign token'>=</span> <span class='existing identifier id'>existing</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='lbrack token'>[</span><span class='@item_name ivar id'>@item_name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='@item_key ivar id'>@item_key</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
      <span class='lock_data identifier id'>lock_data</span>        <span class='assign token'>=</span> <span class='YAML constant id'>YAML</span><span class='dot token'>.</span><span class='load identifier id'>load</span><span class='lparen token'>(</span><span class='lock_data_string identifier id'>lock_data_string</span><span class='rparen token'>)</span>
      <span class='lock_expiry identifier id'>lock_expiry</span>      <span class='assign token'>=</span> <span class='lock_data identifier id'>lock_data</span><span class='lbrack token'>[</span><span class='symbol val'>:timestamp</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='@timeout ivar id'>@timeout</span>
      
      <span class='comment val'># do we own the lock, or has it expired?</span>
      <span class='if if kw'>if</span> <span class='lparen token'>(</span> <span class='lock_data identifier id'>lock_data</span><span class='lbrack token'>[</span><span class='symbol val'>:consumer</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='@consumer ivar id'>@consumer</span> <span class='or or kw'>or</span> <span class='lock_expiry identifier id'>lock_expiry</span> <span class='lt op'>&lt;</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span> <span class='rparen token'>)</span> <span class='then then kw'>then</span>
        <span class='return return kw'>return</span> <span class='false false kw'>false</span>
      <span class='end end kw'>end</span>
      
    <span class='rescue rescue kw'>rescue</span> <span class='Exception constant id'>Exception</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='err identifier id'>err</span>
      <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='warn identifier id'>warn</span> <span class='dstring node'>&quot;Unable to parse remote lock: #{err}&quot;</span><span class='comma token'>,</span> <span class='lock_data_string identifier id'>lock_data_string</span>
      <span class='comment val'># we don't want to be stuck</span>
      <span class='return return kw'>return</span> <span class='false false kw'>false</span>
    <span class='end end kw'>end</span>
    
    <span class='return return kw'>return</span> <span class='true true kw'>true</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>unlock</h3>
</div><div id="unlock-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>unlock</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/safis/util/sdb_lock.rb', line 85</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/safis/util/blob/bb8394a6cc19306d97a14561b5362281f66d4c70/lib/safis/util/sdb_lock.rb#L85">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">85
86
87
88
89
90
91</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='unlock identifier id'>unlock</span>
  <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='dstring node'>&quot;Releasing lock: #{@item_name}/#{@item_key}&quot;</span>
  
  <span class='@domain ivar id'>@domain</span><span class='dot token'>.</span><span class='delete identifier id'>delete</span><span class='lparen token'>(</span><span class='@item_name ivar id'>@item_name</span><span class='comma token'>,</span> <span class='@item_key ivar id'>@item_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@current_lock ivar id'>@current_lock</span><span class='rparen token'>)</span>
  
  <span class='@current_lock ivar id'>@current_lock</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
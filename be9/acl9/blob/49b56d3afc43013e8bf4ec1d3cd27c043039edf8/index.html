<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>be9's acl9 - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/be9/commits/acl9/master" rel="alternate" title="Recent Commits to acl9:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("be9", "acl9", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='be9/acl9/blob/49b56d3afc43013e8bf4ec1d3cd27c043039edf8' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='be9/acl9/blob/49b56d3afc43013e8bf4ec1d3cd27c043039edf8' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("be9", "acl9", "49b56d3afc43013e8bf4ec1d3cd27c043039edf8", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/be9/acl9/tree/">Source</a></li>
            <li class=""><a href="http://github.com/be9/acl9/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/be9/acl9/network">Network</a></li>            
            <li class=""><a href="http://github.com/be9/acl9/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/be9/acl9">Wiki</a></li>
            <li class=""><a href="http://github.com/be9/acl9/graphs">Graphs</a></li>                    
            <li class="active"><a href="/be9/acl9">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/be9">be9</a> / <b><a href="http://github.com/be9/acl9/tree">acl9</a></b>        
                <a id="namespaces_button" rel="be9/acl9/blob/49b56d3afc43013e8bf4ec1d3cd27c043039edf8" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="be9/acl9/blob/49b56d3afc43013e8bf4ec1d3cd27c043039edf8" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>Acl9</h1>
<p>Acl9 is yet another solution for role-based authorization in Rails. It consists of two<br />
subsystems which can be used separately.</p>
<p><strong>Role control subsystem</strong> allows you to set and query user roles for various objects.</p>
<p><strong>Access control subsystem</strong> allows you to specify different role-based access rules<br />
inside controllers.</p>
<p>A bunch of access rules is translated into a complex<br />
boolean expression. Then it&#8217;s turned into a lambda or a method and can<br />
be used with <code>before_filter</code>. Thus you can block unprivileged access to certain<br />
actions of your controller.</p>
<p>An example:</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='VerySecretController constant id'>VerySecretController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span>
    <span class='access_control identifier id'>access_control</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:superadmin</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:owner</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:secret</span>

      <span class='action identifier id'>action</span> <span class='symbol val'>:index</span> <span class='do do kw'>do</span>
        <span class='allow identifier id'>allow</span> <span class='anonymous identifier id'>anonymous</span><span class='comma token'>,</span> <span class='logged_in identifier id'>logged_in</span>
      <span class='end end kw'>end</span>

      <span class='allow identifier id'>allow</span> <span class='logged_in identifier id'>logged_in</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:show</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:manager</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:secret</span><span class='comma token'>,</span> <span class='symbol val'>:except</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:delete</span><span class='comma token'>,</span> <span class='symbol val'>:destroy</span><span class='rbrack token'>]</span>
      <span class='deny identifier id'>deny</span> <span class='symbol val'>:thiefs</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='index identifier id'>index</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># ...</span>
  <span class='end end kw'>end</span>
</pre>
<h1>Contacts</h1>
<p>Acl9 is hosted <a href="http://github.com/be9/acl9">on the GitHub</a>.</p>
<p>You may find tutorials and additional docs on the <a href="http://wiki.github.com/be9/acl9">wiki page</a>.</p>
<p>Rdocs are available <a href="http://rdoc.info/projects/be9/acl9">here</a>.</p>
<p>If you have questions, please post to the <br />
<a href="http://groups.google.com/group/acl9-discuss">acl9-discuss group</a></p>
<h1>Installation</h1>
<p>Acl9 can be installed as a gem from <a href="http://github.com">GitHub</a>.</p>
<p>Add the following line to your <code>config/environment.rb</code>:</p>
<pre class="code">
  <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='gem identifier id'>gem</span> <span class='string val'>&quot;be9-acl9&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:source</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;http://gems.github.com&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:lib</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;acl9&quot;</span>
</pre><p></code></p>
<p>Then run <code>rake gems:install</code> (with possible <code>rake gems:unpack</code> thereafter) and you&#8217;re done!</p>
<p>Alternatively you can install Acl9 as a plugin:</p>
<pre class="code">
  <span class='script identifier id'>script</span><span class='div op'>/</span><span class='plugin identifier id'>plugin</span> <span class='install identifier id'>install</span> <span class='git identifier id'>git</span><span class='symbol val'>:/</span><span class='regexp val'>/github.com/</span><span class='be9 identifier id'>be9</span><span class='div op'>/</span><span class='acl9 identifier id'>acl9</span><span class='dot token'>.</span><span class='git identifier id'>git</span>
</pre><p></code></p>
<h1>Basics</h1>
<h2>Authorization is not authentication!</h2>
<p>Both words start with &#8220;auth&#8221; but have different meaning!</p>
<p><strong>Authentication</strong> is basically a mapping of credentials (username, password) or<br />
OpenID to specific user account in the system.</p>
<p><strong>Authorization</strong> is an <em>authenticated</em> user&#8217;s permission to perform some<br />
specific action somewhere in the system.</p>
<p>Acl9 is a authorization solution, so you will need to implement authentication<br />
by other means. I recommend <a href="http://github.com/binarylogic/authlogic">Authlogic</a><br />
for that purpose, as it&#8217;s simple, clean and at the same time very configurable.</p>
<h2>Roles</h2>
<p>Role is an abstraction. You could directly assign permissions to user accounts in <br />
your system, but you&#8217;d not want to! Way more manageable solution is to assign permissions<br />
to roles and roles further to users.</p>
<p>For example, you can have role called <em>admin</em> which has all available permissions. Now<br />
you may assign this role to several trusted accounts on your system.</p>
<p>Acl9 also supports the notion of <em>object roles</em>, that is, roles with limited scope.</p>
<p>Imagine we are building a magazine site and want to develop a permission system. So, what roles<br />
and permissions are there?</p>
<p><em>Journalists</em> should be able to create articles in their section and edit their own articles.</p>
<p><em>Section editors</em> should be able to edit and delete all articles in their sections and<br />
change the <em>published</em> flag.</p>
<p><em>Editor-in-chief</em> should be able to change everything.</p>
<p>We clearly see that journalists and section editors are tied to a specific section, whereas<br />
editor-in-chief is a role with global scope.</p>
<h2>Role interface</h2>
<p>All permission checks in Acl9 are boiled down to calls of a single method:</p>
<p><code>subject.has_role?(role, object)</code></p>
<p>That should be read as &#8220;Does <em>subject</em> have <em>role</em> on <em>object</em>?&#8221;.</p>
<p>Subject is an instance of a <code>User</code>, or <code>Account</code>, or whatever model you use for<br />
authentication.  Object is an instance of any class (including subject class!)<br />
or <code>nil</code> (in which case it&#8217;s a global role).</p>
<p>Acl9 builtin role control subsystem provides <code>has_role?</code> method for you, but you can<br />
also implemented it by hand (see <em>Coming up with your own role implementation</em> below).</p>
<h1>Acl9 role control subsystem</h1>
<p>Role control subsystem has been lifted from <br />
<a href="http://github.com/DocSavage/rails-authorization-plugin">Rails authorization plugin</a>, <br />
but undergone some modifications.</p>
<p>It&#8217;s based on two tables in the database. First, role table, which stores pairs <code>[role_name, object]</code><br />
where object is a polymorphic model instance or a class. Second, join table, which joins users and roles.</p>
<p>To use this subsystem, you should define a <code>Role</code> model.</p>
<h2>Role model</h2>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Role constant id'>Role</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_role identifier id'>acts_as_authorization_role</span>
  <span class='end end kw'>end</span>
</pre>
<p>The structure of <code>roles</code> table is as follows:</p>
<pre class="code">
  <span class='create_table identifier id'>create_table</span> <span class='string val'>&quot;roles&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:force</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='t identifier id'>t</span><span class='bitor op'>|</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='string identifier id'>string</span>   <span class='string val'>&quot;name&quot;</span><span class='comma token'>,</span>              <span class='symbol val'>:limit</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>40</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='string identifier id'>string</span>   <span class='string val'>&quot;authorizable_type&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:limit</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>40</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='integer identifier id'>integer</span>  <span class='string val'>&quot;authorizable_id&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='string val'>&quot;created_at&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='string val'>&quot;updated_at&quot;</span>
  <span class='end end kw'>end</span>
</pre>
<p>Note that you will almost never use the <code>Role</code> class directly.</p>
<h2>Subject model</h2>
<pre class="code">
  <span class='class class kw'>class</span> <span class='User constant id'>User</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_subject identifier id'>acts_as_authorization_subject</span>
  <span class='end end kw'>end</span>
</pre>
<p>You won&#8217;t need any specific columns in the <code>users</code> table, but <br />
there should be a join table:</p>
<pre class="code">
  <span class='create_table identifier id'>create_table</span> <span class='string val'>&quot;roles_users&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='comma token'>,</span> <span class='symbol val'>:force</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='t identifier id'>t</span><span class='bitor op'>|</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='integer identifier id'>integer</span>  <span class='string val'>&quot;user_id&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='integer identifier id'>integer</span>  <span class='string val'>&quot;role_id&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='string val'>&quot;created_at&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='string val'>&quot;updated_at&quot;</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Object model</h2>
<p>Place <code>acts_as_authorization_object</code> call inside any model you want to act<br />
as such.</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Foo constant id'>Foo</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_object identifier id'>acts_as_authorization_object</span>
  <span class='end end kw'>end</span>
  
  <span class='class class kw'>class</span> <span class='Bar constant id'>Bar</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_object identifier id'>acts_as_authorization_object</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Interface</h2>
<h3>Subject model</h3>
<p>A call of <code>acts_as_authorization_subject</code> defines following methods on the model:</p>
<p><code>subject.has_role?(role, object = nil)</code>. Returns <code>true</code> of <code>false</code> (has or has not).</p>
<p><code>subject.has_role!(role, object = nil)</code>. Assigns a <code>role</code> for the <code>object</code> to the <code>subject</code>. <br />
Does nothing is subject already has such a role.</p>
<p><code>subject.has_no_role!(role, object = nil)</code>. Unassigns a role from the <code>subject</code>.</p>
<p><code>subject.has_roles_for?(object)</code>. Does the <code>subject</code> has any roles for <code>object</code>? (<code>true</code> of <code>false</code>)</p>
<p><code>subject.has_role_for?(object)</code>. Same as <code>has_roles_for?</code>.</p>
<p><code>subject.roles_for(object)</code>. Returns an array of <code>Role</code> instances, corresponding to <code>subject</code> &#8217;s roles on<br />
<code>object</code>. E.g. <code>subject.roles_for(object).map(&amp;:name).sort</code> will give you role names in alphabetical order.</p>
<p><code>subject.has_no_roles_for!(object)</code>. Unassign any <code>subject</code> &#8217;s roles for a given <code>object</code>.</p>
<p><code>subject.has_no_roles!</code>. Unassign all roles from <code>subject</code>.</p>
<h3>Object model</h3>
<p>A call of <code>acts_as_authorization_object</code> defines following methods on the model:</p>
<p><code>object.accepts_role?(role_name, subject)</code>. An alias for <code>subject.has_role?(role_name, object)</code>.</p>
<p><code>object.accepts_role!(role_name, subject)</code>. An alias for <code>subject.has_role!(role_name, object)</code>.</p>
<p><code>object.accepts_no_role!(role_name, subject)</code>. An alias for <code>subject.has_no_role!(role_name, object)</code>.<br />
      <br />
<code>object.accepts_roles_by?(subject)</code>. An alias for <code>subject.has_roles_for?(object)</code>.</p>
<p><code>object.accepts_role_by?(subject)</code>. Same as <code>accepts_roles_by?</code>.</p>
<p><code>object.accepts_roles_by(subject)</code>. An alias for <code>subject.roles_for(object)</code>.</p>
<h2>Custom class names</h2>
<p>You may want to deviate from default <code>User</code> and <code>Role</code> class names. That can easily be done with<br />
arguments to <code>acts_as_...</code>.</p>
<p>Say, you have <code>Account</code> and <code>AccountRole</code>:</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Account constant id'>Account</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_subject identifier id'>acts_as_authorization_subject</span> <span class='symbol val'>:role_class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'AccountRole'</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='AccountRole constant id'>AccountRole</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_role identifier id'>acts_as_authorization_role</span> <span class='symbol val'>:subject_class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'Account'</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='FooBar constant id'>FooBar</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_object identifier id'>acts_as_authorization_object</span> <span class='symbol val'>:role_class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'AccountRole'</span><span class='comma token'>,</span> <span class='symbol val'>:subject_class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'Account'</span>
  <span class='end end kw'>end</span>
</pre>
<p>Or&#8230; since Acl9 defaults can be changed in a special hash, you can put the following snippet:</p>
<pre class="code">
  <span class='Acl9 constant id'>Acl9</span><span class='colon2 op'>::</span><span class='config identifier id'>config</span><span class='dot token'>.</span><span class='merge! fid id'>merge!</span><span class='lparen token'>(</span><span class='lbrace token'>{</span>
    <span class='symbol val'>:default_role_class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'AccountRole'</span><span class='comma token'>,</span>
    <span class='symbol val'>:default_subject_class_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'Account'</span><span class='comma token'>,</span>
  <span class='rbrace token'>}</span><span class='rparen token'>)</span>
</pre>
<p>&#8230; into <code>config/initializers/acl9.rb</code> and get rid of that clunky arguments:</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Account constant id'>Account</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_subject identifier id'>acts_as_authorization_subject</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='AccountRole constant id'>AccountRole</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_role identifier id'>acts_as_authorization_role</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='FooBar constant id'>FooBar</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_authorization_object identifier id'>acts_as_authorization_object</span>
  <span class='end end kw'>end</span>
</pre>
<p>Note that you&#8217;ll need to change your database structure appropriately:</p>
<pre class="code">
  <span class='create_table identifier id'>create_table</span> <span class='string val'>&quot;account_roles&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:force</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='t identifier id'>t</span><span class='bitor op'>|</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='string identifier id'>string</span>   <span class='string val'>&quot;name&quot;</span><span class='comma token'>,</span>              <span class='symbol val'>:limit</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>40</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='string identifier id'>string</span>   <span class='string val'>&quot;authorizable_type&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:limit</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>40</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='integer identifier id'>integer</span>  <span class='string val'>&quot;authorizable_id&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='string val'>&quot;created_at&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='string val'>&quot;updated_at&quot;</span>
  <span class='end end kw'>end</span>
  
  <span class='create_table identifier id'>create_table</span> <span class='string val'>&quot;account_roles_accounts&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='comma token'>,</span> <span class='symbol val'>:force</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='t identifier id'>t</span><span class='bitor op'>|</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='integer identifier id'>integer</span>  <span class='string val'>&quot;account_id&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='integer identifier id'>integer</span>  <span class='string val'>&quot;account_role_id&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='string val'>&quot;created_at&quot;</span>
    <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='datetime identifier id'>datetime</span> <span class='string val'>&quot;updated_at&quot;</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Examples</h2>
<pre class="code">
  <span class='user identifier id'>user</span> <span class='assign token'>=</span> <span class='User constant id'>User</span><span class='dot token'>.</span><span class='create! fid id'>create!</span>
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='string val'>'admin'</span>              <span class='comment val'># =&gt; false</span>

  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role! fid id'>has_role!</span> <span class='symbol val'>:admin</span>

  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='symbol val'>:admin</span>               <span class='comment val'># =&gt; true</span>
</pre>
<p><code>user</code> now has global role <em>admin</em>. Note that you can specify role name either<br />
as a string or as a symbol.</p>
<pre class="code">
  <span class='foo identifier id'>foo</span> <span class='assign token'>=</span> <span class='Foo constant id'>Foo</span><span class='dot token'>.</span><span class='create! fid id'>create!</span>

  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='string val'>'admin'</span><span class='comma token'>,</span> <span class='foo identifier id'>foo</span>         <span class='comment val'># =&gt; false</span>

  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role! fid id'>has_role!</span> <span class='symbol val'>:manager</span><span class='comma token'>,</span> <span class='foo identifier id'>foo</span>
  
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='symbol val'>:manager</span><span class='comma token'>,</span> <span class='foo identifier id'>foo</span>        <span class='comment val'># =&gt; true</span>
  <span class='foo identifier id'>foo</span><span class='dot token'>.</span><span class='accepts_role? fid id'>accepts_role?</span> <span class='symbol val'>:manager</span><span class='comma token'>,</span> <span class='user identifier id'>user</span>    <span class='comment val'># =&gt; true</span>
  
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_roles_for? fid id'>has_roles_for?</span> <span class='foo identifier id'>foo</span>             <span class='comment val'># =&gt; true</span>
</pre>
<p>You can see here that global and object roles are distinguished from each other. User<br />
with global role <em>admin</em> isn&#8217;t automatically admin of <code>foo</code>.</p>
<p>However,</p>
<pre class="code">
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='symbol val'>:manager</span>             <span class='comment val'># =&gt; true</span>
</pre>
<p>That is, if you have an object role, it means that you have a global role with the same name too!<br />
In other words, you are <em>manager</em> if you manage at least one <code>foo</code> (or a <code>bar</code>&#8230;).</p>
<pre class="code">
  <span class='bar identifier id'>bar</span> <span class='assign token'>=</span> <span class='Bar constant id'>Bar</span><span class='dot token'>.</span><span class='create! fid id'>create!</span>

  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role! fid id'>has_role!</span> <span class='symbol val'>:manager</span><span class='comma token'>,</span> <span class='bar identifier id'>bar</span>
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_no_role! fid id'>has_no_role!</span> <span class='symbol val'>:manager</span><span class='comma token'>,</span> <span class='foo identifier id'>foo</span>

  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='symbol val'>:manager</span><span class='comma token'>,</span> <span class='foo identifier id'>foo</span>        <span class='comment val'># =&gt; false</span>
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='symbol val'>:manager</span>             <span class='comment val'># =&gt; true</span>
</pre>
<p>Our <code>user</code> is no more manager of <code>foo</code>, but has become a manager of <code>bar</code>.</p>
<pre class="code">
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_no_roles! fid id'>has_no_roles!</span>

  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='symbol val'>:manager</span>             <span class='comment val'># =&gt; false</span>
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span> <span class='symbol val'>:admin</span>               <span class='comment val'># =&gt; false</span>
  <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='roles identifier id'>roles</span>                          <span class='comment val'># =&gt; []</span>
</pre>
<p>At this time <code>user</code> has no roles in the system.</p>
<h2>Coming up with your own role implementation</h2>
<p>The described role system with its 2 tables (not counting the <code>users</code> table!)<br />
might be an overkill for many cases. If all you want is global roles without<br />
any scope, you&#8217;d better off implementing it by hand.</p>
<p>The access control subsystem of Acl9 uses only <code>subject.has_role?</code> method, so<br />
there&#8217;s no need to implement anything else except for own convenience.</p>
<p>For example, if each your user can have only one global role, just add <code>role</code><br />
column to your <code>User</code> class:</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='User constant id'>User</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='def def kw'>def</span> <span class='has_role? fid id'>has_role?</span><span class='lparen token'>(</span><span class='role_name identifier id'>role_name</span><span class='comma token'>,</span> <span class='obj identifier id'>obj</span><span class='assign token'>=</span><span class='nil nil kw'>nil</span><span class='rparen token'>)</span>
      <span class='self self kw'>self</span><span class='dot token'>.</span><span class='role identifier id'>role</span> <span class='eq op'>==</span> <span class='role_name identifier id'>role_name</span>
    <span class='end end kw'>end</span>
    
    <span class='def def kw'>def</span> <span class='has_role! fid id'>has_role!</span><span class='lparen token'>(</span><span class='role_name identifier id'>role_name</span><span class='comma token'>,</span> <span class='obj identifier id'>obj</span><span class='assign token'>=</span><span class='nil nil kw'>nil</span><span class='rparen token'>)</span>
      <span class='self self kw'>self</span><span class='dot token'>.</span><span class='role identifier id'>role</span> <span class='assign token'>=</span> <span class='role_name identifier id'>role_name</span>
      <span class='save! fid id'>save!</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>If you need to assign multiple roles to your users, you can use <code>serialize</code><br />
with role array or a special solution like<br />
<a href="http://github.com/brennandunn/preference_fu">preference_fu</a>.</p>
<h1>Access control subsystem</h1>
<p>By means of access control subsystem you can protect actions of your controller<br />
from unauthorized access. Acl9 provides a nice <span class="caps">DSL</span> for writing access rules.</p>
<h2>Allow and deny</h2>
<p>Access control is mostly about allowing and denying. So there are two  <br />
basic methods: <code>allow</code> and <code>deny</code>. They have the same syntax:</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='ROLE_LIST constant id'>ROLE_LIST</span><span class='comma token'>,</span> <span class='OPTIONS constant id'>OPTIONS</span>
  <span class='deny identifier id'>deny</span>  <span class='ROLE_LIST constant id'>ROLE_LIST</span><span class='comma token'>,</span> <span class='OPTIONS constant id'>OPTIONS</span>
</pre>
<h3>Specifying roles</h3>
<p>ROLE_LIST is a list of roles (at least 1 role should be there). So,</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:manager</span><span class='comma token'>,</span> <span class='symbol val'>:admin</span>
  <span class='deny identifier id'>deny</span>  <span class='symbol val'>:banned</span>
</pre>
<p>will match holders of global role <em>manager</em> <strong>and</strong> holders of global role <em>admin</em> as allowed.  <br />
On the contrary, holders of <em>banned</em> role will match as denied.</p>
<p>Basically this snippet is equivalent to</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:manager</span>
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:admin</span>
  <span class='deny identifier id'>deny</span>  <span class='symbol val'>:banned</span>
</pre>
<p>which means that roles in argument list are OR&#8217;ed for a match, and not AND&#8217;ed.</p>
<p>Also note that:</p>
<ul>
	<li>You may use both strings and :symbols to specify roles (the latter get converted into strings).</li>
	<li>Role names are singularized before check.</li>
</ul>
<p>Thus the snippet above can also be written as</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:managers</span><span class='comma token'>,</span> <span class='symbol val'>:admins</span>
  <span class='deny identifier id'>deny</span>  <span class='string val'>'banned'</span>
</pre>
<p>or even</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='mult op'>*</span><span class='dstring node'>%w(managers admins)</span>
  <span class='deny identifier id'>deny</span>  <span class='string val'>'banned'</span>
</pre>
<h3>Object and class roles</h3>
<p>Examples in the previous section were all about global roles. Let&#8217;s see how we can<br />
use object and class roles in the <span class="caps">ACL</span> block.</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:responsible</span><span class='comma token'>,</span> <span class='symbol val'>:for</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Widget constant id'>Widget</span>
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:possessor</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:foo</span>
  <span class='deny identifier id'>deny</span>  <span class='symbol val'>:angry</span><span class='comma token'>,</span> <span class='symbol val'>:at</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:me</span>
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:interested</span><span class='comma token'>,</span> <span class='symbol val'>:in</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Future constant id'>Future</span>
  <span class='deny identifier id'>deny</span>  <span class='symbol val'>:short</span><span class='comma token'>,</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:time</span>
  <span class='deny identifier id'>deny</span>  <span class='symbol val'>:hated</span><span class='comma token'>,</span> <span class='symbol val'>:by</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:us</span>
</pre>
<p>To specify an object you use one of the 6 preposition options:</p>
<ul>
	<li>:of</li>
	<li>:at</li>
	<li>:on</li>
	<li>:by</li>
	<li>:for</li>
	<li>:in</li>
</ul>
<p>They all have the same meaning, use one that makes better English out of your rule.</p>
<p>Now, each of these prepositions may point to a Class or a :symbol. In the former case we get<br />
a class role. E.g. <code>allow :responsible, :for =&gt; Widget</code> becomes <code>subject.has_role?('responsible', Widget)</code>.</p>
<p>Symbol is trickier, it means that the appropriate instance variable of the controller is taken<br />
as an object.</p>
<p><code>allow :possessor, :of =&gt; :foo</code> is translated into <br />
<code>subject.has_role?('possessor', controller.instance_variable_get('@foo'))</code>.</p>
<p>Checking against an instance variable has sense when you have another <em>before filter</em> which is executed<br />
<strong>before</strong> the one generated by <code>access_control</code>, like this:</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='MoorblesController constant id'>MoorblesController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span>
    <span class='before_filter identifier id'>before_filter</span> <span class='symbol val'>:load_moorble</span><span class='comma token'>,</span> <span class='symbol val'>:only</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:edit</span><span class='comma token'>,</span> <span class='symbol val'>:update</span><span class='comma token'>,</span> <span class='symbol val'>:destroy</span><span class='rbrack token'>]</span>

    <span class='access_control identifier id'>access_control</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:creator</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:moorble</span>

      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># ...</span>

    <span class='private identifier id'>private</span>

    <span class='def def kw'>def</span> <span class='load_moorble identifier id'>load_moorble</span>
      <span class='@moorble ivar id'>@moorble</span> <span class='assign token'>=</span> <span class='Moorble constant id'>Moorble</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:id</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>Note that the object option is applied to all of the roles you specify in the argument list.<br />
As such,</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:devil</span><span class='comma token'>,</span> <span class='symbol val'>:son</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='God constant id'>God</span>
</pre>
<p>is equivalent to</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:devil</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='God constant id'>God</span>
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:son</span><span class='comma token'>,</span>   <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='God constant id'>God</span>
</pre>
<p>but <strong><span class="caps">NOT</span></strong></p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:devil</span>
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:son</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='God constant id'>God</span>
</pre>
<h3>Pseudo-roles</h3>
<p>There are three pseudo-roles in the <span class="caps">ACL</span>: <code>all</code>, <code>anonymous</code> and <code>logged_in</code>.</p>
<p><code>allow all</code> will always match (as well as <code>deny all</code>).</p>
<p><code>allow anonymous</code> and <code>deny anonymous</code> will match when user is anonymous, i.e. subject is <code>nil</code>. <br />
You may also use a shorter notation: <code>allow nil</code> (<code>deny nil</code>).</p>
<p><code>logged_in</code> is direct opposite of <code>anonymous</code>, so <code>allow logged_in</code> will match if the user is logged in<br />
(subject is not <code>nil</code>).</p>
<p>No role checks are done in either case.</p>
<h3>Limiting action scope</h3>
<p>By default rules apply to all actions of the controller. There are two options that<br />
narrow the scope of the <code>deny</code> or <code>allow</code> rule: <code>:to</code> and <code>:except</code>.</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:owner</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:site</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:delete</span><span class='comma token'>,</span> <span class='symbol val'>:destroy</span><span class='rbrack token'>]</span>
  <span class='deny identifier id'>deny</span> <span class='anonymous identifier id'>anonymous</span><span class='comma token'>,</span> <span class='symbol val'>:except</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:index</span><span class='comma token'>,</span> <span class='symbol val'>:show</span><span class='rbrack token'>]</span>
</pre>
<p>For the first rule to match not only the current user should be an <em>owner</em> of the <em>site</em>, but also<br />
current action should be <em>delete</em> or <em>destroy</em>.</p>
<p>In the second rule anonymous user access is denied for all actions, except <em>index</em> and <em>show</em>.</p>
<p>You may not specify both <code>:to</code> and <code>:except</code>.</p>
<p>Note that you can use actions block instead of <code>:to</code> (see <em>Actions block</em><br />
below). You can also use <code>:only</code> and <code>:except</code> options in the<br />
<code>access_control</code> call which will serve as options of the <code>before_filter</code> and thus<br />
limit the scope of the whole <span class="caps">ACL</span>.</p>
<h3>Rule conditions</h3>
<p>You may create conditional rules using <code>:if</code> and <code>:unless</code> options.</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:owner</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:site</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:delete</span><span class='comma token'>,</span> <span class='symbol val'>:destroy</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:if</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:chance_to_delete</span>
</pre>
<p>Controller&#8217;s <code>:chance_to_delete</code> method will be called here. The rule will match if the action<br />
is &#8216;delete&#8217; or &#8216;destroy&#8217; <span class="caps">AND</span> if the method returned <code>true</code>.</p>
<p><code>:unless</code> has the opposite meaning and should return <code>false</code> for a rule to match.</p>
<p>Both options can be specified in the same rule.</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:visitor</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:index</span><span class='comma token'>,</span> <span class='symbol val'>:show</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:if</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:right_phase_of_the_moon?</span><span class='comma token'>,</span> <span class='symbol val'>:unless</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:suspicious?</span>
</pre>
<p><code>right_phase_of_the_moon?</code> should return <code>true</code> <span class="caps">AND</span> <code>suspicious?</code> should return <code>false</code> for a poor visitor to<br />
see a page.</p>
<p>Currently only controller methods are supported (specify them as :symbols). Lambdas are <strong>not</strong> supported.</p>
<h2>Rule matching order</h2>
<p>Rule matching system is similar to that of Apache web server. There are two modes: <em>default allow</em><br />
(corresponding to <code>Order Deny,Allow</code> in Apache) and <em>default deny</em> (<code>Order Allow,Deny</code> in Apache).</p>
<h3>Setting modes</h3>
<p>Mode is set with a <code>default</code> call.</p>
<p><code>default :allow</code> will set <em>default allow</em> mode.</p>
<p><code>default :deny</code> will set <em>default deny</em> mode. Note that this is the default mode, i.e. it will be on<br />
if you don&#8217;t do a <code>default</code> call at all.</p>
<h3>Matching algorithm</h3>
<p>First of all, regardless of the mode, all <code>allow</code> matches are OR&#8217;ed together and all <code>deny</code> matches<br />
are OR&#8217;ed as well.</p>
<p>We&#8217;ll express this in the following manner:</p>
<pre class="code">
  <span class='ALLOWED constant id'>ALLOWED</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='allow identifier id'>allow</span> <span class='rule identifier id'>rule</span> <span class='integer val'>1</span> <span class='matches? fid id'>matches?</span><span class='rparen token'>)</span> <span class='OR constant id'>OR</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='allow identifier id'>allow</span> <span class='rule identifier id'>rule</span> <span class='integer val'>2</span> <span class='matches? fid id'>matches?</span><span class='rparen token'>)</span> <span class='OR constant id'>OR</span> <span class='dot3 op'>...</span>
  <span class='NOT_DENIED constant id'>NOT_DENIED</span> <span class='assign token'>=</span> <span class='NOT constant id'>NOT</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='deny identifier id'>deny</span> <span class='rule identifier id'>rule</span> <span class='integer val'>1</span> <span class='matches? fid id'>matches?</span><span class='rparen token'>)</span> <span class='OR constant id'>OR</span> <span class='lparen token'>(</span><span class='deny identifier id'>deny</span> <span class='rule identifier id'>rule</span> <span class='integer val'>2</span> <span class='matches? fid id'>matches?</span><span class='rparen token'>)</span> <span class='OR constant id'>OR</span> <span class='dot3 op'>...</span><span class='rparen token'>)</span>
</pre>
<p>So, <span class="caps">ALLOWED</span> is <code>true</code> when either of the <code>allow</code> rules matches, and NOT_DENIED is <code>true</code> when none<br />
of the <code>deny</code> rules matches.</p>
<p>Let&#8217;s denote the final result of algorithm as <span class="caps">ALLOWANCE</span>. If it&#8217;s <code>true</code>, access is allowed, if <code>false</code> &#8211; denied.</p>
<p>In the case of <em>default allow</em>:<br />
<pre class="code">
  <span class='ALLOWANCE constant id'>ALLOWANCE</span> <span class='assign token'>=</span> <span class='ALLOWED constant id'>ALLOWED</span> <span class='OR constant id'>OR</span> <span class='NOT_DENIED constant id'>NOT_DENIED</span>
</pre></p>
<p>In the case of <em>default deny</em>:<br />
<pre class="code">
  <span class='ALLOWANCE constant id'>ALLOWANCE</span> <span class='assign token'>=</span> <span class='ALLOWED constant id'>ALLOWED</span> <span class='AND constant id'>AND</span> <span class='NOT_DENIED constant id'>NOT_DENIED</span>
</pre></p>
<p>Same result as a table:</p>
<table>
	<tr>
		<th>Rule matches </th>
		<th>Default allow mode </th>
		<th>Default deny mode </th>
	</tr>
	<tr>
		<td> None of the <code>allow</code> and <code>deny</code> rules matched. </td>
		<td> Access is allowed. </td>
		<td> Access is denied. </td>
	</tr>
	<tr>
		<td> Some of the <code>allow</code> rules matched, none of the <code>deny</code> rules matched. </td>
		<td> Access is allowed. </td>
		<td> Access is allowed. </td>
	</tr>
	<tr>
		<td> None of the <code>allow</code> rules matched, some of the <code>deny</code> rules matched. </td>
		<td> Access is denied. </td>
		<td> Access is denied. </td>
	</tr>
	<tr>
		<td> Some of the <code>allow</code> rules matched, some of the <code>deny</code> rules matched. </td>
		<td> Access is allowed. </td>
		<td> Access is denied. </td>
	</tr>
</table>
<p>Apparently <em>default deny</em> mode is more strict, and that&#8217;s because it&#8217;s on by default.</p>
<h2>Actions block</h2>
<p>You may group rules with the help of the <code>actions</code> block.</p>
<p>An example from the imaginary <code>PostsController</code>:</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:admin</span>
  
  <span class='actions identifier id'>actions</span> <span class='symbol val'>:index</span><span class='comma token'>,</span> <span class='symbol val'>:show</span> <span class='do do kw'>do</span>
    <span class='allow identifier id'>allow</span> <span class='all identifier id'>all</span>
  <span class='end end kw'>end</span>

  <span class='actions identifier id'>actions</span> <span class='symbol val'>:new</span><span class='comma token'>,</span> <span class='symbol val'>:create</span> <span class='do do kw'>do</span>
    <span class='allow identifier id'>allow</span> <span class='symbol val'>:managers</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Post constant id'>Post</span>
  <span class='end end kw'>end</span>

  <span class='actions identifier id'>actions</span> <span class='symbol val'>:edit</span><span class='comma token'>,</span> <span class='symbol val'>:update</span> <span class='do do kw'>do</span>
    <span class='allow identifier id'>allow</span> <span class='symbol val'>:owner</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:post</span>
  <span class='end end kw'>end</span>

  <span class='action identifier id'>action</span> <span class='symbol val'>:destroy</span> <span class='do do kw'>do</span>
    <span class='allow identifier id'>allow</span> <span class='symbol val'>:owner</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:post</span>
  <span class='end end kw'>end</span>
</pre>
<p>This is equivalent to:</p>
<pre class="code">
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:admin</span>
  
  <span class='allow identifier id'>allow</span> <span class='all identifier id'>all</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:index</span><span class='comma token'>,</span> <span class='symbol val'>:show</span><span class='rbrack token'>]</span>
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:managers</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Post constant id'>Post</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:new</span><span class='comma token'>,</span> <span class='symbol val'>:create</span><span class='rbrack token'>]</span>
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:owner</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:post</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:edit</span><span class='comma token'>,</span> <span class='symbol val'>:update</span><span class='rbrack token'>]</span>
  <span class='allow identifier id'>allow</span> <span class='symbol val'>:owner</span><span class='comma token'>,</span> <span class='symbol val'>:of</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:post</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:destroy</span>
</pre>
<p>Note that only <code>allow</code> and <code>deny</code> calls are available inside <code>actions</code> block, and these may not have<br />
<code>:to</code>/<code>:except</code> options.</p>
<p><code>action</code> is just a synonym for <code>actions</code>.</p>
<h2>access_control method</h2>
<p>By calling <code>access_control</code> in your controller you can get your <span class="caps">ACL</span> block translated into&#8230;</p>
<ol>
	<li>a lambda, installed with <code>before_filter</code> and raising <code>Acl9::AccessDenied</code> exception on occasion.</li>
	<li>a method, installed with <code>before_filter</code> and raising <code>Acl9::AccessDenied</code> exception on occasion.</li>
	<li>a method, returning <code>true</code> or <code>false</code>, whether access is allowed or denied.</li>
</ol>
<p>First case is by default. You can catch the exception with <code>rescue_from</code> call and do something <br />
you like: make a redirect, or render &#8220;Access denied&#8221; template, or whatever.</p>
<p>Second case is obtained with specifying method name as an argument to<br />
<code>access_control</code> (or using <code>:as_method</code> option, see below) and may be helpful<br />
if you want to use <code>skip_before_filter</code> somewhere in the derived controller.</p>
<p>Third case will take place if you supply <code>:filter =&gt; false</code> along with method<br />
name. You&#8217;ll get an ordinary method which you can call anywhere you want.</p>
<h3>:subject_method</h3>
<p>Acl9 obtains the subject instance by calling specific method of the controller. By default it&#8217;s <br />
<code>:current_user</code>, but you may change it.</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='MyController constant id'>MyController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:subject_method</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:current_account</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:nifty</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># ...</span>
  <span class='end end kw'>end</span>
</pre>
<p>Subject method can also be changed globally. Place the following into <code>config/initializers/acl9.rb</code>:</p>
<pre class="code">
  <span class='Acl9 constant id'>Acl9</span><span class='colon2 op'>::</span><span class='config identifier id'>config</span><span class='lbrack token'>[</span><span class='symbol val'>:default_subject_method</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='symbol val'>:current_account</span>
</pre>
<h3>:debug</h3>
<p><code>:debug =&gt; true</code> will output the filtering expression into the debug log. If<br />
Acl9 does something strange, you may look at it as the last resort.</p>
<h3>:as_method</h3>
<p>In the case</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='NiftyController constant id'>NiftyController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:as_method</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:acl</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:nifty</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># ...</span>
  <span class='end end kw'>end</span>
</pre>
<p>access control checks will be added as <code>acl</code> method onto MyController, with <code>before_filter :acl</code> call thereafter.</p>
<p>Instead of using <code>:as_method</code> you may specify the name of the method as a positional argument<br />
to <code>access_control</code>:</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='MyController constant id'>MyController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:acl</span> <span class='do do kw'>do</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># ...</span>
  <span class='end end kw'>end</span>
</pre>
<h3>:filter</h3>
<p>If you set <code>:filter</code> to <code>false</code> (it&#8217;s <code>true</code> by default) and also use<br />
<code>:as_method</code> (or method name as 1st argument to <code>access_control</code>, you&#8217;ll get a<br />
method which won&#8217;t raise <code>Acl9::AccessDenied</code> exception, but rather return<br />
<code>true</code> or <code>false</code> (access allowed/denied).</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='SecretController constant id'>SecretController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:secret_access?</span><span class='comma token'>,</span> <span class='symbol val'>:filter</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:james_bond</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='index identifier id'>index</span>
      <span class='if if kw'>if</span> <span class='secret_access? fid id'>secret_access?</span>
        <span class='_secret_index identifier id'>_secret_index</span>
      <span class='else else kw'>else</span>
        <span class='_ordinary_index identifier id'>_ordinary_index</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># ...</span>

    <span class='private identifier id'>private</span>

    <span class='def def kw'>def</span> <span class='_secret_index identifier id'>_secret_index</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>
    
    <span class='def def kw'>def</span> <span class='_ordinary_index identifier id'>_ordinary_index</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>The generated method can receive an objects hash as an argument. In this example,</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='LolController constant id'>LolController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:lolcats?</span><span class='comma token'>,</span> <span class='symbol val'>:filter</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:cats</span><span class='comma token'>,</span> <span class='symbol val'>:by</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:lol</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>you may not only call <code>lolcats?</code> with no arguments, which will basically return</p>
<pre class="code">
  <span class='current_user identifier id'>current_user</span><span class='dot token'>.</span><span class='has_role? fid id'>has_role?</span><span class='lparen token'>(</span><span class='string val'>'cats'</span><span class='comma token'>,</span> <span class='@lol ivar id'>@lol</span><span class='rparen token'>)</span>
</pre>
<p>but also as <code>lolcats?(:lol =&gt; Lol.find(params[:lol]))</code>. The hash will be looked into first,<br />
even if you have an instance variable <code>lol</code>.</p>
<h3>:helper</h3>
<p>Sometimes you want to have a boolean method (like <code>:filter =&gt; false</code>) accessible<br />
in your views. Acl9 can call <code>helper_method</code> for you:</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='LolController constant id'>LolController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:helper</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:lolcats?</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:cats</span><span class='comma token'>,</span> <span class='symbol val'>:by</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:lol</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>That&#8217;s equivalent to</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='LolController constant id'>LolController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:lolcats?</span><span class='comma token'>,</span> <span class='symbol val'>:filter</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:cats</span><span class='comma token'>,</span> <span class='symbol val'>:by</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:lol</span>
      <span class='comment val'># ...</span>
    <span class='end end kw'>end</span>

    <span class='helper_method identifier id'>helper_method</span> <span class='symbol val'>:lolcats?</span>
  <span class='end end kw'>end</span>
</pre>
<h3>Other options</h3>
<p>Other options will be passed to <code>before_filter</code>. As such, you may use <code>:only</code> and <code>:except</code> to narrow<br />
the action scope of the whole <span class="caps">ACL</span> block.</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='OmgController constant id'>OmgController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:only</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:index</span><span class='comma token'>,</span> <span class='symbol val'>:show</span><span class='rbrack token'>]</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='all identifier id'>all</span>
      <span class='deny identifier id'>deny</span> <span class='symbol val'>:banned</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># ...</span>
  <span class='end end kw'>end</span>
</pre>
<p>is basically equivalent to</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='OmgController constant id'>OmgController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span> 
    <span class='access_control identifier id'>access_control</span> <span class='do do kw'>do</span>
      <span class='actions identifier id'>actions</span> <span class='symbol val'>:index</span><span class='comma token'>,</span> <span class='symbol val'>:show</span> <span class='do do kw'>do</span>
        <span class='allow identifier id'>allow</span> <span class='all identifier id'>all</span>
        <span class='deny identifier id'>deny</span> <span class='symbol val'>:banned</span>
      <span class='end end kw'>end</span>

      <span class='allow identifier id'>allow</span> <span class='all identifier id'>all</span><span class='comma token'>,</span> <span class='symbol val'>:except</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:index</span><span class='comma token'>,</span> <span class='symbol val'>:show</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># ...</span>
  <span class='end end kw'>end</span>
</pre>
<h2>access_control in your helpers</h2>
<p>Apart from using <code>:helper</code> option for <code>access_control</code> call inside controller, there&#8217;s a<br />
way to generate helper methods directly, like this:</p>
<pre class="code">
  <span class='module module kw'>module</span> <span class='SettingsHelper constant id'>SettingsHelper</span>
    <span class='include identifier id'>include</span> <span class='Acl9Helpers constant id'>Acl9Helpers</span>

    <span class='access_control identifier id'>access_control</span> <span class='symbol val'>:show_settings?</span> <span class='do do kw'>do</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:admin</span>
      <span class='allow identifier id'>allow</span> <span class='symbol val'>:settings_manager</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>Here we mix in <code>Acl9Helpers</code> module which brings in <code>access_control</code> method and call it,<br />
obtaining <code>show_settings?</code> method.</p>
<p>An imaginary view:</p>
<pre class="code">
  <span class='lt op'>&lt;</span><span class='string val'>% if </span><span class='show_settings? fid id'>show_settings?</span> <span class='mod op'>%</span><span class='gt op'>&gt;</span>
    <span class='lt op'>&lt;</span><span class='string val'>%= link_to 'Settings', settings_path %&gt;
  &lt;% end %&gt;
</span></pre>
<p>Copyright &#169; 2009 Oleg Dashevskii, released under the <span class="caps">MIT</span> license.</p>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> 2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
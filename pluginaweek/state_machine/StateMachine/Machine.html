<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" charset="utf-8" />
<link rel="stylesheet" href="../syntax_highlight.css" type="text/css" charset="utf-8" />

    <script src="../jquery.js" type="text/javascript" charset="utf-8"></script>
    <script src="../app.js" type="text/javascript" charset="utf-8"></script>
    <title>Class: StateMachine::Machine</title>
  </head>
  <body>
    <div id="content">
      <div class="section class StateMachine_Machine">
  <h1 class="title">Class: StateMachine::Machine</h1>
  <div class="section mixins">
  <h1>Included Modules</h1>
  <p><a href='Machine/Assertions.html' title='StateMachine::Assertions'>StateMachine::Assertions</a>, <a href='Machine/MatcherHelpers.html' title='StateMachine::MatcherHelpers'>StateMachine::MatcherHelpers</a></p>
</div><div class="section docstring">
  <p>
Represents a state machine for a particular attribute. State machines
consist of states, events and a set of transitions that define how the
state changes after a particular event is fired.
</p>
<p>
A state machine will not know all of the possible states for an object
unless they are referenced <b>somewhere</b> in the state machine
definition. As a result, any unused states should be defined with the
<tt>other_states</tt> or <tt>state</tt> helper.
</p>
<h2>Actions</h2>
<p>
When an action is configured for a state machine, it is invoked when an
object transitions via an event. The success of the event becomes dependent
on the success of the action. If the action is successful, then the
transitioned state remains persisted. However, if the action fails (by
returning false), the transitioned state will be rolled back.
</p>
<p>
For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='attr_accessor identifier id'>attr_accessor</span> <span class='symbol val'>:fail</span><span class='comma token'>,</span> <span class='symbol val'>:saving_state</span>

    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:action</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:save</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:ignite</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span>
      <span class='end end kw'>end</span>

      <span class='event identifier id'>event</span> <span class='symbol val'>:park</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:idling</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='save identifier id'>save</span>
      <span class='@saving_state ivar id'>@saving_state</span> <span class='assign token'>=</span> <span class='state identifier id'>state</span>
      <span class='fail identifier id'>fail</span> <span class='neq op'>!=</span> <span class='true true kw'>true</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>     <span class='comment val'># =&gt; #&lt;Vehicle:0xb7c27024 @state=&quot;parked&quot;&gt;</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='save identifier id'>save</span>              <span class='comment val'># =&gt; true</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='saving_state identifier id'>saving_state</span>      <span class='comment val'># =&gt; &quot;parked&quot; # The state was &quot;parked&quot; was save was called</span>

  <span class='comment val'># Successful event</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='ignite identifier id'>ignite</span>            <span class='comment val'># =&gt; true</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='saving_state identifier id'>saving_state</span>      <span class='comment val'># =&gt; &quot;idling&quot; # The state was &quot;idling&quot; when save was called</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='state identifier id'>state</span>             <span class='comment val'># =&gt; &quot;idling&quot;</span>

  <span class='comment val'># Failed event</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='fail identifier id'>fail</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='park identifier id'>park</span>              <span class='comment val'># =&gt; false</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='saving_state identifier id'>saving_state</span>      <span class='comment val'># =&gt; &quot;parked&quot;</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='state identifier id'>state</span>             <span class='comment val'># =&gt; &quot;idling&quot;</span>
</pre>
<p>
As shown, even though the state is set prior to calling the <tt>save</tt>
action on the object, it will be rolled back to the original state if the
action fails. <b>Note</b> that this will also be the case if an exception
is raised while calling the action.
</p>
<h2>Callbacks</h2>
<p>
Callbacks are supported for hooking before and after every possible
transition in the machine. Each callback is invoked in the order in which
it was defined. See StateMachine::Machine#before_transition and
StateMachine::Machine#after_transition for documentation on how to define
new callbacks.
</p>
<p>
<b>Note</b> that callbacks only get executed within the context of an
event. As a result, if a class has an initial state when it&#8217;s
created, any callbacks that would normally get executed when the object
enters that state will <b>not</b> get triggered.
</p>
<p>
For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='after_transition identifier id'>after_transition</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
        <span class='raise identifier id'>raise</span> <span class='ArgumentError constant id'>ArgumentError</span>
      <span class='end end kw'>end</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>   <span class='comment val'># =&gt; #&lt;Vehicle id: 1, state: &quot;parked&quot;&gt;</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='save identifier id'>save</span>            <span class='comment val'># =&gt; true (no exception raised)</span>
</pre>
<p>
If you need callbacks to get triggered when an object is created, this
should be done by either:
</p>
<ul>
<li>Use a <tt>before :save</tt> or equivalent hook, or

</li>
<li>Set an initial state of nil and use the correct event to create the object
with the proper state, resulting in callbacks being triggered and the
object getting persisted

</li>
</ul>
<h3>Canceling callbacks</h3>
<p>
Callbacks can be canceled by throwing :halt at any point during the
callback. For example,
</p>
<pre class="code">
  <span class='dot3 op'>...</span>
  <span class='throw identifier id'>throw</span> <span class='symbol val'>:halt</span>
  <span class='dot3 op'>...</span>
</pre>
<p>
If a <tt>before</tt> callback halts the chain, the associated transition
and all later callbacks are canceled. If an <tt>after</tt> callback halts
the chain, the later callbacks are canceled, but the transition is still
successful.
</p>
<p>
<b>Note</b> that if a <tt>before</tt> callback fails and the bang version
of an event was invoked, an exception will be raised instead of returning
false. For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='any identifier id'>any</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lambda identifier id'>lambda</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='vehicle identifier id'>vehicle</span><span class='bitor op'>|</span> <span class='throw identifier id'>throw</span> <span class='symbol val'>:halt</span><span class='rbrace token'>}</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='park identifier id'>park</span>        <span class='comment val'># =&gt; false</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='park! fid id'>park!</span>       <span class='comment val'># =&gt; StateMachine::InvalidTransition: Cannot transition state via :park from &quot;idling&quot;</span>
</pre>
<h2>Observers</h2>
<p>
Observers, in the sense of external classes and <b>not</b> Ruby&#8217;s
Observable mechanism, can hook into state machines as well. Such observers
use the same callback api that&#8217;s used internally.
</p>
<p>
Below are examples of defining observers for the following state machine:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:park</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:idling</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span>
      <span class='end end kw'>end</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
    <span class='dot3 op'>...</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Event/Transition behaviors:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='VehicleObserver constant id'>VehicleObserver</span>
    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='before_park identifier id'>before_park</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='rparen token'>)</span>
      <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;#{vehicle} instructed to park... state is: #{transition.from}, state will be: #{transition.to}&quot;</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='after_park identifier id'>after_park</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='comma token'>,</span> <span class='result identifier id'>result</span><span class='rparen token'>)</span>
      <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;#{vehicle} instructed to park... state was: #{transition.from}, state is: #{transition.to}&quot;</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='before_transition identifier id'>before_transition</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='rparen token'>)</span>
      <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;#{vehicle} instructed to #{transition.event}... #{transition.attribute} is: #{transition.from}, #{transition.attribute} will be: #{transition.to}&quot;</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='after_transition identifier id'>after_transition</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='rparen token'>)</span>
      <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='dstring node'>&quot;#{vehicle} instructed to #{transition.event}... #{transition.attribute} was: #{transition.from}, #{transition.attribute} is: #{transition.to}&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
    <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:park</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='VehicleObserver constant id'>VehicleObserver</span><span class='dot token'>.</span><span class='method identifier id'>method</span><span class='lparen token'>(</span><span class='symbol val'>:before_park</span><span class='rparen token'>)</span>
    <span class='before_transition identifier id'>before_transition</span> <span class='VehicleObserver constant id'>VehicleObserver</span><span class='dot token'>.</span><span class='method identifier id'>method</span><span class='lparen token'>(</span><span class='symbol val'>:before_transition</span><span class='rparen token'>)</span>

    <span class='after_transition identifier id'>after_transition</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:park</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='VehicleObserver constant id'>VehicleObserver</span><span class='dot token'>.</span><span class='method identifier id'>method</span><span class='lparen token'>(</span><span class='symbol val'>:after_park</span><span class='rparen token'>)</span>
    <span class='after_transition identifier id'>after_transition</span> <span class='VehicleObserver constant id'>VehicleObserver</span><span class='dot token'>.</span><span class='method identifier id'>method</span><span class='lparen token'>(</span><span class='symbol val'>:after_transition</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
</pre>
<p>
One common callback is to record transitions for all models in the system
for auditing/debugging purposes. Below is an example of an observer that
can easily automate this process for all models:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='StateMachineObserver constant id'>StateMachineObserver</span>
    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='before_transition identifier id'>before_transition</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='rparen token'>)</span>
      <span class='Audit constant id'>Audit</span><span class='dot token'>.</span><span class='log_transition identifier id'>log_transition</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='dot token'>.</span><span class='attributes identifier id'>attributes</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='lbrack token'>[</span><span class='Vehicle constant id'>Vehicle</span><span class='comma token'>,</span> <span class='Switch constant id'>Switch</span><span class='comma token'>,</span> <span class='Project constant id'>Project</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='klass identifier id'>klass</span><span class='bitor op'>|</span>
    <span class='klass identifier id'>klass</span><span class='dot token'>.</span><span class='state_machines identifier id'>state_machines</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='attribute identifier id'>attribute</span><span class='comma token'>,</span> <span class='machine identifier id'>machine</span><span class='bitor op'>|</span>
      <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='before_transition identifier id'>before_transition</span> <span class='klass identifier id'>klass</span><span class='dot token'>.</span><span class='method identifier id'>method</span><span class='lparen token'>(</span><span class='symbol val'>:before_transition</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Additional observer-like behavior may be exposed by the various
integrations available. See below for more information on integrations.
</p>
<h2>Overriding instance / class methods</h2>
<p>
Hooking in behavior to the generated instance / class methods from the
state machine, events, and states is very simple because of the way these
methods are generated on the class. Using the class&#8217;s ancestors, the
original generated method can be referred to via <tt>super</tt>. For
example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:park</span> <span class='do do kw'>do</span>
        <span class='dot3 op'>...</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='park identifier id'>park</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='args identifier id'>args</span><span class='rparen token'>)</span>
      <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span> <span class='string val'>&quot;...&quot;</span>
      <span class='super super kw'>super</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
In the above example, the <tt>park</tt> instance method that&#8217;s
generated on the Vehicle class (by the associated event) is overridden with
custom behavior. Once this behavior is complete, the original method from
the state machine is invoked by simply calling <tt>super</tt>.
</p>
<p>
The same technique can be used for <tt>state</tt>, <tt>state_name</tt>, and
all other instance <b>and</b> class methods on the Vehicle class.
</p>
<h2>Integrations</h2>
<p>
By default, state machines are library-agnostic, meaning that they work on
any Ruby class and have no external dependencies. However, there are
certain libraries which expose additional behavior that can be taken
advantage of by state machines.
</p>
<p>
This library is built to work out of the box with a few popular Ruby
libraries that allow for additional behavior to provide a cleaner and
smoother experience. This is especially the case for objects backed by a
database that may allow for transactions, persistent storage,
search/filters, callbacks, etc.
</p>
<p>
When a state machine is defined for classes using any of the above
libraries, it will try to automatically determine the integration to use
(Agnostic, ActiveRecord, DataMapper, or Sequel) based on the class
definition. To see how each integration affects the machine&#8217;s
behavior, refer to all constants defined under the
StateMachine::Integrations namespace.
</p>

</div><div class="section attributes">
  <h1>Attributes</h1>

  
    <div class="class">
      <h2>Class Attributes</h2>
      <table>
      
        <tr>
          <th class="name">default_messages</td>
          <td class="readwrite">
            [<span id='default_messages-class_method'>R</span><span id='default_messages%3D-class_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>default_messages</tt>.
</p>

            
          </td>
        </tr>
      
      </table>
    </div>
  
    <div class="instance">
      <h2>Instance Attributes</h2>
      <table>
      
        <tr>
          <th class="name">action</td>
          <td class="readwrite">
            [<span id='action-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
The action to invoke when an object transitions.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">attribute</td>
          <td class="readwrite">
            [<span id='attribute-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
The attribute for which the machine is being defined.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">callbacks</td>
          <td class="readwrite">
            [<span id='callbacks-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
The callbacks to invoke before/after a transition is performed.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">events</td>
          <td class="readwrite">
            [<span id='events-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
The events that trigger transitions.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">instance_helper_module</td>
          <td class="readwrite">
            [<span id='instance_helper_module-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>instance_helper_module</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">namespace</td>
          <td class="readwrite">
            [<span id='namespace-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
An identifier that forces all methods (including state predicates and event
methods) to be generated with the value prefixed or suffixed, depending on
the context.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">owner_class</td>
          <td class="readwrite">
            [R<span id='owner_class%3D-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Sets the class which is the owner of this state machine.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">states</td>
          <td class="readwrite">
            [<span id='states-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
A list of all of the states known to this state machine.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">use_transactions</td>
          <td class="readwrite">
            [<span id='use_transactions-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Whether the machine will use transactions when firing events.
</p>

            
          </td>
        </tr>
      
      </table>
    </div>
  
</div><div class="section constants">
  
</div><div class="section constructor">
<h1>Constructor Summary</h1>
  <div id="initialize-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>initialize</span><span class='args'>(owner_class, *args, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Creates a new state machine for the given attribute
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 363</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='owner_class identifier id'>owner_class</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='args identifier id'>args</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='Hash constant id'>Hash</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='args identifier id'>args</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span> <span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='assert_valid_keys identifier id'>assert_valid_keys</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='comma token'>,</span> <span class='symbol val'>:initial</span><span class='comma token'>,</span> <span class='symbol val'>:action</span><span class='comma token'>,</span> <span class='symbol val'>:plural</span><span class='comma token'>,</span> <span class='symbol val'>:namespace</span><span class='comma token'>,</span> <span class='symbol val'>:integration</span><span class='comma token'>,</span> <span class='symbol val'>:messages</span><span class='comma token'>,</span> <span class='symbol val'>:use_transactions</span><span class='rparen token'>)</span>
  
  <span class='comment val'># Find an integration that matches this machine's owner class</span>
  <span class='if if kw'>if</span> <span class='integration identifier id'>integration</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='integration identifier id'>integration</span><span class='rbrack token'>]</span> <span class='question op'>?</span> <span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='Integrations constant id'>Integrations</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='integration identifier id'>integration</span><span class='rbrack token'>]</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='Integrations constant id'>Integrations</span><span class='dot token'>.</span><span class='match identifier id'>match</span><span class='lparen token'>(</span><span class='owner_class identifier id'>owner_class</span><span class='rparen token'>)</span>
    <span class='extend identifier id'>extend</span> <span class='integration identifier id'>integration</span>
    <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='integration identifier id'>integration</span><span class='dot token'>.</span><span class='defaults identifier id'>defaults</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='integration identifier id'>integration</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='symbol val'>:defaults</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
  
  <span class='comment val'># Add machine-wide defaults</span>
  <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:use_transactions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rbrace token'>}</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='rparen token'>)</span>
  
  <span class='comment val'># Set machine configuration</span>
  <span class='@attribute ivar id'>@attribute</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='dot token'>.</span><span class='first identifier id'>first</span> <span class='orop op'>||</span> <span class='symbol val'>:state</span>
  <span class='@events ivar id'>@events</span> <span class='assign token'>=</span> <span class='EventCollection constant id'>EventCollection</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='rparen token'>)</span>
  <span class='@states ivar id'>@states</span> <span class='assign token'>=</span> <span class='StateCollection constant id'>StateCollection</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='rparen token'>)</span>
  <span class='@callbacks ivar id'>@callbacks</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:before</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:after</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rbrace token'>}</span>
  <span class='@namespace ivar id'>@namespace</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:namespace</span><span class='rbrack token'>]</span>
  <span class='@messages ivar id'>@messages</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:messages</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='@action ivar id'>@action</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:action</span><span class='rbrack token'>]</span>
  <span class='@use_transactions ivar id'>@use_transactions</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:use_transactions</span><span class='rbrack token'>]</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='owner_class identifier id'>owner_class</span> <span class='assign token'>=</span> <span class='owner_class identifier id'>owner_class</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='initial_state identifier id'>initial_state</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:initial</span><span class='rbrack token'>]</span>
  
  <span class='comment val'># Define class integration</span>
  <span class='define_helpers identifier id'>define_helpers</span>
  <span class='define_scopes identifier id'>define_scopes</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:plural</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  <span class='after_initialize identifier id'>after_initialize</span>
  
  <span class='comment val'># Evaluate DSL</span>
  <span class='instance_eval identifier id'>instance_eval</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='block_given? fid id'>block_given?</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
</div>  <div class="section visibilitygroup public">
    <h1>Public Visibility</h1>
      <div class="section methodsummary class public">
    <h1>Public Class Method Summary</h1>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#draw-class_method' title='draw'>draw</a></span><span class='args'>(class_names, options = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Draws the state machines defined in the given classes using GraphViz.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#find_or_create-class_method' title='find_or_create'>find_or_create</a></span><span class='args'>(owner_class, *args, &amp;block)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Attempts to find or create a state machine for the given class.
</p>

        
      </td>
    </tr>
  
</table>
  </div>
  <div class="section methodsummary instance public">
    <h1>Public Instance Method Summary</h1>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#after_transition-instance_method' title='#after_transition'>#after_transition</a></span><span class='args'>(options = {}, &amp;block)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Creates a callback that will be invoked <b>after</b> a transition is
performed so long as the given requirements match the transition.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#before_transition-instance_method' title='#before_transition'>#before_transition</a></span><span class='args'>(options = {}, &amp;block)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Creates a callback that will be invoked <b>before</b> a transition is
performed so long as the given requirements match the transition.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#define_class_method-instance_method' title='#define_class_method'>#define_class_method</a></span><span class='args'>(method, &amp;block)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Defines a new class method with the given name on the machine&#8217;s owner
class.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#define_instance_method-instance_method' title='#define_instance_method'>#define_instance_method</a></span><span class='args'>(method, &amp;block)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Defines a new instance method with the given name on the machine&#8217;s
owner class.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#draw-instance_method' title='#draw'>#draw</a></span><span class='args'>(options = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Draws a directed graph of the machine for visualizing the various events,
states, and their transitions.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#event-instance_method' title='#event'>#event</a></span><span class='args'>(*names, &amp;block)</span>
        <span class='block'></span>
        
          <span class='alias'>#on</span>
        
      </th>
      <td class="docstring">
        <p>
Defines one or more events for the machine and the transitions that can be
performed when those events are run.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#initial_state-instance_method' title='#initial_state'>#initial_state</a></span><span class='args'>(object)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Gets the initial state of the machine for the given object.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#initialize_copy-instance_method' title='#initialize_copy'>#initialize_copy</a></span><span class='args'>(orig)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Creates a copy of this machine in addition to copies of each associated
event/states/callback, so that the modifications to those collections do
not affect the original machine.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#invalidate-instance_method' title='#invalidate'>#invalidate</a></span><span class='args'>(object, attribute, message, values = [])</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Marks the given object as invalid with the given message.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#owner_class-instance_method' title='#owner_class'>#owner_class</a></span><span class='args'>=(klass)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Sets the class which is the owner of this state machine..
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#read-instance_method' title='#read'>#read</a></span><span class='args'>(object)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Gets the current value stored in the given object&#8217;s state.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#reset-instance_method' title='#reset'>#reset</a></span><span class='args'>(object)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Resets an errors previously added when invalidating the given object.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#state-instance_method' title='#state'>#state</a></span><span class='args'>(*names, &amp;block)</span>
        <span class='block'></span>
        
          <span class='alias'>#other_states</span>
        
      </th>
      <td class="docstring">
        <p>
Customizes the definition of one or more states in the machine.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#within_transaction-instance_method' title='#within_transaction'>#within_transaction</a></span><span class='args'>(object)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Runs a transaction, rolling back any changes if the yielded block fails.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#write-instance_method' title='#write'>#write</a></span><span class='args'>(object, value)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Sets a new value in the given object&#8217;s state.
</p>

        
      </td>
    </tr>
  
</table><div class="included">
  
  <div>
    <h1>Public Instance Methods Included from <a href='Machine/Assertions.html' title='StateMachine::Assertions'>StateMachine::Assertions</a></h1>
    <p><span class='name'><a href='Assertions.html#assert_exclusive_keys-instance_method' title='assert_exclusive_keys'>assert_exclusive_keys</a></span>, <span class='name'><a href='Assertions.html#assert_valid_keys-instance_method' title='assert_valid_keys'>assert_valid_keys</a></span></p>
  </div>
  
  <div>
    <h1>Public Instance Methods Included from <a href='Machine/MatcherHelpers.html' title='StateMachine::MatcherHelpers'>StateMachine::MatcherHelpers</a></h1>
    <p><span class='name'><a href='MatcherHelpers.html#all-instance_method' title='all'>all</a></span>, <span class='name'><a href='MatcherHelpers.html#same-instance_method' title='same'>same</a></span></p>
  </div>
  
</div>
<div class="clear"></div>
  </div>
<div class="section methoddetails class public">
  <h1>Public Class Method Details</h1>
  
    <div class="method">
      <div class="method_header">
  <h3>draw</h3>
</div><div id="draw-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>draw</span><span class='args'>(class_names, options = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Draws the state machines defined in the given classes using GraphViz. The
given classes must be a comma-delimited string of class names.
</p>
<p>
Configuration options:
</p>
<ul>
<li><tt>:file</tt> - A comma-delimited string of files to load that contain the
state machine definitions to draw

</li>
<li><tt>:path</tt> - The path to write the graph file to

</li>
<li><tt>:format</tt> - The image format to generate the graph in

</li>
<li><tt>:font</tt> - The name of the font to draw state names in

</li>
</ul>

</div><div class="section tags">
  <h2>Meta Tags</h2>
  <div class="raise">
  <h3>Raises:</h3>
  <dl>
  
    <dt>
      
        <span class='type'>[<tt>ArgumentError</tt>]</span>
      
      
    </dt>
    <dd>
      <span class='desc'></span>
    </dd>
  
  </dl>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 294</span>

<span class='def def kw'>def</span> <span class='draw identifier id'>draw</span><span class='lparen token'>(</span><span class='class_names identifier id'>class_names</span><span class='comma token'>,</span> <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='raise identifier id'>raise</span> <span class='ArgumentError constant id'>ArgumentError</span><span class='comma token'>,</span> <span class='string val'>'At least one class must be specified'</span> <span class='unless unless_mod kw'>unless</span> <span class='class_names identifier id'>class_names</span> <span class='andop op'>&amp;&amp;</span> <span class='class_names identifier id'>class_names</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>','</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
  
  <span class='comment val'># Load any files</span>
  <span class='if if kw'>if</span> <span class='files identifier id'>files</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='dot token'>.</span><span class='delete identifier id'>delete</span><span class='lparen token'>(</span><span class='colon op'>:</span><span class='file identifier id'>file</span><span class='rparen token'>)</span>
    <span class='files identifier id'>files</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>','</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='file identifier id'>file</span><span class='bitor op'>|</span> <span class='require identifier id'>require</span> <span class='file identifier id'>file</span><span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>
  
  <span class='class_names identifier id'>class_names</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>','</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='class_name identifier id'>class_name</span><span class='bitor op'>|</span>
    <span class='comment val'># Navigate through the namespace structure to get to the class</span>
    <span class='klass identifier id'>klass</span> <span class='assign token'>=</span> <span class='Object constant id'>Object</span>
    <span class='class_name identifier id'>class_name</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>'::'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='name identifier id'>name</span><span class='bitor op'>|</span>
      <span class='klass identifier id'>klass</span> <span class='assign token'>=</span> <span class='klass identifier id'>klass</span><span class='dot token'>.</span><span class='const_defined? fid id'>const_defined?</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='klass identifier id'>klass</span><span class='dot token'>.</span><span class='const_get identifier id'>const_get</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='klass identifier id'>klass</span><span class='dot token'>.</span><span class='const_missing identifier id'>const_missing</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    
    <span class='comment val'># Draw each of the class's state machines</span>
    <span class='klass identifier id'>klass</span><span class='dot token'>.</span><span class='state_machines identifier id'>state_machines</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='machine identifier id'>machine</span><span class='bitor op'>|</span>
      <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='draw identifier id'>draw</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>find_or_create</h3>
</div><div id="find_or_create-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>find_or_create</span><span class='args'>(owner_class, *args, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Attempts to find or create a state machine for the given class. For
example,
</p>
<pre class="code">
  <span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='Machine constant id'>Machine</span><span class='dot token'>.</span><span class='find_or_create identifier id'>find_or_create</span><span class='lparen token'>(</span><span class='Vehicle constant id'>Vehicle</span><span class='rparen token'>)</span>
  <span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='Machine constant id'>Machine</span><span class='dot token'>.</span><span class='find_or_create identifier id'>find_or_create</span><span class='lparen token'>(</span><span class='Vehicle constant id'>Vehicle</span><span class='comma token'>,</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span><span class='rparen token'>)</span>
  <span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='Machine constant id'>Machine</span><span class='dot token'>.</span><span class='find_or_create identifier id'>find_or_create</span><span class='lparen token'>(</span><span class='Vehicle constant id'>Vehicle</span><span class='comma token'>,</span> <span class='symbol val'>:status</span><span class='rparen token'>)</span>
  <span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='Machine constant id'>Machine</span><span class='dot token'>.</span><span class='find_or_create identifier id'>find_or_create</span><span class='lparen token'>(</span><span class='Vehicle constant id'>Vehicle</span><span class='comma token'>,</span> <span class='symbol val'>:status</span><span class='comma token'>,</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span><span class='rparen token'>)</span>
</pre>
<p>
If a machine of the given name already exists in one of the class&#8217;s
superclasses, then a copy of that machine will be created and stored in the
new owner class (the original will remain unchanged).
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 261</span>

<span class='def def kw'>def</span> <span class='find_or_create identifier id'>find_or_create</span><span class='lparen token'>(</span><span class='owner_class identifier id'>owner_class</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='args identifier id'>args</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='Hash constant id'>Hash</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='args identifier id'>args</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span> <span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='attribute identifier id'>attribute</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='dot token'>.</span><span class='first identifier id'>first</span> <span class='orop op'>||</span> <span class='symbol val'>:state</span>
  
  <span class='comment val'># Find an existing machine</span>
  <span class='if if kw'>if</span> <span class='owner_class identifier id'>owner_class</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='colon op'>:</span><span class='state_machines identifier id'>state_machines</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span> <span class='machine identifier id'>machine</span> <span class='assign token'>=</span> <span class='owner_class identifier id'>owner_class</span><span class='dot token'>.</span><span class='state_machines identifier id'>state_machines</span><span class='lbrack token'>[</span><span class='attribute identifier id'>attribute</span><span class='rbrack token'>]</span>
    <span class='comment val'># Only create a new copy if changes are being made to the machine in</span>
    <span class='comment val'># a subclass</span>
    <span class='if if kw'>if</span> <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='owner_class identifier id'>owner_class</span> <span class='neq op'>!=</span> <span class='owner_class identifier id'>owner_class</span> <span class='andop op'>&amp;&amp;</span> <span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='dot token'>.</span><span class='any? fid id'>any?</span> <span class='orop op'>||</span> <span class='block_given? fid id'>block_given?</span><span class='rparen token'>)</span>
      <span class='machine identifier id'>machine</span> <span class='assign token'>=</span> <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='clone identifier id'>clone</span>
      <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='initial_state identifier id'>initial_state</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:initial</span><span class='rbrack token'>]</span> <span class='if if_mod kw'>if</span> <span class='options identifier id'>options</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='symbol val'>:initial</span><span class='rparen token'>)</span>
      <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='owner_class identifier id'>owner_class</span> <span class='assign token'>=</span> <span class='owner_class identifier id'>owner_class</span>
    <span class='end end kw'>end</span>
    
    <span class='comment val'># Evaluate DSL</span>
    <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='instance_eval identifier id'>instance_eval</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='block_given? fid id'>block_given?</span>
  <span class='else else kw'>else</span>
    <span class='comment val'># No existing machine: create a new one</span>
    <span class='machine identifier id'>machine</span> <span class='assign token'>=</span> <span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='owner_class identifier id'>owner_class</span><span class='comma token'>,</span> <span class='attribute identifier id'>attribute</span><span class='comma token'>,</span> <span class='options identifier id'>options</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
  
  <span class='machine identifier id'>machine</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
</div><div class="section methoddetails instance public">
  <h1>Public Instance Method Details</h1>
  
    <div class="method">
      <div class="method_header">
  <h3>after_transition</h3>
</div><div id="after_transition-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>after_transition</span><span class='args'>(options = {}, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Creates a callback that will be invoked <b>after</b> a transition is
performed so long as the given requirements match the transition.
</p>
<p>
See <tt>before_transition</tt> for a description of the possible
configurations for defining callbacks.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


1103
1104
1105</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 1103</span>

<span class='def def kw'>def</span> <span class='after_transition identifier id'>after_transition</span><span class='lparen token'>(</span><span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='add_callback identifier id'>add_callback</span><span class='lparen token'>(</span><span class='symbol val'>:after</span><span class='comma token'>,</span> <span class='options identifier id'>options</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='Hash constant id'>Hash</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='options identifier id'>options</span> <span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='options identifier id'>options</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>before_transition</h3>
</div><div id="before_transition-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>before_transition</span><span class='args'>(options = {}, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Creates a callback that will be invoked <b>before</b> a transition is
performed so long as the given requirements match the transition.
</p>
<h2>The callback</h2>
<p>
Callbacks must be defined as either an argument, in the :do option, or as a
block. For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:set_alarm</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:set_alarm</span><span class='comma token'>,</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:set_alarm</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='bitor op'>|</span>
        <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='set_alarm identifier id'>set_alarm</span>
      <span class='end end kw'>end</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Notice that the first three callbacks are the same in terms of how the
methods to invoke are defined. However, using the <tt>:do</tt> can provide
for a more fluid DSL.
</p>
<p>
In addition, multiple callbacks can be defined like so:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:set_alarm</span><span class='comma token'>,</span> <span class='symbol val'>:lock_doors</span><span class='comma token'>,</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:set_alarm</span><span class='comma token'>,</span> <span class='symbol val'>:lock_doors</span><span class='rbrack token'>]</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:set_alarm</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='bitor op'>|</span>
        <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='lock_doors identifier id'>lock_doors</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Notice that the different ways of configuring methods can be mixed.
</p>
<h2>State requirements</h2>
<p>
Callbacks can require that the machine be transitioning from and to
specific states. These requirements use a Hash syntax to map beginning
states to ending states. For example,
</p>
<pre class="code">
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:idling</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:first_gear</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:set_alarm</span>
</pre>
<p>
In this case, the <tt>set_alarm</tt> callback will only be called if the
machine is transitioning from <tt>parked</tt> to <tt>idling</tt> or from
<tt>idling</tt> to <tt>parked</tt>.
</p>
<p>
To help define state requirements, a set of helpers are available for
slightly more complex matching:
</p>
<ul>
<li><tt>all</tt> - Matches every state/event in the machine

</li>
<li><tt>all - [:parked, :idling, &#8230;]</tt> - Matches every state/event
except those specified

</li>
<li><tt>any</tt> - An alias for <tt>all</tt> (matches every state/event in the
machine)

</li>
<li><tt>same</tt> - Matches the same state being transitioned from

</li>
</ul>
<p>
See StateMachine::MatcherHelpers for more information.
</p>
<p>
Examples:
</p>
<pre class="code">
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:first_gear</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>     <span class='comment val'># Matches from parked to idling or first_gear</span>
  <span class='before_transition identifier id'>before_transition</span> <span class='all identifier id'>all</span> <span class='minus op'>-</span> <span class='lbrack token'>[</span><span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:idling</span><span class='rbrack token'>]</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>   <span class='comment val'># Matches from every state except parked and idling to idling</span>
  <span class='before_transition identifier id'>before_transition</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>                        <span class='comment val'># Matches all states to parked</span>
  <span class='before_transition identifier id'>before_transition</span> <span class='any identifier id'>any</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='same identifier id'>same</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>                           <span class='comment val'># Matches every loopback</span>
</pre>
<h2>Event requirements</h2>
<p>
In addition to state requirements, an event requirement can be defined so
that the callback is only invoked on specific events using the <tt>on</tt>
option. This can also use the same matcher helpers as the state
requirements.
</p>
<p>
Examples:
</p>
<pre class="code">
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:ignite</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>                        <span class='comment val'># Matches only on ignite</span>
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='all identifier id'>all</span> <span class='minus op'>-</span> <span class='symbol val'>:ignite</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>                  <span class='comment val'># Matches on every event except ignite</span>
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:ignite</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>    <span class='comment val'># Matches from parked to idling on ignite</span>
</pre>
<h2>Verbose Requirements</h2>
<p>
Requirements can also be defined using verbose options rather than the
implicit Hash syntax and helper methods described above.
</p>
<p>
Configuration options:
</p>
<ul>
<li><tt>:from</tt> - One or more states being transitioned from. If none are
specified, then all states will match.

</li>
<li><tt>:to</tt> - One or more states being transitioned to. If none are
specified, then all states will match.

</li>
<li><tt>:on</tt> - One or more events that fired the transition. If none are
specified, then all events will match.

</li>
<li><tt>:except_from</tt> - One or more states <b>not</b> being transitioned
from

</li>
<li><tt>:except_to</tt> - One more states <b>not</b> being transitioned to

</li>
<li><tt>:except_on</tt> - One or more events that *did not* fire the transition

</li>
</ul>
<p>
Examples:
</p>
<pre class="code">
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:from</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:ignite</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:park</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:except_from</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:ignite</span><span class='comma token'>,</span> <span class='symbol val'>:except_to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:except_on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:park</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>
</pre>
<h2>Conditions</h2>
<p>
In addition to the state/event requirements, a condition can also be
defined to help determine whether the callback should be invoked.
</p>
<p>
Configuration options:
</p>
<ul>
<li><tt>:if</tt> - A method, proc or string to call to determine if the
callback should occur (e.g. :if =&gt; :allow_callbacks, or :if =&gt; lambda
{|user| user.signup_step &gt; 2}). The method, proc or string should return
or evaluate to a true or false value.

</li>
<li><tt>:unless</tt> - A method, proc or string to call to determine if the
callback should not occur (e.g. :unless =&gt; :skip_callbacks, or :unless
=&gt; lambda {|user| user.signup_step &lt;= 2}). The method, proc or string
should return or evaluate to a true or false value.

</li>
</ul>
<p>
Examples:
</p>
<pre class="code">
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:if</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:moving?</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>
  <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:ignite</span><span class='comma token'>,</span> <span class='symbol val'>:unless</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:seatbelt_on?</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span>
</pre>
<h3>Accessing the transition</h3>
<p>
In addition to passing the object being transitioned, the actual transition
describing the context (e.g. event, from, to) can be accessed as well. This
additional argument is only passed if the callback allows for it.
</p>
<p>
For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='comment val'># Only specifies one parameter (the object being transitioned)</span>
    <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='vehicle identifier id'>vehicle</span><span class='bitor op'>|</span>
      <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='set_alarm identifier id'>set_alarm</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># Specifies 2 parameters (object being transitioned and actual transition)</span>
    <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='bitor op'>|</span>
      <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='set_alarm identifier id'>set_alarm</span><span class='lparen token'>(</span><span class='transition identifier id'>transition</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
<b>Note</b> that the object in the callback will only be passed in as an
argument if callbacks are configured to <b>not</b> be bound to the object
involved. This is the default and may change on a per-integration basis.
</p>
<p>
See StateMachine::Transition for more information about the attributes
available on the transition.
</p>
<h2>Examples</h2>
<p>
Below is an example of a class with one state machine and various types of
<tt>before</tt> transitions defined for it:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='comment val'># Before all transitions</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:update_dashboard</span>

      <span class='comment val'># Before specific transition:</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='lbrack token'>[</span><span class='symbol val'>:first_gear</span><span class='comma token'>,</span> <span class='symbol val'>:idling</span><span class='rbrack token'>]</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:park</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:take_off_seatbelt</span>

      <span class='comment val'># With conditional callback:</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:take_off_seatbelt</span><span class='comma token'>,</span> <span class='symbol val'>:if</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:seatbelt_on?</span>

      <span class='comment val'># Using helpers:</span>
      <span class='before_transition identifier id'>before_transition</span> <span class='all identifier id'>all</span> <span class='minus op'>-</span> <span class='symbol val'>:stalled</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='same identifier id'>same</span><span class='comma token'>,</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='any identifier id'>any</span> <span class='minus op'>-</span> <span class='symbol val'>:crash</span><span class='comma token'>,</span> <span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:update_dashboard</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
As can be seen, any number of transitions can be created using various
combinations of configuration options.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


1094
1095
1096</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 1094</span>

<span class='def def kw'>def</span> <span class='before_transition identifier id'>before_transition</span><span class='lparen token'>(</span><span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='add_callback identifier id'>add_callback</span><span class='lparen token'>(</span><span class='symbol val'>:before</span><span class='comma token'>,</span> <span class='options identifier id'>options</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='Hash constant id'>Hash</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='options identifier id'>options</span> <span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='symbol val'>:do</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='options identifier id'>options</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>define_class_method</h3>
</div><div id="define_class_method-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>define_class_method</span><span class='args'>(method, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Defines a new class method with the given name on the machine&#8217;s owner
class. If the method is already defined in the class, then this will not
override it.
</p>
<p>
Example:
</p>
<pre class="code">
  <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='define_class_method identifier id'>define_class_method</span><span class='lparen token'>(</span><span class='symbol val'>:states</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='machine identifier id'>machine</span><span class='comma token'>,</span> <span class='klass identifier id'>klass</span><span class='bitor op'>|</span>
    <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='states identifier id'>states</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span>
  <span class='end end kw'>end</span>
</pre>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


477
478
479
480
481
482
483
484
485</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 477</span>

<span class='def def kw'>def</span> <span class='define_class_method identifier id'>define_class_method</span><span class='lparen token'>(</span><span class='method identifier id'>method</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='attribute identifier id'>attribute</span> <span class='assign token'>=</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='attribute identifier id'>attribute</span>
  
  <span class='@class_helper_module ivar id'>@class_helper_module</span><span class='dot token'>.</span><span class='class_eval identifier id'>class_eval</span> <span class='do do kw'>do</span>
    <span class='define_method identifier id'>define_method</span><span class='lparen token'>(</span><span class='method identifier id'>method</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='mult op'>*</span><span class='args identifier id'>args</span><span class='bitor op'>|</span>
      <span class='block identifier id'>block</span><span class='dot token'>.</span><span class='call identifier id'>call</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='state_machine identifier id'>state_machine</span><span class='lparen token'>(</span><span class='attribute identifier id'>attribute</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='self self kw'>self</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='args identifier id'>args</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>define_instance_method</h3>
</div><div id="define_instance_method-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>define_instance_method</span><span class='args'>(method, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Defines a new instance method with the given name on the machine&#8217;s
owner class. If the method is already defined in the class, then this will
not override it.
</p>
<p>
Example:
</p>
<pre class="code">
  <span class='attribute identifier id'>attribute</span> <span class='assign token'>=</span> <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='attribute identifier id'>attribute</span>
  <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='define_instance_method identifier id'>define_instance_method</span><span class='lparen token'>(</span><span class='symbol val'>:state_name</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='machine identifier id'>machine</span><span class='comma token'>,</span> <span class='object identifier id'>object</span><span class='bitor op'>|</span>
    <span class='machine identifier id'>machine</span><span class='dot token'>.</span><span class='states identifier id'>states</span><span class='dot token'>.</span><span class='match identifier id'>match</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
</pre>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


457
458
459
460
461
462
463
464
465</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 457</span>

<span class='def def kw'>def</span> <span class='define_instance_method identifier id'>define_instance_method</span><span class='lparen token'>(</span><span class='method identifier id'>method</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='attribute identifier id'>attribute</span> <span class='assign token'>=</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='attribute identifier id'>attribute</span>
  
  <span class='@instance_helper_module ivar id'>@instance_helper_module</span><span class='dot token'>.</span><span class='class_eval identifier id'>class_eval</span> <span class='do do kw'>do</span>
    <span class='define_method identifier id'>define_method</span><span class='lparen token'>(</span><span class='method identifier id'>method</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='mult op'>*</span><span class='args identifier id'>args</span><span class='bitor op'>|</span>
      <span class='block identifier id'>block</span><span class='dot token'>.</span><span class='call identifier id'>call</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='state_machine identifier id'>state_machine</span><span class='lparen token'>(</span><span class='attribute identifier id'>attribute</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='self self kw'>self</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='args identifier id'>args</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>draw</h3>
</div><div id="draw-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>draw</span><span class='args'>(options = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Draws a directed graph of the machine for visualizing the various events,
states, and their transitions.
</p>
<p>
This requires both the Ruby graphviz gem and the graphviz library be
installed on the system.
</p>
<p>
Configuration options:
</p>
<ul>
<li><tt>:name</tt> - The name of the file to write to (without the file
extension). Default is &quot;#{owner_class.name}_#{attribute}&quot;

</li>
<li><tt>:path</tt> - The path to write the graph file to. Default is the
current directory (&quot;.&quot;).

</li>
<li><tt>:format</tt> - The image format to generate the graph in. Default is
&quot;png&#8217;.

</li>
<li><tt>:font</tt> - The name of the font to draw state names in. Default is
&quot;Arial&quot;.

</li>
<li><tt>:orientation</tt> - The direction of the graph (&quot;portrait&quot; or
&quot;landscape&quot;). Default is &quot;portrait&quot;.

</li>
<li><tt>:output</tt> - Whether to generate the output of the graph

</li>
</ul>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 1150</span>

<span class='def def kw'>def</span> <span class='draw identifier id'>draw</span><span class='lparen token'>(</span><span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span>
    <span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;#{owner_class.name}_#{attribute}&quot;</span><span class='comma token'>,</span>
    <span class='symbol val'>:path</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'.'</span><span class='comma token'>,</span>
    <span class='symbol val'>:format</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'png'</span><span class='comma token'>,</span>
    <span class='symbol val'>:font</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'Arial'</span><span class='comma token'>,</span>
    <span class='symbol val'>:orientation</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'portrait'</span><span class='comma token'>,</span>
    <span class='symbol val'>:output</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>
  <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='rparen token'>)</span>
  <span class='assert_valid_keys identifier id'>assert_valid_keys</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='comma token'>,</span> <span class='symbol val'>:name</span><span class='comma token'>,</span> <span class='symbol val'>:path</span><span class='comma token'>,</span> <span class='symbol val'>:format</span><span class='comma token'>,</span> <span class='symbol val'>:font</span><span class='comma token'>,</span> <span class='symbol val'>:orientation</span><span class='comma token'>,</span> <span class='symbol val'>:output</span><span class='rparen token'>)</span>
  
  <span class='begin begin kw'>begin</span>
    <span class='comment val'># Load the graphviz library</span>
    <span class='require identifier id'>require</span> <span class='string val'>'rubygems'</span>
    <span class='require identifier id'>require</span> <span class='string val'>'graphviz'</span>
    
    <span class='graph identifier id'>graph</span> <span class='assign token'>=</span> <span class='GraphViz constant id'>GraphViz</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='string val'>'G'</span><span class='comma token'>,</span>
      <span class='symbol val'>:output</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:format</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
      <span class='symbol val'>:file</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:path</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='dstring node'>&quot;#{options[:name]}.#{options[:format]}&quot;</span><span class='rparen token'>)</span><span class='comma token'>,</span>
      <span class='symbol val'>:rankdir</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:orientation</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>'landscape'</span> <span class='question op'>?</span> <span class='string val'>'LR'</span> <span class='colon op'>:</span> <span class='string val'>'TB'</span>
    <span class='rparen token'>)</span>
    
    <span class='comment val'># Add nodes</span>
    <span class='states identifier id'>states</span><span class='dot token'>.</span><span class='by_priority identifier id'>by_priority</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='state identifier id'>state</span><span class='bitor op'>|</span>
      <span class='node identifier id'>node</span> <span class='assign token'>=</span> <span class='state identifier id'>state</span><span class='dot token'>.</span><span class='draw identifier id'>draw</span><span class='lparen token'>(</span><span class='graph identifier id'>graph</span><span class='rparen token'>)</span>
      <span class='node identifier id'>node</span><span class='dot token'>.</span><span class='fontname identifier id'>fontname</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:font</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>
    
    <span class='comment val'># Add edges</span>
    <span class='events identifier id'>events</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='event identifier id'>event</span><span class='bitor op'>|</span>
      <span class='edges identifier id'>edges</span> <span class='assign token'>=</span> <span class='event identifier id'>event</span><span class='dot token'>.</span><span class='draw identifier id'>draw</span><span class='lparen token'>(</span><span class='graph identifier id'>graph</span><span class='rparen token'>)</span>
      <span class='edges identifier id'>edges</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='edge identifier id'>edge</span><span class='bitor op'>|</span> <span class='edge identifier id'>edge</span><span class='dot token'>.</span><span class='fontname identifier id'>fontname</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:font</span><span class='rbrack token'>]</span><span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>
    
    <span class='comment val'># Generate the graph</span>
    <span class='graph identifier id'>graph</span><span class='dot token'>.</span><span class='output identifier id'>output</span> <span class='if if_mod kw'>if</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:output</span><span class='rbrack token'>]</span>
    <span class='graph identifier id'>graph</span>
  <span class='rescue rescue kw'>rescue</span> <span class='LoadError constant id'>LoadError</span>
    <span class='$stderr gvar id'>$stderr</span><span class='dot token'>.</span><span class='puts identifier id'>puts</span> <span class='string val'>'Cannot draw the machine. `gem install ruby-graphviz` and try again.'</span>
    <span class='false false kw'>false</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>event</h3>
</div><div id="event-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>event</span><span class='args'>(*names, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>
<p class="aliases">
  <span class="aka">Also known as:</span>
  
    <tt id="on-instance_method">on</tt>
  
</p>
</div><div class="section docstring">
  <p>
Defines one or more events for the machine and the transitions that can be
performed when those events are run.
</p>
<p>
This method is also aliased as <tt>on</tt> for improved compatibility with
using a domain-specific language.
</p>
<h2>Instance methods</h2>
<p>
The following instance methods are generated when a new event is defined
(the &quot;park&quot; event is used as an example):
</p>
<ul>
<li><tt>can_park?</tt> - Checks whether the &quot;park&quot; event can be fired
given the current state of the object.

</li>
<li><tt>park_transition</tt> - Gets the next transition that would be performed
if the &quot;park&quot; event were to be fired now on the object or nil if
no transitions can be performed.

</li>
<li><tt>park(run_action = true)</tt> - Fires the &quot;park&quot; event,
transitioning from the current state to the next valid state.

</li>
<li><tt>park!(run_action = true)</tt> - Fires the &quot;park&quot; event,
transitioning from the current state to the next valid state. If the
transition fails, then a StateMachine::InvalidTransition error will be
raised.

</li>
</ul>
<p>
With a namespace of &quot;car&quot;, the above names map to the following
methods:
</p>
<ul>
<li><tt>can_park_car?</tt>

</li>
<li><tt>park_car_transition</tt>

</li>
<li><tt>park_car</tt>

</li>
<li><tt>park_car!</tt>

</li>
</ul>
<h2>Defining transitions</h2>
<p>
<tt>event</tt> requires a block which allows you to define the possible
transitions that can happen as a result of that event. For example,
</p>
<pre class="code">
  <span class='event identifier id'>event</span> <span class='symbol val'>:park</span><span class='comma token'>,</span> <span class='symbol val'>:stop</span> <span class='do do kw'>do</span>
    <span class='transition identifier id'>transition</span> <span class='symbol val'>:idling</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span>
  <span class='end end kw'>end</span>

  <span class='event identifier id'>event</span> <span class='symbol val'>:first_gear</span> <span class='do do kw'>do</span>
    <span class='transition identifier id'>transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:first_gear</span><span class='comma token'>,</span> <span class='symbol val'>:if</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:seatbelt_on?</span>
  <span class='end end kw'>end</span>
</pre>
<p>
See StateMachine::Event#transition for more information on the possible
options that can be passed in.
</p>
<p>
<b>Note</b> that this block is executed within the context of the actual
event object. As a result, you will not be able to reference any class
methods on the model without referencing the class itself. For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='safe_states identifier id'>safe_states</span>
      <span class='lbrack token'>[</span><span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:stalled</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>

    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:park</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='safe_states identifier id'>safe_states</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Defining additional arguments</h2>
<p>
Additional arguments on event actions can be defined like so:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:park</span> <span class='do do kw'>do</span>
        <span class='dot3 op'>...</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='park identifier id'>park</span><span class='lparen token'>(</span><span class='kind identifier id'>kind</span> <span class='assign token'>=</span> <span class='symbol val'>:parallel</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='args identifier id'>args</span><span class='rparen token'>)</span>
      <span class='take_deep_breath identifier id'>take_deep_breath</span> <span class='if if_mod kw'>if</span> <span class='kind identifier id'>kind</span> <span class='eq op'>==</span> <span class='symbol val'>:parallel</span>
      <span class='super super kw'>super</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='take_deep_breath identifier id'>take_deep_breath</span>
      <span class='sleep identifier id'>sleep</span> <span class='integer val'>3</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Note that <tt>super</tt> is called instead of <tt>super(*args)</tt>. This
allows the entire arguments list to be accessed by transition callbacks
through StateMachine::Transition#args like so:
</p>
<pre class="code">
  <span class='after_transition identifier id'>after_transition</span> <span class='symbol val'>:on</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:park</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='transition identifier id'>transition</span><span class='bitor op'>|</span>
    <span class='kind identifier id'>kind</span> <span class='assign token'>=</span> <span class='mult op'>*</span><span class='transition identifier id'>transition</span><span class='dot token'>.</span><span class='args identifier id'>args</span>
    <span class='dot3 op'>...</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Example</h2>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='comment val'># The park, stop, and halt events will all share the given transitions</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:park</span><span class='comma token'>,</span> <span class='symbol val'>:stop</span><span class='comma token'>,</span> <span class='symbol val'>:halt</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='lbrack token'>[</span><span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:backing_up</span><span class='rbrack token'>]</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span>
      <span class='end end kw'>end</span>

      <span class='event identifier id'>event</span> <span class='symbol val'>:stop</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:first_gear</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span>
      <span class='end end kw'>end</span>

      <span class='event identifier id'>event</span> <span class='symbol val'>:ignite</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 905</span>

<span class='def def kw'>def</span> <span class='event identifier id'>event</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='names identifier id'>names</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='events identifier id'>events</span> <span class='assign token'>=</span> <span class='names identifier id'>names</span><span class='dot token'>.</span><span class='collect identifier id'>collect</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='name identifier id'>name</span><span class='bitor op'>|</span>
    <span class='unless unless kw'>unless</span> <span class='event identifier id'>event</span> <span class='assign token'>=</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='events identifier id'>events</span><span class='lbrack token'>[</span><span class='name identifier id'>name</span><span class='rbrack token'>]</span>
      <span class='self self kw'>self</span><span class='dot token'>.</span><span class='events identifier id'>events</span> <span class='lshft op'>&lt;&lt;</span> <span class='event identifier id'>event</span> <span class='assign token'>=</span> <span class='Event constant id'>Event</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='comma token'>,</span> <span class='name identifier id'>name</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    
    <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
      <span class='event identifier id'>event</span><span class='dot token'>.</span><span class='instance_eval identifier id'>instance_eval</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
      <span class='add_states identifier id'>add_states</span><span class='lparen token'>(</span><span class='event identifier id'>event</span><span class='dot token'>.</span><span class='known_states identifier id'>known_states</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    
    <span class='event identifier id'>event</span>
  <span class='end end kw'>end</span>
  
  <span class='events identifier id'>events</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='eq op'>==</span> <span class='integer val'>1</span> <span class='question op'>?</span> <span class='events identifier id'>events</span><span class='dot token'>.</span><span class='first identifier id'>first</span> <span class='colon op'>:</span> <span class='events identifier id'>events</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>initial_state</h3>
</div><div id="initial_state-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>initial_state</span><span class='args'>(object)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Gets the initial state of the machine for the given object. If a dynamic
initial state was configured for this machine, then the object will be
passed into the lambda block to help determine the actual state.
</p>
<h2>Examples</h2>
<p>
With a static initial state:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='state_machine identifier id'>state_machine</span><span class='dot token'>.</span><span class='initial_state identifier id'>initial_state</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='rparen token'>)</span>  <span class='comment val'># =&gt; #&lt;StateMachine::State name=:parked value=&quot;parked&quot; initial=true&gt;</span>
</pre>
<p>
With a dynamic initial state:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='attr_accessor identifier id'>attr_accessor</span> <span class='symbol val'>:force_idle</span>

    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lambda identifier id'>lambda</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='vehicle identifier id'>vehicle</span><span class='bitor op'>|</span> <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='force_idle identifier id'>force_idle</span> <span class='integer val'>? </span><span class='symbol val'>:idling</span> <span class='colon op'>:</span> <span class='symbol val'>:parked</span><span class='rbrace token'>}</span> <span class='do do kw'>do</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>

  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='force_idle identifier id'>force_idle</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
  <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='state_machine identifier id'>state_machine</span><span class='dot token'>.</span><span class='initial_state identifier id'>initial_state</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='rparen token'>)</span>  <span class='comment val'># =&gt; #&lt;StateMachine::State name=:idling value=&quot;idling&quot; initial=false&gt;</span>

  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='force_idle identifier id'>force_idle</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='state_machine identifier id'>state_machine</span><span class='dot token'>.</span><span class='initial_state identifier id'>initial_state</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='rparen token'>)</span>  <span class='comment val'># =&gt; #&lt;StateMachine::State name=:parked value=&quot;parked&quot; initial=false&gt;</span>
</pre>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


521
522
523</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 521</span>

<span class='def def kw'>def</span> <span class='initial_state identifier id'>initial_state</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='rparen token'>)</span>
  <span class='states identifier id'>states</span><span class='dot token'>.</span><span class='fetch identifier id'>fetch</span><span class='lparen token'>(</span><span class='@initial_state ivar id'>@initial_state</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='Proc constant id'>Proc</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='@initial_state ivar id'>@initial_state</span><span class='dot token'>.</span><span class='call identifier id'>call</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='@initial_state ivar id'>@initial_state</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>initialize_copy</h3>
</div><div id="initialize_copy-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>initialize_copy</span><span class='args'>(orig)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Creates a copy of this machine in addition to copies of each associated
event/states/callback, so that the modifications to those collections do
not affect the original machine.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


400
401
402
403
404
405
406
407
408</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 400</span>

<span class='def def kw'>def</span> <span class='initialize_copy identifier id'>initialize_copy</span><span class='lparen token'>(</span><span class='orig identifier id'>orig</span><span class='rparen token'>)</span> <span class='comment val'>#:nodoc:</span>
  <span class='super super kw'>super</span>
  
  <span class='@events ivar id'>@events</span> <span class='assign token'>=</span> <span class='@events ivar id'>@events</span><span class='dot token'>.</span><span class='dup identifier id'>dup</span>
  <span class='@events ivar id'>@events</span><span class='dot token'>.</span><span class='machine identifier id'>machine</span> <span class='assign token'>=</span> <span class='self self kw'>self</span>
  <span class='@states ivar id'>@states</span> <span class='assign token'>=</span> <span class='@states ivar id'>@states</span><span class='dot token'>.</span><span class='dup identifier id'>dup</span>
  <span class='@states ivar id'>@states</span><span class='dot token'>.</span><span class='machine identifier id'>machine</span> <span class='assign token'>=</span> <span class='self self kw'>self</span>
  <span class='@callbacks ivar id'>@callbacks</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='symbol val'>:before</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@callbacks ivar id'>@callbacks</span><span class='lbrack token'>[</span><span class='symbol val'>:before</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='dup identifier id'>dup</span><span class='comma token'>,</span> <span class='symbol val'>:after</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@callbacks ivar id'>@callbacks</span><span class='lbrack token'>[</span><span class='symbol val'>:after</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='dup identifier id'>dup</span><span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>invalidate</h3>
</div><div id="invalidate-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>invalidate</span><span class='args'>(object, attribute, message, values = [])</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Marks the given object as invalid with the given message.
</p>
<p>
By default, this is a no-op.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


1110
1111</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 1110</span>

<span class='def def kw'>def</span> <span class='invalidate identifier id'>invalidate</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='comma token'>,</span> <span class='attribute identifier id'>attribute</span><span class='comma token'>,</span> <span class='message identifier id'>message</span><span class='comma token'>,</span> <span class='values identifier id'>values</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>owner_class</h3>
</div><div id="owner_class-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>owner_class</span><span class='args'>=(klass)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Sets the class which is the owner of this state machine. Any methods
generated by states, events, or other parts of the machine will be defined
on the given owner class.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 413</span>

<span class='def def kw'>def</span> <span class='owner_class= identifier id'>owner_class=</span><span class='lparen token'>(</span><span class='klass identifier id'>klass</span><span class='rparen token'>)</span>
  <span class='@owner_class ivar id'>@owner_class</span> <span class='assign token'>=</span> <span class='klass identifier id'>klass</span>
  
  <span class='comment val'># Add class-/instance-level methods to the owner class for state initialization</span>
  <span class='owner_class identifier id'>owner_class</span><span class='dot token'>.</span><span class='class_eval identifier id'>class_eval</span> <span class='do do kw'>do</span>
    <span class='extend identifier id'>extend</span> <span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='ClassMethods constant id'>ClassMethods</span>
    <span class='include identifier id'>include</span> <span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='InstanceMethods constant id'>InstanceMethods</span>
  <span class='end end kw'>end</span> <span class='unless unless_mod kw'>unless</span> <span class='owner_class identifier id'>owner_class</span><span class='dot token'>.</span><span class='included_modules identifier id'>included_modules</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='StateMachine constant id'>StateMachine</span><span class='colon2 op'>::</span><span class='InstanceMethods constant id'>InstanceMethods</span><span class='rparen token'>)</span>
  
  <span class='comment val'># Create modules for extending the class with state/event-specific methods</span>
  <span class='class_helper_module identifier id'>class_helper_module</span> <span class='assign token'>=</span> <span class='@class_helper_module ivar id'>@class_helper_module</span> <span class='assign token'>=</span> <span class='Module constant id'>Module</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='instance_helper_module identifier id'>instance_helper_module</span> <span class='assign token'>=</span> <span class='@instance_helper_module ivar id'>@instance_helper_module</span> <span class='assign token'>=</span> <span class='Module constant id'>Module</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='owner_class identifier id'>owner_class</span><span class='dot token'>.</span><span class='class_eval identifier id'>class_eval</span> <span class='do do kw'>do</span>
    <span class='extend identifier id'>extend</span> <span class='class_helper_module identifier id'>class_helper_module</span>
    <span class='include identifier id'>include</span> <span class='instance_helper_module identifier id'>instance_helper_module</span>
  <span class='end end kw'>end</span>
  
  <span class='comment val'># Record this machine as matched to the attribute in the current owner</span>
  <span class='comment val'># class.  This will override any machines mapped to the same attribute</span>
  <span class='comment val'># in any superclasses.</span>
  <span class='owner_class identifier id'>owner_class</span><span class='dot token'>.</span><span class='state_machines identifier id'>state_machines</span><span class='lbrack token'>[</span><span class='attribute identifier id'>attribute</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='self self kw'>self</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>read</h3>
</div><div id="read-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>read</span><span class='args'>(object)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Gets the current value stored in the given object&#8217;s state.
</p>
<p>
For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>                 <span class='comment val'># =&gt; #&lt;Vehicle:0xb7d94ab0 @state=&quot;parked&quot;&gt;</span>
  <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='state_machine identifier id'>state_machine</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='rparen token'>)</span>   <span class='comment val'># =&gt; &quot;parked&quot;</span>
</pre>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


777
778
779</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 777</span>

<span class='def def kw'>def</span> <span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='rparen token'>)</span>
  <span class='object identifier id'>object</span><span class='dot token'>.</span><span class='send identifier id'>send</span><span class='lparen token'>(</span><span class='attribute identifier id'>attribute</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>reset</h3>
</div><div id="reset-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>reset</span><span class='args'>(object)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Resets an errors previously added when invalidating the given object
</p>
<p>
By default, this is a no-op.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


1116
1117</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 1116</span>

<span class='def def kw'>def</span> <span class='reset identifier id'>reset</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>state</h3>
</div><div id="state-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>state</span><span class='args'>(*names, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>
<p class="aliases">
  <span class="aka">Also known as:</span>
  
    <tt id="other_states-instance_method">other_states</tt>
  
</p>
</div><div class="section docstring">
  <p>
Customizes the definition of one or more states in the machine.
</p>
<p>
Configuration options:
</p>
<ul>
<li><tt>:value</tt> - The actual value to store when an object transitions to
the state. Default is the name (stringified).

</li>
<li><tt>:if</tt> - Determines whether an object&#8217;s value matches the state
(e.g. :value =&gt; lambda <tt>Time.now</tt>, :if =&gt; lambda {|state|
!state.nil?}). By default, the configured value is matched.

</li>
</ul>
<h2>Customizing the stored value</h2>
<p>
Whenever a state is automatically discovered in the state machine, its
default value is assumed to be the stringified version of the name. For
example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:ignite</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
In the above state machine, there are two states automatically discovered:
:parked and :idling. These states, by default, will store their stringified
equivalents when an object moves into that states (e.g. &quot;parked&quot;
/ &quot;idling&quot;).
</p>
<p>
For legacy systems or when tying state machines into existing frameworks,
it&#8217;s oftentimes necessary to need to store a different value for a
state than the default. In order to continue taking advantage of an
expressive state machine and helper methods, every defined state can be
re-configured with a custom stored value. For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:ignite</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span>
      <span class='end end kw'>end</span>

      <span class='state identifier id'>state</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'IDLING'</span>
      <span class='state identifier id'>state</span> <span class='symbol val'>:parked</span><span class='comma token'>,</span> <span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'PARKED
    end
  end
</span></pre>
<p>
This is also useful if being used in association with a database and,
instead of storing the state name in a column, you want to store the
state&#8217;s foreign key:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='VehicleState constant id'>VehicleState</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
  <span class='end end kw'>end</span>

  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:state_id</span><span class='comma token'>,</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:ignite</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span>
      <span class='end end kw'>end</span>

      <span class='states identifier id'>states</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='state identifier id'>state</span><span class='bitor op'>|</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='state identifier id'>state</span><span class='lparen token'>(</span><span class='state identifier id'>state</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='VehicleState constant id'>VehicleState</span><span class='dot token'>.</span><span class='find_by_name identifier id'>find_by_name</span><span class='lparen token'>(</span><span class='state identifier id'>state</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='id identifier id'>id</span><span class='rparen token'>)</span><span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
In the above example, each known state is configured to store it&#8217;s
associated database id in the <tt>state_id</tt> attribute.
</p>
<h3>Dynamic values</h3>
<p>
In addition to customizing states with other value types, lambda blocks can
also be specified to allow for a state&#8217;s value to be determined
dynamically at runtime. For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:purchased_at</span><span class='comma token'>,</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:available</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:purchase</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:purchased</span>
      <span class='end end kw'>end</span>

      <span class='event identifier id'>event</span> <span class='symbol val'>:restock</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='all identifier id'>all</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:available</span>
      <span class='end end kw'>end</span>

      <span class='state identifier id'>state</span> <span class='symbol val'>:available</span><span class='comma token'>,</span> <span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='nil nil kw'>nil</span>
      <span class='state identifier id'>state</span> <span class='symbol val'>:purchased</span><span class='comma token'>,</span> <span class='symbol val'>:if</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lambda identifier id'>lambda</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='value identifier id'>value</span><span class='bitor op'>|</span> <span class='notop op'>!</span><span class='value identifier id'>value</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lambda identifier id'>lambda</span> <span class='lbrace token'>{</span><span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
In the above definition, the <tt>:purchased</tt> state is customized with
both a dynamic value <b>and</b> a value matcher.
</p>
<p>
When an object transitions to the purchased state, the value&#8217;s lambda
block will be called. This will get the current time and store it in the
object&#8217;s <tt>purchased_at</tt> attribute.
</p>
<p>
<b>Note</b> that the custom matcher is very important here. Since
there&#8217;s no way for the state machine to figure out an object&#8217;s
state when it&#8217;s set to a runtime value, it must be explicitly
defined. If the <tt>:if</tt> option were not configured for the state, then
an ArgumentError exception would be raised at runtime, indicating that the
state machine could not figure out what the current state of the object
was.
</p>
<h2>Behaviors</h2>
<p>
Behaviors define a series of methods to mixin with objects when the current
state matches the given one(s). This allows instance methods to behave a
specific way depending on what the value of the object&#8217;s state is.
</p>
<p>
For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='attr_accessor identifier id'>attr_accessor</span> <span class='symbol val'>:driver</span>
    <span class='attr_accessor identifier id'>attr_accessor</span> <span class='symbol val'>:passenger</span>

    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='event identifier id'>event</span> <span class='symbol val'>:ignite</span> <span class='do do kw'>do</span>
        <span class='transition identifier id'>transition</span> <span class='symbol val'>:parked</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:idling</span>
      <span class='end end kw'>end</span>

      <span class='state identifier id'>state</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
        <span class='def def kw'>def</span> <span class='speed identifier id'>speed</span>
          <span class='integer val'>0</span>
        <span class='end end kw'>end</span>

        <span class='def def kw'>def</span> <span class='rotate_driver identifier id'>rotate_driver</span>
          <span class='driver identifier id'>driver</span> <span class='assign token'>=</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='driver identifier id'>driver</span>
          <span class='self self kw'>self</span><span class='dot token'>.</span><span class='driver identifier id'>driver</span> <span class='assign token'>=</span> <span class='passenger identifier id'>passenger</span>
          <span class='self self kw'>self</span><span class='dot token'>.</span><span class='passenger identifier id'>passenger</span> <span class='assign token'>=</span> <span class='driver identifier id'>driver</span>
          <span class='true true kw'>true</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>

      <span class='state identifier id'>state</span> <span class='symbol val'>:idling</span><span class='comma token'>,</span> <span class='symbol val'>:first_gear</span> <span class='do do kw'>do</span>
        <span class='def def kw'>def</span> <span class='speed identifier id'>speed</span>
          <span class='integer val'>20</span>
        <span class='end end kw'>end</span>

        <span class='def def kw'>def</span> <span class='rotate_driver identifier id'>rotate_driver</span>
          <span class='self self kw'>self</span><span class='dot token'>.</span><span class='state identifier id'>state</span> <span class='assign token'>=</span> <span class='string val'>'parked'</span>
          <span class='rotate_driver identifier id'>rotate_driver</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>

      <span class='other_states identifier id'>other_states</span> <span class='symbol val'>:backing_up</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
In the above example, there are two dynamic behaviors defined for the
class:
</p>
<ul>
<li><tt>speed</tt>

</li>
<li><tt>rotate_driver</tt>

</li>
</ul>
<p>
Each of these behaviors are instance methods on the Vehicle class. However,
which method actually gets invoked is based on the current state of the
object. Using the above class as the example:
</p>
<pre class="code">
  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='driver identifier id'>driver</span> <span class='assign token'>=</span> <span class='string val'>'John'</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='passenger identifier id'>passenger</span> <span class='assign token'>=</span> <span class='string val'>'Jane'</span>

  <span class='comment val'># Behaviors in the &quot;parked&quot; state</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='state identifier id'>state</span>             <span class='comment val'># =&gt; &quot;parked&quot;</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='speed identifier id'>speed</span>             <span class='comment val'># =&gt; 0</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='rotate_driver identifier id'>rotate_driver</span>     <span class='comment val'># =&gt; true</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='driver identifier id'>driver</span>            <span class='comment val'># =&gt; &quot;Jane&quot;</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='passenger identifier id'>passenger</span>         <span class='comment val'># =&gt; &quot;John&quot;</span>

  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='ignite identifier id'>ignite</span>            <span class='comment val'># =&gt; true</span>

  <span class='comment val'># Behaviors in the &quot;idling&quot; state</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='state identifier id'>state</span>             <span class='comment val'># =&gt; &quot;idling&quot;</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='speed identifier id'>speed</span>             <span class='comment val'># =&gt; 20</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='rotate_driver identifier id'>rotate_driver</span>     <span class='comment val'># =&gt; true</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='driver identifier id'>driver</span>            <span class='comment val'># =&gt; &quot;John&quot;</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='passenger identifier id'>passenger</span>         <span class='comment val'># =&gt; &quot;Jane&quot;</span>
</pre>
<p>
As can be seen, both the <tt>speed</tt> and <tt>rotate_driver</tt> instance
method implementations changed how they behave based on what the current
state of the vehicle was.
</p>
<h3>Invalid behaviors</h3>
<p>
If a specific behavior has not been defined for a state, then a
NoMethodError exception will be raised, indicating that that method would
not normally exist for an object with that state.
</p>
<p>
Using the example from before:
</p>
<pre class="code">
  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='state identifier id'>state</span> <span class='assign token'>=</span> <span class='string val'>'backing_up'</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='speed identifier id'>speed</span>               <span class='comment val'># =&gt; NoMethodError: undefined method 'speed' for #&lt;Vehicle:0xb7d296ac&gt; in state &quot;backing_up&quot;</span>
</pre>
<h2>State-aware class methods</h2>
<p>
In addition to defining scopes for instance methods that are state-aware,
the same can be done for certain types of class methods.
</p>
<p>
Some libraries have support for class-level methods that only run certain
behaviors based on a conditions hash passed in. For example:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='do do kw'>do</span>
      <span class='dot3 op'>...</span>
      <span class='state identifier id'>state</span> <span class='symbol val'>:first_gear</span><span class='comma token'>,</span> <span class='symbol val'>:second_gear</span><span class='comma token'>,</span> <span class='symbol val'>:third_gear</span> <span class='do do kw'>do</span>
        <span class='validates_presence_of identifier id'>validates_presence_of</span>   <span class='symbol val'>:speed</span>
        <span class='validates_inclusion_of identifier id'>validates_inclusion_of</span>  <span class='symbol val'>:speed</span><span class='comma token'>,</span> <span class='symbol val'>:in</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>0</span><span class='dot2 op'>..</span><span class='integer val'>25</span><span class='comma token'>,</span> <span class='symbol val'>:if</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:in_school_zone?</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
In the above ActiveRecord model, two validations have been defined which
will <b>only</b> run when the Vehicle object is in one of the three states:
<tt>first_gear</tt>, <tt>second_gear</tt>, or +third_gear. Notice, also,
that if/unless conditions can continue to be used.
</p>
<p>
This functionality is not library-specific and can work for any class-level
method that is defined like so:
</p>
<pre class="code">
  <span class='def def kw'>def</span> <span class='validates_presence_of identifier id'>validates_presence_of</span><span class='lparen token'>(</span><span class='attribute identifier id'>attribute</span><span class='comma token'>,</span> <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
    <span class='dot3 op'>...</span>
  <span class='end end kw'>end</span>
</pre>
<p>
The minimum requirement is that the last argument in the method be an
options hash which contains at least <tt>:if</tt> condition support.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 746</span>

<span class='def def kw'>def</span> <span class='state identifier id'>state</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='names identifier id'>names</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='names identifier id'>names</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='Hash constant id'>Hash</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='names identifier id'>names</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span> <span class='colon op'>:</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='assert_valid_keys identifier id'>assert_valid_keys</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='comma token'>,</span> <span class='symbol val'>:value</span><span class='comma token'>,</span> <span class='symbol val'>:if</span><span class='rparen token'>)</span>
  
  <span class='states identifier id'>states</span> <span class='assign token'>=</span> <span class='add_states identifier id'>add_states</span><span class='lparen token'>(</span><span class='names identifier id'>names</span><span class='rparen token'>)</span>
  <span class='states identifier id'>states</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='state identifier id'>state</span><span class='bitor op'>|</span>
    <span class='if if kw'>if</span> <span class='options identifier id'>options</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='colon op'>:</span><span class='value identifier id'>value</span><span class='rparen token'>)</span>
      <span class='state identifier id'>state</span><span class='dot token'>.</span><span class='value identifier id'>value</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:value</span><span class='rbrack token'>]</span>
      <span class='self self kw'>self</span><span class='dot token'>.</span><span class='states identifier id'>states</span><span class='dot token'>.</span><span class='update identifier id'>update</span><span class='lparen token'>(</span><span class='state identifier id'>state</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    
    <span class='state identifier id'>state</span><span class='dot token'>.</span><span class='matcher identifier id'>matcher</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:if</span><span class='rbrack token'>]</span> <span class='if if_mod kw'>if</span> <span class='options identifier id'>options</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='symbol val'>:if</span><span class='rparen token'>)</span>
    <span class='state identifier id'>state</span><span class='dot token'>.</span><span class='context identifier id'>context</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='block_given? fid id'>block_given?</span>
  <span class='end end kw'>end</span>
  
  <span class='states identifier id'>states</span><span class='dot token'>.</span><span class='length identifier id'>length</span> <span class='eq op'>==</span> <span class='integer val'>1</span> <span class='question op'>?</span> <span class='states identifier id'>states</span><span class='dot token'>.</span><span class='first identifier id'>first</span> <span class='colon op'>:</span> <span class='states identifier id'>states</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>within_transaction</h3>
</div><div id="within_transaction-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>within_transaction</span><span class='args'>(object)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Runs a transaction, rolling back any changes if the yielded block fails.
</p>
<p>
This is only applicable to integrations that involve databases. By default,
this will not run any transactions, since the changes aren&#8217;t taking
place within the context of a database.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


1124
1125
1126
1127
1128
1129
1130</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 1124</span>

<span class='def def kw'>def</span> <span class='within_transaction identifier id'>within_transaction</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='rparen token'>)</span>
  <span class='if if kw'>if</span> <span class='use_transactions identifier id'>use_transactions</span>
    <span class='transaction identifier id'>transaction</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='rparen token'>)</span> <span class='lbrace token'>{</span> <span class='yield yield kw'>yield</span> <span class='rbrace token'>}</span>
  <span class='else else kw'>else</span>
    <span class='yield yield kw'>yield</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>write</h3>
</div><div id="write-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>write</span><span class='args'>(object, value)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Sets a new value in the given object&#8217;s state.
</p>
<p>
For example,
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Vehicle constant id'>Vehicle</span>
    <span class='state_machine identifier id'>state_machine</span> <span class='symbol val'>:initial</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:parked</span> <span class='do do kw'>do</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='vehicle identifier id'>vehicle</span> <span class='assign token'>=</span> <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='new identifier id'>new</span>   <span class='comment val'># =&gt; #&lt;Vehicle:0xb7d94ab0 @state=&quot;parked&quot;&gt;</span>
  <span class='Vehicle constant id'>Vehicle</span><span class='dot token'>.</span><span class='state_machine identifier id'>state_machine</span><span class='dot token'>.</span><span class='write identifier id'>write</span><span class='lparen token'>(</span><span class='vehicle identifier id'>vehicle</span><span class='comma token'>,</span> <span class='string val'>'idling'</span><span class='rparen token'>)</span>
  <span class='vehicle identifier id'>vehicle</span><span class='dot token'>.</span><span class='state identifier id'>state</span>           <span class='comment val'># =&gt; &quot;idling&quot;</span>
</pre>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


794
795
796</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/state_machine/machine.rb', line 794</span>

<span class='def def kw'>def</span> <span class='write identifier id'>write</span><span class='lparen token'>(</span><span class='object identifier id'>object</span><span class='comma token'>,</span> <span class='value identifier id'>value</span><span class='rparen token'>)</span>
  <span class='object identifier id'>object</span><span class='dot token'>.</span><span class='send identifier id'>send</span><span class='lparen token'>(</span><span class='dstring node'>&quot;#{attribute}=&quot;</span><span class='comma token'>,</span> <span class='value identifier id'>value</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
</div>
  </div>

</div>
    </div>
  </body>
</html>
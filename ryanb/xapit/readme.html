<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
<link rel="stylesheet" href="syntax_highlight.css" type="text/css" charset="utf-8" />

    <title>README</title>
  </head>
  <body>
    <div id="content">
      <div class="section docstring readme">
        <h1>Xapit</h1>
<p>
Xapit (pronounced &quot;zap it&quot;) is a high level interface for working
with a Xapian database.
</p>
<p>
Note: This project is early in development and the API is subject to
change.
</p>
<h2>Install</h2>
<p>
If you haven&#8217;t already, first install Xapian and the Xapian Bindings
for Ruby. http://wiki.github.com/Overbryd/acts_as_xapian/installation
</p>
<p>
To install as a Rails plugin, run this command.
</p>
<pre class="code">
  <span class='script identifier id'>script</span><span class='div op'>/</span><span class='plugin identifier id'>plugin</span> <span class='install identifier id'>install</span> <span class='git identifier id'>git</span><span class='symbol val'>:/</span><span class='regexp val'>/github.com/</span><span class='ryanb identifier id'>ryanb</span><span class='div op'>/</span><span class='xapit identifier id'>xapit</span><span class='dot token'>.</span><span class='git identifier id'>git</span>
</pre>
<p>
Note: this will soon also be available as a Ruby gem, but not yet.
</p>
<h2>Setup</h2>
<p>
Simply call &quot;xapit&quot; in the model and pass a block to define the
indexed attributes.
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Article constant id'>Article</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='xapit identifier id'>xapit</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='index identifier id'>index</span><span class='bitor op'>|</span>
      <span class='index identifier id'>index</span><span class='dot token'>.</span><span class='text identifier id'>text</span> <span class='symbol val'>:name</span><span class='comma token'>,</span> <span class='symbol val'>:content</span>
      <span class='index identifier id'>index</span><span class='dot token'>.</span><span class='field identifier id'>field</span> <span class='symbol val'>:category_id</span>
      <span class='index identifier id'>index</span><span class='dot token'>.</span><span class='facet identifier id'>facet</span> <span class='symbol val'>:author_name</span><span class='comma token'>,</span> <span class='string val'>&quot;Author&quot;</span>
      <span class='index identifier id'>index</span><span class='dot token'>.</span><span class='sortable identifier id'>sortable</span> <span class='symbol val'>:id</span><span class='comma token'>,</span> <span class='symbol val'>:category_id</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
First we index &quot;name&quot; and &quot;content&quot; attributes for full
text searching. The &quot;category_id&quot; field is indexed for
:conditions searching. The &quot;author_name&quot; is indexed as a facet
with &quot;Author&quot; being the display name of the facet. See the facets
section below for details. Finally the &quot;id&quot; and
&quot;category_id&quot; attributes are indexed as sortable attributes so
they can be included in the :order option in a search.
</p>
<p>
Because the indexing happens in Ruby these attributes do no have to be
database columns. They can be simple Ruby methods. For example, the
&quot;author_name&quot; attribute mentioned above can be defined like this.
</p>
<pre class="code">
  <span class='def def kw'>def</span> <span class='author_name identifier id'>author_name</span>
    <span class='author identifier id'>author</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
  <span class='end end kw'>end</span>
</pre>
<p>
This way you can create a completely custom facet by simply defining your
own method. Multiple facet options or field values per record are supported
if you return an array.
</p>
<pre class="code">
  <span class='def def kw'>def</span> <span class='author_names identifier id'>author_names</span>
    <span class='authors identifier id'>authors</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='symbol val'>:name</span><span class='rparen token'>)</span> <span class='comment val'># =&gt; [&quot;John&quot;, &quot;Bob&quot;]</span>
  <span class='end end kw'>end</span>
</pre>
<p>
Finally, you can pass any find options to the xapit method to determine
what gets indexed or improve performance with eager loading or a different
batch size.
</p>
<pre class="code">
  <span class='xapit identifier id'>xapit</span><span class='lparen token'>(</span><span class='symbol val'>:batch_size</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>100</span><span class='comma token'>,</span> <span class='symbol val'>:include</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:author</span><span class='comma token'>,</span> <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='symbol val'>:visible</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span>
</pre>
<h2>Index</h2>
<p>
To perform the indexing, run the xapit:index rake task.
</p>
<pre class="code">
  <span class='rake identifier id'>rake</span> <span class='xapit identifier id'>xapit</span><span class='symbol val'>:index</span>
</pre>
<p>
It can also be triggered through Ruby code using this command.
</p>
<pre class="code">
  <span class='Xapit constant id'>Xapit</span><span class='colon2 op'>::</span><span class='Config constant id'>Config</span><span class='dot token'>.</span><span class='remove_database identifier id'>remove_database</span>
  <span class='Xapit constant id'>Xapit</span><span class='dot token'>.</span><span class='index_all identifier id'>index_all</span>
</pre>
<h2>Search</h2>
<p>
You can then perform a search on the model.
</p>
<pre class="code">
  <span class='comment val'># perform a simple full text search</span>
  <span class='@articles ivar id'>@articles</span> <span class='assign token'>=</span> <span class='Article constant id'>Article</span><span class='dot token'>.</span><span class='search identifier id'>search</span><span class='lparen token'>(</span><span class='string val'>&quot;phone&quot;</span><span class='rparen token'>)</span>

  <span class='comment val'># add pagination if you're using will_paginate</span>
  <span class='@articles ivar id'>@articles</span> <span class='assign token'>=</span> <span class='Article constant id'>Article</span><span class='dot token'>.</span><span class='search identifier id'>search</span><span class='lparen token'>(</span><span class='string val'>&quot;phone&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:per_page</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>10</span><span class='comma token'>,</span> <span class='symbol val'>:page</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:page</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

  <span class='comment val'># search based on indexed fields</span>
  <span class='@articles ivar id'>@articles</span> <span class='assign token'>=</span> <span class='Article constant id'>Article</span><span class='dot token'>.</span><span class='search identifier id'>search</span><span class='lparen token'>(</span><span class='string val'>&quot;phone&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='symbol val'>:category_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:category_id</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span>

  <span class='comment val'># manually sort based on any number of indexed fields, sort defaults to most relevant</span>
  <span class='@articles ivar id'>@articles</span> <span class='assign token'>=</span> <span class='Article constant id'>Article</span><span class='dot token'>.</span><span class='search identifier id'>search</span><span class='lparen token'>(</span><span class='string val'>&quot;phone&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:category_id</span><span class='comma token'>,</span> <span class='symbol val'>:id</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:descending</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>

  <span class='comment val'># basic boolean matching is supported</span>
  <span class='@articles ivar id'>@articles</span> <span class='assign token'>=</span> <span class='Article constant id'>Article</span><span class='dot token'>.</span><span class='search identifier id'>search</span><span class='lparen token'>(</span><span class='string val'>&quot;phone OR fax NOT email&quot;</span><span class='rparen token'>)</span>
</pre>
<p>
You can also search all indexed models through Xapit.search.
</p>
<pre class="code">
  <span class='comment val'># search all indexed models</span>
  <span class='@records ivar id'>@records</span> <span class='assign token'>=</span> <span class='Xapit constant id'>Xapit</span><span class='dot token'>.</span><span class='search identifier id'>search</span><span class='lparen token'>(</span><span class='string val'>&quot;phone&quot;</span><span class='rparen token'>)</span>
</pre>
<h2>Results</h2>
<p>
Simply iterate through the returned set to display the results.
</p>
<pre class="code">
  <span class='lt op'>&lt;</span><span class='string val'>% for </span><span class='article identifier id'>article</span> <span class='in in kw'>in</span> <span class='@articles ivar id'>@articles</span> <span class='mod op'>%</span><span class='gt op'>&gt;</span>
    <span class='lt op'>&lt;</span><span class='string val'>%= article.name %&gt;
    &lt;%=</span> <span class='article identifier id'>article</span><span class='dot token'>.</span><span class='xapit_relevance identifier id'>xapit_relevance</span> <span class='string val'>%&gt;
  &lt;% end %&gt;</span>
</pre>
<p>
The &quot;xapit_relevance&quot; holds a percentage (between 0 and 100)
determining how relevant the given document is to the user&#8217;s search
query.
</p>
<h2>Spelling</h2>
<p>
If the searched term isn&#8217;t found, but it is similar to another term
then it will show up as a spelling suggestion.
</p>
<pre class="code">
  <span class='lt op'>&lt;</span><span class='string val'>% if </span><span class='@articles ivar id'>@articles</span><span class='dot token'>.</span><span class='spelling_suggestion identifier id'>spelling_suggestion</span> <span class='string val'>%&gt;
    Did you mean &lt;%= link_to h(@articles.spelling_suggestion), :overwrite_params =&gt;</span> <span class='lbrace token'>{</span> <span class='symbol val'>:keywords</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@articles ivar id'>@articles</span><span class='dot token'>.</span><span class='spelling_suggestion identifier id'>spelling_suggestion</span> <span class='rbrace token'>}</span> <span class='mod op'>%</span><span class='gt op'>&gt;</span><span class='integer val'>?
</span>  <span class='lt op'>&lt;</span><span class='string val'>% end </span><span class='mod op'>%</span><span class='gt op'>&gt;</span>
</pre>
<h2>Facets</h2>
<p>
Facets allow you to further filter the result set based on certain
attributes.
</p>
<pre class="code">
  <span class='lt op'>&lt;</span><span class='string val'>% for </span><span class='facet identifier id'>facet</span> <span class='in in kw'>in</span> <span class='@articles ivar id'>@articles</span><span class='dot token'>.</span><span class='facets identifier id'>facets</span> <span class='string val'>%&gt;
    &lt;%= facet.name %&gt;</span>
    <span class='lt op'>&lt;</span><span class='string val'>% for </span><span class='option identifier id'>option</span> <span class='in in kw'>in</span> <span class='facet identifier id'>facet</span><span class='dot token'>.</span><span class='options identifier id'>options</span> <span class='string val'>%&gt;
      &lt;%= link_to option.name, :overwrite_params =&gt;</span> <span class='lbrace token'>{</span> <span class='symbol val'>:facets</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='option identifier id'>option</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span> <span class='mod op'>%</span><span class='gt op'>&gt;</span>
      <span class='lparen token'>(</span><span class='lt op'>&lt;</span><span class='string val'>%= option.count %&gt;)
    &lt;% end %&gt;
  &lt;% end %&gt;
</span></pre>
<p>
The to_param method is defined on option to return an identifier which will
be passed through the URL. Use this in the search.
</p>
<pre class="code">
  <span class='Article constant id'>Article</span><span class='dot token'>.</span><span class='search identifier id'>search</span><span class='lparen token'>(</span><span class='string val'>&quot;phone&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:facets</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:facets</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
</pre>
<p>
You can also list the applied facets along with a remove link.
</p>
<pre class="code">
  <span class='lt op'>&lt;</span><span class='string val'>% for </span><span class='option identifier id'>option</span> <span class='in in kw'>in</span> <span class='@articles ivar id'>@articles</span><span class='dot token'>.</span><span class='applied_facet_options identifier id'>applied_facet_options</span> <span class='string val'>%&gt;
    &lt;%=h option.name %&gt;</span>
    <span class='lt op'>&lt;</span><span class='string val'>%= link_to &quot;remove&quot;, :overwrite_params =</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='symbol val'>:facets</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='option identifier id'>option</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span> <span class='mod op'>%</span><span class='gt op'>&gt;</span>
  <span class='lt op'>&lt;</span><span class='string val'>% end </span><span class='mod op'>%</span><span class='gt op'>&gt;</span>
</pre>
<h2>Config</h2>
<p>
When installing Xapit as a Rails plugin, an initializer file is
automatically created to setup. It looks like this.
</p>
<pre class="code">
  <span class='Xapit constant id'>Xapit</span><span class='colon2 op'>::</span><span class='Config constant id'>Config</span><span class='dot token'>.</span><span class='setup identifier id'>setup</span><span class='lparen token'>(</span><span class='symbol val'>:database_path</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;#{Rails.root}/db/xapiandb&quot;</span><span class='rparen token'>)</span>
</pre>
<p>
There are many other options you can pass into here. This is a more
advanced configuration setting which changes the stemming language,
disables spelling, and changes the indexer and parser to a classic
variation. The classic ones use Xapian&#8217;s built-in term generator and
query parser instead of the ones offered by Xapit.
</p>
<pre class="code">
  <span class='Xapit constant id'>Xapit</span><span class='colon2 op'>::</span><span class='Config constant id'>Config</span><span class='dot token'>.</span><span class='setup identifier id'>setup</span><span class='lparen token'>(</span>
    <span class='symbol val'>:database_path</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;#{Rails.root}/db/external/xapiandb&quot;</span><span class='comma token'>,</span>
    <span class='symbol val'>:spelling</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='comma token'>,</span>
    <span class='symbol val'>:stemming</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;german&quot;</span><span class='comma token'>,</span>
    <span class='symbol val'>:indexer</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='ClassicIndexer constant id'>ClassicIndexer</span><span class='comma token'>,</span>
    <span class='symbol val'>:query_parser</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='ClassicQueryParser constant id'>ClassicQueryParser</span>
  <span class='rparen token'>)</span>
</pre>
<h2>Outside of Rails</h2>
<p>
Xapit can be used outside of Rails too. You&#8217;ll just need to include
the membership module:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Product constant id'>Product</span> <span class='comment val'># not Active Record</span>
    <span class='include identifier id'>include</span> <span class='Xapit constant id'>Xapit</span><span class='colon2 op'>::</span><span class='Membership constant id'>Membership</span>

    <span class='xapit identifier id'>xapit</span> <span class='comment val'># ...</span>
  <span class='end end kw'>end</span>
</pre>
<p>
This class is expected to respond to &quot;find_each&quot;
(Product.find_each) which is used to iterate through the records when
indexing and &quot;find&quot; for fetching a record by &quot;id&quot;.
</p>
<h2>Bug Reports</h2>
<p>
If you have found a bug to report or a feature to request, please add it to
the GitHub issue tracker if it is not there already.
</p>
<p>
http://github.com/ryanb/xapit/issues/
</p>
<h2>Development</h2>
<p>
This project can be found on github at the following URL.
</p>
<p>
http://github.com/ryanb/xapit
</p>
<p>
If you would like to contribute to this project, please fork the repository
and send me a pull request.
</p>

      </div>
    </div>
  </body>
</html>
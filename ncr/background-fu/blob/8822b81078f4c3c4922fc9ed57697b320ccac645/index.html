<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>ncr's background-fu - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/ncr/commits/background-fu/master" rel="alternate" title="Recent Commits to background-fu:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("ncr", "background-fu", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='ncr/background-fu/blob/8822b81078f4c3c4922fc9ed57697b320ccac645' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='ncr/background-fu/blob/8822b81078f4c3c4922fc9ed57697b320ccac645' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("ncr", "background-fu", "8822b81078f4c3c4922fc9ed57697b320ccac645", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/ncr/background-fu/tree/">Source</a></li>
            <li class=""><a href="http://github.com/ncr/background-fu/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/ncr/background-fu/network">Network</a></li>            
            <li class=""><a href="http://github.com/ncr/background-fu/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/ncr/background-fu">Wiki</a></li>
            <li class=""><a href="http://github.com/ncr/background-fu/graphs">Graphs</a></li>                    
            <li class="active"><a href="/ncr/background-fu">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/ncr">ncr</a> / <b><a href="http://github.com/ncr/background-fu/tree">background-fu</a></b>        
                <a id="namespaces_button" rel="ncr/background-fu/blob/8822b81078f4c3c4922fc9ed57697b320ccac645" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="ncr/background-fu/blob/8822b81078f4c3c4922fc9ed57697b320ccac645" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>BackgroundFu</h1>
<ul>
<li>http://github.com/ncr/background-fu

</li>
<li>git://github.com/ncr/background-fu.git

</li>
<li>http://trix.lighthouseapp.com/projects/9809-backgroundfu

</li>
<li>ncr@trix.pl

</li>
<li>http://trix.pl

</li>
</ul>
<h2>DESCRIPTION:</h2>
<p>
Background tasks in Ruby On Rails made dead simple.
</p>
<h2>FEATURES/PROBLEMS:</h2>
<ul>
<li>Running long background tasks outside of request-response cycle.

</li>
<li>Very easy to setup and fun to use (See examples below).

</li>
<li>Clean and straightforward approach (database-based priority queue).

</li>
<li>Uses database table (migration included) to store jobs reliably.

</li>
<li>Capistrano tasks included.

</li>
<li>Generators with migrations and example views (Prototype required) included
(to be used with concurrency enabled).

</li>
<li>Multiple worker daemons available.

</li>
<li>Easy to deploy in distributed environments.

</li>
<li>Enables prioritizing and simple scheduling.

</li>
<li>Optional worker monitoring (good for AJAX progress bars).

</li>
<li>Proven its stability and reliability in production use.

</li>
</ul>
<h2>SYNOPSIS:</h2>
<pre class="code">
  <span class='ruby identifier id'>ruby</span> <span class='dot token'>.</span><span class='div op'>/</span><span class='script identifier id'>script</span><span class='div op'>/</span><span class='generate identifier id'>generate</span> <span class='background identifier id'>background</span>
  <span class='rake identifier id'>rake</span> <span class='db identifier id'>db</span><span class='symbol val'>:migrate</span>

  <span class='comment val'># to run in production mode use RAILS_ENV=production ruby ./script/daemons start</span>
  <span class='ruby identifier id'>ruby</span> <span class='dot token'>.</span><span class='div op'>/</span><span class='script identifier id'>script</span><span class='div op'>/</span><span class='daemons identifier id'>daemons</span> <span class='start identifier id'>start</span>

  <span class='comment val'># then try in console:</span>

  <span class='job_id identifier id'>job_id</span> <span class='assign token'>=</span> <span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='enqueue! fid id'>enqueue!</span><span class='lparen token'>(</span><span class='ExampleWorker constant id'>ExampleWorker</span><span class='comma token'>,</span> <span class='symbol val'>:add</span><span class='comma token'>,</span> <span class='integer val'>1</span><span class='comma token'>,</span> <span class='integer val'>2</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='id identifier id'>id</span>

  <span class='comment val'># after few seconds when background daemon completes the job</span>

  <span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='job_id identifier id'>job_id</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='result identifier id'>result</span> <span class='comment val'># result of the job should equal 3</span>

  <span class='If constant id'>If</span> <span class='you identifier id'>you</span> <span class='want identifier id'>want</span> <span class='to identifier id'>to</span> <span class='use identifier id'>use</span> <span class='default identifier id'>default</span> <span class='generated identifier id'>generated</span> <span class='views identifier id'>views</span><span class='comma token'>,</span> <span class='update identifier id'>update</span> <span class='your identifier id'>your</span> <span class='config identifier id'>config</span><span class='div op'>/</span><span class='routes identifier id'>routes</span><span class='dot token'>.</span><span class='rb identifier id'>rb</span><span class='colon op'>:</span>

  <span class='map identifier id'>map</span><span class='dot token'>.</span><span class='namespace identifier id'>namespace</span> <span class='string val'>&quot;admin&quot;</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='admin identifier id'>admin</span><span class='bitor op'>|</span>
    <span class='admin identifier id'>admin</span><span class='dot token'>.</span><span class='resources identifier id'>resources</span> <span class='symbol val'>:jobs</span>
  <span class='end end kw'>end</span>

  <span class='Then constant id'>Then</span> <span class='you identifier id'>you</span> <span class='can identifier id'>can</span> <span class='point identifier id'>point</span> <span class='your identifier id'>your</span> <span class='browser identifier id'>browser</span> <span class='to identifier id'>to</span> <span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/localhost:3000/</span><span class='admin identifier id'>admin</span><span class='div op'>/</span><span class='jobs identifier id'>jobs</span>
</pre>
<h2>EXAMPLES:</h2>
<pre class="code">
  <span class='comment val'># In lib/workers/example_worker.rb:</span>

  <span class='comment val'># Simple, non-monitored worker.</span>
  <span class='class class kw'>class</span> <span class='ExampleWorker constant id'>ExampleWorker</span>

    <span class='def def kw'>def</span> <span class='add identifier id'>add</span><span class='lparen token'>(</span><span class='a identifier id'>a</span><span class='comma token'>,</span> <span class='b identifier id'>b</span><span class='rparen token'>)</span>
      <span class='a identifier id'>a</span> <span class='plus op'>+</span> <span class='b identifier id'>b</span>
    <span class='end end kw'>end</span>

  <span class='end end kw'>end</span>

  <span class='comment val'># In lib/workers/example_monitored_worker.rb:</span>

  <span class='comment val'># Remeber to include BackgroundFu::WorkerMonitoring.</span>
  <span class='class class kw'>class</span> <span class='ExampleMonitoredWorker constant id'>ExampleMonitoredWorker</span>

    <span class='include identifier id'>include</span> <span class='BackgroundFu constant id'>BackgroundFu</span><span class='colon2 op'>::</span><span class='WorkerMonitoring constant id'>WorkerMonitoring</span>

    <span class='def def kw'>def</span> <span class='long_and_monitored identifier id'>long_and_monitored</span>
      <span class='my_progress identifier id'>my_progress</span> <span class='assign token'>=</span> <span class='integer val'>0</span>

      <span class='record_progress identifier id'>record_progress</span><span class='lparen token'>(</span><span class='my_progress identifier id'>my_progress</span><span class='rparen token'>)</span>

      <span class='while while kw'>while</span><span class='lparen token'>(</span><span class='my_progress identifier id'>my_progress</span> <span class='lt op'>&lt;</span> <span class='integer val'>100</span><span class='rparen token'>)</span>
        <span class='my_progress identifier id'>my_progress</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='record_progress identifier id'>record_progress</span><span class='lparen token'>(</span><span class='my_progress identifier id'>my_progress</span><span class='rparen token'>)</span>
        <span class='sleep identifier id'>sleep</span> <span class='integer val'>1</span>
      <span class='end end kw'>end</span>

      <span class='record_progress identifier id'>record_progress</span><span class='lparen token'>(</span><span class='integer val'>100</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

  <span class='end end kw'>end</span>

  <span class='comment val'># In a controller:</span>

    <span class='def def kw'>def</span> <span class='create identifier id'>create</span>
      <span class='session identifier id'>session</span><span class='lbrack token'>[</span><span class='symbol val'>:job_id</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='enqueue! fid id'>enqueue!</span><span class='lparen token'>(</span><span class='ExampleWorker constant id'>ExampleWorker</span><span class='comma token'>,</span> <span class='symbol val'>:add</span><span class='comma token'>,</span> <span class='integer val'>1</span><span class='comma token'>,</span> <span class='integer val'>2</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='id identifier id'>id</span>
      <span class='comment val'># or try the monitored worker: session[:job_id] = Job.enqueue!(ExampleMonitoredWorker, :long_and_monitored)</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='show identifier id'>show</span>
      <span class='@job ivar id'>@job</span>    <span class='assign token'>=</span> <span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='session identifier id'>session</span><span class='lbrack token'>[</span><span class='symbol val'>:job_id</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='@result ivar id'>@result</span> <span class='assign token'>=</span> <span class='@job ivar id'>@job</span><span class='dot token'>.</span><span class='result identifier id'>result</span> <span class='if if_mod kw'>if</span> <span class='@job ivar id'>@job</span><span class='dot token'>.</span><span class='finished? fid id'>finished?</span>
      <span class='comment val'># or check progress if your worker is monitored: @progress = @job.progress</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='index identifier id'>index</span>
      <span class='@jobs ivar id'>@jobs</span> <span class='assign token'>=</span> <span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='destroy identifier id'>destroy</span>
      <span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='session identifier id'>session</span><span class='lbrack token'>[</span><span class='symbol val'>:job_id</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='destroy identifier id'>destroy</span>
    <span class='end end kw'>end</span>
</pre>
<h2>HANDY CAPISTRANO TASKS:</h2>
<pre class="code">
  <span class='namespace identifier id'>namespace</span> <span class='symbol val'>:deploy</span> <span class='do do kw'>do</span>

    <span class='desc identifier id'>desc</span> <span class='string val'>&quot;Run this after every successful deployment&quot;</span>
    <span class='task identifier id'>task</span> <span class='symbol val'>:after_default</span> <span class='do do kw'>do</span>
      <span class='restart_background_fu identifier id'>restart_background_fu</span>
    <span class='end end kw'>end</span>

  <span class='end end kw'>end</span>

  <span class='desc identifier id'>desc</span> <span class='string val'>&quot;Restart BackgroundFu daemon&quot;</span>
  <span class='task identifier id'>task</span> <span class='symbol val'>:restart_background_fu</span> <span class='do do kw'>do</span>
    <span class='run identifier id'>run</span> <span class='dstring node'>&quot;RAILS_ENV=production ruby #{current_path}/script/daemons stop&quot;</span>
    <span class='run identifier id'>run</span> <span class='dstring node'>&quot;RAILS_ENV=production ruby #{current_path}/script/daemons start&quot;</span>
  <span class='end end kw'>end</span>
</pre>
<h2>CONFIGURATION:</h2>
<pre class="code">
  <span class='By constant id'>By</span> <span class='default identifier id'>default</span><span class='comma token'>,</span> <span class='completed identifier id'>completed</span> <span class='background identifier id'>background</span> <span class='jobs identifier id'>jobs</span> <span class='that identifier id'>that</span> <span class='are identifier id'>are</span> <span class='more identifier id'>more</span> <span class='than identifier id'>than</span> <span class='one identifier id'>one</span> <span class='week identifier id'>week</span> <span class='old identifier id'>old</span>
  <span class='will identifier id'>will</span> <span class='be identifier id'>be</span> <span class='cleaned identifier id'>cleaned</span> <span class='out identifier id'>out</span> <span class='of identifier id'>of</span> <span class='the identifier id'>the</span> <span class='database identifier id'>database</span> <span class='on identifier id'>on</span> <span class='application identifier id'>application</span> <span class='startup identifier id'>startup</span><span class='comma token'>,</span> <span class='and and kw'>and</span> <span class='the identifier id'>the</span> <span class='daemon identifier id'>daemon</span>
  <span class='will identifier id'>will</span> <span class='check identifier id'>check</span> <span class='for for kw'>for</span> <span class='queued identifier id'>queued</span> <span class='background identifier id'>background</span> <span class='jobs identifier id'>jobs</span> <span class='every identifier id'>every</span> <span class='integer val'>5</span> <span class='seconds identifier id'>seconds</span><span class='dot token'>.</span>

  <span class='To constant id'>To</span> <span class='override identifier id'>override</span> <span class='these identifier id'>these</span> <span class='settings identifier id'>settings</span><span class='comma token'>,</span> <span class='modify identifier id'>modify</span> <span class='your identifier id'>your</span> <span class='config identifier id'>config</span><span class='div op'>/</span><span class='daemons identifier id'>daemons</span><span class='dot token'>.</span><span class='yml identifier id'>yml</span> <span class='file identifier id'>file</span><span class='colon op'>:</span>

  <span class='background_fu identifier id'>background_fu</span><span class='colon op'>:</span>
    <span class='cleanup_interval identifier id'>cleanup_interval</span><span class='colon op'>:</span> <span class='symbol val'>:on_startup</span> <span class='comment val'># :on_startup | :continuous</span>
    <span class='monitor_interval identifier id'>monitor_interval</span><span class='colon op'>:</span> <span class='integer val'>5</span>           <span class='comment val'># Check every x seconds</span>
</pre>
<h2>BONUS FEATURES:</h2>
<p>
There are bonus features available if you set
config.active_record.allow_concurrency = true in your environment.
</p>
<p>
These features are:
</p>
<pre class="code">
 <span class='mult op'>*</span> <span class='monitoring identifier id'>monitoring</span> <span class='progress identifier id'>progress</span> <span class='lparen token'>(</span><span class='perfect identifier id'>perfect</span> <span class='for for kw'>for</span> <span class='ajax identifier id'>ajax</span> <span class='progress identifier id'>progress</span> <span class='bars identifier id'>bars</span><span class='rparen token'>)</span>
 <span class='mult op'>*</span> <span class='stopping identifier id'>stopping</span> <span class='a identifier id'>a</span> <span class='running identifier id'>running</span> <span class='worker identifier id'>worker</span> <span class='in in kw'>in</span> <span class='a identifier id'>a</span> <span class='merciful identifier id'>merciful</span> <span class='way identifier id'>way</span><span class='dot token'>.</span>
</pre>
<p>
Generated admin views are meant to be used only when bonus features
(concurrency) are enabled.
</p>
<p>
Read the code (short and easy) to discover them.
</p>
<h2>REQUIREMENTS:</h2>
<ul>
<li>rails

</li>
<li>daemons

</li>
</ul>
<h2>INSTALL:</h2>
<ul>
<li>As a Rails plugin: ./script/plugin install
git://github.com/ncr/background-fu.git

</li>
<li>As as a gem to be &#8216;vendorized&#8217; starting from Rails 2.1: refer
to documentation on rake gems:unpack:dependencies.

</li>
</ul>
<h2>CONTRIBUTING:</h2>
<p>
If you want to help improve this plugin, feel free to contact me. Fork the
project on GitHub, implement a feature, send me a pull request.
</p>
<h2>LICENSE:</h2>
<p>
(The MIT License)
</p>
<p>
Copyright &#169; Jacek Becela
</p>
<p>
Permission is hereby granted, free of charge, to any person obtaining a
copy of this software and associated documentation files (the
&#8216;Software&#8217;), to deal in the Software without restriction,
including without limitation the rights to use, copy, modify, merge,
publish, distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to the
following conditions:
</p>
<p>
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
</p>
<p>
THE SOFTWARE IS PROVIDED &#8216;AS IS&#8217;, WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
USE OR OTHER DEALINGS IN THE SOFTWARE.
</p>

</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>bmabey's database_cleaner - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/bmabey/commits/database_cleaner/master" rel="alternate" title="Recent Commits to database_cleaner:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("bmabey", "database_cleaner", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='bmabey/database_cleaner/blob/0870eb9f684cfa50da907f6abb22b1cd2d19059e' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='bmabey/database_cleaner/blob/0870eb9f684cfa50da907f6abb22b1cd2d19059e' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("bmabey", "database_cleaner", "0870eb9f684cfa50da907f6abb22b1cd2d19059e", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/bmabey/database_cleaner/tree/">Source</a></li>
            <li class=""><a href="http://github.com/bmabey/database_cleaner/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/bmabey/database_cleaner/network">Network</a></li>            
            <li class=""><a href="http://github.com/bmabey/database_cleaner/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/bmabey/database_cleaner">Wiki</a></li>
            <li class=""><a href="http://github.com/bmabey/database_cleaner/graphs">Graphs</a></li>                    
            <li class="active"><a href="/bmabey/database_cleaner">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/bmabey">bmabey</a> / <b><a href="http://github.com/bmabey/database_cleaner/tree">database_cleaner</a></b>        
                <a id="namespaces_button" rel="bmabey/database_cleaner/blob/0870eb9f684cfa50da907f6abb22b1cd2d19059e" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="bmabey/database_cleaner/blob/0870eb9f684cfa50da907f6abb22b1cd2d19059e" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>Database Cleaner</h1>


	<p>Database Cleaner is a set of strategies for cleaning your database in Ruby.
The original use case was to ensure a clean state during tests.  Each strategy 
is a small amount of code but is code that is usually needed in any ruby app 
that is testing with a database.</p>


	<p>Right now the only <span class="caps">ORM</span> supported is ActiveRecord and it currently has two strategies:
truncation and transaction.</p>


	<p>Support for DataMapper is built-in.  All that needs to be written are the strategies. :)</p>


	<h2>How to use</h2>


<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner'</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='symbol val'>:truncation</span>

  <span class='comment val'># then, whenever you need to clean the DB</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='clean identifier id'>clean</span>
</pre>

With the :truncation strategy you can also pass in options, for example:
<pre class="code">
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='symbol val'>:truncation</span><span class='comma token'>,</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='geq op'>&gt;=</span><span class='bitand op'>&amp;</span><span class='gt identifier id'>gt</span><span class='semicolon token'>;</span> <span class='dstring node'>%w[widgets dogs some_other_table]</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;
</span></pre>

<pre class="code">
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='symbol val'>:truncation</span><span class='comma token'>,</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='geq op'>&gt;=</span><span class='bitand op'>&amp;</span><span class='gt identifier id'>gt</span><span class='semicolon token'>;</span> <span class='dstring node'>%w[widgets]</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;
</span></pre>

	<p>(I should point out the truncation strategy will never truncate your schema_migrations table.)</p>


	<p>Some strategies require that you call DatabaseCleaner.start before calling clean 
(for example the :transaction one needs to know to open up a transaction). So
you would have:</p>


<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner'</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='symbol val'>:transaction</span>

  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='start identifier id'>start</span> <span class='comment val'># usually this is called in setup of a test</span>
  <span class='dirty_the_db identifier id'>dirty_the_db</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='clean identifier id'>clean</span> <span class='comment val'># cleanup of the test</span>
</pre>

	<p>At times you may want to do a single clean with one strategy.  For example, you may want
to start the process by truncating all the tables, but then use the faster transaction
strategy the remaining time.  To accomplish this you can say:</p>


<pre class="code">
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner'</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='clean_with identifier id'>clean_with</span> <span class='symbol val'>:truncation</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='symbol val'>:transaction</span>
  <span class='comment val'># then make the DatabaseCleaner.start and DatabaseCleaner.clean calls appropriately</span>
</pre>

	<p>Example usage with RSpec:</p>


<pre class="code">
<span class='Spec constant id'>Spec</span><span class='colon2 op'>::</span><span class='Runner constant id'>Runner</span><span class='dot token'>.</span><span class='configure identifier id'>configure</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='config identifier id'>config</span><span class='bitor op'>|</span>

  <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='before identifier id'>before</span><span class='lparen token'>(</span><span class='symbol val'>:suite</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='symbol val'>:transaction</span>
    <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='clean_with identifier id'>clean_with</span><span class='lparen token'>(</span><span class='symbol val'>:truncation</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='before identifier id'>before</span><span class='lparen token'>(</span><span class='symbol val'>:each</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='start identifier id'>start</span>
  <span class='end end kw'>end</span>

  <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='after identifier id'>after</span><span class='lparen token'>(</span><span class='symbol val'>:each</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
    <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='clean identifier id'>clean</span>
  <span class='end end kw'>end</span>

<span class='end end kw'>end</span>
</pre>

	<p>For use in Cucumber please see the section below.</p>


	<h2>Why?</h2>


	<p>One of my motivations for writing this library was to have an easy way to 
turn on what Rails calls &#8220;transactional_fixtures&#8221; in my non-rails 
ActiveRecord projects.  For example, Cucumber ships with a Rails world that
will wrap each scenario in a transaction.  This is great, but what if you are 
using ActiveRecord in a non-rails project?  You used to have to copy-and-paste
the needed code, but with DatabaseCleaner you can now say:</p>


<pre class="code">
  <span class='comment val'>#env.rb</span>
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner'</span>
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner/cucumber'</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='symbol val'>:transaction</span>
</pre>

	<p>Now lets say you are running your features and it requires that another process be 
involved (i.e. Selenium running against your app&#8217;s server.)  You can simply change
your strategy type:</p>


<pre class="code">
  <span class='comment val'>#env.rb</span>
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner'</span>
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner/cucumber'</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='symbol val'>:truncation</span>
</pre>

You can have the best of both worlds and use the best one for the job:
<pre class="code">
  <span class='comment val'>#env.rb</span>
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner'</span>
  <span class='require identifier id'>require</span> <span class='string val'>'database_cleaner/cucumber'</span>
  <span class='DatabaseCleaner constant id'>DatabaseCleaner</span><span class='dot token'>.</span><span class='strategy identifier id'>strategy</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='ENV constant id'>ENV</span><span class='lbrack token'>[</span><span class='string val'>'SELENIUM'</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='string val'>'true'</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='symbol val'>:truncation</span> <span class='colon op'>:</span> <span class='symbol val'>:transaction</span>
</pre>

	<h2><span class="caps">COPYRIGHT</span></h2>


	<p>Copyright&#169; 2009 Ben Mabey. See <span class="caps">LICENSE</span> for details.</p>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>datamapper's dm-core - Class: DataMapper::Adapters::DataObjectsAdapter - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/datamapper/commits/dm-core/master" rel="alternate" title="Recent Commits to dm-core:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    GitHubRepo.init("datamapper", "dm-core", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='datamapper/dm-core/blob/65802c9db1e61d0ae584633fc274b5cae959733a' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='datamapper/dm-core/blob/65802c9db1e61d0ae584633fc274b5cae959733a' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("datamapper", "dm-core", "65802c9db1e61d0ae584633fc274b5cae959733a", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/datamapper/dm-core/tree/">Source</a></li>
            <li class=""><a href="http://github.com/datamapper/dm-core/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/datamapper/dm-core/network">Network</a></li>            
            <li class=""><a href="http://github.com/datamapper/dm-core/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/datamapper/dm-core">Wiki</a></li>
            <li class=""><a href="http://github.com/datamapper/dm-core/graphs">Graphs</a></li>                    
            <li class="active"><a href="/datamapper/dm-core">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/datamapper">datamapper</a> / <b><a href="http://github.com/datamapper/dm-core/tree">dm-core</a></b>        
                <a id="namespaces_button" rel="datamapper/dm-core/blob/65802c9db1e61d0ae584633fc274b5cae959733a" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="datamapper/dm-core/blob/65802c9db1e61d0ae584633fc274b5cae959733a" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section class DataMapper_Adapters_DataObjectsAdapter">
  <h1>Class: DataMapper::Adapters::DataObjectsAdapter</h1>
  <div class="section inheritance">
  <ul>
  <li><a title="DataMapper::Adapters::AbstractAdapter" href="AbstractAdapter.html">DataMapper::Adapters::AbstractAdapter</a></li><ul><li>DataMapper::Adapters::DataObjectsAdapter</li>
  </ul></ul>
</div><div class="section docstring">
  <p>
You must inherit from the DoAdapter, and implement the required methods to
adapt a database library for use with the DataMapper.
</p>
<p>
NOTE: By inheriting from DataObjectsAdapter, you get a copy of all the
standard sub-modules (Quoting, Coersion and Queries) in your own Adapter.
You can extend and overwrite these copies without affecting the originals.
</p>

</div><div class="section constants">
  
</div><div class="section constructor">
<h2>Constructor</h2>
  <p class="inherited_msg">
    This class inherits a constructor from <a title="DataMapper::Adapters::AbstractAdapter" href="AbstractAdapter.html#initialize-instance_method">DataMapper::Adapters::AbstractAdapter</a>.
  </p>
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#create-instance_method">#create</span><span class='args'>(resources)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#delete-instance_method">#delete</span><span class='args'>(query)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#execute-instance_method">#execute</span><span class='args'>(statement, *bind_values)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Database-specific method.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#query-instance_method">#query</span><span class='args'>(statement, *bind_values)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#read_many-instance_method">#read_many</span><span class='args'>(query)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#read_one-instance_method">#read_one</span><span class='args'>(query)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#update-instance_method">#update</span><span class='args'>(attributes, query)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
</table><div class="inherited">
  
</div>
<div class="clear"></div>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>create</h3>
</div><div id="create-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>create</span><span class='args'>(resources)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/dm-core/adapters/data_objects_adapter.rb', line 13</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/datamapper/dm-core/blob/master/lib/dm-core/adapters/data_objects_adapter.rb#L13">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='resources identifier id'>resources</span><span class='rparen token'>)</span>
  <span class='created identifier id'>created</span> <span class='assign token'>=</span> <span class='integer val'>0</span>
  <span class='resources identifier id'>resources</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='resource identifier id'>resource</span><span class='bitor op'>|</span>
    <span class='repository identifier id'>repository</span> <span class='assign token'>=</span> <span class='resource identifier id'>resource</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span>
    <span class='model identifier id'>model</span>      <span class='assign token'>=</span> <span class='resource identifier id'>resource</span><span class='dot token'>.</span><span class='model identifier id'>model</span>
    <span class='attributes identifier id'>attributes</span> <span class='assign token'>=</span> <span class='resource identifier id'>resource</span><span class='dot token'>.</span><span class='dirty_attributes identifier id'>dirty_attributes</span>

    <span class='comment val'># TODO: make a model.identity_field method</span>
    <span class='identity_field identifier id'>identity_field</span> <span class='assign token'>=</span> <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='key identifier id'>key</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='detect identifier id'>detect</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='p identifier id'>p</span><span class='dot token'>.</span><span class='serial? fid id'>serial?</span> <span class='rbrace token'>}</span>

    <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='create_statement identifier id'>create_statement</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='comma token'>,</span> <span class='attributes identifier id'>attributes</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='comma token'>,</span> <span class='identity_field identifier id'>identity_field</span><span class='rparen token'>)</span>
    <span class='bind_values identifier id'>bind_values</span> <span class='assign token'>=</span> <span class='attributes identifier id'>attributes</span><span class='dot token'>.</span><span class='values identifier id'>values</span>

    <span class='result identifier id'>result</span> <span class='assign token'>=</span> <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span>

    <span class='if if kw'>if</span> <span class='result identifier id'>result</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='eq op'>==</span> <span class='integer val'>1</span>
      <span class='if if kw'>if</span> <span class='identity_field identifier id'>identity_field</span>
        <span class='identity_field identifier id'>identity_field</span><span class='dot token'>.</span><span class='set! fid id'>set!</span><span class='lparen token'>(</span><span class='resource identifier id'>resource</span><span class='comma token'>,</span> <span class='result identifier id'>result</span><span class='dot token'>.</span><span class='insert_id identifier id'>insert_id</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
      <span class='created identifier id'>created</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='created identifier id'>created</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>delete</h3>
</div><div id="delete-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>delete</span><span class='args'>(query)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/dm-core/adapters/data_objects_adapter.rb', line 83</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/datamapper/dm-core/blob/master/lib/dm-core/adapters/data_objects_adapter.rb#L83">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">83
84
85
86</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='delete identifier id'>delete</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
  <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='delete_statement identifier id'>delete_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
  <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>execute</h3>
</div><div id="execute-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>execute</span><span class='args'>(statement, *bind_values)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Database-specific method
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/dm-core/adapters/data_objects_adapter.rb', line 89</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/datamapper/dm-core/blob/master/lib/dm-core/adapters/data_objects_adapter.rb#L89">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">89
90
91
92
93
94</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span>
  <span class='with_connection identifier id'>with_connection</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='connection identifier id'>connection</span><span class='bitor op'>|</span>
    <span class='command identifier id'>command</span> <span class='assign token'>=</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='create_command identifier id'>create_command</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='rparen token'>)</span>
    <span class='command identifier id'>command</span><span class='dot token'>.</span><span class='execute_non_query identifier id'>execute_non_query</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>query</h3>
</div><div id="query-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>query</span><span class='args'>(statement, *bind_values)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/dm-core/adapters/data_objects_adapter.rb', line 96</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/datamapper/dm-core/blob/master/lib/dm-core/adapters/data_objects_adapter.rb#L96">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='query identifier id'>query</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span>
      <span class='with_reader identifier id'>with_reader</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='comma token'>,</span> <span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='reader identifier id'>reader</span><span class='bitor op'>|</span>
        <span class='results identifier id'>results</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

        <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='fields identifier id'>fields</span> <span class='assign token'>=</span> <span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='fields identifier id'>fields</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='gt op'>&gt;</span> <span class='integer val'>1</span>
          <span class='fields identifier id'>fields</span> <span class='assign token'>=</span> <span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='field identifier id'>field</span><span class='bitor op'>|</span> <span class='Extlib constant id'>Extlib</span><span class='colon2 op'>::</span><span class='Inflection constant id'>Inflection</span><span class='dot token'>.</span><span class='underscore identifier id'>underscore</span><span class='lparen token'>(</span><span class='field identifier id'>field</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span> <span class='rbrace token'>}</span>
          <span class='struct identifier id'>struct</span> <span class='assign token'>=</span> <span class='Struct constant id'>Struct</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='fields identifier id'>fields</span><span class='rparen token'>)</span>

          <span class='while while kw'>while</span><span class='lparen token'>(</span><span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='next! fid id'>next!</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
            <span class='results identifier id'>results</span> <span class='lshft op'>&lt;&lt;</span> <span class='struct identifier id'>struct</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='values identifier id'>values</span><span class='rparen token'>)</span>
          <span class='end end kw'>end</span>
        <span class='else else kw'>else</span>
          <span class='while while kw'>while</span><span class='lparen token'>(</span><span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='next! fid id'>next!</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
            <span class='results identifier id'>results</span> <span class='lshft op'>&lt;&lt;</span> <span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='values identifier id'>values</span><span class='dot token'>.</span><span class='at identifier id'>at</span><span class='lparen token'>(</span><span class='integer val'>0</span><span class='rparen token'>)</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>

        <span class='results identifier id'>results</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='protected identifier id'>protected</span>

    <span class='def def kw'>def</span> <span class='normalize_uri identifier id'>normalize_uri</span><span class='lparen token'>(</span><span class='uri_or_options identifier id'>uri_or_options</span><span class='rparen token'>)</span>
      <span class='if if kw'>if</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='String constant id'>String</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Addressable constant id'>Addressable</span><span class='colon2 op'>::</span><span class='URI constant id'>URI</span><span class='rparen token'>)</span>
        <span class='uri_or_options identifier id'>uri_or_options</span> <span class='assign token'>=</span> <span class='DataObjects constant id'>DataObjects</span><span class='colon2 op'>::</span><span class='URI constant id'>URI</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='uri_or_options identifier id'>uri_or_options</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>

      <span class='if if kw'>if</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='DataObjects constant id'>DataObjects</span><span class='colon2 op'>::</span><span class='URI constant id'>URI</span><span class='rparen token'>)</span>
        <span class='return return kw'>return</span> <span class='uri_or_options identifier id'>uri_or_options</span>
      <span class='end end kw'>end</span>

      <span class='query identifier id'>query</span> <span class='assign token'>=</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='dot token'>.</span><span class='except identifier id'>except</span><span class='lparen token'>(</span><span class='symbol val'>:adapter</span><span class='comma token'>,</span> <span class='symbol val'>:username</span><span class='comma token'>,</span> <span class='symbol val'>:password</span><span class='comma token'>,</span> <span class='symbol val'>:host</span><span class='comma token'>,</span> <span class='symbol val'>:port</span><span class='comma token'>,</span> <span class='symbol val'>:database</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='pair identifier id'>pair</span><span class='bitor op'>|</span> <span class='pair identifier id'>pair</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>'='</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>'&amp;'</span><span class='rparen token'>)</span>
      <span class='query identifier id'>query</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span> <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>

      <span class='return return kw'>return</span> <span class='DataObjects constant id'>DataObjects</span><span class='colon2 op'>::</span><span class='URI constant id'>URI</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='Addressable constant id'>Addressable</span><span class='colon2 op'>::</span><span class='URI constant id'>URI</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span>
        <span class='symbol val'>:scheme</span>   <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='lbrack token'>[</span><span class='symbol val'>:adapter</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='comma token'>,</span>
        <span class='symbol val'>:user</span>     <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='lbrack token'>[</span><span class='symbol val'>:username</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
        <span class='symbol val'>:password</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='lbrack token'>[</span><span class='symbol val'>:password</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
        <span class='symbol val'>:host</span>     <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='lbrack token'>[</span><span class='symbol val'>:host</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
        <span class='symbol val'>:port</span>     <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='lbrack token'>[</span><span class='symbol val'>:port</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
        <span class='symbol val'>:path</span>     <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='lbrack token'>[</span><span class='symbol val'>:database</span><span class='rbrack token'>]</span><span class='comma token'>,</span>
        <span class='symbol val'>:query</span>    <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='query identifier id'>query</span>
      <span class='rparen token'>)</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># TODO: clean up once transaction related methods move to dm-more/dm-transactions</span>
    <span class='def def kw'>def</span> <span class='create_connection identifier id'>create_connection</span>
      <span class='if if kw'>if</span> <span class='within_transaction? fid id'>within_transaction?</span>
        <span class='current_transaction identifier id'>current_transaction</span><span class='dot token'>.</span><span class='primitive_for identifier id'>primitive_for</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='connection identifier id'>connection</span>
      <span class='else else kw'>else</span>
        <span class='comment val'># DataObjects::Connection.new(uri) will give you back the right</span>
        <span class='comment val'># driver based on the Uri#scheme.</span>
        <span class='DataObjects constant id'>DataObjects</span><span class='colon2 op'>::</span><span class='Connection constant id'>Connection</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='@uri ivar id'>@uri</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># TODO: clean up once transaction related methods move to dm-more/dm-transactions</span>
    <span class='def def kw'>def</span> <span class='close_connection identifier id'>close_connection</span><span class='lparen token'>(</span><span class='connection identifier id'>connection</span><span class='rparen token'>)</span>
      <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='close identifier id'>close</span> <span class='unless unless_mod kw'>unless</span> <span class='within_transaction? fid id'>within_transaction?</span> <span class='andop op'>&amp;&amp;</span> <span class='current_transaction identifier id'>current_transaction</span><span class='dot token'>.</span><span class='primitive_for identifier id'>primitive_for</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='connection identifier id'>connection</span> <span class='eq op'>==</span> <span class='connection identifier id'>connection</span>
    <span class='end end kw'>end</span>

    <span class='private identifier id'>private</span>

    <span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='uri_or_options identifier id'>uri_or_options</span><span class='rparen token'>)</span>
      <span class='super super kw'>super</span>

      <span class='comment val'># Default the driver-specifc logger to DataMapper's logger</span>
      <span class='if if kw'>if</span> <span class='driver_module identifier id'>driver_module</span> <span class='assign token'>=</span> <span class='DataObjects constant id'>DataObjects</span><span class='dot token'>.</span><span class='const_get identifier id'>const_get</span><span class='lparen token'>(</span><span class='@uri ivar id'>@uri</span><span class='dot token'>.</span><span class='scheme identifier id'>scheme</span><span class='dot token'>.</span><span class='capitalize identifier id'>capitalize</span><span class='rparen token'>)</span> <span class='rescue rescue kw'>rescue</span> <span class='nil nil kw'>nil</span>
        <span class='driver_module identifier id'>driver_module</span><span class='dot token'>.</span><span class='logger identifier id'>logger</span> <span class='assign token'>=</span> <span class='DataMapper constant id'>DataMapper</span><span class='dot token'>.</span><span class='logger identifier id'>logger</span> <span class='if if_mod kw'>if</span> <span class='driver_module identifier id'>driver_module</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='symbol val'>:logger=</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='with_connection identifier id'>with_connection</span>
      <span class='connection identifier id'>connection</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
      <span class='begin begin kw'>begin</span>
        <span class='connection identifier id'>connection</span> <span class='assign token'>=</span> <span class='create_connection identifier id'>create_connection</span>
        <span class='return return kw'>return</span> <span class='yield yield kw'>yield</span><span class='lparen token'>(</span><span class='connection identifier id'>connection</span><span class='rparen token'>)</span>
      <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
        <span class='DataMapper constant id'>DataMapper</span><span class='dot token'>.</span><span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='error identifier id'>error</span><span class='lparen token'>(</span><span class='e identifier id'>e</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span>
        <span class='raise identifier id'>raise</span> <span class='e identifier id'>e</span>
      <span class='ensure ensure kw'>ensure</span>
        <span class='close_connection identifier id'>close_connection</span><span class='lparen token'>(</span><span class='connection identifier id'>connection</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='connection identifier id'>connection</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='with_reader identifier id'>with_reader</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='comma token'>,</span> <span class='bind_values identifier id'>bind_values</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='with_connection identifier id'>with_connection</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='connection identifier id'>connection</span><span class='bitor op'>|</span>
        <span class='reader identifier id'>reader</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
        <span class='begin begin kw'>begin</span>
          <span class='reader identifier id'>reader</span> <span class='assign token'>=</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='create_command identifier id'>create_command</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='execute_reader identifier id'>execute_reader</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span>
          <span class='return return kw'>return</span> <span class='yield yield kw'>yield</span><span class='lparen token'>(</span><span class='reader identifier id'>reader</span><span class='rparen token'>)</span>
        <span class='ensure ensure kw'>ensure</span>
          <span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='close identifier id'>close</span> <span class='if if_mod kw'>if</span> <span class='reader identifier id'>reader</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># This model is just for organization. The methods are included into the</span>
    <span class='comment val'># Adapter below.</span>
    <span class='module module kw'>module</span> <span class='SQL constant id'>SQL</span>
      <span class='private identifier id'>private</span>

      <span class='comment val'># Adapters requiring a RETURNING syntax for INSERT statements</span>
      <span class='comment val'># should overwrite this to return true.</span>
      <span class='def def kw'>def</span> <span class='supports_returning? fid id'>supports_returning?</span>
        <span class='false false kw'>false</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># Adapters that do not support the DEFAULT VALUES syntax for</span>
      <span class='comment val'># INSERT statements should overwrite this to return false.</span>
      <span class='def def kw'>def</span> <span class='supports_default_values? fid id'>supports_default_values?</span>
        <span class='true true kw'>true</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='create_statement identifier id'>create_statement</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='comma token'>,</span> <span class='properties identifier id'>properties</span><span class='comma token'>,</span> <span class='identity_field identifier id'>identity_field</span><span class='rparen token'>)</span>
        <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;INSERT INTO #{quote_table_name(model.storage_name(repository.name))} &quot;</span>

        <span class='if if kw'>if</span> <span class='supports_default_values? fid id'>supports_default_values?</span> <span class='andop op'>&amp;&amp;</span> <span class='properties identifier id'>properties</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>'DEFAULT VALUES'</span>
        <span class='else else kw'>else</span>
          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>&quot;(\#{properties.map { |p| quote_column_name(p.field(repository.name)) } * ', '})\nVALUES\n(\#{(['?'] * properties.size) * ', '})\n&quot;</span><span class='dot token'>.</span><span class='compress_lines identifier id'>compress_lines</span>
        <span class='end end kw'>end</span>

        <span class='if if kw'>if</span> <span class='supports_returning? fid id'>supports_returning?</span> <span class='andop op'>&amp;&amp;</span> <span class='identity_field identifier id'>identity_field</span>
          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; RETURNING #{quote_column_name(identity_field.field(repository.name))}&quot;</span>
        <span class='end end kw'>end</span>

        <span class='statement identifier id'>statement</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='read_statement identifier id'>read_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
        <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;SELECT #{fields_statement(query)}&quot;</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; FROM #{quote_table_name(query.model.storage_name(query.repository.name))}&quot;</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='links_statement identifier id'>links_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>                        <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='links identifier id'>links</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; WHERE #{conditions_statement(query)}&quot;</span>       <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='conditions identifier id'>conditions</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; GROUP BY #{group_by_statement(query)}&quot;</span>      <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='unique? fid id'>unique?</span> <span class='andop op'>&amp;&amp;</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='any? fid id'>any?</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='p identifier id'>p</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Property constant id'>Property</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; ORDER BY #{order_statement(query)}&quot;</span>         <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='order identifier id'>order</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; LIMIT #{quote_column_value(query.limit)}&quot;</span>   <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='limit identifier id'>limit</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; OFFSET #{quote_column_value(query.offset)}&quot;</span> <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='offset identifier id'>offset</span> <span class='andop op'>&amp;&amp;</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='offset identifier id'>offset</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
        <span class='statement identifier id'>statement</span>
      <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
        <span class='DataMapper constant id'>DataMapper</span><span class='dot token'>.</span><span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='error identifier id'>error</span><span class='lparen token'>(</span><span class='dstring node'>&quot;QUERY INVALID: #{query.inspect} (#{e})&quot;</span><span class='rparen token'>)</span>
        <span class='raise identifier id'>raise</span> <span class='e identifier id'>e</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='update_statement identifier id'>update_statement</span><span class='lparen token'>(</span><span class='properties identifier id'>properties</span><span class='comma token'>,</span> <span class='query identifier id'>query</span><span class='rparen token'>)</span>
        <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;UPDATE #{quote_table_name(query.model.storage_name(query.repository.name))}&quot;</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; SET #{set_statement(query.repository, properties)}&quot;</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; WHERE #{conditions_statement(query)}&quot;</span> <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='conditions identifier id'>conditions</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
        <span class='statement identifier id'>statement</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='set_statement identifier id'>set_statement</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='properties identifier id'>properties</span><span class='rparen token'>)</span>
        <span class='properties identifier id'>properties</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='dstring node'>&quot;#{quote_column_name(p.field(repository.name))} = ?&quot;</span> <span class='rbrace token'>}</span> <span class='mult op'>*</span> <span class='string val'>', '</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='delete_statement identifier id'>delete_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
        <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;DELETE FROM #{quote_table_name(query.model.storage_name(query.repository.name))}&quot;</span>
        <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; WHERE #{conditions_statement(query)}&quot;</span> <span class='if if_mod kw'>if</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='conditions identifier id'>conditions</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
        <span class='statement identifier id'>statement</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='fields_statement identifier id'>fields_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
        <span class='qualify identifier id'>qualify</span> <span class='assign token'>=</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='links identifier id'>links</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
        <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='property_to_column_name identifier id'>property_to_column_name</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='p identifier id'>p</span><span class='comma token'>,</span> <span class='qualify identifier id'>qualify</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span> <span class='mult op'>*</span> <span class='string val'>', '</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='links_statement identifier id'>links_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
        <span class='table_list identifier id'>table_list</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='model identifier id'>model</span><span class='dot token'>.</span><span class='storage_name identifier id'>storage_name</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rbrack token'>]</span>

        <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='string val'>''</span>
        <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='links identifier id'>links</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='relationship identifier id'>relationship</span><span class='bitor op'>|</span>
          <span class='parent_table_name identifier id'>parent_table_name</span> <span class='assign token'>=</span> <span class='relationship identifier id'>relationship</span><span class='dot token'>.</span><span class='parent_model identifier id'>parent_model</span><span class='dot token'>.</span><span class='storage_name identifier id'>storage_name</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
          <span class='child_table_name identifier id'>child_table_name</span>  <span class='assign token'>=</span> <span class='relationship identifier id'>relationship</span><span class='dot token'>.</span><span class='child_model identifier id'>child_model</span><span class='dot token'>.</span><span class='storage_name identifier id'>storage_name</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>

          <span class='join_table_name identifier id'>join_table_name</span> <span class='assign token'>=</span> <span class='if if kw'>if</span> <span class='table_list identifier id'>table_list</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='parent_table_name identifier id'>parent_table_name</span><span class='rparen token'>)</span>
            <span class='child_table_name identifier id'>child_table_name</span>
          <span class='elsif elsif kw'>elsif</span> <span class='table_list identifier id'>table_list</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='child_table_name identifier id'>child_table_name</span><span class='rparen token'>)</span>
            <span class='parent_table_name identifier id'>parent_table_name</span>
          <span class='else else kw'>else</span>
            <span class='raise identifier id'>raise</span> <span class='ArgumentError constant id'>ArgumentError</span><span class='comma token'>,</span> <span class='string val'>'you\'re trying to join a table with no connection to this query'</span>
          <span class='end end kw'>end</span>
          <span class='table_list identifier id'>table_list</span> <span class='lshft op'>&lt;&lt;</span> <span class='join_table_name identifier id'>join_table_name</span>

          <span class='comment val'># We only do INNER JOIN for now</span>
          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; INNER JOIN #{quote_table_name(join_table_name)} ON &quot;</span>

          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='relationship identifier id'>relationship</span><span class='dot token'>.</span><span class='parent_key identifier id'>parent_key</span><span class='dot token'>.</span><span class='zip identifier id'>zip</span><span class='lparen token'>(</span><span class='relationship identifier id'>relationship</span><span class='dot token'>.</span><span class='child_key identifier id'>child_key</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='parent_property identifier id'>parent_property</span><span class='comma token'>,</span><span class='child_property identifier id'>child_property</span><span class='bitor op'>|</span>
            <span class='condition_statement identifier id'>condition_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='comma token'>,</span> <span class='symbol val'>:eql</span><span class='comma token'>,</span> <span class='parent_property identifier id'>parent_property</span><span class='comma token'>,</span> <span class='child_property identifier id'>child_property</span><span class='rparen token'>)</span>
          <span class='end end kw'>end</span> <span class='mult op'>*</span> <span class='string val'>' AND '</span>
        <span class='end end kw'>end</span>

        <span class='statement identifier id'>statement</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='conditions_statement identifier id'>conditions_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
        <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='conditions identifier id'>conditions</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='o identifier id'>o</span><span class='comma token'>,</span><span class='p identifier id'>p</span><span class='comma token'>,</span><span class='b identifier id'>b</span><span class='bitor op'>|</span> <span class='condition_statement identifier id'>condition_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='comma token'>,</span> <span class='o identifier id'>o</span><span class='comma token'>,</span> <span class='p identifier id'>p</span><span class='comma token'>,</span> <span class='b identifier id'>b</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span> <span class='mult op'>*</span> <span class='string val'>' AND '</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='group_by_statement identifier id'>group_by_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
        <span class='repository identifier id'>repository</span> <span class='assign token'>=</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span>
        <span class='qualify identifier id'>qualify</span>    <span class='assign token'>=</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='links identifier id'>links</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
        <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='select identifier id'>select</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='p identifier id'>p</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Property constant id'>Property</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='property_to_column_name identifier id'>property_to_column_name</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='p identifier id'>p</span><span class='comma token'>,</span> <span class='qualify identifier id'>qualify</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span> <span class='mult op'>*</span> <span class='string val'>', '</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='order_statement identifier id'>order_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
        <span class='repository identifier id'>repository</span> <span class='assign token'>=</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span>
        <span class='qualify identifier id'>qualify</span>    <span class='assign token'>=</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='links identifier id'>links</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
        <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='order identifier id'>order</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='order_column identifier id'>order_column</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='i identifier id'>i</span><span class='comma token'>,</span> <span class='qualify identifier id'>qualify</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span> <span class='mult op'>*</span> <span class='string val'>', '</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='order_column identifier id'>order_column</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='item identifier id'>item</span><span class='comma token'>,</span> <span class='qualify identifier id'>qualify</span><span class='rparen token'>)</span>
        <span class='property identifier id'>property</span><span class='comma token'>,</span> <span class='descending identifier id'>descending</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='false false kw'>false</span>

        <span class='case case kw'>case</span> <span class='item identifier id'>item</span>
          <span class='when when kw'>when</span> <span class='Property constant id'>Property</span>
            <span class='property identifier id'>property</span> <span class='assign token'>=</span> <span class='item identifier id'>item</span>
          <span class='when when kw'>when</span> <span class='Query constant id'>Query</span><span class='colon2 op'>::</span><span class='Direction constant id'>Direction</span>
            <span class='property identifier id'>property</span>  <span class='assign token'>=</span> <span class='item identifier id'>item</span><span class='dot token'>.</span><span class='property identifier id'>property</span>
            <span class='descending identifier id'>descending</span> <span class='assign token'>=</span> <span class='true true kw'>true</span> <span class='if if_mod kw'>if</span> <span class='item identifier id'>item</span><span class='dot token'>.</span><span class='direction identifier id'>direction</span> <span class='eq op'>==</span> <span class='symbol val'>:desc</span>
        <span class='end end kw'>end</span>

        <span class='order_column identifier id'>order_column</span> <span class='assign token'>=</span> <span class='property_to_column_name identifier id'>property_to_column_name</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='property identifier id'>property</span><span class='comma token'>,</span> <span class='qualify identifier id'>qualify</span><span class='rparen token'>)</span>
        <span class='order_column identifier id'>order_column</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>' DESC'</span> <span class='if if_mod kw'>if</span> <span class='descending identifier id'>descending</span>
        <span class='order_column identifier id'>order_column</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='condition_statement identifier id'>condition_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='comma token'>,</span> <span class='operator identifier id'>operator</span><span class='comma token'>,</span> <span class='left_condition identifier id'>left_condition</span><span class='comma token'>,</span> <span class='right_condition identifier id'>right_condition</span><span class='rparen token'>)</span>
        <span class='return return kw'>return</span> <span class='left_condition identifier id'>left_condition</span> <span class='if if_mod kw'>if</span> <span class='operator identifier id'>operator</span> <span class='eq op'>==</span> <span class='symbol val'>:raw</span>

        <span class='qualify identifier id'>qualify</span> <span class='assign token'>=</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='links identifier id'>links</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>

        <span class='conditions identifier id'>conditions</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span> <span class='left_condition identifier id'>left_condition</span><span class='comma token'>,</span> <span class='right_condition identifier id'>right_condition</span> <span class='rbrack token'>]</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='condition identifier id'>condition</span><span class='bitor op'>|</span>
          <span class='if if kw'>if</span> <span class='condition identifier id'>condition</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Property constant id'>Property</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='condition identifier id'>condition</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Query constant id'>Query</span><span class='colon2 op'>::</span><span class='Path constant id'>Path</span><span class='rparen token'>)</span>
            <span class='property_to_column_name identifier id'>property_to_column_name</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='condition identifier id'>condition</span><span class='comma token'>,</span> <span class='qualify identifier id'>qualify</span><span class='rparen token'>)</span>
          <span class='elsif elsif kw'>elsif</span> <span class='condition identifier id'>condition</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Query constant id'>Query</span><span class='rparen token'>)</span>
            <span class='opposite identifier id'>opposite</span> <span class='assign token'>=</span> <span class='condition identifier id'>condition</span> <span class='eq op'>==</span> <span class='left_condition identifier id'>left_condition</span> <span class='integer val'>? </span><span class='right_condition identifier id'>right_condition</span> <span class='colon op'>:</span> <span class='left_condition identifier id'>left_condition</span>
            <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='merge_subquery identifier id'>merge_subquery</span><span class='lparen token'>(</span><span class='operator identifier id'>operator</span><span class='comma token'>,</span> <span class='opposite identifier id'>opposite</span><span class='comma token'>,</span> <span class='condition identifier id'>condition</span><span class='rparen token'>)</span>
            <span class='dstring node'>&quot;(#{read_statement(condition)})&quot;</span>

          <span class='comment val'># [].all? is always true</span>
          <span class='elsif elsif kw'>elsif</span> <span class='condition identifier id'>condition</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Array constant id'>Array</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span> <span class='condition identifier id'>condition</span><span class='dot token'>.</span><span class='any? fid id'>any?</span> <span class='andop op'>&amp;&amp;</span> <span class='condition identifier id'>condition</span><span class='dot token'>.</span><span class='all? fid id'>all?</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='p identifier id'>p</span><span class='dot token'>.</span><span class='kind_of? fid id'>kind_of?</span><span class='lparen token'>(</span><span class='Property constant id'>Property</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
            <span class='property_values identifier id'>property_values</span> <span class='assign token'>=</span> <span class='condition identifier id'>condition</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='property_to_column_name identifier id'>property_to_column_name</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='p identifier id'>p</span><span class='comma token'>,</span> <span class='qualify identifier id'>qualify</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
            <span class='dstring node'>&quot;(#{property_values * ', '})&quot;</span>
          <span class='else else kw'>else</span>
            <span class='string val'>'?'</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>

        <span class='comparison identifier id'>comparison</span> <span class='assign token'>=</span> <span class='case case kw'>case</span> <span class='operator identifier id'>operator</span>
          <span class='when when kw'>when</span> <span class='symbol val'>:eql</span><span class='comma token'>,</span> <span class='symbol val'>:in</span> <span class='then then kw'>then</span> <span class='equality_operator identifier id'>equality_operator</span><span class='lparen token'>(</span><span class='right_condition identifier id'>right_condition</span><span class='rparen token'>)</span>
          <span class='when when kw'>when</span> <span class='symbol val'>:not</span>      <span class='then then kw'>then</span> <span class='inequality_operator identifier id'>inequality_operator</span><span class='lparen token'>(</span><span class='right_condition identifier id'>right_condition</span><span class='rparen token'>)</span>
          <span class='when when kw'>when</span> <span class='symbol val'>:like</span>     <span class='then then kw'>then</span> <span class='string val'>'LIKE'</span>
          <span class='when when kw'>when</span> <span class='symbol val'>:gt</span>       <span class='then then kw'>then</span> <span class='string val'>'&gt;'</span>
          <span class='when when kw'>when</span> <span class='symbol val'>:gte</span>      <span class='then then kw'>then</span> <span class='string val'>'&gt;='</span>
          <span class='when when kw'>when</span> <span class='symbol val'>:lt</span>       <span class='then then kw'>then</span> <span class='string val'>'&lt;'</span>
          <span class='when when kw'>when</span> <span class='symbol val'>:lte</span>      <span class='then then kw'>then</span> <span class='string val'>'&lt;='</span>
          <span class='else else kw'>else</span> <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Invalid query operator: #{operator.inspect}&quot;</span>
        <span class='end end kw'>end</span>

        <span class='string val'>&quot;(&quot;</span> <span class='plus op'>+</span> <span class='lparen token'>(</span><span class='conditions identifier id'>conditions</span> <span class='mult op'>*</span> <span class='dstring node'>&quot; #{comparison} &quot;</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;)&quot;</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='equality_operator identifier id'>equality_operator</span><span class='lparen token'>(</span><span class='operand identifier id'>operand</span><span class='rparen token'>)</span>
        <span class='case case kw'>case</span> <span class='operand identifier id'>operand</span>
          <span class='when when kw'>when</span> <span class='Array constant id'>Array</span><span class='comma token'>,</span> <span class='Query constant id'>Query</span> <span class='then then kw'>then</span> <span class='string val'>'IN'</span>
          <span class='when when kw'>when</span> <span class='Range constant id'>Range</span>        <span class='then then kw'>then</span> <span class='string val'>'BETWEEN'</span>
          <span class='when when kw'>when</span> <span class='NilClass constant id'>NilClass</span>     <span class='then then kw'>then</span> <span class='string val'>'IS'</span>
          <span class='else else kw'>else</span>                   <span class='string val'>'='</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='inequality_operator identifier id'>inequality_operator</span><span class='lparen token'>(</span><span class='operand identifier id'>operand</span><span class='rparen token'>)</span>
        <span class='case case kw'>case</span> <span class='operand identifier id'>operand</span>
          <span class='when when kw'>when</span> <span class='Array constant id'>Array</span><span class='comma token'>,</span> <span class='Query constant id'>Query</span> <span class='then then kw'>then</span> <span class='string val'>'NOT IN'</span>
          <span class='when when kw'>when</span> <span class='Range constant id'>Range</span>        <span class='then then kw'>then</span> <span class='string val'>'NOT BETWEEN'</span>
          <span class='when when kw'>when</span> <span class='NilClass constant id'>NilClass</span>     <span class='then then kw'>then</span> <span class='string val'>'IS NOT'</span>
          <span class='else else kw'>else</span>                   <span class='string val'>'&lt;&gt;'</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>

      <span class='def def kw'>def</span> <span class='property_to_column_name identifier id'>property_to_column_name</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='property identifier id'>property</span><span class='comma token'>,</span> <span class='qualify identifier id'>qualify</span><span class='rparen token'>)</span>
        <span class='table_name identifier id'>table_name</span> <span class='assign token'>=</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='model identifier id'>model</span><span class='dot token'>.</span><span class='storage_name identifier id'>storage_name</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='property identifier id'>property</span> <span class='andop op'>&amp;&amp;</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='symbol val'>:model</span><span class='rparen token'>)</span>

        <span class='if if kw'>if</span> <span class='table_name identifier id'>table_name</span> <span class='andop op'>&amp;&amp;</span> <span class='qualify identifier id'>qualify</span>
          <span class='dstring node'>&quot;#{quote_table_name(table_name)}.#{quote_column_name(property.field(repository.name))}&quot;</span>
        <span class='else else kw'>else</span>
          <span class='quote_column_name identifier id'>quote_column_name</span><span class='lparen token'>(</span><span class='property identifier id'>property</span><span class='dot token'>.</span><span class='field identifier id'>field</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># TODO: once the driver's quoting methods become public, have</span>
      <span class='comment val'># this method delegate to them instead</span>
      <span class='def def kw'>def</span> <span class='quote_table_name identifier id'>quote_table_name</span><span class='lparen token'>(</span><span class='table_name identifier id'>table_name</span><span class='rparen token'>)</span>
        <span class='table_name identifier id'>table_name</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='string val'>'&quot;'</span><span class='comma token'>,</span> <span class='string val'>'&quot;&quot;'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>'.'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='part identifier id'>part</span><span class='bitor op'>|</span> <span class='dstring node'>&quot;\&quot;#{part}\&quot;&quot;</span> <span class='rbrace token'>}</span> <span class='mult op'>*</span> <span class='string val'>'.'</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># TODO: once the driver's quoting methods become public, have</span>
      <span class='comment val'># this method delegate to them instead</span>
      <span class='def def kw'>def</span> <span class='quote_column_name identifier id'>quote_column_name</span><span class='lparen token'>(</span><span class='column_name identifier id'>column_name</span><span class='rparen token'>)</span>
        <span class='dstring node'>&quot;\&quot;#{column_name.gsub('&quot;', '&quot;&quot;')}\&quot;&quot;</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># TODO: once the driver's quoting methods become public, have</span>
      <span class='comment val'># this method delegate to them instead</span>
      <span class='def def kw'>def</span> <span class='quote_column_value identifier id'>quote_column_value</span><span class='lparen token'>(</span><span class='column_value identifier id'>column_value</span><span class='rparen token'>)</span>
        <span class='return return kw'>return</span> <span class='string val'>'NULL'</span> <span class='if if_mod kw'>if</span> <span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>

        <span class='case case kw'>case</span> <span class='column_value identifier id'>column_value</span>
          <span class='when when kw'>when</span> <span class='String constant id'>String</span>
            <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='integer identifier id'>integer</span> <span class='assign token'>=</span> <span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='eq op'>==</span> <span class='column_value identifier id'>column_value</span>
              <span class='quote_column_value identifier id'>quote_column_value</span><span class='lparen token'>(</span><span class='integer identifier id'>integer</span><span class='rparen token'>)</span>
            <span class='elsif elsif kw'>elsif</span> <span class='lparen token'>(</span><span class='float identifier id'>float</span> <span class='assign token'>=</span> <span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='to_f identifier id'>to_f</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='eq op'>==</span> <span class='column_value identifier id'>column_value</span>
              <span class='quote_column_value identifier id'>quote_column_value</span><span class='lparen token'>(</span><span class='integer identifier id'>integer</span><span class='rparen token'>)</span>
            <span class='else else kw'>else</span>
              <span class='dstring node'>&quot;'#{column_value.gsub(&quot;'&quot;, &quot;''&quot;)}'&quot;</span>
            <span class='end end kw'>end</span>
          <span class='when when kw'>when</span> <span class='DateTime constant id'>DateTime</span>
            <span class='quote_column_value identifier id'>quote_column_value</span><span class='lparen token'>(</span><span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='strftime identifier id'>strftime</span><span class='lparen token'>(</span><span class='string val'>'%Y-%m-%d %H:%M:%S'</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
          <span class='when when kw'>when</span> <span class='Date constant id'>Date</span>
            <span class='quote_column_value identifier id'>quote_column_value</span><span class='lparen token'>(</span><span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='strftime identifier id'>strftime</span><span class='lparen token'>(</span><span class='string val'>'%Y-%m-%d'</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
          <span class='when when kw'>when</span> <span class='Time constant id'>Time</span>
            <span class='quote_column_value identifier id'>quote_column_value</span><span class='lparen token'>(</span><span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='strftime identifier id'>strftime</span><span class='lparen token'>(</span><span class='string val'>'%Y-%m-%d %H:%M:%S'</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='usec identifier id'>usec</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span> <span class='question op'>?</span> <span class='dstring node'>&quot;.#{column_value.usec.to_s.rjust(6, '0')}&quot;</span> <span class='colon op'>:</span> <span class='string val'>''</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
          <span class='when when kw'>when</span> <span class='Integer constant id'>Integer</span><span class='comma token'>,</span> <span class='Float constant id'>Float</span>
            <span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
          <span class='when when kw'>when</span> <span class='BigDecimal constant id'>BigDecimal</span>
            <span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='lparen token'>(</span><span class='string val'>'F'</span><span class='rparen token'>)</span>
          <span class='else else kw'>else</span>
            <span class='column_value identifier id'>column_value</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span> <span class='comment val'>#module SQL</span>

    <span class='include identifier id'>include</span> <span class='SQL constant id'>SQL</span>

    <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
    <span class='module module kw'>module</span> <span class='Migration constant id'>Migration</span>
      <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
      <span class='def def kw'>def</span> <span class='upgrade_model_storage identifier id'>upgrade_model_storage</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span>
        <span class='table_name identifier id'>table_name</span> <span class='assign token'>=</span> <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='storage_name identifier id'>storage_name</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>

        <span class='if if kw'>if</span> <span class='success identifier id'>success</span> <span class='assign token'>=</span> <span class='create_model_storage identifier id'>create_model_storage</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span>
          <span class='return return kw'>return</span> <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='properties identifier id'>properties</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>

        <span class='properties identifier id'>properties</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

        <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='properties identifier id'>properties</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='property identifier id'>property</span><span class='bitor op'>|</span>
          <span class='schema_hash identifier id'>schema_hash</span> <span class='assign token'>=</span> <span class='property_schema_hash identifier id'>property_schema_hash</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='property identifier id'>property</span><span class='rparen token'>)</span>
          <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='field_exists? fid id'>field_exists?</span><span class='lparen token'>(</span><span class='table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='schema_hash identifier id'>schema_hash</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
          <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='alter_table_add_column_statement identifier id'>alter_table_add_column_statement</span><span class='lparen token'>(</span><span class='table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='schema_hash identifier id'>schema_hash</span><span class='rparen token'>)</span>
          <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='rparen token'>)</span>
          <span class='properties identifier id'>properties</span> <span class='lshft op'>&lt;&lt;</span> <span class='property identifier id'>property</span>
        <span class='end end kw'>end</span>

        <span class='properties identifier id'>properties</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
      <span class='def def kw'>def</span> <span class='create_model_storage identifier id'>create_model_storage</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span>
        <span class='return return kw'>return</span> <span class='false false kw'>false</span> <span class='if if_mod kw'>if</span> <span class='storage_exists? fid id'>storage_exists?</span><span class='lparen token'>(</span><span class='model identifier id'>model</span><span class='dot token'>.</span><span class='storage_name identifier id'>storage_name</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

        <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='create_table_statement identifier id'>create_table_statement</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

        <span class='lparen token'>(</span><span class='create_index_statements identifier id'>create_index_statements</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='create_unique_index_statements identifier id'>create_unique_index_statements</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='sql identifier id'>sql</span><span class='bitor op'>|</span>
          <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='sql identifier id'>sql</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>

        <span class='true true kw'>true</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
      <span class='def def kw'>def</span> <span class='destroy_model_storage identifier id'>destroy_model_storage</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span>
        <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='drop_table_statement identifier id'>drop_table_statement</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
        <span class='true true kw'>true</span>
      <span class='end end kw'>end</span>

      <span class='comment val'># TODO: move to dm-more/dm-transactions</span>
      <span class='def def kw'>def</span> <span class='transaction_primitive identifier id'>transaction_primitive</span>
        <span class='DataObjects constant id'>DataObjects</span><span class='colon2 op'>::</span><span class='Transaction constant id'>Transaction</span><span class='dot token'>.</span><span class='create_for_uri identifier id'>create_for_uri</span><span class='lparen token'>(</span><span class='@uri ivar id'>@uri</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>

      <span class='module module kw'>module</span> <span class='SQL constant id'>SQL</span>
        <span class='private identifier id'>private</span>

        <span class='comment val'># Adapters that support AUTO INCREMENT fields for CREATE TABLE</span>
        <span class='comment val'># statements should overwrite this to return true</span>
        <span class='comment val'>#</span>
        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='supports_serial? fid id'>supports_serial?</span>
          <span class='false false kw'>false</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='alter_table_add_column_statement identifier id'>alter_table_add_column_statement</span><span class='lparen token'>(</span><span class='table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='schema_hash identifier id'>schema_hash</span><span class='rparen token'>)</span>
          <span class='dstring node'>&quot;ALTER TABLE #{quote_table_name(table_name)} ADD COLUMN #{property_schema_statement(schema_hash)}&quot;</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='create_table_statement identifier id'>create_table_statement</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span>
          <span class='repository_name identifier id'>repository_name</span> <span class='assign token'>=</span> <span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span>

          <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='string val'>&quot;CREATE TABLE \#{quote_table_name(model.storage_name(repository_name))}\n(\#{model.properties_with_subclasses(repository_name).map { |p| property_schema_statement(property_schema_hash(repository, p)) } * ', '}\n&quot;</span><span class='dot token'>.</span><span class='compress_lines identifier id'>compress_lines</span>

          <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='key identifier id'>key</span> <span class='assign token'>=</span> <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='key identifier id'>key</span><span class='lparen token'>(</span><span class='repository_name identifier id'>repository_name</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
            <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot;, PRIMARY KEY(#{ key.map { |p| quote_column_name(p.field(repository_name)) } * ', '})&quot;</span>
          <span class='end end kw'>end</span>

          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>')'</span>
          <span class='statement identifier id'>statement</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='drop_table_statement identifier id'>drop_table_statement</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span>
          <span class='dstring node'>&quot;DROP TABLE IF EXISTS #{quote_table_name(model.storage_name(repository.name))}&quot;</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='create_index_statements identifier id'>create_index_statements</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span>
          <span class='table_name identifier id'>table_name</span> <span class='assign token'>=</span> <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='storage_name identifier id'>storage_name</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
          <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='properties identifier id'>properties</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='indexes identifier id'>indexes</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='index_name identifier id'>index_name</span><span class='comma token'>,</span> <span class='fields identifier id'>fields</span><span class='bitor op'>|</span>
            <span class='string val'>&quot;CREATE INDEX \#{quote_column_name(\&quot;index_\#{table_name}_\#{index_name}\&quot;)} ON\n\#{quote_table_name(table_name)} (\#{fields.map { |f| quote_column_name(f) } * ', '})\n&quot;</span><span class='dot token'>.</span><span class='compress_lines identifier id'>compress_lines</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='create_unique_index_statements identifier id'>create_unique_index_statements</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='model identifier id'>model</span><span class='rparen token'>)</span>
          <span class='table_name identifier id'>table_name</span> <span class='assign token'>=</span> <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='storage_name identifier id'>storage_name</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>
          <span class='model identifier id'>model</span><span class='dot token'>.</span><span class='properties identifier id'>properties</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='unique_indexes identifier id'>unique_indexes</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='index_name identifier id'>index_name</span><span class='comma token'>,</span> <span class='fields identifier id'>fields</span><span class='bitor op'>|</span>
            <span class='string val'>&quot;CREATE UNIQUE INDEX \#{quote_column_name(\&quot;unique_index_\#{table_name}_\#{index_name}\&quot;)} ON\n\#{quote_table_name(table_name)} (\#{fields.map { |f| quote_column_name(f) } * ', '})\n&quot;</span><span class='dot token'>.</span><span class='compress_lines identifier id'>compress_lines</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='property_schema_hash identifier id'>property_schema_hash</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='comma token'>,</span> <span class='property identifier id'>property</span><span class='rparen token'>)</span>
          <span class='schema identifier id'>schema</span> <span class='assign token'>=</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='type_map identifier id'>type_map</span><span class='lbrack token'>[</span><span class='property identifier id'>property</span><span class='dot token'>.</span><span class='type identifier id'>type</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='field identifier id'>field</span><span class='lparen token'>(</span><span class='repository identifier id'>repository</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
          <span class='comment val'># TODO: figure out a way to specify the size not be included, even if</span>
          <span class='comment val'># a default is defined in the typemap</span>
          <span class='comment val'>#  - use this to make it so all TEXT primitive fields do not have size</span>
          <span class='if if kw'>if</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='primitive identifier id'>primitive</span> <span class='eq op'>==</span> <span class='String constant id'>String</span> <span class='andop op'>&amp;&amp;</span> <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='primitive identifier id'>primitive</span><span class='rbrack token'>]</span> <span class='neq op'>!=</span> <span class='string val'>'TEXT'</span>
            <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:size</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='length identifier id'>length</span>
          <span class='elsif elsif kw'>elsif</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='primitive identifier id'>primitive</span> <span class='eq op'>==</span> <span class='BigDecimal constant id'>BigDecimal</span> <span class='orop op'>||</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='primitive identifier id'>primitive</span> <span class='eq op'>==</span> <span class='Float constant id'>Float</span>
            <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:precision</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='precision identifier id'>precision</span>
            <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:scale</span><span class='rbrack token'>]</span>     <span class='assign token'>=</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='scale identifier id'>scale</span>
          <span class='end end kw'>end</span>

          <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:nullable?</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='nullable? fid id'>nullable?</span>
          <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:serial?</span><span class='rbrack token'>]</span>   <span class='assign token'>=</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='serial? fid id'>serial?</span>

          <span class='if if kw'>if</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='default identifier id'>default</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='orop op'>||</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='default identifier id'>default</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='colon op'>:</span><span class='call identifier id'>call</span><span class='rparen token'>)</span>
            <span class='comment val'># remove the default if the property is not nullable</span>
            <span class='schema identifier id'>schema</span><span class='dot token'>.</span><span class='delete identifier id'>delete</span><span class='lparen token'>(</span><span class='symbol val'>:default</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='nullable? fid id'>nullable?</span>
          <span class='else else kw'>else</span>
            <span class='if if kw'>if</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='type identifier id'>type</span><span class='dot token'>.</span><span class='respond_to? fid id'>respond_to?</span><span class='lparen token'>(</span><span class='colon op'>:</span><span class='dump identifier id'>dump</span><span class='rparen token'>)</span>
              <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:default</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='type identifier id'>type</span><span class='dot token'>.</span><span class='dump identifier id'>dump</span><span class='lparen token'>(</span><span class='property identifier id'>property</span><span class='dot token'>.</span><span class='default identifier id'>default</span><span class='comma token'>,</span> <span class='property identifier id'>property</span><span class='rparen token'>)</span>
            <span class='else else kw'>else</span>
              <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:default</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='property identifier id'>property</span><span class='dot token'>.</span><span class='default identifier id'>default</span>
            <span class='end end kw'>end</span>
          <span class='end end kw'>end</span>

          <span class='schema identifier id'>schema</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='property_schema_statement identifier id'>property_schema_statement</span><span class='lparen token'>(</span><span class='schema identifier id'>schema</span><span class='rparen token'>)</span>
          <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='quote_column_name identifier id'>quote_column_name</span><span class='lparen token'>(</span><span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:name</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; #{schema[:primitive]}&quot;</span>

          <span class='if if kw'>if</span> <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='precision identifier id'>precision</span><span class='rbrack token'>]</span> <span class='andop op'>&amp;&amp;</span> <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='scale identifier id'>scale</span><span class='rbrack token'>]</span>
            <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot;(#{[ :precision, :scale ].map { |k| quote_column_value(schema[k]) } * ','})&quot;</span>
          <span class='elsif elsif kw'>elsif</span> <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:size</span><span class='rbrack token'>]</span>
            <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot;(#{quote_column_value(schema[:size])})&quot;</span>
          <span class='end end kw'>end</span>

          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>' NOT NULL'</span> <span class='unless unless_mod kw'>unless</span> <span class='schema identifier id'>schema</span><span class='lbrack token'>[</span><span class='symbol val'>:nullable?</span><span class='rbrack token'>]</span>
          <span class='statement identifier id'>statement</span> <span class='lshft op'>&lt;&lt;</span> <span class='dstring node'>&quot; DEFAULT #{quote_column_value(schema[:default])}&quot;</span> <span class='if if_mod kw'>if</span> <span class='schema identifier id'>schema</span><span class='dot token'>.</span><span class='has_key? fid id'>has_key?</span><span class='lparen token'>(</span><span class='symbol val'>:default</span><span class='rparen token'>)</span>
          <span class='statement identifier id'>statement</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='relationship_schema_hash identifier id'>relationship_schema_hash</span><span class='lparen token'>(</span><span class='relationship identifier id'>relationship</span><span class='rparen token'>)</span>
          <span class='identifier identifier id'>identifier</span><span class='comma token'>,</span> <span class='relationship identifier id'>relationship</span> <span class='assign token'>=</span> <span class='relationship identifier id'>relationship</span>

          <span class='self self kw'>self</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='type_map identifier id'>type_map</span><span class='lbrack token'>[</span><span class='Integer constant id'>Integer</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='symbol val'>:name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;#{identifier}_id&quot;</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='identifier identifier id'>identifier</span> <span class='eq op'>==</span> <span class='relationship identifier id'>relationship</span><span class='dot token'>.</span><span class='name identifier id'>name</span>
        <span class='end end kw'>end</span>

        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='relationship_schema_statement identifier id'>relationship_schema_statement</span><span class='lparen token'>(</span><span class='hash identifier id'>hash</span><span class='rparen token'>)</span>
          <span class='property_schema_statement identifier id'>property_schema_statement</span><span class='lparen token'>(</span><span class='hash identifier id'>hash</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='hash identifier id'>hash</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span> <span class='comment val'># module SQL</span>

      <span class='include identifier id'>include</span> <span class='SQL constant id'>SQL</span>

      <span class='module module kw'>module</span> <span class='ClassMethods constant id'>ClassMethods</span>
        <span class='comment val'># Default TypeMap for all data object based adapters.</span>
        <span class='comment val'>#</span>
        <span class='comment val'># @return &lt;DataMapper::TypeMap&gt; default TypeMap for data objects adapters.</span>
        <span class='comment val'>#</span>
        <span class='comment val'># TODO: move to dm-more/dm-migrations</span>
        <span class='def def kw'>def</span> <span class='type_map identifier id'>type_map</span>
          <span class='@type_map ivar id'>@type_map</span> <span class='opasgn op'>||=</span> <span class='TypeMap constant id'>TypeMap</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='super super kw'>super</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='tm identifier id'>tm</span><span class='bitor op'>|</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='Integer constant id'>Integer</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'INT'</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='String constant id'>String</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'VARCHAR'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='with identifier id'>with</span><span class='lparen token'>(</span><span class='symbol val'>:size</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Property constant id'>Property</span><span class='colon2 op'>::</span><span class='DEFAULT_LENGTH constant id'>DEFAULT_LENGTH</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='Class constant id'>Class</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'VARCHAR'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='with identifier id'>with</span><span class='lparen token'>(</span><span class='symbol val'>:size</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Property constant id'>Property</span><span class='colon2 op'>::</span><span class='DEFAULT_LENGTH constant id'>DEFAULT_LENGTH</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Discriminator constant id'>Discriminator</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'VARCHAR'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='with identifier id'>with</span><span class='lparen token'>(</span><span class='symbol val'>:size</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Property constant id'>Property</span><span class='colon2 op'>::</span><span class='DEFAULT_LENGTH constant id'>DEFAULT_LENGTH</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='BigDecimal constant id'>BigDecimal</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'DECIMAL'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='with identifier id'>with</span><span class='lparen token'>(</span><span class='symbol val'>:precision</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Property constant id'>Property</span><span class='colon2 op'>::</span><span class='DEFAULT_PRECISION constant id'>DEFAULT_PRECISION</span><span class='comma token'>,</span> <span class='symbol val'>:scale</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Property constant id'>Property</span><span class='colon2 op'>::</span><span class='DEFAULT_SCALE_BIGDECIMAL constant id'>DEFAULT_SCALE_BIGDECIMAL</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='Float constant id'>Float</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'FLOAT'</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='with identifier id'>with</span><span class='lparen token'>(</span><span class='symbol val'>:precision</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Property constant id'>Property</span><span class='colon2 op'>::</span><span class='DEFAULT_PRECISION constant id'>DEFAULT_PRECISION</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='DateTime constant id'>DateTime</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'TIMESTAMP'</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='Date constant id'>Date</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'DATE'</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='Time constant id'>Time</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'TIMESTAMP'</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='TrueClass constant id'>TrueClass</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'BOOLEAN'</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Object constant id'>Object</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'TEXT'</span><span class='rparen token'>)</span>
            <span class='tm identifier id'>tm</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='DM constant id'>DM</span><span class='colon2 op'>::</span><span class='Text constant id'>Text</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to identifier id'>to</span><span class='lparen token'>(</span><span class='string val'>'TEXT'</span><span class='rparen token'>)</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span> <span class='comment val'># module ClassMethods</span>
    <span class='end end kw'>end</span> <span class='comment val'># module Migration</span>

    <span class='include identifier id'>include</span> <span class='Migration constant id'>Migration</span>
    <span class='extend identifier id'>extend</span> <span class='Migration constant id'>Migration</span><span class='colon2 op'>::</span><span class='ClassMethods constant id'>ClassMethods</span>
  <span class='end end kw'>end</span> <span class='comment val'># class DataObjectsAdapter</span>
<span class='end end kw'>end</span> <span class='comment val'># module Adapters</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>read_many</h3>
</div><div id="read_many-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>read_many</span><span class='args'>(query)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/dm-core/adapters/data_objects_adapter.rb', line 38</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/datamapper/dm-core/blob/master/lib/dm-core/adapters/data_objects_adapter.rb#L38">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='read_many identifier id'>read_many</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
  <span class='Collection constant id'>Collection</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='collection identifier id'>collection</span><span class='bitor op'>|</span>
    <span class='with_connection identifier id'>with_connection</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='connection identifier id'>connection</span><span class='bitor op'>|</span>
      <span class='command identifier id'>command</span> <span class='assign token'>=</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='create_command identifier id'>create_command</span><span class='lparen token'>(</span><span class='read_statement identifier id'>read_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
      <span class='command identifier id'>command</span><span class='dot token'>.</span><span class='set_types identifier id'>set_types</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='p identifier id'>p</span><span class='dot token'>.</span><span class='primitive identifier id'>primitive</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span>

      <span class='begin begin kw'>begin</span>
        <span class='bind_values identifier id'>bind_values</span> <span class='assign token'>=</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='bind_values identifier id'>bind_values</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='v identifier id'>v</span><span class='bitor op'>|</span>
          <span class='v identifier id'>v</span> <span class='eq op'>==</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span> <span class='question op'>?</span> <span class='lbrack token'>[</span><span class='nil nil kw'>nil</span><span class='rbrack token'>]</span> <span class='colon op'>:</span> <span class='v identifier id'>v</span>
        <span class='end end kw'>end</span>
        <span class='reader identifier id'>reader</span> <span class='assign token'>=</span> <span class='command identifier id'>command</span><span class='dot token'>.</span><span class='execute_reader identifier id'>execute_reader</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span>

        <span class='while while kw'>while</span><span class='lparen token'>(</span><span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='next! fid id'>next!</span><span class='rparen token'>)</span>
          <span class='collection identifier id'>collection</span><span class='dot token'>.</span><span class='load identifier id'>load</span><span class='lparen token'>(</span><span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='values identifier id'>values</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>
      <span class='ensure ensure kw'>ensure</span>
        <span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='close identifier id'>close</span> <span class='if if_mod kw'>if</span> <span class='reader identifier id'>reader</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>read_one</h3>
</div><div id="read_one-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>read_one</span><span class='args'>(query)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/dm-core/adapters/data_objects_adapter.rb', line 60</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/datamapper/dm-core/blob/master/lib/dm-core/adapters/data_objects_adapter.rb#L60">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='read_one identifier id'>read_one</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span>
  <span class='with_connection identifier id'>with_connection</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='connection identifier id'>connection</span><span class='bitor op'>|</span>
    <span class='command identifier id'>command</span> <span class='assign token'>=</span> <span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='create_command identifier id'>create_command</span><span class='lparen token'>(</span><span class='read_statement identifier id'>read_statement</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
    <span class='command identifier id'>command</span><span class='dot token'>.</span><span class='set_types identifier id'>set_types</span><span class='lparen token'>(</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='fields identifier id'>fields</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='p identifier id'>p</span><span class='dot token'>.</span><span class='primitive identifier id'>primitive</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span>

    <span class='begin begin kw'>begin</span>
      <span class='reader identifier id'>reader</span> <span class='assign token'>=</span> <span class='command identifier id'>command</span><span class='dot token'>.</span><span class='execute_reader identifier id'>execute_reader</span><span class='lparen token'>(</span><span class='mult op'>*</span><span class='query identifier id'>query</span><span class='dot token'>.</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span>

      <span class='if if kw'>if</span> <span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='next! fid id'>next!</span>
        <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='model identifier id'>model</span><span class='dot token'>.</span><span class='load identifier id'>load</span><span class='lparen token'>(</span><span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='values identifier id'>values</span><span class='comma token'>,</span> <span class='query identifier id'>query</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='ensure ensure kw'>ensure</span>
      <span class='reader identifier id'>reader</span><span class='dot token'>.</span><span class='close identifier id'>close</span> <span class='if if_mod kw'>if</span> <span class='reader identifier id'>reader</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>update</h3>
</div><div id="update-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>update</span><span class='args'>(attributes, query)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/dm-core/adapters/data_objects_adapter.rb', line 77</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/datamapper/dm-core/blob/master/lib/dm-core/adapters/data_objects_adapter.rb#L77">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">77
78
79
80
81</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='update identifier id'>update</span><span class='lparen token'>(</span><span class='attributes identifier id'>attributes</span><span class='comma token'>,</span> <span class='query identifier id'>query</span><span class='rparen token'>)</span>
  <span class='statement identifier id'>statement</span> <span class='assign token'>=</span> <span class='update_statement identifier id'>update_statement</span><span class='lparen token'>(</span><span class='attributes identifier id'>attributes</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='comma token'>,</span> <span class='query identifier id'>query</span><span class='rparen token'>)</span>
  <span class='bind_values identifier id'>bind_values</span> <span class='assign token'>=</span> <span class='attributes identifier id'>attributes</span><span class='dot token'>.</span><span class='values identifier id'>values</span> <span class='plus op'>+</span> <span class='query identifier id'>query</span><span class='dot token'>.</span><span class='bind_values identifier id'>bind_values</span>
  <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='statement identifier id'>statement</span><span class='comma token'>,</span> <span class='mult op'>*</span><span class='bind_values identifier id'>bind_values</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
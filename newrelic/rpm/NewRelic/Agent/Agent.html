<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../../style.css" type="text/css" charset="utf-8" />
<link rel="stylesheet" href="../../syntax_highlight.css" type="text/css" charset="utf-8" />

    <script src="../../jquery.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../app.js" type="text/javascript" charset="utf-8"></script>
    <title>Class: NewRelic::Agent::Agent</title>
  </head>
  <body>
    <div id="content">
      <div class="section class NewRelic_Agent_Agent">
  <h1 class="title">Class: NewRelic::Agent::Agent</h1>
  <div class="section inheritance">
  <ul>
  <li><a href='../../Object.html' title='Object'>Object</a></li><ul><li>NewRelic::Agent::Agent</li>
  </ul></ul>
</div><div class="section mixins">
  <h1>Included Modules</h1>
  <p>Singleton</p>
</div><div class="section docstring">
  <p>
Implementation default for the NewRelic Agent
</p>

</div><div class="section attributes">
  <h1>Attributes</h1>

  
    <div class="instance">
      <h2>Instance Attributes</h2>
      <table>
      
        <tr>
          <th class="name">config</td>
          <td class="readwrite">
            [<span id='config-instance_method'>R</span><span id='config%3D-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Config object.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">error_collector</td>
          <td class="readwrite">
            [<span id='error_collector-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>error_collector</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">identifier</td>
          <td class="readwrite">
            [<span id='identifier-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>identifier</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">license_key</td>
          <td class="readwrite">
            [<span id='license_key-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>license_key</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">obfuscator</td>
          <td class="readwrite">
            [<span id='obfuscator-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>obfuscator</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">record_sql</td>
          <td class="readwrite">
            [<span id='record_sql-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>record_sql</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">stats_engine</td>
          <td class="readwrite">
            [<span id='stats_engine-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>stats_engine</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">transaction_sampler</td>
          <td class="readwrite">
            [<span id='transaction_sampler-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>transaction_sampler</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">worker_loop</td>
          <td class="readwrite">
            [<span id='worker_loop-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>worker_loop</tt>.
</p>

            
          </td>
        </tr>
      
      </table>
    </div>
  
</div><div class="section constants">
  <div class="thisclass">
  <h1>Constants</h1>
  <dl>
    
      <dt id="PROTOCOL_VERSION-constant">PROTOCOL_VERSION</dt>
      <dd>5</dd>
    
  </dl>
</div>

</div><div class="section constructor">
<h1>Constructor Summary</h1>
  <div id="initialize-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>private</span>
    <span class='return_types'></span>
    <span class='name'>initialize</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 456</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span>
  <span class='@connected ivar id'>@connected</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='@launch_time ivar id'>@launch_time</span> <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span>
  
  <span class='@metric_ids ivar id'>@metric_ids</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='@environment ivar id'>@environment</span> <span class='assign token'>=</span> <span class='symbol val'>:unknown</span>
  
  <span class='@config ivar id'>@config</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='Config constant id'>Config</span><span class='dot token'>.</span><span class='instance identifier id'>instance</span>
  
  <span class='@stats_engine ivar id'>@stats_engine</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='Agent constant id'>Agent</span><span class='colon2 op'>::</span><span class='StatsEngine constant id'>StatsEngine</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='@transaction_sampler ivar id'>@transaction_sampler</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='Agent constant id'>Agent</span><span class='colon2 op'>::</span><span class='TransactionSampler constant id'>TransactionSampler</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='rparen token'>)</span>
  <span class='@error_collector ivar id'>@error_collector</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='Agent constant id'>Agent</span><span class='colon2 op'>::</span><span class='ErrorCollector constant id'>ErrorCollector</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='rparen token'>)</span>
  
  <span class='@request_timeout ivar id'>@request_timeout</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='Config constant id'>Config</span><span class='dot token'>.</span><span class='instance identifier id'>instance</span><span class='dot token'>.</span><span class='fetch identifier id'>fetch</span><span class='lparen token'>(</span><span class='string val'>'timeout'</span><span class='comma token'>,</span> <span class='integer val'>2</span> <span class='mult op'>*</span> <span class='integer val'>60</span><span class='rparen token'>)</span>
  
  <span class='@invalid_license ivar id'>@invalid_license</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  
  <span class='@last_harvest_time ivar id'>@last_harvest_time</span> <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
</div>  <div class="section visibilitygroup public">
    <h1>Public Visibility</h1>
      <div class="section methodsummary class public">
    <h1>Public Class Method Summary</h1>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#instance-class_method' title='instance'>instance</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
</table>
  </div>
  <div class="section methodsummary instance public">
    <h1>Public Instance Method Summary</h1>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#add_custom_parameters-instance_method' title='#add_custom_parameters'>#add_custom_parameters</a></span><span class='args'>(params)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#apdex_t-instance_method' title='#apdex_t'>#apdex_t</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#custom_params-instance_method' title='#custom_params'>#custom_params</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#end_transaction-instance_method' title='#end_transaction'>#end_transaction</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#ensure_worker_thread_started-instance_method' title='#ensure_worker_thread_started'>#ensure_worker_thread_started</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
this method makes sure that the agent is running.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#instrument_app-instance_method' title='#instrument_app'>#instrument_app</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#log-instance_method' title='#log'>#log</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#manual_start-instance_method' title='#manual_start'>#manual_start</a></span><span class='args'>(environment, identifier)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
This method is deprecated.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#set_record_sql-instance_method' title='#set_record_sql'>#set_record_sql</a></span><span class='args'>(should_record)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#set_record_tt-instance_method' title='#set_record_tt'>#set_record_tt</a></span><span class='args'>(should_record)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#set_sql_obfuscator-instance_method' title='#set_sql_obfuscator'>#set_sql_obfuscator</a></span><span class='args'>(type, &amp;block)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#shutdown-instance_method' title='#shutdown'>#shutdown</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Attempt a graceful shutdown of the agent.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#start-instance_method' title='#start'>#start</a></span><span class='args'>(environment, identifier, force=false)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Start up the agent, which will connect to the newrelic server and start
reporting performance information.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#start_transaction-instance_method' title='#start_transaction'>#start_transaction</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href='#started%3F-instance_method' title='#started?'>#started?</a></span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
True if we have initialized and completed &#8216;start_reporting&#8217;.
</p>

        
      </td>
    </tr>
  
</table><div class="inherited">
  
  <div>
    <h1>Public Instance Methods Inherited from <a href='../../Object.html' title='Object'>Object</a></h1>
    <p><span class='name'><a href='../../Object.html#new_relic_load-instance_method' title='new_relic_load'>new_relic_load</a></span>, <span class='name'><a href='../../Object.html#new_relic_require-instance_method' title='new_relic_require'>new_relic_require</a></span></p>
  </div>
  
</div>
<div class="clear"></div>
  </div>
<div class="section methoddetails class public">
  <h1>Public Class Method Details</h1>
  
    <div class="method">
      <div class="method_header">
  <h3>instance</h3>
</div><div id="instance-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>instance</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


72
73
74</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/shim_agent.rb', line 72</span>

<span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='instance identifier id'>instance</span>
  <span class='@@agent ivar id'>@@agent</span> <span class='opasgn op'>||=</span> <span class='new identifier id'>new</span>
<span class='end end kw'>end</span>      
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
</div><div class="section methoddetails instance public">
  <h1>Public Instance Method Details</h1>
  
    <div class="method">
      <div class="method_header">
  <h3>add_custom_parameters</h3>
</div><div id="add_custom_parameters-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>add_custom_parameters</span><span class='args'>(params)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


253
254
255
256
257</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 253</span>

<span class='def def kw'>def</span> <span class='add_custom_parameters identifier id'>add_custom_parameters</span><span class='lparen token'>(</span><span class='params identifier id'>params</span><span class='rparen token'>)</span>
  <span class='p identifier id'>p</span> <span class='assign token'>=</span> <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:custom_params</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='lparen token'>(</span><span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:custom_params</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  
  <span class='p identifier id'>p</span><span class='dot token'>.</span><span class='merge! fid id'>merge!</span><span class='lparen token'>(</span><span class='params identifier id'>params</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>apdex_t</h3>
</div><div id="apdex_t-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>apdex_t</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


306
307
308</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 306</span>

<span class='def def kw'>def</span> <span class='apdex_t identifier id'>apdex_t</span>
  <span class='@apdex_t ivar id'>@apdex_t</span> <span class='opasgn op'>||=</span> <span class='config identifier id'>config</span><span class='lbrack token'>[</span><span class='string val'>'apdex_t'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_f identifier id'>to_f</span>
<span class='end end kw'>end</span>    
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>custom_params</h3>
</div><div id="custom_params-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>custom_params</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


259
260
261</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 259</span>

<span class='def def kw'>def</span> <span class='custom_params identifier id'>custom_params</span>
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:custom_params</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>end_transaction</h3>
</div><div id="end_transaction-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>end_transaction</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


234
235
236
237</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 234</span>

<span class='def def kw'>def</span> <span class='end_transaction identifier id'>end_transaction</span>
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:custom_params</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='@stats_engine ivar id'>@stats_engine</span><span class='dot token'>.</span><span class='end_transaction identifier id'>end_transaction</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>ensure_worker_thread_started</h3>
</div><div id="ensure_worker_thread_started-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>ensure_worker_thread_started</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
this method makes sure that the agent is running. it&#8217;s important for
passenger where processes are forked and the agent is dormant
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


190
191
192
193
194
195
196</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 190</span>

<span class='def def kw'>def</span> <span class='ensure_worker_thread_started identifier id'>ensure_worker_thread_started</span>
  <span class='return return kw'>return</span> <span class='unless unless_mod kw'>unless</span> <span class='@prod_mode_enabled ivar id'>@prod_mode_enabled</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='@invalid_license ivar id'>@invalid_license</span>
  <span class='if if kw'>if</span> <span class='@worker_loop ivar id'>@worker_loop</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='orop op'>||</span> <span class='@worker_loop ivar id'>@worker_loop</span><span class='dot token'>.</span><span class='pid identifier id'>pid</span> <span class='neq op'>!=</span> <span class='$$ gvar id'>$$</span>
    <span class='launch_worker_thread identifier id'>launch_worker_thread</span>
    <span class='@stats_engine ivar id'>@stats_engine</span><span class='dot token'>.</span><span class='spawn_sampler_thread identifier id'>spawn_sampler_thread</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>instrument_app</h3>
</div><div id="instrument_app-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>instrument_app</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 275</span>

<span class='def def kw'>def</span> <span class='instrument_app identifier id'>instrument_app</span>
  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='@instrumented ivar id'>@instrumented</span>
  
  <span class='@instrumented ivar id'>@instrumented</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
  
  <span class='comment val'># Instrumentation for the key code points inside rails for monitoring by NewRelic.</span>
  <span class='comment val'># note this file is loaded only if the newrelic agent is enabled (through config/newrelic.yml)</span>
  <span class='instrumentation_path identifier id'>instrumentation_path</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='__FILE__ __file__ kw'>__FILE__</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='string val'>'instrumentation'</span><span class='rparen token'>)</span>
  <span class='instrumentation_files identifier id'>instrumentation_files</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span> <span class='rbrack token'>]</span> <span class='lshft op'>&lt;&lt;</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='instrumentation_path identifier id'>instrumentation_path</span><span class='comma token'>,</span> <span class='string val'>'*.rb'</span><span class='rparen token'>)</span> <span class='lshft op'>&lt;&lt;</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='instrumentation_path identifier id'>instrumentation_path</span><span class='comma token'>,</span> <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='app identifier id'>app</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='comma token'>,</span> <span class='string val'>'*.rb'</span><span class='rparen token'>)</span>
  <span class='instrumentation_files identifier id'>instrumentation_files</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span> <span class='pattern identifier id'>pattern</span> <span class='bitor op'>|</span>
    <span class='Dir constant id'>Dir</span><span class='dot token'>.</span><span class='glob identifier id'>glob</span><span class='lparen token'>(</span><span class='pattern identifier id'>pattern</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='file identifier id'>file</span><span class='bitor op'>|</span>
      <span class='begin begin kw'>begin</span>
        <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='dstring node'>&quot;Processing instrumentation file '#{file}'&quot;</span>
        <span class='require identifier id'>require</span> <span class='file identifier id'>file</span>
      <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
        <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='error identifier id'>error</span> <span class='dstring node'>&quot;Error loading instrumentation file '#{file}': #{e}&quot;</span>
        <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='backtrace identifier id'>backtrace</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot;\n&quot;</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  
  <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='string val'>&quot;Finished instrumentation&quot;</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>log</h3>
</div><div id="log-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>log</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


301
302
303
304</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 301</span>

<span class='def def kw'>def</span> <span class='log identifier id'>log</span>
  <span class='setup_log identifier id'>setup_log</span> <span class='unless unless_mod kw'>unless</span> <span class='@log ivar id'>@log</span>
  <span class='@log ivar id'>@log</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>manual_start</h3>
</div><div id="manual_start-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>manual_start</span><span class='args'>(environment, identifier)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
This method is deprecated. Use start.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


154
155
156</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 154</span>

<span class='def def kw'>def</span> <span class='manual_start identifier id'>manual_start</span><span class='lparen token'>(</span><span class='environment identifier id'>environment</span><span class='comma token'>,</span> <span class='identifier identifier id'>identifier</span><span class='rparen token'>)</span>
  <span class='start identifier id'>start</span><span class='lparen token'>(</span><span class='environment identifier id'>environment</span><span class='comma token'>,</span> <span class='identifier identifier id'>identifier</span><span class='comma token'>,</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>set_record_sql</h3>
</div><div id="set_record_sql-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>set_record_sql</span><span class='args'>(should_record)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


239
240
241
242
243
244</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 239</span>

<span class='def def kw'>def</span> <span class='set_record_sql identifier id'>set_record_sql</span><span class='lparen token'>(</span><span class='should_record identifier id'>should_record</span><span class='rparen token'>)</span>
  <span class='prev identifier id'>prev</span> <span class='assign token'>=</span> <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:record_sql</span><span class='rbrack token'>]</span>
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:record_sql</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='should_record identifier id'>should_record</span>
  
  <span class='prev identifier id'>prev</span> <span class='orop op'>||</span> <span class='true true kw'>true</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>set_record_tt</h3>
</div><div id="set_record_tt-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>set_record_tt</span><span class='args'>(should_record)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


246
247
248
249
250
251</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 246</span>

<span class='def def kw'>def</span> <span class='set_record_tt identifier id'>set_record_tt</span><span class='lparen token'>(</span><span class='should_record identifier id'>should_record</span><span class='rparen token'>)</span>
  <span class='prev identifier id'>prev</span> <span class='assign token'>=</span> <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:record_tt</span><span class='rbrack token'>]</span>
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:record_tt</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='should_record identifier id'>should_record</span>
  
  <span class='prev identifier id'>prev</span> <span class='orop op'>||</span> <span class='true true kw'>true</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>set_sql_obfuscator</h3>
</div><div id="set_sql_obfuscator-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>set_sql_obfuscator</span><span class='args'>(type, &amp;block)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


263
264
265
266
267
268
269
270
271
272
273</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 263</span>

<span class='def def kw'>def</span> <span class='set_sql_obfuscator identifier id'>set_sql_obfuscator</span><span class='lparen token'>(</span><span class='type identifier id'>type</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='if if kw'>if</span> <span class='type identifier id'>type</span> <span class='eq op'>==</span> <span class='colon op'>:</span><span class='before identifier id'>before</span>
    <span class='@obfuscator ivar id'>@obfuscator</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='ChainedCall constant id'>ChainedCall</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='block identifier id'>block</span><span class='comma token'>,</span> <span class='@obfuscator ivar id'>@obfuscator</span><span class='rparen token'>)</span>
  <span class='elsif elsif kw'>elsif</span> <span class='type identifier id'>type</span> <span class='eq op'>==</span> <span class='symbol val'>:after</span>
    <span class='@obfuscator ivar id'>@obfuscator</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='ChainedCall constant id'>ChainedCall</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='@obfuscator ivar id'>@obfuscator</span><span class='comma token'>,</span> <span class='block identifier id'>block</span><span class='rparen token'>)</span>
  <span class='elsif elsif kw'>elsif</span> <span class='type identifier id'>type</span> <span class='eq op'>==</span> <span class='symbol val'>:replace</span>
    <span class='@obfuscator ivar id'>@obfuscator</span> <span class='assign token'>=</span> <span class='block identifier id'>block</span>
  <span class='else else kw'>else</span>
    <span class='fail identifier id'>fail</span> <span class='dstring node'>&quot;unknown sql_obfuscator type #{type}&quot;</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>shutdown</h3>
</div><div id="shutdown-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>shutdown</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Attempt a graceful shutdown of the agent.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 205</span>

<span class='def def kw'>def</span> <span class='shutdown identifier id'>shutdown</span>
  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='@started ivar id'>@started</span>
  <span class='if if kw'>if</span> <span class='@worker_loop ivar id'>@worker_loop</span>
    <span class='@worker_loop ivar id'>@worker_loop</span><span class='dot token'>.</span><span class='stop identifier id'>stop</span>
    
    <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='string val'>&quot;Starting Agent shutdown&quot;</span>
    
    <span class='comment val'># if litespeed, then ignore all future SIGUSR1 - it's litespeed trying to shut us down</span>
    
    <span class='if if kw'>if</span> <span class='@environment ivar id'>@environment</span> <span class='eq op'>==</span> <span class='colon op'>:</span><span class='litespeed identifier id'>litespeed</span>
      <span class='Signal constant id'>Signal</span><span class='dot token'>.</span><span class='trap identifier id'>trap</span><span class='lparen token'>(</span><span class='string val'>&quot;SIGUSR1&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;IGNORE&quot;</span><span class='rparen token'>)</span>
      <span class='Signal constant id'>Signal</span><span class='dot token'>.</span><span class='trap identifier id'>trap</span><span class='lparen token'>(</span><span class='string val'>&quot;SIGTERM&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot;IGNORE&quot;</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    
    <span class='begin begin kw'>begin</span>
      <span class='graceful_disconnect identifier id'>graceful_disconnect</span>
    <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
      <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='error identifier id'>error</span> <span class='e identifier id'>e</span>
      <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='error identifier id'>error</span> <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='backtrace identifier id'>backtrace</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot;\n&quot;</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='@started ivar id'>@started</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>start</h3>
</div><div id="start-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>start</span><span class='args'>(environment, identifier, force=false)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Start up the agent, which will connect to the newrelic server and start
reporting performance information. Typically this is done from the
environment configuration file. environment identifies the host
environment, like mongrel, thin, or take. identifier is an identifier which
uniquely identifies the process hosting the agent. It should be ideally
something like a server port, like 3000, a handler thread name, or a script
name. It should not be a PID because that will change from invocation to
invocation. For something like rake, you could use the task name. Return
false if the agent was not started
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 169</span>

<span class='def def kw'>def</span> <span class='start identifier id'>start</span><span class='lparen token'>(</span><span class='environment identifier id'>environment</span><span class='comma token'>,</span> <span class='identifier identifier id'>identifier</span><span class='comma token'>,</span> <span class='force identifier id'>force</span><span class='assign token'>=</span><span class='false false kw'>false</span><span class='rparen token'>)</span>
  
  <span class='if if kw'>if</span> <span class='@started ivar id'>@started</span>
    <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='log! fid id'>log!</span> <span class='string val'>&quot;Agent Started Already!&quot;</span>
    <span class='return return kw'>return</span>
  <span class='end end kw'>end</span>
  <span class='@environment ivar id'>@environment</span> <span class='assign token'>=</span> <span class='environment identifier id'>environment</span>
  <span class='@identifier ivar id'>@identifier</span> <span class='assign token'>=</span> <span class='identifier identifier id'>identifier</span> <span class='andop op'>&amp;&amp;</span> <span class='identifier identifier id'>identifier</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
  <span class='if if kw'>if</span> <span class='@identifier ivar id'>@identifier</span>
    <span class='start_reporting identifier id'>start_reporting</span><span class='lparen token'>(</span><span class='force identifier id'>force</span><span class='rparen token'>)</span>
    <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='log! fid id'>log!</span> <span class='dstring node'>&quot;New Relic RPM Agent #{NewRelic::VERSION::STRING} Initialized: pid = #{$$}, handler = #{@environment}&quot;</span>
    <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='log! fid id'>log!</span> <span class='dstring node'>&quot;Agent Log is found in #{NewRelic::Config.instance.log_file}&quot;</span>
    <span class='return return kw'>return</span> <span class='true true kw'>true</span>
  <span class='else else kw'>else</span>
    <span class='return return kw'>return</span> <span class='false false kw'>false</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>start_transaction</h3>
</div><div id="start_transaction-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>start_transaction</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


229
230
231
232</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 229</span>

<span class='def def kw'>def</span> <span class='start_transaction identifier id'>start_transaction</span>
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:custom_params</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='@stats_engine ivar id'>@stats_engine</span><span class='dot token'>.</span><span class='start_transaction identifier id'>start_transaction</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>started?</h3>
</div><div id="started%3F-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>started?</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
True if we have initialized and completed &#8216;start_reporting&#8217;
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


199
200
201</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/new_relic/agent/agent.rb', line 199</span>

<span class='def def kw'>def</span> <span class='started? fid id'>started?</span>
  <span class='@started ivar id'>@started</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
</div>
  </div>

</div>
    </div>
  </body>
</html>
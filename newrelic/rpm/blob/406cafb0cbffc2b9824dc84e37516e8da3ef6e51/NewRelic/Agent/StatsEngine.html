<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>newrelic's rpm - Class: NewRelic::Agent::StatsEngine - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/newrelic/commits/rpm/master" rel="alternate" title="Recent Commits to rpm:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    GitHubRepo.init("newrelic", "rpm", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='newrelic/rpm/blob/406cafb0cbffc2b9824dc84e37516e8da3ef6e51' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='newrelic/rpm/blob/406cafb0cbffc2b9824dc84e37516e8da3ef6e51' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("newrelic", "rpm", "406cafb0cbffc2b9824dc84e37516e8da3ef6e51", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/newrelic/rpm/tree/">Source</a></li>
            <li class=""><a href="http://github.com/newrelic/rpm/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/newrelic/rpm/network">Network</a></li>            
            <li class=""><a href="http://github.com/newrelic/rpm/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/newrelic/rpm">Wiki</a></li>
            <li class=""><a href="http://github.com/newrelic/rpm/graphs">Graphs</a></li>                    
            <li class="active"><a href="/newrelic/rpm">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/newrelic">newrelic</a> / <b><a href="http://github.com/newrelic/rpm/tree">rpm</a></b>        
                <a id="namespaces_button" rel="newrelic/rpm/blob/406cafb0cbffc2b9824dc84e37516e8da3ef6e51" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="newrelic/rpm/blob/406cafb0cbffc2b9824dc84e37516e8da3ef6e51" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section class NewRelic_Agent_StatsEngine">
  <h1>Class: NewRelic::Agent::StatsEngine</h1>
  <div class="section inheritance">
  <ul>
  <li><a title="Object" href="../../Object.html">Object</a></li><ul><li>NewRelic::Agent::StatsEngine</li>
  </ul></ul>
</div><div class="section attributes">
  
    <div class="">
      <h2>Instance Attributes</h2>
      <table>
      
        <tr>
          <th class="name">log</td>
          <td class="readwrite">
            [<span id='log-instance_method'>R</span><span id='log%3D-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>log</tt>.
</p>

            
          </td>
        </tr>
      
      </table>
    </div>
  
</div><div class="section constants">
  <div class="thisclass">
  <h2>Constants</h2>
  <dl>
    
      <dt id="POLL_PERIOD-constant">POLL_PERIOD</dt>
      <dd>10</dd>
    
      <dt id="ScopeStackElement-constant">ScopeStackElement</dt>
      <dd>Struct.new(:name, :children_time, :deduct_call_time_from_parent)</dd>
    
  </dl>
</div>

</div><div class="section constructor">
<h2>Constructor</h2>
  <div id="initialize-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>initialize</span><span class='args'>(log = Logger.new(STDERR))</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 21</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L21">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">21
22
23
24
25
26
27
28
29
30
31</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='log identifier id'>log</span> <span class='assign token'>=</span> <span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='STDERR constant id'>STDERR</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
  <span class='@stats_hash ivar id'>@stats_hash</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='@sampled_items ivar id'>@sampled_items</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='@log ivar id'>@log</span> <span class='assign token'>=</span> <span class='log identifier id'>log</span>
  
  <span class='comment val'># Makes the unit tests happy</span>
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  
  <span class='spawn_sampler_thread identifier id'>spawn_sampler_thread</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#add_sampled_metric-instance_method">#add_sampled_metric</span><span class='args'>(metric_name, &amp;sampler_callback)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#add_scope_stack_listener-instance_method">#add_scope_stack_listener</span><span class='args'>(l)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#end_transaction-instance_method">#end_transaction</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Try to clean up gracefully, otherwise we leave things hanging around on
thread locals.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#get_stats-instance_method">#get_stats</span><span class='args'>(metric_name, use_scope = true)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#get_stats_no_scope-instance_method">#get_stats_no_scope</span><span class='args'>(metric_name)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#harvest_timeslice_data-instance_method">#harvest_timeslice_data</span><span class='args'>(previous_timeslice_data, metric_ids)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Note: this is not synchronized.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#lookup_stat-instance_method">#lookup_stat</span><span class='args'>(metric_name)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#metrics-instance_method">#metrics</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#peek_scope-instance_method">#peek_scope</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#pop_scope-instance_method">#pop_scope</span><span class='args'>(expected_scope, duration, time = Time.now.to_f)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#push_scope-instance_method">#push_scope</span><span class='args'>(metric, time = Time.now.to_f, deduct_call_time_from_parent = true)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#remove_scope_stack_listener-instance_method">#remove_scope_stack_listener</span><span class='args'>(l)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#spawn_sampler_thread-instance_method">#spawn_sampler_thread</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#start_transaction-instance_method">#start_transaction</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#transaction_name-instance_method">#transaction_name</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
set the name of the transaction for the current thread, which will be used
to define the scope of all traced methods called on this thread until the
scope stack is empty.
</p>

        
      </td>
    </tr>
  
</table><div class="inherited">
  
  <div>
    <h2>Public Instance Methods Inherited from <a title="Object" href="../../Object.html">Object</a></h2>
    <p><span class='name'><a title="new_relic_load" href="../../Object.html#new_relic_load-instance_method">new_relic_load</a></span>, <span class='name'><a title="new_relic_require" href="../../Object.html#new_relic_require-instance_method">new_relic_require</a></span></p>
  </div>
  
</div>
<div class="clear"></div>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>add_sampled_metric</h3>
</div><div id="add_sampled_metric-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>add_sampled_metric</span><span class='args'>(metric_name, &amp;sampler_callback)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 109</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L109">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">109
110
111
112</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='add_sampled_metric identifier id'>add_sampled_metric</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='sampler_callback identifier id'>sampler_callback</span><span class='rparen token'>)</span>
  <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='get_stats identifier id'>get_stats</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='comma token'>,</span> <span class='false false kw'>false</span><span class='rparen token'>)</span>
  <span class='@sampled_items ivar id'>@sampled_items</span> <span class='lshft op'>&lt;&lt;</span> <span class='SampledItem constant id'>SampledItem</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='stats identifier id'>stats</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='sampler_callback identifier id'>sampler_callback</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>add_scope_stack_listener</h3>
</div><div id="add_scope_stack_listener-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>add_scope_stack_listener</span><span class='args'>(l)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 59</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L59">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">59
60
61
62</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='add_scope_stack_listener identifier id'>add_scope_stack_listener</span><span class='lparen token'>(</span><span class='l identifier id'>l</span><span class='rparen token'>)</span>
  <span class='fail identifier id'>fail</span> <span class='string val'>&quot;Can't add a scope listener midflight in a transaction&quot;</span> <span class='if if_mod kw'>if</span> <span class='scope_stack identifier id'>scope_stack</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
  <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span> <span class='assign token'>=</span>  <span class='l identifier id'>l</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>end_transaction</h3>
</div><div id="end_transaction-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>end_transaction</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Try to clean up gracefully, otherwise we leave things hanging around on
thread locals
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 223</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L223">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">223
224
225
226
227
228
229
230
231
232</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='end_transaction identifier id'>end_transaction</span>
  <span class='stack identifier id'>stack</span> <span class='assign token'>=</span> <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span>
  
  <span class='if if kw'>if</span> <span class='stack identifier id'>stack</span>
    <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_scope_empty identifier id'>notice_scope_empty</span><span class='lparen token'>(</span><span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span> 
    <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='end end kw'>end</span>
  
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_transaction_name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>get_stats</h3>
</div><div id="get_stats-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>get_stats</span><span class='args'>(metric_name, use_scope = true)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 147</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L147">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='get_stats identifier id'>get_stats</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='comma token'>,</span> <span class='use_scope identifier id'>use_scope</span> <span class='assign token'>=</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
  <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span>
  <span class='if if kw'>if</span> <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MethodTraceStats constant id'>MethodTraceStats</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
    <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='stats identifier id'>stats</span>
  <span class='end end kw'>end</span>
  
  <span class='if if kw'>if</span> <span class='use_scope identifier id'>use_scope</span> <span class='andop op'>&amp;&amp;</span> <span class='transaction_name identifier id'>transaction_name</span>
    <span class='spec identifier id'>spec</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MetricSpec constant id'>MetricSpec</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='metric_name identifier id'>metric_name</span><span class='comma token'>,</span> <span class='transaction_name identifier id'>transaction_name</span>
    
    <span class='scoped_stats identifier id'>scoped_stats</span> <span class='assign token'>=</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='spec identifier id'>spec</span><span class='rbrack token'>]</span>
    <span class='if if kw'>if</span> <span class='scoped_stats identifier id'>scoped_stats</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='scoped_stats identifier id'>scoped_stats</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='ScopedMethodTraceStats constant id'>ScopedMethodTraceStats</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='stats identifier id'>stats</span>
      <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='spec identifier id'>spec</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='scoped_stats identifier id'>scoped_stats</span>        
    <span class='end end kw'>end</span>
    
    <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='scoped_stats identifier id'>scoped_stats</span>
  <span class='end end kw'>end</span>
  <span class='return return kw'>return</span> <span class='stats identifier id'>stats</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>get_stats_no_scope</h3>
</div><div id="get_stats_no_scope-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>get_stats_no_scope</span><span class='args'>(metric_name)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 138</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L138">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">138
139
140
141
142
143
144
145</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='get_stats_no_scope identifier id'>get_stats_no_scope</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='rparen token'>)</span>
  <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span>
  <span class='if if kw'>if</span> <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MethodTraceStats constant id'>MethodTraceStats</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
    <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='stats identifier id'>stats</span>
  <span class='end end kw'>end</span>
  <span class='stats identifier id'>stats</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>harvest_timeslice_data</h3>
</div><div id="harvest_timeslice_data-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>harvest_timeslice_data</span><span class='args'>(previous_timeslice_data, metric_ids)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Note: this is not synchronized. There is still some risk in this and we
will revisit later to see if we can make this more robust without
sacrificing efficiency.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 171</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L171">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='harvest_timeslice_data identifier id'>harvest_timeslice_data</span><span class='lparen token'>(</span><span class='previous_timeslice_data identifier id'>previous_timeslice_data</span><span class='comma token'>,</span> <span class='metric_ids identifier id'>metric_ids</span><span class='rparen token'>)</span>
  <span class='timeslice_data identifier id'>timeslice_data</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='@stats_hash ivar id'>@stats_hash</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='metric_spec identifier id'>metric_spec</span><span class='bitor op'>|</span>
    
    
    <span class='comment val'># get a copy of the stats collected since the last harvest, and clear</span>
    <span class='comment val'># the stats inside our hash table for the next time slice.</span>
    <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span>

    <span class='comment val'># we have an optimization for unscoped metrics</span>
    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='lparen token'>(</span><span class='metric_spec identifier id'>metric_spec</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MetricSpec constant id'>MetricSpec</span><span class='rparen token'>)</span>
      <span class='metric_spec identifier id'>metric_spec</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MetricSpec constant id'>MetricSpec</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='metric_spec identifier id'>metric_spec</span>
    <span class='end end kw'>end</span>

    <span class='if if kw'>if</span> <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> 
      <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Nil stats for #{metric_spec.name} (#{metric_spec.scope})&quot;</span>
    <span class='end end kw'>end</span>
    
    <span class='stats_copy identifier id'>stats_copy</span> <span class='assign token'>=</span> <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='clone identifier id'>clone</span>
    <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='reset identifier id'>reset</span>
    
    <span class='comment val'># if the previous timeslice data has not been reported (due to an error of some sort)</span>
    <span class='comment val'># then we need to merge this timeslice with the previously accumulated - but not sent</span>
    <span class='comment val'># data</span>
    <span class='previous_metric_data identifier id'>previous_metric_data</span> <span class='assign token'>=</span> <span class='previous_timeslice_data identifier id'>previous_timeslice_data</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span>
    <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='merge! fid id'>merge!</span> <span class='previous_metric_data identifier id'>previous_metric_data</span><span class='dot token'>.</span><span class='stats identifier id'>stats</span> <span class='unless unless_mod kw'>unless</span> <span class='previous_metric_data identifier id'>previous_metric_data</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    
    <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='round! fid id'>round!</span>
    
    <span class='comment val'># don't bother collecting and reporting stats that have zero-values for this timeslice.</span>
    <span class='comment val'># significant performance boost and storage savings.</span>
    <span class='unless unless kw'>unless</span> <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='call_count identifier id'>call_count</span> <span class='eq op'>==</span> <span class='integer val'>0</span> <span class='andop op'>&amp;&amp;</span> <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='total_call_time identifier id'>total_call_time</span> <span class='eq op'>==</span> <span class='integer val'>0</span><span class='integer val'>.0</span> <span class='andop op'>&amp;&amp;</span> <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='total_exclusive_time identifier id'>total_exclusive_time</span> <span class='eq op'>==</span> <span class='integer val'>0</span><span class='integer val'>.0</span>
      
      <span class='metric_spec_for_transport identifier id'>metric_spec_for_transport</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='metric_ids identifier id'>metric_ids</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='metric_spec identifier id'>metric_spec</span> <span class='colon op'>:</span> <span class='nil nil kw'>nil</span>
      
      <span class='metric_data identifier id'>metric_data</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MetricData constant id'>MetricData</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='metric_spec_for_transport identifier id'>metric_spec_for_transport</span><span class='comma token'>,</span> <span class='stats_copy identifier id'>stats_copy</span><span class='comma token'>,</span> <span class='metric_ids identifier id'>metric_ids</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      
      <span class='timeslice_data identifier id'>timeslice_data</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='metric_data identifier id'>metric_data</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  
  <span class='timeslice_data identifier id'>timeslice_data</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>lookup_stat</h3>
</div><div id="lookup_stat-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>lookup_stat</span><span class='args'>(metric_name)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 131</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L131">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">131
132
133</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='lookup_stat identifier id'>lookup_stat</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>metrics</h3>
</div><div id="metrics-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>metrics</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 134</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L134">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">134
135
136</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='metrics identifier id'>metrics</span>
  <span class='return return kw'>return</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>peek_scope</h3>
</div><div id="peek_scope-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>peek_scope</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 105</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L105">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">105
106
107</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='peek_scope identifier id'>peek_scope</span>
  <span class='scope_stack identifier id'>scope_stack</span><span class='dot token'>.</span><span class='last identifier id'>last</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>pop_scope</h3>
</div><div id="pop_scope-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>pop_scope</span><span class='args'>(expected_scope, duration, time = Time.now.to_f)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 83</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L83">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='pop_scope identifier id'>pop_scope</span><span class='lparen token'>(</span><span class='expected_scope identifier id'>expected_scope</span><span class='comma token'>,</span> <span class='duration identifier id'>duration</span><span class='comma token'>,</span> <span class='time identifier id'>time</span><span class='assign token'>=</span><span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='dot token'>.</span><span class='to_f identifier id'>to_f</span><span class='rparen token'>)</span>

  <span class='stack identifier id'>stack</span> <span class='assign token'>=</span> <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span>
  
  <span class='scope identifier id'>scope</span> <span class='assign token'>=</span> <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span>
  
  <span class='fail identifier id'>fail</span> <span class='dstring node'>&quot;unbalanced pop from blame stack: #{scope.name} != #{expected_scope.name}&quot;</span> <span class='if if_mod kw'>if</span> <span class='scope identifier id'>scope</span> <span class='neq op'>!=</span> <span class='expected_scope identifier id'>expected_scope</span>
   
  <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='children_time identifier id'>children_time</span> <span class='opasgn op'>+=</span> <span class='duration identifier id'>duration</span> <span class='unless unless_mod kw'>unless</span> <span class='lparen token'>(</span><span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='scope identifier id'>scope</span><span class='dot token'>.</span><span class='deduct_call_time_from_parent identifier id'>deduct_call_time_from_parent</span><span class='rparen token'>)</span>
  
  <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='scope identifier id'>scope</span><span class='dot token'>.</span><span class='deduct_call_time_from_parent identifier id'>deduct_call_time_from_parent</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='children_time identifier id'>children_time</span> <span class='opasgn op'>+=</span> <span class='scope identifier id'>scope</span><span class='dot token'>.</span><span class='children_time identifier id'>children_time</span>
  <span class='end end kw'>end</span>
  
  <span class='if if kw'>if</span> <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span>
    <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_pop_scope identifier id'>notice_pop_scope</span><span class='lparen token'>(</span><span class='scope identifier id'>scope</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='time identifier id'>time</span><span class='rparen token'>)</span>
    <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_scope_empty identifier id'>notice_scope_empty</span><span class='lparen token'>(</span><span class='time identifier id'>time</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span> 
  <span class='end end kw'>end</span>
  
  <span class='scope identifier id'>scope</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>push_scope</h3>
</div><div id="push_scope-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>push_scope</span><span class='args'>(metric, time = Time.now.to_f, deduct_call_time_from_parent = true)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 68</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L68">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">68
69
70
71
72
73
74
75
76
77
78
79
80
81</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='push_scope identifier id'>push_scope</span><span class='lparen token'>(</span><span class='metric identifier id'>metric</span><span class='comma token'>,</span> <span class='time identifier id'>time</span> <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='dot token'>.</span><span class='to_f identifier id'>to_f</span><span class='comma token'>,</span> <span class='deduct_call_time_from_parent identifier id'>deduct_call_time_from_parent</span> <span class='assign token'>=</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
  
  <span class='stack identifier id'>stack</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
  
  <span class='if if kw'>if</span> <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span>
    <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_first_scope_push identifier id'>notice_first_scope_push</span><span class='lparen token'>(</span><span class='time identifier id'>time</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span> 
    <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_push_scope identifier id'>notice_push_scope</span> <span class='metric identifier id'>metric</span><span class='comma token'>,</span> <span class='time identifier id'>time</span>
  <span class='end end kw'>end</span>
  
  <span class='scope identifier id'>scope</span> <span class='assign token'>=</span> <span class='ScopeStackElement constant id'>ScopeStackElement</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='metric identifier id'>metric</span><span class='comma token'>,</span> <span class='integer val'>0</span><span class='comma token'>,</span> <span class='deduct_call_time_from_parent identifier id'>deduct_call_time_from_parent</span><span class='rparen token'>)</span>
  <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='scope identifier id'>scope</span>
  
  <span class='scope identifier id'>scope</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>remove_scope_stack_listener</h3>
</div><div id="remove_scope_stack_listener-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>remove_scope_stack_listener</span><span class='args'>(l)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 64</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L64">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">64
65
66</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='remove_scope_stack_listener identifier id'>remove_scope_stack_listener</span><span class='lparen token'>(</span><span class='l identifier id'>l</span><span class='rparen token'>)</span>
  <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>spawn_sampler_thread</h3>
</div><div id="spawn_sampler_thread-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>spawn_sampler_thread</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 33</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L33">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='spawn_sampler_thread identifier id'>spawn_sampler_thread</span>
    
    <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='@sampler_process ivar id'>@sampler_process</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='@sampler_process ivar id'>@sampler_process</span> <span class='eq op'>==</span> <span class='$$ gvar id'>$$</span> 
    
    <span class='comment val'># start up a thread that will periodically poll for metric samples</span>
    <span class='@sampler_thread ivar id'>@sampler_thread</span> <span class='assign token'>=</span> <span class='Thread constant id'>Thread</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='do do kw'>do</span>
      <span class='while while kw'>while</span> <span class='true true kw'>true</span> <span class='do do kw'>do</span>
        <span class='begin begin kw'>begin</span>
          <span class='sleep identifier id'>sleep</span> <span class='POLL_PERIOD constant id'>POLL_PERIOD</span>
          <span class='@sampled_items ivar id'>@sampled_items</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='sampled_item identifier id'>sampled_item</span><span class='bitor op'>|</span>
            <span class='begin begin kw'>begin</span> 
              <span class='sampled_item identifier id'>sampled_item</span><span class='dot token'>.</span><span class='poll identifier id'>poll</span>
            <span class='rescue rescue kw'>rescue</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='e identifier id'>e</span>
              <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='error identifier id'>error</span> <span class='e identifier id'>e</span>
              <span class='@sampled_items ivar id'>@sampled_items</span><span class='dot token'>.</span><span class='delete identifier id'>delete</span> <span class='sampled_item identifier id'>sampled_item</span>
              <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='error identifier id'>error</span> <span class='dstring node'>&quot;Removing #{sampled_item} from list&quot;</span>
              <span class='log identifier id'>log</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='e identifier id'>e</span><span class='dot token'>.</span><span class='backtrace identifier id'>backtrace</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
            <span class='end end kw'>end</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='@sampler_process ivar id'>@sampler_process</span> <span class='assign token'>=</span> <span class='$$ gvar id'>$$</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='add_scope_stack_listener identifier id'>add_scope_stack_listener</span><span class='lparen token'>(</span><span class='l identifier id'>l</span><span class='rparen token'>)</span>
    <span class='fail identifier id'>fail</span> <span class='string val'>&quot;Can't add a scope listener midflight in a transaction&quot;</span> <span class='if if_mod kw'>if</span> <span class='scope_stack identifier id'>scope_stack</span><span class='dot token'>.</span><span class='any? fid id'>any?</span>
    <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span> <span class='assign token'>=</span>  <span class='l identifier id'>l</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='remove_scope_stack_listener identifier id'>remove_scope_stack_listener</span><span class='lparen token'>(</span><span class='l identifier id'>l</span><span class='rparen token'>)</span>
    <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='push_scope identifier id'>push_scope</span><span class='lparen token'>(</span><span class='metric identifier id'>metric</span><span class='comma token'>,</span> <span class='time identifier id'>time</span> <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='dot token'>.</span><span class='to_f identifier id'>to_f</span><span class='comma token'>,</span> <span class='deduct_call_time_from_parent identifier id'>deduct_call_time_from_parent</span> <span class='assign token'>=</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
    
    <span class='stack identifier id'>stack</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
    
    <span class='if if kw'>if</span> <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span>
      <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_first_scope_push identifier id'>notice_first_scope_push</span><span class='lparen token'>(</span><span class='time identifier id'>time</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span> 
      <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_push_scope identifier id'>notice_push_scope</span> <span class='metric identifier id'>metric</span><span class='comma token'>,</span> <span class='time identifier id'>time</span>
    <span class='end end kw'>end</span>
    
    <span class='scope identifier id'>scope</span> <span class='assign token'>=</span> <span class='ScopeStackElement constant id'>ScopeStackElement</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='metric identifier id'>metric</span><span class='comma token'>,</span> <span class='integer val'>0</span><span class='comma token'>,</span> <span class='deduct_call_time_from_parent identifier id'>deduct_call_time_from_parent</span><span class='rparen token'>)</span>
    <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='push identifier id'>push</span> <span class='scope identifier id'>scope</span>
    
    <span class='scope identifier id'>scope</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='pop_scope identifier id'>pop_scope</span><span class='lparen token'>(</span><span class='expected_scope identifier id'>expected_scope</span><span class='comma token'>,</span> <span class='duration identifier id'>duration</span><span class='comma token'>,</span> <span class='time identifier id'>time</span><span class='assign token'>=</span><span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='dot token'>.</span><span class='to_f identifier id'>to_f</span><span class='rparen token'>)</span>

    <span class='stack identifier id'>stack</span> <span class='assign token'>=</span> <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span>
    
    <span class='scope identifier id'>scope</span> <span class='assign token'>=</span> <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span>
    
    <span class='fail identifier id'>fail</span> <span class='dstring node'>&quot;unbalanced pop from blame stack: #{scope.name} != #{expected_scope.name}&quot;</span> <span class='if if_mod kw'>if</span> <span class='scope identifier id'>scope</span> <span class='neq op'>!=</span> <span class='expected_scope identifier id'>expected_scope</span>
     
    <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='children_time identifier id'>children_time</span> <span class='opasgn op'>+=</span> <span class='duration identifier id'>duration</span> <span class='unless unless_mod kw'>unless</span> <span class='lparen token'>(</span><span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span> <span class='orop op'>||</span> <span class='notop op'>!</span><span class='scope identifier id'>scope</span><span class='dot token'>.</span><span class='deduct_call_time_from_parent identifier id'>deduct_call_time_from_parent</span><span class='rparen token'>)</span>
    
    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='scope identifier id'>scope</span><span class='dot token'>.</span><span class='deduct_call_time_from_parent identifier id'>deduct_call_time_from_parent</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
      <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='last identifier id'>last</span><span class='dot token'>.</span><span class='children_time identifier id'>children_time</span> <span class='opasgn op'>+=</span> <span class='scope identifier id'>scope</span><span class='dot token'>.</span><span class='children_time identifier id'>children_time</span>
    <span class='end end kw'>end</span>
    
    <span class='if if kw'>if</span> <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span>
      <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_pop_scope identifier id'>notice_pop_scope</span><span class='lparen token'>(</span><span class='scope identifier id'>scope</span><span class='dot token'>.</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='time identifier id'>time</span><span class='rparen token'>)</span>
      <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_scope_empty identifier id'>notice_scope_empty</span><span class='lparen token'>(</span><span class='time identifier id'>time</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span> 
    <span class='end end kw'>end</span>
    
    <span class='scope identifier id'>scope</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='peek_scope identifier id'>peek_scope</span>
    <span class='scope_stack identifier id'>scope_stack</span><span class='dot token'>.</span><span class='last identifier id'>last</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='add_sampled_metric identifier id'>add_sampled_metric</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='sampler_callback identifier id'>sampler_callback</span><span class='rparen token'>)</span>
    <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='get_stats identifier id'>get_stats</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='comma token'>,</span> <span class='false false kw'>false</span><span class='rparen token'>)</span>
    <span class='@sampled_items ivar id'>@sampled_items</span> <span class='lshft op'>&lt;&lt;</span> <span class='SampledItem constant id'>SampledItem</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='stats identifier id'>stats</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='sampler_callback identifier id'>sampler_callback</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
  
  <span class='comment val'># set the name of the transaction for the current thread, which will be used</span>
  <span class='comment val'># to define the scope of all traced methods called on this thread until the</span>
  <span class='comment val'># scope stack is empty.  </span>
  <span class='comment val'>#</span>
  <span class='comment val'># currently the transaction name is the name of the controller action that </span>
  <span class='comment val'># is invoked via the dispatcher, but conceivably we could use other transaction</span>
  <span class='comment val'># names in the future if the traced application does more than service http request</span>
  <span class='comment val'># via controller actions</span>
  <span class='def def kw'>def</span> <span class='transaction_name= identifier id'>transaction_name=</span><span class='lparen token'>(</span><span class='transaction identifier id'>transaction</span><span class='rparen token'>)</span>
    <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_transaction_name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='transaction identifier id'>transaction</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='transaction_name identifier id'>transaction_name</span>
    <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_transaction_name</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>
  
  
  <span class='def def kw'>def</span> <span class='lookup_stat identifier id'>lookup_stat</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='rparen token'>)</span>
    <span class='return return kw'>return</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>
  <span class='def def kw'>def</span> <span class='metrics identifier id'>metrics</span>
    <span class='return return kw'>return</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='get_stats_no_scope identifier id'>get_stats_no_scope</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='rparen token'>)</span>
    <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span>
    <span class='if if kw'>if</span> <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MethodTraceStats constant id'>MethodTraceStats</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
      <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='stats identifier id'>stats</span>
    <span class='end end kw'>end</span>
    <span class='stats identifier id'>stats</span>
  <span class='end end kw'>end</span>
  
  <span class='def def kw'>def</span> <span class='get_stats identifier id'>get_stats</span><span class='lparen token'>(</span><span class='metric_name identifier id'>metric_name</span><span class='comma token'>,</span> <span class='use_scope identifier id'>use_scope</span> <span class='assign token'>=</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>
    <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span>
    <span class='if if kw'>if</span> <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MethodTraceStats constant id'>MethodTraceStats</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
      <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_name identifier id'>metric_name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='stats identifier id'>stats</span>
    <span class='end end kw'>end</span>
    
    <span class='if if kw'>if</span> <span class='use_scope identifier id'>use_scope</span> <span class='andop op'>&amp;&amp;</span> <span class='transaction_name identifier id'>transaction_name</span>
      <span class='spec identifier id'>spec</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MetricSpec constant id'>MetricSpec</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='metric_name identifier id'>metric_name</span><span class='comma token'>,</span> <span class='transaction_name identifier id'>transaction_name</span>
      
      <span class='scoped_stats identifier id'>scoped_stats</span> <span class='assign token'>=</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='spec identifier id'>spec</span><span class='rbrack token'>]</span>
      <span class='if if kw'>if</span> <span class='scoped_stats identifier id'>scoped_stats</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
        <span class='scoped_stats identifier id'>scoped_stats</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='ScopedMethodTraceStats constant id'>ScopedMethodTraceStats</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='stats identifier id'>stats</span>
        <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='spec identifier id'>spec</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='scoped_stats identifier id'>scoped_stats</span>        
      <span class='end end kw'>end</span>
      
      <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='scoped_stats identifier id'>scoped_stats</span>
    <span class='end end kw'>end</span>
    <span class='return return kw'>return</span> <span class='stats identifier id'>stats</span>
  <span class='end end kw'>end</span>
  
  <span class='comment val'># Note: this is not synchronized.  There is still some risk in this and</span>
  <span class='comment val'># we will revisit later to see if we can make this more robust without</span>
  <span class='comment val'># sacrificing efficiency.</span>
  <span class='def def kw'>def</span> <span class='harvest_timeslice_data identifier id'>harvest_timeslice_data</span><span class='lparen token'>(</span><span class='previous_timeslice_data identifier id'>previous_timeslice_data</span><span class='comma token'>,</span> <span class='metric_ids identifier id'>metric_ids</span><span class='rparen token'>)</span>
    <span class='timeslice_data identifier id'>timeslice_data</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
    <span class='@stats_hash ivar id'>@stats_hash</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='metric_spec identifier id'>metric_spec</span><span class='bitor op'>|</span>
      
      
      <span class='comment val'># get a copy of the stats collected since the last harvest, and clear</span>
      <span class='comment val'># the stats inside our hash table for the next time slice.</span>
      <span class='stats identifier id'>stats</span> <span class='assign token'>=</span> <span class='@stats_hash ivar id'>@stats_hash</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span>

      <span class='comment val'># we have an optimization for unscoped metrics</span>
      <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='lparen token'>(</span><span class='metric_spec identifier id'>metric_spec</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MetricSpec constant id'>MetricSpec</span><span class='rparen token'>)</span>
        <span class='metric_spec identifier id'>metric_spec</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MetricSpec constant id'>MetricSpec</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='metric_spec identifier id'>metric_spec</span>
      <span class='end end kw'>end</span>

      <span class='if if kw'>if</span> <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> 
        <span class='raise identifier id'>raise</span> <span class='dstring node'>&quot;Nil stats for #{metric_spec.name} (#{metric_spec.scope})&quot;</span>
      <span class='end end kw'>end</span>
      
      <span class='stats_copy identifier id'>stats_copy</span> <span class='assign token'>=</span> <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='clone identifier id'>clone</span>
      <span class='stats identifier id'>stats</span><span class='dot token'>.</span><span class='reset identifier id'>reset</span>
      
      <span class='comment val'># if the previous timeslice data has not been reported (due to an error of some sort)</span>
      <span class='comment val'># then we need to merge this timeslice with the previously accumulated - but not sent</span>
      <span class='comment val'># data</span>
      <span class='previous_metric_data identifier id'>previous_metric_data</span> <span class='assign token'>=</span> <span class='previous_timeslice_data identifier id'>previous_timeslice_data</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span>
      <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='merge! fid id'>merge!</span> <span class='previous_metric_data identifier id'>previous_metric_data</span><span class='dot token'>.</span><span class='stats identifier id'>stats</span> <span class='unless unless_mod kw'>unless</span> <span class='previous_metric_data identifier id'>previous_metric_data</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      
      <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='round! fid id'>round!</span>
      
      <span class='comment val'># don't bother collecting and reporting stats that have zero-values for this timeslice.</span>
      <span class='comment val'># significant performance boost and storage savings.</span>
      <span class='unless unless kw'>unless</span> <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='call_count identifier id'>call_count</span> <span class='eq op'>==</span> <span class='integer val'>0</span> <span class='andop op'>&amp;&amp;</span> <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='total_call_time identifier id'>total_call_time</span> <span class='eq op'>==</span> <span class='integer val'>0</span><span class='integer val'>.0</span> <span class='andop op'>&amp;&amp;</span> <span class='stats_copy identifier id'>stats_copy</span><span class='dot token'>.</span><span class='total_exclusive_time identifier id'>total_exclusive_time</span> <span class='eq op'>==</span> <span class='integer val'>0</span><span class='integer val'>.0</span>
        
        <span class='metric_spec_for_transport identifier id'>metric_spec_for_transport</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='metric_ids identifier id'>metric_ids</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='metric_spec identifier id'>metric_spec</span> <span class='colon op'>:</span> <span class='nil nil kw'>nil</span>
        
        <span class='metric_data identifier id'>metric_data</span> <span class='assign token'>=</span> <span class='NewRelic constant id'>NewRelic</span><span class='colon2 op'>::</span><span class='MetricData constant id'>MetricData</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='metric_spec_for_transport identifier id'>metric_spec_for_transport</span><span class='comma token'>,</span> <span class='stats_copy identifier id'>stats_copy</span><span class='comma token'>,</span> <span class='metric_ids identifier id'>metric_ids</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
        
        <span class='timeslice_data identifier id'>timeslice_data</span><span class='lbrack token'>[</span><span class='metric_spec identifier id'>metric_spec</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='metric_data identifier id'>metric_data</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    
    <span class='timeslice_data identifier id'>timeslice_data</span>
  <span class='end end kw'>end</span>
  
  
  <span class='def def kw'>def</span> <span class='start_transaction identifier id'>start_transaction</span>
    <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>
  
  
  <span class='comment val'># Try to clean up gracefully, otherwise we leave things hanging around on thread locals</span>
  <span class='comment val'>#</span>
  <span class='def def kw'>def</span> <span class='end_transaction identifier id'>end_transaction</span>
    <span class='stack identifier id'>stack</span> <span class='assign token'>=</span> <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span>
    
    <span class='if if kw'>if</span> <span class='stack identifier id'>stack</span>
      <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span><span class='dot token'>.</span><span class='notice_scope_empty identifier id'>notice_scope_empty</span><span class='lparen token'>(</span><span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='@scope_stack_listener ivar id'>@scope_stack_listener</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='stack identifier id'>stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span> 
      <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
    <span class='end end kw'>end</span>
    
    <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_transaction_name</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='end end kw'>end</span>
  
  <span class='private identifier id'>private</span>
  
    <span class='def def kw'>def</span> <span class='scope_stack identifier id'>scope_stack</span>
      <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>start_transaction</h3>
</div><div id="start_transaction-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>start_transaction</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 216</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L216">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">216
217
218</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='start_transaction identifier id'>start_transaction</span>
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_scope_stack</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>transaction_name</h3>
</div><div id="transaction_name-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>transaction_name</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
set the name of the transaction for the current thread, which will be used
to define the scope of all traced methods called on this thread until the
scope stack is empty.
</p>
<p>
currently the transaction name is the name of the controller action that is
invoked via the dispatcher, but conceivably we could use other transaction
names in the future if the traced application does more than service http
request via controller actions
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/new_relic/agent/stats_engine.rb', line 122</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/newrelic/rpm/blob/master/lib/new_relic/agent/stats_engine.rb#L122">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">122
123
124</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='transaction_name identifier id'>transaction_name</span>
  <span class='Thread constant id'>Thread</span><span class='colon2 op'>::</span><span class='current identifier id'>current</span><span class='lbrack token'>[</span><span class='symbol val'>:newrelic_transaction_name</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> 2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>jgoizueta's flt - Class: Flt::Support::Formatter - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/jgoizueta/commits/flt/master" rel="alternate" title="Recent Commits to flt:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("jgoizueta", "flt", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("jgoizueta", "flt", "74e2b0218d3b82b2bb954d8787e3d2beaf422338", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/jgoizueta/flt/tree/">Source</a></li>
            <li class=""><a href="http://github.com/jgoizueta/flt/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/jgoizueta/flt/network">Network</a></li>            
            <li class=""><a href="http://github.com/jgoizueta/flt/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/jgoizueta/flt">Wiki</a></li>
            <li class=""><a href="http://github.com/jgoizueta/flt/graphs">Graphs</a></li>                    
            <li class="active"><a href="/jgoizueta/flt">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/jgoizueta">jgoizueta</a> / <b><a href="http://github.com/jgoizueta/flt/tree">flt</a></b>        
                <a id="namespaces_button" rel="jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section class Flt_Support_Formatter">
  <h1>Class: Flt::Support::Formatter</h1>
  <div class="section docstring">
  <p>
Burger and Dybvig free formatting algorithm, from their paper:
&quot;Printing Floating-Point Numbers Quickly and Accurately&quot; (Robert
G. Burger, R. Kent Dybvig)
</p>
<p>
This algorithm formats arbitrary base floating point numbers as decimal
text literals. The floating-point (with fixed precision) is interpreted as
an approximated value, representing any value in its
&#8216;rounding-range&#8217; (the interval where all values round to the
floating-point value, with the given precision and rounding mode). An
alternative approach which is not taken here would be to represent the
exact floating-point value with some given precision and rounding mode
requirements; that can be achieved with Clinger algorithm (which may fail
for exact precision).
</p>
<p>
The variables used by the algorithm are stored in instance variables:
</p>

</div><div class="section attributes">
  
    <div class="">
      <h2>Instance Attributes</h2>
      <table>
      
        <tr>
          <th class="name">round_up</td>
          <td class="readwrite">
            [<span id='round_up-instance_method'>R</span>W] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Returns the value of attribute <tt>round_up</tt>.
</p>

            
          </td>
        </tr>
      
      </table>
    </div>
  
</div><div class="section constants">
  <div class="thisclass">
  <h2>Constants</h2>
  <dl>
    
      <dt id="ESTIMATE_FLOAT_LOG_B-constant">ESTIMATE_FLOAT_LOG_B</dt>
      <dd>{2=&gt;1/Math.log(2), 10=&gt;1/Math.log(10), 16=&gt;1/Math.log(16)}</dd>
    
  </dl>
</div>

</div><div class="section constructor">
<h2>Constructor</h2>
  <div id="initialize-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>initialize</span><span class='args'>(input_b, input_min_e, output_b)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
This Object-oriented implementation is slower than the functional one for
two reasons:
</p>
<ul>
<li>The overhead of object creation

</li>
<li>The use of instance variables instead of local variables

</li>
</ul>
<p>
But if scale is optimized or local variables are used in the inner loops,
then this implementation is on par with the functional one for Float and it
is more efficient for Flt types, where the variables passed as parameters
hold larger objects.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 832</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L832">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='input_b identifier id'>input_b</span><span class='comma token'>,</span> <span class='input_min_e identifier id'>input_min_e</span><span class='comma token'>,</span> <span class='output_b identifier id'>output_b</span><span class='rparen token'>)</span>
  <span class='@b ivar id'>@b</span> <span class='assign token'>=</span> <span class='input_b identifier id'>input_b</span>
  <span class='@min_e ivar id'>@min_e</span> <span class='assign token'>=</span> <span class='input_min_e identifier id'>input_min_e</span>
  <span class='@output_b ivar id'>@output_b</span> <span class='assign token'>=</span> <span class='output_b identifier id'>output_b</span>
  <span class='comment val'># result of last operation</span>
  <span class='@adjusted_digits ivar id'>@adjusted_digits</span> <span class='assign token'>=</span> <span class='@digits ivar id'>@digits</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='comment val'># for &quot;all-digits&quot; mode results (which are truncated, rather than rounded),</span>
  <span class='comment val'># round_up contains information to round the result:</span>
  <span class='comment val'># * it is nil if the rest of digits are zero (the result is exact)</span>
  <span class='comment val'># * it is :lo if there exist non-zero digits beyond the significant ones (those returned), but</span>
  <span class='comment val'>#   the value is below the tie (the value must be rounded up only for :up rounding mode)</span>
  <span class='comment val'># * it is :tie if there exists exactly one nonzero digit after the significant and it is radix/2,</span>
  <span class='comment val'>#   for round-to-nearest it is atie.</span>
  <span class='comment val'># * it is :hi otherwise (the value should be rounded-up except for the :down mode)</span>
  <span class='@round_up ivar id'>@round_up</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#adjusted_digits-instance_method">#adjusted_digits</span><span class='args'>(round_mode)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Access rounded result of format operation: scaling (position of radix
point) and digits.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#b_power-instance_method">#b_power</span><span class='args'>(n)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#digits-instance_method">#digits</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Access result of format operation: scaling (position of radix point) and
digits.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#format-instance_method">#format</span><span class='args'>(v, f, e, round_mode, p = nil, all = false)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
This method converts v = f*b**e into a sequence of output_b-base digits, so
that if the digits are converted back to a floating-point value of
precision p (correctly rounded), the result is v.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#generate-instance_method">#generate</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#generate_max-instance_method">#generate_max</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#output_b_power-instance_method">#output_b_power</span><span class='args'>(n)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#scale-21-instance_method">#scale!</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
using local vars instead of instance vars: it makes a difference in
performance.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#scale_fixup-21-instance_method">#scale_fixup!</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
fix up scaling (final step): specialized version of scale! This performs a
single up scaling step, i.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#scale_optimized-21-instance_method">#scale_optimized!</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
scale_o1! is an optimized version of scale!; it requires an additional
parameters with the floating-point number v=r/s.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#scale_original-21-instance_method">#scale_original!</span><span class='args'>(really = false)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Given r/s = v (number to convert to text), m_m/s = (v - v-)/s, m_p/s = (v+
- v)/s Scale the fractions so that the first significant digit is right
after the radix point, i.
</p>

        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>adjusted_digits</h3>
</div><div id="adjusted_digits-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>adjusted_digits</span><span class='args'>(round_mode)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Access rounded result of format operation: scaling (position of radix
point) and digits
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 983</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L983">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">983
984
985
986
987
988
989
990
991
992
993
994
995
996
997
998
999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='adjusted_digits identifier id'>adjusted_digits</span><span class='lparen token'>(</span><span class='round_mode identifier id'>round_mode</span><span class='rparen token'>)</span>
  <span class='round_mode identifier id'>round_mode</span> <span class='assign token'>=</span> <span class='Support constant id'>Support</span><span class='dot token'>.</span><span class='simplified_round_mode identifier id'>simplified_round_mode</span><span class='lparen token'>(</span><span class='round_mode identifier id'>round_mode</span><span class='comma token'>,</span> <span class='@minus ivar id'>@minus</span><span class='rparen token'>)</span>
  <span class='if if kw'>if</span> <span class='@adjusted_digits ivar id'>@adjusted_digits</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='@digits ivar id'>@digits</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='increment identifier id'>increment</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='@round_up ivar id'>@round_up</span> <span class='andop op'>&amp;&amp;</span> <span class='lparen token'>(</span><span class='round_mode identifier id'>round_mode</span> <span class='neq op'>!=</span> <span class='symbol val'>:down</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span>
                <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='round_mode identifier id'>round_mode</span> <span class='eq op'>==</span> <span class='symbol val'>:up</span><span class='rparen token'>)</span> <span class='orop op'>||</span>
                <span class='lparen token'>(</span><span class='@round_up ivar id'>@round_up</span> <span class='eq op'>==</span> <span class='symbol val'>:hi</span><span class='rparen token'>)</span> <span class='orop op'>||</span>
                <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='@round_up ivar id'>@round_up</span> <span class='eq op'>==</span> <span class='symbol val'>:tie</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span>
                 <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='round_mode identifier id'>round_mode</span><span class='eq op'>==</span><span class='symbol val'>:half_up</span><span class='rparen token'>)</span> <span class='orop op'>||</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='round_mode identifier id'>round_mode</span><span class='eq op'>==</span><span class='symbol val'>:half_even</span><span class='rparen token'>)</span> <span class='andop op'>&amp;&amp;</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='@digits ivar id'>@digits</span><span class='dot token'>.</span><span class='last identifier id'>last</span> <span class='mod op'>%</span> <span class='integer val'>2</span><span class='rparen token'>)</span><span class='eq op'>==</span><span class='integer val'>1</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
    <span class='comment val'># increment = (@round_up == :tie) || (@round_up == :hi) # old behaviour (:half_up)</span>
    <span class='if if kw'>if</span> <span class='increment identifier id'>increment</span>
      <span class='base identifier id'>base</span> <span class='assign token'>=</span> <span class='@output_b ivar id'>@output_b</span>
      <span class='dec_pos identifier id'>dec_pos</span> <span class='assign token'>=</span> <span class='@k ivar id'>@k</span>
      <span class='digits identifier id'>digits</span> <span class='assign token'>=</span> <span class='@digits ivar id'>@digits</span><span class='dot token'>.</span><span class='dup identifier id'>dup</span>
      <span class='comment val'># carry = increment ? 1 : 0</span>
      <span class='comment val'># digits = digits.reverse.map{|d| d += carry; d&gt;=base ? 0 : (carry=0;d)}.reverse</span>
      <span class='comment val'># if carry != 0</span>
      <span class='comment val'>#   digits.unshift carry</span>
      <span class='comment val'>#   dec_pos += 1</span>
      <span class='comment val'># end</span>
      <span class='i identifier id'>i</span> <span class='assign token'>=</span> <span class='digits identifier id'>digits</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='minus op'>-</span> <span class='integer val'>1</span>
      <span class='while while kw'>while</span> <span class='i identifier id'>i</span><span class='geq op'>&gt;=</span><span class='integer val'>0</span>
        <span class='digits identifier id'>digits</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='if if kw'>if</span> <span class='digits identifier id'>digits</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='eq op'>==</span> <span class='base identifier id'>base</span>
          <span class='digits identifier id'>digits</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='integer val'>0</span>
        <span class='else else kw'>else</span>
          <span class='break break kw'>break</span>
        <span class='end end kw'>end</span>
        <span class='i identifier id'>i</span> <span class='opasgn op'>-=</span> <span class='integer val'>1</span>
      <span class='end end kw'>end</span>
      <span class='if if kw'>if</span> <span class='i identifier id'>i</span><span class='lt op'>&lt;</span><span class='integer val'>0</span>
        <span class='dec_pos identifier id'>dec_pos</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
        <span class='digits identifier id'>digits</span><span class='dot token'>.</span><span class='unshift identifier id'>unshift</span> <span class='integer val'>1</span>
      <span class='end end kw'>end</span>
      <span class='@adjusted_k ivar id'>@adjusted_k</span> <span class='assign token'>=</span> <span class='dec_pos identifier id'>dec_pos</span>
      <span class='@adjusted_digits ivar id'>@adjusted_digits</span> <span class='assign token'>=</span> <span class='digits identifier id'>digits</span>
    <span class='else else kw'>else</span>
      <span class='@adjusted_k ivar id'>@adjusted_k</span> <span class='assign token'>=</span> <span class='@k ivar id'>@k</span>
      <span class='@adjusted_digits ivar id'>@adjusted_digits</span> <span class='assign token'>=</span> <span class='@digits ivar id'>@digits</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='return return kw'>return</span> <span class='@adjusted_k ivar id'>@adjusted_k</span><span class='comma token'>,</span> <span class='@adjusted_digits ivar id'>@adjusted_digits</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>b_power</h3>
</div><div id="b_power-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>b_power</span><span class='args'>(n)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 1073</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L1073">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">1073
1074
1075</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='b_power identifier id'>b_power</span><span class='lparen token'>(</span><span class='n identifier id'>n</span><span class='rparen token'>)</span>
  <span class='@b ivar id'>@b</span><span class='pow op'>**</span><span class='n identifier id'>n</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>digits</h3>
</div><div id="digits-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>digits</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Access result of format operation: scaling (position of radix point) and
digits
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 975</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L975">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">975
976
977</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='digits identifier id'>digits</span>
  <span class='return return kw'>return</span> <span class='@k ivar id'>@k</span><span class='comma token'>,</span> <span class='@digits ivar id'>@digits</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>format</h3>
</div><div id="format-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>format</span><span class='args'>(v, f, e, round_mode, p = nil, all = false)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
This method converts v = f*b**e into a sequence of output_b-base digits, so
that if the digits are converted back to a floating-point value of
precision p (correctly rounded), the result is v. If round_mode is not nil,
just enough digits to produce v using that rounding is used; otherwise
enough digits to produce v with any rounding are delivered.
</p>
<p>
If the <tt>all</tt> parameter is true, all significant digits are generated
without rounding, i.e. all digits that, if used on input, cannot
arbitrarily change while preserving the parsed value of the floating point
number. Since the digits are not rounded more digits may be needed to
assure round-trip value preservation. This is useful to reflect the
precision of the floating point value in the output; in particular trailing
significant zeros are shown. But note that, for directed rounding and base
conversion this may need to produce an infinite number of digits, in which
case an exception will be raised. This is specially frequent for the :up
rounding mode, in which any number with a finite number of nonzero digits
equal to or less than the precision will haver and infinite sequence of
zero significant digits.
</p>
<p>
With :down rounding (truncation) this could be used to show the exact value
of the floating point but beware: when used with directed rounding, if the
value has not an exact representation in the output base this will lead to
an infinite loop. formatting &#8216;0.1&#8217; (as a decimal floating-point
number) in base 2 with :down rounding
</p>
<p>
When the <tt>all</tt> parameters is used the result is not rounded (is
truncated), and the round_up flag is set to indicate that nonzero digits
exists beyond the returned digits; the possible values of the round_up flag
are:
</p>
<ul>
<li>nil : the rest of digits are zero (the result is exact)

</li>
<li>:lo : there exist non-zero digits beyond the significant ones (those
returned), but the value is below the tie (the value must be rounded up
only for :up rounding mode)

</li>
<li>:tie : there exists exactly one nonzero digit after the significant and it
is radix/2, for round-to-nearest it is atie.

</li>
<li>:hi : the value is closer to the rounded-up value (incrementing the last
significative digit.)

</li>
</ul>
<p>
Note that the round_mode here is not the rounding mode applied to the
output; it is the rounding mode that applied to <b>input</b> preserves the
original floating-point value (with the same precision as input). should be
rounded-up.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 886</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L886">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">886
887
888
889
890
891
892
893
894
895
896
897
898
899
900
901
902
903
904
905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930
931
932
933
934
935
936
937
938
939
940
941
942
943
944
945
946
947
948
949
950
951
952
953
954
955
956
957
958
959
960
961
962
963
964
965
966
967
968
969
970
971
972</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='format identifier id'>format</span><span class='lparen token'>(</span><span class='v identifier id'>v</span><span class='comma token'>,</span> <span class='f identifier id'>f</span><span class='comma token'>,</span> <span class='e identifier id'>e</span><span class='comma token'>,</span> <span class='round_mode identifier id'>round_mode</span><span class='comma token'>,</span> <span class='p identifier id'>p</span><span class='assign token'>=</span><span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='all identifier id'>all</span><span class='assign token'>=</span><span class='false false kw'>false</span><span class='rparen token'>)</span>
  <span class='context identifier id'>context</span> <span class='assign token'>=</span> <span class='v identifier id'>v</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='context identifier id'>context</span>
  <span class='comment val'># TODO: consider removing parameters f,e and using v.split instead</span>
  <span class='@minus ivar id'>@minus</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='context identifier id'>context</span><span class='dot token'>.</span><span class='sign identifier id'>sign</span><span class='lparen token'>(</span><span class='v identifier id'>v</span><span class='rparen token'>)</span><span class='eq op'>==</span><span class='integer val'>-1</span><span class='rparen token'>)</span>
  <span class='@v ivar id'>@v</span> <span class='assign token'>=</span> <span class='context identifier id'>context</span><span class='dot token'>.</span><span class='copy_sign identifier id'>copy_sign</span><span class='lparen token'>(</span><span class='v identifier id'>v</span><span class='comma token'>,</span> <span class='integer val'>+1</span><span class='rparen token'>)</span> <span class='comment val'># don't use context.abs(v) because it rounds (and may overflow also)</span>
  <span class='@f ivar id'>@f</span> <span class='assign token'>=</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='abs identifier id'>abs</span>
  <span class='@e ivar id'>@e</span> <span class='assign token'>=</span> <span class='e identifier id'>e</span>
  <span class='@round_mode ivar id'>@round_mode</span> <span class='assign token'>=</span> <span class='round_mode identifier id'>round_mode</span>
  <span class='@all_digits ivar id'>@all_digits</span> <span class='assign token'>=</span> <span class='all identifier id'>all</span>
  <span class='p identifier id'>p</span> <span class='opasgn op'>||=</span> <span class='context identifier id'>context</span><span class='dot token'>.</span><span class='precision identifier id'>precision</span>

  <span class='comment val'># adjust the rounding mode to work only with positive numbers</span>
  <span class='@round_mode ivar id'>@round_mode</span> <span class='assign token'>=</span> <span class='Support constant id'>Support</span><span class='dot token'>.</span><span class='simplified_round_mode identifier id'>simplified_round_mode</span><span class='lparen token'>(</span><span class='@round_mode ivar id'>@round_mode</span><span class='comma token'>,</span> <span class='@minus ivar id'>@minus</span><span class='rparen token'>)</span>

  <span class='comment val'># determine the high,low inclusion flags of the rounding limits</span>
  <span class='case case kw'>case</span> <span class='@round_mode ivar id'>@round_mode</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:half_even</span>
      <span class='comment val'># rounding rage is (v-m-,v+m+) if v is odd and [v+m-,v+m+] if even</span>
      <span class='@round_l ivar id'>@round_l</span> <span class='assign token'>=</span> <span class='@round_h ivar id'>@round_h</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='@f ivar id'>@f</span><span class='mod op'>%</span><span class='integer val'>2</span><span class='rparen token'>)</span><span class='eq op'>==</span><span class='integer val'>0</span><span class='rparen token'>)</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:up</span>
      <span class='comment val'># rounding rage is (v-,v]</span>
      <span class='comment val'># ceiling is treated here assuming f&gt;0</span>
      <span class='@round_l ivar id'>@round_l</span><span class='comma token'>,</span> <span class='@round_h ivar id'>@round_h</span> <span class='assign token'>=</span> <span class='false false kw'>false</span><span class='comma token'>,</span> <span class='true true kw'>true</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:down</span>
      <span class='comment val'># rounding rage is [v,v+)</span>
      <span class='comment val'># floor is treated here assuming f&gt;0</span>
      <span class='@round_l ivar id'>@round_l</span><span class='comma token'>,</span> <span class='@round_h ivar id'>@round_h</span> <span class='assign token'>=</span> <span class='true true kw'>true</span><span class='comma token'>,</span> <span class='false false kw'>false</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:half_up</span>
      <span class='comment val'># rounding rage is [v+m-,v+m+)</span>
      <span class='@round_l ivar id'>@round_l</span><span class='comma token'>,</span> <span class='@round_h ivar id'>@round_h</span> <span class='assign token'>=</span> <span class='true true kw'>true</span><span class='comma token'>,</span> <span class='false false kw'>false</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:half_down</span>
      <span class='comment val'># rounding rage is (v+m-,v+m+]</span>
      <span class='@round_l ivar id'>@round_l</span><span class='comma token'>,</span> <span class='@round_h ivar id'>@round_h</span> <span class='assign token'>=</span> <span class='false false kw'>false</span><span class='comma token'>,</span> <span class='true true kw'>true</span>
    <span class='else else kw'>else</span> <span class='comment val'># :nearest</span>
      <span class='comment val'># Here assume only that round-to-nearest will be used, but not which variant of it</span>
      <span class='comment val'># The result is valid for any rounding (to nearest) but may produce more digits</span>
      <span class='comment val'># than stricly necessary for specific rounding modes.</span>
      <span class='comment val'># That is, enough digits are generated so that when the result is</span>
      <span class='comment val'># converted to floating point with the specified precision and</span>
      <span class='comment val'># correct rounding (to nearest), the result is the original number.</span>
      <span class='comment val'># rounding range is (v+m-,v+m+)</span>
      <span class='@round_l ivar id'>@round_l</span> <span class='assign token'>=</span> <span class='@round_h ivar id'>@round_h</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># TODO: use context.next_minus, next_plus instead of direct computing, don't require min_e &amp; ps</span>
  <span class='comment val'># Now compute the working quotients @r/@s, @m_p/@s = (v+ - @v), @m_m/@s = (@v - v-) and scale them.</span>
  <span class='if if kw'>if</span> <span class='@e ivar id'>@e</span> <span class='geq op'>&gt;=</span> <span class='integer val'>0</span>
    <span class='if if kw'>if</span> <span class='@f ivar id'>@f</span> <span class='neq op'>!=</span> <span class='b_power identifier id'>b_power</span><span class='lparen token'>(</span><span class='p identifier id'>p</span><span class='minus op'>-</span><span class='integer val'>1</span><span class='rparen token'>)</span>
      <span class='be identifier id'>be</span> <span class='assign token'>=</span> <span class='b_power identifier id'>b_power</span><span class='lparen token'>(</span><span class='@e ivar id'>@e</span><span class='rparen token'>)</span>
      <span class='@r ivar id'>@r</span><span class='comma token'>,</span> <span class='@s ivar id'>@s</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span><span class='comma token'>,</span> <span class='@m_m ivar id'>@m_m</span> <span class='assign token'>=</span> <span class='@f ivar id'>@f</span><span class='mult op'>*</span><span class='be identifier id'>be</span><span class='mult op'>*</span><span class='integer val'>2</span><span class='comma token'>,</span> <span class='integer val'>2</span><span class='comma token'>,</span> <span class='be identifier id'>be</span><span class='comma token'>,</span> <span class='be identifier id'>be</span>
    <span class='else else kw'>else</span>
      <span class='be identifier id'>be</span> <span class='assign token'>=</span> <span class='b_power identifier id'>b_power</span><span class='lparen token'>(</span><span class='@e ivar id'>@e</span><span class='rparen token'>)</span>
      <span class='be1 identifier id'>be1</span> <span class='assign token'>=</span> <span class='be identifier id'>be</span><span class='mult op'>*</span><span class='@b ivar id'>@b</span>
      <span class='@r ivar id'>@r</span><span class='comma token'>,</span> <span class='@s ivar id'>@s</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span><span class='comma token'>,</span> <span class='@m_m ivar id'>@m_m</span> <span class='assign token'>=</span> <span class='@f ivar id'>@f</span><span class='mult op'>*</span><span class='be1 identifier id'>be1</span><span class='mult op'>*</span><span class='integer val'>2</span><span class='comma token'>,</span> <span class='@b ivar id'>@b</span><span class='mult op'>*</span><span class='integer val'>2</span><span class='comma token'>,</span> <span class='be1 identifier id'>be1</span><span class='comma token'>,</span> <span class='be identifier id'>be</span>
    <span class='end end kw'>end</span>
  <span class='else else kw'>else</span>
    <span class='if if kw'>if</span> <span class='@e ivar id'>@e</span><span class='eq op'>==</span><span class='@min_e ivar id'>@min_e</span> <span class='or or kw'>or</span> <span class='@f ivar id'>@f</span> <span class='neq op'>!=</span> <span class='b_power identifier id'>b_power</span><span class='lparen token'>(</span><span class='p identifier id'>p</span><span class='minus op'>-</span><span class='integer val'>1</span><span class='rparen token'>)</span>
      <span class='@r ivar id'>@r</span><span class='comma token'>,</span> <span class='@s ivar id'>@s</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span><span class='comma token'>,</span> <span class='@m_m ivar id'>@m_m</span> <span class='assign token'>=</span> <span class='@f ivar id'>@f</span><span class='mult op'>*</span><span class='integer val'>2</span><span class='comma token'>,</span> <span class='b_power identifier id'>b_power</span><span class='lparen token'>(</span><span class='minus op'>-</span><span class='@e ivar id'>@e</span><span class='rparen token'>)</span><span class='mult op'>*</span><span class='integer val'>2</span><span class='comma token'>,</span> <span class='integer val'>1</span><span class='comma token'>,</span> <span class='integer val'>1</span>
    <span class='else else kw'>else</span>
      <span class='@r ivar id'>@r</span><span class='comma token'>,</span> <span class='@s ivar id'>@s</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span><span class='comma token'>,</span> <span class='@m_m ivar id'>@m_m</span> <span class='assign token'>=</span> <span class='@f ivar id'>@f</span><span class='mult op'>*</span><span class='@b ivar id'>@b</span><span class='mult op'>*</span><span class='integer val'>2</span><span class='comma token'>,</span> <span class='b_power identifier id'>b_power</span><span class='lparen token'>(</span><span class='integer val'>1</span><span class='minus op'>-</span><span class='@e ivar id'>@e</span><span class='rparen token'>)</span><span class='mult op'>*</span><span class='integer val'>2</span><span class='comma token'>,</span> <span class='@b ivar id'>@b</span><span class='comma token'>,</span> <span class='integer val'>1</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='@k ivar id'>@k</span> <span class='assign token'>=</span> <span class='integer val'>0</span>
  <span class='@context ivar id'>@context</span> <span class='assign token'>=</span> <span class='context identifier id'>context</span>
  <span class='scale_optimized! fid id'>scale_optimized!</span>


  <span class='comment val'># The value to be formatted is @v=@r/@s; m- = @m_m/@s = (@v - v-)/@s; m+ = @m_p/@s = (v+ - @v)/@s</span>
  <span class='comment val'># Now adjust @m_m, @m_p so that they define the rounding range</span>
  <span class='case case kw'>case</span> <span class='@round_mode ivar id'>@round_mode</span>
  <span class='when when kw'>when</span> <span class='symbol val'>:up</span>
    <span class='comment val'># ceiling is treated here assuming @f&gt;0</span>
    <span class='comment val'># rounding range is -v,@v</span>
    <span class='@m_m ivar id'>@m_m</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span> <span class='assign token'>=</span> <span class='@m_m ivar id'>@m_m</span><span class='mult op'>*</span><span class='integer val'>2</span><span class='comma token'>,</span> <span class='integer val'>0</span>
  <span class='when when kw'>when</span> <span class='symbol val'>:down</span>
    <span class='comment val'># floor is treated here assuming #f&gt;0</span>
    <span class='comment val'># rounding range is @v,v+</span>
    <span class='@m_m ivar id'>@m_m</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span> <span class='assign token'>=</span> <span class='integer val'>0</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span><span class='mult op'>*</span><span class='integer val'>2</span>
  <span class='else else kw'>else</span>
    <span class='comment val'># rounding range is v-,v+</span>
    <span class='comment val'># @m_m, @m_p = @m_m, @m_p</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># Now m_m, m_p define the rounding range</span>
  <span class='all identifier id'>all</span> <span class='integer val'>? </span><span class='generate_max identifier id'>generate_max</span> <span class='colon op'>:</span> <span class='generate identifier id'>generate</span>

<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>generate</h3>
</div><div id="generate-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>generate</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 1121</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L1121">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='generate identifier id'>generate</span>
  <span class='list identifier id'>list</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='r identifier id'>r</span><span class='comma token'>,</span> <span class='s identifier id'>s</span><span class='comma token'>,</span> <span class='m_p identifier id'>m_p</span><span class='comma token'>,</span> <span class='m_m identifier id'>m_m</span><span class='comma token'>,</span> <span class='assign token'>=</span> <span class='@r ivar id'>@r</span><span class='comma token'>,</span> <span class='@s ivar id'>@s</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span><span class='comma token'>,</span> <span class='@m_m ivar id'>@m_m</span>
  <span class='loop identifier id'>loop</span> <span class='do do kw'>do</span>
    <span class='d identifier id'>d</span><span class='comma token'>,</span><span class='r identifier id'>r</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='mult op'>*</span><span class='@output_b ivar id'>@output_b</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='divmod identifier id'>divmod</span><span class='lparen token'>(</span><span class='s identifier id'>s</span><span class='rparen token'>)</span>
    <span class='m_p identifier id'>m_p</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>
    <span class='m_m identifier id'>m_m</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>
    <span class='tc1 identifier id'>tc1</span> <span class='assign token'>=</span> <span class='@round_l ivar id'>@round_l</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='leq op'>&lt;=</span><span class='m_m identifier id'>m_m</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='lt op'>&lt;</span><span class='m_m identifier id'>m_m</span><span class='rparen token'>)</span>
    <span class='tc2 identifier id'>tc2</span> <span class='assign token'>=</span> <span class='@round_h ivar id'>@round_h</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='plus op'>+</span><span class='m_p identifier id'>m_p</span> <span class='geq op'>&gt;=</span> <span class='s identifier id'>s</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='plus op'>+</span><span class='m_p identifier id'>m_p</span> <span class='gt op'>&gt;</span> <span class='s identifier id'>s</span><span class='rparen token'>)</span>

    <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='tc1 identifier id'>tc1</span>
      <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='tc2 identifier id'>tc2</span>
        <span class='list identifier id'>list</span> <span class='lshft op'>&lt;&lt;</span> <span class='d identifier id'>d</span>
      <span class='else else kw'>else</span>
        <span class='list identifier id'>list</span> <span class='lshft op'>&lt;&lt;</span> <span class='d identifier id'>d</span><span class='plus op'>+</span><span class='integer val'>1</span>
        <span class='break break kw'>break</span>
      <span class='end end kw'>end</span>
    <span class='else else kw'>else</span>
      <span class='if if kw'>if</span> <span class='not not kw'>not</span> <span class='tc2 identifier id'>tc2</span>
        <span class='list identifier id'>list</span> <span class='lshft op'>&lt;&lt;</span> <span class='d identifier id'>d</span>
        <span class='break break kw'>break</span>
      <span class='else else kw'>else</span>
        <span class='if if kw'>if</span> <span class='r identifier id'>r</span><span class='mult op'>*</span><span class='integer val'>2</span> <span class='lt op'>&lt;</span> <span class='s identifier id'>s</span>
          <span class='list identifier id'>list</span> <span class='lshft op'>&lt;&lt;</span> <span class='d identifier id'>d</span>
          <span class='break break kw'>break</span>
        <span class='else else kw'>else</span>
          <span class='list identifier id'>list</span> <span class='lshft op'>&lt;&lt;</span> <span class='d identifier id'>d</span><span class='plus op'>+</span><span class='integer val'>1</span>
          <span class='break break kw'>break</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

  <span class='end end kw'>end</span>
  <span class='@digits ivar id'>@digits</span> <span class='assign token'>=</span> <span class='list identifier id'>list</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>generate_max</h3>
</div><div id="generate_max-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>generate_max</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 1081</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L1081">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='generate_max identifier id'>generate_max</span>
  <span class='@round_up ivar id'>@round_up</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='list identifier id'>list</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='r identifier id'>r</span><span class='comma token'>,</span> <span class='s identifier id'>s</span><span class='comma token'>,</span> <span class='m_p identifier id'>m_p</span><span class='comma token'>,</span> <span class='m_m identifier id'>m_m</span><span class='comma token'>,</span> <span class='assign token'>=</span> <span class='@r ivar id'>@r</span><span class='comma token'>,</span> <span class='@s ivar id'>@s</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span><span class='comma token'>,</span> <span class='@m_m ivar id'>@m_m</span>
  <span class='n_iters identifier id'>n_iters</span><span class='comma token'>,</span> <span class='rs identifier id'>rs</span> <span class='assign token'>=</span> <span class='integer val'>0</span><span class='comma token'>,</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='loop identifier id'>loop</span> <span class='do do kw'>do</span>
    <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='n_iters identifier id'>n_iters</span> <span class='gt op'>&gt;</span> <span class='integer val'>10000</span><span class='rparen token'>)</span>
      <span class='raise identifier id'>raise</span> <span class='string val'>&quot;Infinite digit sequence.&quot;</span> <span class='if if_mod kw'>if</span> <span class='rs identifier id'>rs</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='rparen token'>)</span>
      <span class='rs identifier id'>rs</span> <span class='lshft op'>&lt;&lt;</span> <span class='r identifier id'>r</span>
    <span class='else else kw'>else</span>
      <span class='n_iters identifier id'>n_iters</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
    <span class='end end kw'>end</span>

    <span class='d identifier id'>d</span><span class='comma token'>,</span><span class='r identifier id'>r</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='mult op'>*</span><span class='@output_b ivar id'>@output_b</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='divmod identifier id'>divmod</span><span class='lparen token'>(</span><span class='s identifier id'>s</span><span class='rparen token'>)</span>

    <span class='m_p identifier id'>m_p</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>
    <span class='m_m identifier id'>m_m</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>

    <span class='list identifier id'>list</span> <span class='lshft op'>&lt;&lt;</span> <span class='d identifier id'>d</span>

    <span class='tc1 identifier id'>tc1</span> <span class='assign token'>=</span> <span class='@round_l ivar id'>@round_l</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='leq op'>&lt;=</span><span class='m_m identifier id'>m_m</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='lt op'>&lt;</span><span class='m_m identifier id'>m_m</span><span class='rparen token'>)</span>
    <span class='tc2 identifier id'>tc2</span> <span class='assign token'>=</span> <span class='@round_h ivar id'>@round_h</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='plus op'>+</span><span class='m_p identifier id'>m_p</span> <span class='geq op'>&gt;=</span> <span class='s identifier id'>s</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='plus op'>+</span><span class='m_p identifier id'>m_p</span> <span class='gt op'>&gt;</span> <span class='s identifier id'>s</span><span class='rparen token'>)</span>

    <span class='if if kw'>if</span> <span class='tc1 identifier id'>tc1</span> <span class='andop op'>&amp;&amp;</span> <span class='tc2 identifier id'>tc2</span>
      <span class='if if kw'>if</span> <span class='r identifier id'>r</span> <span class='neq op'>!=</span> <span class='integer val'>0</span>
        <span class='r identifier id'>r</span> <span class='opasgn op'>*=</span> <span class='integer val'>2</span>
        <span class='if if kw'>if</span> <span class='r identifier id'>r</span> <span class='gt op'>&gt;</span> <span class='s identifier id'>s</span>
          <span class='@round_up ivar id'>@round_up</span> <span class='assign token'>=</span> <span class='symbol val'>:hi</span>
        <span class='elsif elsif kw'>elsif</span> <span class='r identifier id'>r</span> <span class='eq op'>==</span> <span class='s identifier id'>s</span>
          <span class='@round_up ivar id'>@round_up</span> <span class='assign token'>=</span> <span class='symbol val'>:tie</span>
        <span class='else else kw'>else</span>
          <span class='@rund_up ivar id'>@rund_up</span> <span class='assign token'>=</span> <span class='symbol val'>:lo</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
      <span class='break break kw'>break</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='@digits ivar id'>@digits</span> <span class='assign token'>=</span> <span class='list identifier id'>list</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>output_b_power</h3>
</div><div id="output_b_power-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>output_b_power</span><span class='args'>(n)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 1077</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L1077">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">1077
1078
1079</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='output_b_power identifier id'>output_b_power</span><span class='lparen token'>(</span><span class='n identifier id'>n</span><span class='rparen token'>)</span>
  <span class='@output_b ivar id'>@output_b</span><span class='pow op'>**</span><span class='n identifier id'>n</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>scale!</h3>
</div><div id="scale-21-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>scale!</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
using local vars instead of instance vars: it makes a difference in
performance
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 1051</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L1051">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='scale! fid id'>scale!</span>
  <span class='r identifier id'>r</span><span class='comma token'>,</span> <span class='s identifier id'>s</span><span class='comma token'>,</span> <span class='m_p identifier id'>m_p</span><span class='comma token'>,</span> <span class='m_m identifier id'>m_m</span><span class='comma token'>,</span> <span class='k identifier id'>k</span><span class='comma token'>,</span><span class='output_b identifier id'>output_b</span> <span class='assign token'>=</span> <span class='@r ivar id'>@r</span><span class='comma token'>,</span> <span class='@s ivar id'>@s</span><span class='comma token'>,</span> <span class='@m_p ivar id'>@m_p</span><span class='comma token'>,</span> <span class='@m_m ivar id'>@m_m</span><span class='comma token'>,</span> <span class='@k ivar id'>@k</span><span class='comma token'>,</span><span class='@output_b ivar id'>@output_b</span>
  <span class='loop identifier id'>loop</span> <span class='do do kw'>do</span>
    <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='@round_h ivar id'>@round_h</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='plus op'>+</span><span class='m_p identifier id'>m_p</span> <span class='geq op'>&gt;=</span> <span class='s identifier id'>s</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='plus op'>+</span><span class='m_p identifier id'>m_p</span> <span class='gt op'>&gt;</span> <span class='s identifier id'>s</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='comment val'># k is too low</span>
      <span class='s identifier id'>s</span> <span class='opasgn op'>*=</span> <span class='output_b identifier id'>output_b</span>
      <span class='k identifier id'>k</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
    <span class='elsif elsif kw'>elsif</span> <span class='lparen token'>(</span><span class='@round_h ivar id'>@round_h</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='plus op'>+</span><span class='m_p identifier id'>m_p</span><span class='rparen token'>)</span><span class='mult op'>*</span><span class='output_b identifier id'>output_b</span><span class='lt op'>&lt;</span><span class='s identifier id'>s</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='r identifier id'>r</span><span class='plus op'>+</span><span class='m_p identifier id'>m_p</span><span class='rparen token'>)</span><span class='mult op'>*</span><span class='output_b identifier id'>output_b</span><span class='leq op'>&lt;=</span><span class='s identifier id'>s</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='comment val'># k is too high</span>
      <span class='r identifier id'>r</span> <span class='opasgn op'>*=</span> <span class='output_b identifier id'>output_b</span>
      <span class='m_p identifier id'>m_p</span> <span class='opasgn op'>*=</span> <span class='output_b identifier id'>output_b</span>
      <span class='m_m identifier id'>m_m</span> <span class='opasgn op'>*=</span> <span class='output_b identifier id'>output_b</span>
      <span class='k identifier id'>k</span> <span class='opasgn op'>-=</span> <span class='integer val'>1</span>
    <span class='else else kw'>else</span>
      <span class='@s ivar id'>@s</span> <span class='assign token'>=</span> <span class='s identifier id'>s</span>
      <span class='@r ivar id'>@r</span> <span class='assign token'>=</span> <span class='r identifier id'>r</span>
      <span class='@m_p ivar id'>@m_p</span> <span class='assign token'>=</span> <span class='m_p identifier id'>m_p</span>
      <span class='@m_m ivar id'>@m_m</span> <span class='assign token'>=</span> <span class='m_m identifier id'>m_m</span>
      <span class='@k ivar id'>@k</span> <span class='assign token'>=</span> <span class='k identifier id'>k</span>
      <span class='break break kw'>break</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>scale_fixup!</h3>
</div><div id="scale_fixup-21-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>scale_fixup!</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
fix up scaling (final step): specialized version of scale! This performs a
single up scaling step, i.e. behaves like scale2, but the input must be at
most one step down from the final result
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 1231</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L1231">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">1231
1232
1233
1234
1235
1236</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='scale_fixup! fid id'>scale_fixup!</span>
  <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='@round_h ivar id'>@round_h</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='@r ivar id'>@r</span><span class='plus op'>+</span><span class='@m_p ivar id'>@m_p</span> <span class='geq op'>&gt;=</span> <span class='@s ivar id'>@s</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='@r ivar id'>@r</span><span class='plus op'>+</span><span class='@m_p ivar id'>@m_p</span> <span class='gt op'>&gt;</span> <span class='@s ivar id'>@s</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='comment val'># too low?</span>
    <span class='@s ivar id'>@s</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>
    <span class='@k ivar id'>@k</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>scale_optimized!</h3>
</div><div id="scale_optimized-21-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>scale_optimized!</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
scale_o1! is an optimized version of scale!; it requires an additional
parameters with the floating-point number v=r/s
</p>
<p>
It uses a Float estimate of ceil(logB(v)) that may need to adjusted one
unit up TODO: find easy to use estimate; determine max distance to correct
value and use it for fixing,
</p>
<pre class="code">
      <span class='or or kw'>or</span> <span class='use identifier id'>use</span> <span class='the identifier id'>the</span> <span class='general identifier id'>general</span> <span class='scale! fid id'>scale!</span> <span class='for for kw'>for</span> <span class='fixing identifier id'>fixing</span> <span class='lparen token'>(</span><span class='but identifier id'>but</span> <span class='remembar identifier id'>remembar</span> <span class='to identifier id'>to</span> <span class='multiply identifier id'>multiply</span> <span class='by identifier id'>by</span> <span class='exptt identifier id'>exptt</span><span class='lparen token'>(</span><span class='dot3 op'>...</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
      <span class='lparen token'>(</span><span class='determine identifier id'>determine</span> <span class='when when kw'>when</span> <span class='Math constant id'>Math</span><span class='dot token'>.</span><span class='log identifier id'>log</span> <span class='is identifier id'>is</span> <span class='aplicable identifier id'>aplicable</span><span class='comma token'>,</span> <span class='etc identifier id'>etc</span><span class='dot token'>.</span><span class='rparen token'>)</span>
</pre>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 1165</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L1165">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='scale_optimized! fid id'>scale_optimized!</span>
  <span class='context identifier id'>context</span> <span class='assign token'>=</span> <span class='@context ivar id'>@context</span> <span class='comment val'># @v.class.context</span>
  <span class='return return kw'>return</span> <span class='scale! fid id'>scale!</span> <span class='if if_mod kw'>if</span> <span class='context identifier id'>context</span><span class='dot token'>.</span><span class='zero? fid id'>zero?</span><span class='lparen token'>(</span><span class='@v ivar id'>@v</span><span class='rparen token'>)</span>

  <span class='comment val'># 1. compute estimated_scale</span>

  <span class='comment val'># 1.1. try to use Float logarithms (Math.log)</span>
  <span class='v identifier id'>v</span> <span class='assign token'>=</span> <span class='@v ivar id'>@v</span>
  <span class='v_abs identifier id'>v_abs</span> <span class='assign token'>=</span> <span class='context identifier id'>context</span><span class='dot token'>.</span><span class='copy_sign identifier id'>copy_sign</span><span class='lparen token'>(</span><span class='v identifier id'>v</span><span class='comma token'>,</span> <span class='integer val'>+1</span><span class='rparen token'>)</span> <span class='comment val'># don't use v.abs because it rounds (and may overflow also)</span>
  <span class='v_flt identifier id'>v_flt</span> <span class='assign token'>=</span> <span class='v_abs identifier id'>v_abs</span><span class='dot token'>.</span><span class='to_f identifier id'>to_f</span>
  <span class='b identifier id'>b</span> <span class='assign token'>=</span> <span class='@output_b ivar id'>@output_b</span>
  <span class='log_b identifier id'>log_b</span> <span class='assign token'>=</span> <span class='ESTIMATE_FLOAT_LOG_B constant id'>ESTIMATE_FLOAT_LOG_B</span><span class='lbrack token'>[</span><span class='b identifier id'>b</span><span class='rbrack token'>]</span>
  <span class='log_b identifier id'>log_b</span> <span class='assign token'>=</span> <span class='ESTIMATE_FLOAT_LOG_B constant id'>ESTIMATE_FLOAT_LOG_B</span><span class='lbrack token'>[</span><span class='b identifier id'>b</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='float val'>1.0</span><span class='div op'>/</span><span class='Math constant id'>Math</span><span class='dot token'>.</span><span class='log identifier id'>log</span><span class='lparen token'>(</span><span class='b identifier id'>b</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='log_b identifier id'>log_b</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
  <span class='estimated_scale identifier id'>estimated_scale</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='fixup identifier id'>fixup</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='begin begin kw'>begin</span>
    <span class='l identifier id'>l</span> <span class='assign token'>=</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='b identifier id'>b</span><span class='eq op'>==</span><span class='integer val'>10</span><span class='rparen token'>)</span> <span class='question op'>?</span> <span class='Math constant id'>Math</span><span class='dot token'>.</span><span class='log10 identifier id'>log10</span><span class='lparen token'>(</span><span class='v_flt identifier id'>v_flt</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='Math constant id'>Math</span><span class='dot token'>.</span><span class='log identifier id'>log</span><span class='lparen token'>(</span><span class='v_flt identifier id'>v_flt</span><span class='rparen token'>)</span><span class='mult op'>*</span><span class='log_b identifier id'>log_b</span><span class='rparen token'>)</span>
    <span class='estimated_scale identifier id'>estimated_scale</span> <span class='assign token'>=</span><span class='lparen token'>(</span><span class='l identifier id'>l</span> <span class='minus op'>-</span> <span class='float val'>1E-10</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='ceil identifier id'>ceil</span>
    <span class='fixup identifier id'>fixup</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
  <span class='rescue rescue kw'>rescue</span>
    <span class='comment val'># rescuing errors is more efficient than checking (v_abs &lt; Float::MAX.to_i) &amp;&amp; (v_flt &gt; Float::MIN) when v is a Flt</span>
  <span class='else else kw'>else</span>
    <span class='comment val'># estimated_scale = nil</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># 1.2. Use Flt::DecNum logarithm</span>
  <span class='if if kw'>if</span> <span class='estimated_scale identifier id'>estimated_scale</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='v identifier id'>v</span><span class='dot token'>.</span><span class='to_decimal_exact identifier id'>to_decimal_exact</span><span class='lparen token'>(</span><span class='symbol val'>:precision=</span><span class='gt op'>&gt;</span><span class='integer val'>12</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='v identifier id'>v</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='BinNum constant id'>BinNum</span><span class='rparen token'>)</span>
    <span class='if if kw'>if</span> <span class='v identifier id'>v</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='DecNum constant id'>DecNum</span><span class='rparen token'>)</span>
      <span class='l identifier id'>l</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
      <span class='DecNum constant id'>DecNum</span><span class='dot token'>.</span><span class='context identifier id'>context</span><span class='lparen token'>(</span><span class='symbol val'>:precision=</span><span class='gt op'>&gt;</span><span class='integer val'>12</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
        <span class='case case kw'>case</span> <span class='b identifier id'>b</span>
        <span class='when when kw'>when</span> <span class='integer val'>10</span>
          <span class='l identifier id'>l</span> <span class='assign token'>=</span> <span class='v_abs identifier id'>v_abs</span><span class='dot token'>.</span><span class='log10 identifier id'>log10</span>
        <span class='else else kw'>else</span>
          <span class='l identifier id'>l</span> <span class='assign token'>=</span> <span class='v_abs identifier id'>v_abs</span><span class='dot token'>.</span><span class='ln identifier id'>ln</span><span class='div op'>/</span><span class='Flt constant id'>Flt</span><span class='dot token'>.</span><span class='DecNum constant id'>DecNum</span><span class='lparen token'>(</span><span class='b identifier id'>b</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='ln identifier id'>ln</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
      <span class='l identifier id'>l</span> <span class='opasgn op'>-=</span> <span class='Flt constant id'>Flt</span><span class='dot token'>.</span><span class='DecNum constant id'>DecNum</span><span class='lparen token'>(</span><span class='integer val'>+1</span><span class='comma token'>,</span><span class='integer val'>1</span><span class='comma token'>,</span><span class='integer val'>-10</span><span class='rparen token'>)</span>
      <span class='estimated_scale identifier id'>estimated_scale</span> <span class='assign token'>=</span> <span class='l identifier id'>l</span><span class='dot token'>.</span><span class='ceil identifier id'>ceil</span>
      <span class='fixup identifier id'>fixup</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># 1.3 more rough Float aproximation</span>
    <span class='comment val'># TODO: optimize denominator, correct numerator for more precision with first digit or part</span>
    <span class='comment val'># of the coefficient (like _log_10_lb)</span>
  <span class='estimated_scale identifier id'>estimated_scale</span> <span class='opasgn op'>||=</span> <span class='lparen token'>(</span><span class='v identifier id'>v</span><span class='dot token'>.</span><span class='adjusted_exponent identifier id'>adjusted_exponent</span><span class='dot token'>.</span><span class='to_f identifier id'>to_f</span> <span class='mult op'>*</span> <span class='Math constant id'>Math</span><span class='dot token'>.</span><span class='log identifier id'>log</span><span class='lparen token'>(</span><span class='v identifier id'>v</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='context identifier id'>context</span><span class='dot token'>.</span><span class='radix identifier id'>radix</span><span class='rparen token'>)</span> <span class='mult op'>*</span> <span class='log_b identifier id'>log_b</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='ceil identifier id'>ceil</span>

  <span class='if if kw'>if</span> <span class='estimated_scale identifier id'>estimated_scale</span> <span class='geq op'>&gt;=</span> <span class='integer val'>0</span>
    <span class='@k ivar id'>@k</span> <span class='assign token'>=</span> <span class='estimated_scale identifier id'>estimated_scale</span>
    <span class='@s ivar id'>@s</span> <span class='opasgn op'>*=</span> <span class='output_b_power identifier id'>output_b_power</span><span class='lparen token'>(</span><span class='estimated_scale identifier id'>estimated_scale</span><span class='rparen token'>)</span>
  <span class='else else kw'>else</span>
    <span class='sc identifier id'>sc</span> <span class='assign token'>=</span> <span class='output_b_power identifier id'>output_b_power</span><span class='lparen token'>(</span><span class='minus op'>-</span><span class='estimated_scale identifier id'>estimated_scale</span><span class='rparen token'>)</span>
    <span class='@k ivar id'>@k</span> <span class='assign token'>=</span> <span class='estimated_scale identifier id'>estimated_scale</span>
    <span class='@r ivar id'>@r</span> <span class='opasgn op'>*=</span> <span class='sc identifier id'>sc</span>
    <span class='@m_p ivar id'>@m_p</span> <span class='opasgn op'>*=</span> <span class='sc identifier id'>sc</span>
    <span class='@m_m ivar id'>@m_m</span> <span class='opasgn op'>*=</span> <span class='sc identifier id'>sc</span>
  <span class='end end kw'>end</span>
  <span class='fixup identifier id'>fixup</span> <span class='integer val'>? </span><span class='scale_fixup! fid id'>scale_fixup!</span> <span class='colon op'>:</span> <span class='scale! fid id'>scale!</span>

<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>scale_original!</h3>
</div><div id="scale_original-21-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>scale_original!</span><span class='args'>(really = false)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Given r/s = v (number to convert to text), m_m/s = (v - v-)/s, m_p/s = (v<tt>
- v)/s Scale the fractions so that the first significant digit is right
after the radix point, i.e. find k = ceil(logB((r</tt>m_p)/s)), the smallest
integer such that (r+m_p)/s &lt;= B^k if k&gt;=0 return:
</p>
<pre class="code">
 <span class='r identifier id'>r</span><span class='assign token'>=</span><span class='r identifier id'>r</span><span class='comma token'>,</span> <span class='s identifier id'>s</span><span class='assign token'>=</span><span class='s identifier id'>s</span><span class='mult op'>*</span><span class='B constant id'>B</span><span class='bitxor op'>^</span><span class='k identifier id'>k</span><span class='comma token'>,</span> <span class='m_p identifier id'>m_p</span><span class='assign token'>=</span><span class='m_p identifier id'>m_p</span><span class='comma token'>,</span> <span class='m_m identifier id'>m_m</span><span class='assign token'>=</span><span class='m_m identifier id'>m_m</span>
</pre>
<p>
if k&lt;0 return:
</p>
<pre class="code">
 <span class='r identifier id'>r</span><span class='assign token'>=</span><span class='r identifier id'>r</span><span class='mult op'>*</span><span class='B constant id'>B</span><span class='bitxor op'>^</span><span class='k identifier id'>k</span><span class='comma token'>,</span> <span class='s identifier id'>s</span><span class='assign token'>=</span><span class='s identifier id'>s</span><span class='comma token'>,</span> <span class='m_p identifier id'>m_p</span><span class='assign token'>=</span><span class='m_p identifier id'>m_p</span><span class='mult op'>*</span><span class='B constant id'>B</span><span class='bitxor op'>^</span><span class='k identifier id'>k</span><span class='comma token'>,</span> <span class='m_m identifier id'>m_m</span><span class='assign token'>=</span><span class='m_m identifier id'>m_m</span><span class='mult op'>*</span><span class='B constant id'>B</span><span class='bitxor op'>^</span><span class='k identifier id'>k</span>
</pre>
<p>
scale! is a general iterative method using only (multiprecision) integer
arithmetic.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/flt/support.rb', line 1035</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/jgoizueta/flt/blob/74e2b0218d3b82b2bb954d8787e3d2beaf422338/lib/flt/support.rb#L1035">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='scale_original! fid id'>scale_original!</span><span class='lparen token'>(</span><span class='really identifier id'>really</span><span class='assign token'>=</span><span class='false false kw'>false</span><span class='rparen token'>)</span>
  <span class='loop identifier id'>loop</span> <span class='do do kw'>do</span>
    <span class='if if kw'>if</span> <span class='lparen token'>(</span><span class='@round_h ivar id'>@round_h</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='@r ivar id'>@r</span><span class='plus op'>+</span><span class='@m_p ivar id'>@m_p</span> <span class='geq op'>&gt;=</span> <span class='@s ivar id'>@s</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='@r ivar id'>@r</span><span class='plus op'>+</span><span class='@m_p ivar id'>@m_p</span> <span class='gt op'>&gt;</span> <span class='@s ivar id'>@s</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='comment val'># k is too low</span>
      <span class='@s ivar id'>@s</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>
      <span class='@k ivar id'>@k</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
    <span class='elsif elsif kw'>elsif</span> <span class='lparen token'>(</span><span class='@round_h ivar id'>@round_h</span> <span class='question op'>?</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='@r ivar id'>@r</span><span class='plus op'>+</span><span class='@m_p ivar id'>@m_p</span><span class='rparen token'>)</span><span class='mult op'>*</span><span class='@output_b ivar id'>@output_b</span><span class='lt op'>&lt;</span><span class='@s ivar id'>@s</span><span class='rparen token'>)</span> <span class='colon op'>:</span> <span class='lparen token'>(</span><span class='lparen token'>(</span><span class='@r ivar id'>@r</span><span class='plus op'>+</span><span class='@m_p ivar id'>@m_p</span><span class='rparen token'>)</span><span class='mult op'>*</span><span class='@output_b ivar id'>@output_b</span><span class='leq op'>&lt;=</span><span class='@s ivar id'>@s</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='comment val'># k is too high</span>
      <span class='@r ivar id'>@r</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>
      <span class='@m_p ivar id'>@m_p</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>
      <span class='@m_m ivar id'>@m_m</span> <span class='opasgn op'>*=</span> <span class='@output_b ivar id'>@output_b</span>
      <span class='@k ivar id'>@k</span> <span class='opasgn op'>-=</span> <span class='integer val'>1</span>
    <span class='else else kw'>else</span>
      <span class='break break kw'>break</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> 2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
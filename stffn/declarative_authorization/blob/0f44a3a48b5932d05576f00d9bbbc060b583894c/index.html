<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>stffn's declarative_authorization - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/stffn/commits/declarative_authorization/master" rel="alternate" title="Recent Commits to declarative_authorization:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("stffn", "declarative_authorization", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='stffn/declarative_authorization/blob/0f44a3a48b5932d05576f00d9bbbc060b583894c' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='stffn/declarative_authorization/blob/0f44a3a48b5932d05576f00d9bbbc060b583894c' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("stffn", "declarative_authorization", "0f44a3a48b5932d05576f00d9bbbc060b583894c", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/stffn/declarative_authorization/tree/">Source</a></li>
            <li class=""><a href="http://github.com/stffn/declarative_authorization/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/stffn/declarative_authorization/network">Network</a></li>            
            <li class=""><a href="http://github.com/stffn/declarative_authorization/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/stffn/declarative_authorization">Wiki</a></li>
            <li class=""><a href="http://github.com/stffn/declarative_authorization/graphs">Graphs</a></li>                    
            <li class="active"><a href="/stffn/declarative_authorization">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/stffn">stffn</a> / <b><a href="http://github.com/stffn/declarative_authorization/tree">declarative_authorization</a></b>        
                <a id="namespaces_button" rel="stffn/declarative_authorization/blob/0f44a3a48b5932d05576f00d9bbbc060b583894c" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="stffn/declarative_authorization/blob/0f44a3a48b5932d05576f00d9bbbc060b583894c" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>Declarative Authorization</h1>
<p>
The declarative authorization plugin offers an authorization mechanism
inspired by <em>RBAC</em>. The most notable distinction to existing
authorization plugins is the declarative authorization approach. That is,
authorization rules are not programmatically in between business logic but
in an authorization configuration.
</p>
<p>
Currently, Rails authorization plugins only provide for programmatic
authorization rules. That is, the developer needs to specify which roles
are allowed to access a specific controller action or a part of a view,
which is not DRY. With a growing application code base and functions, as it
happens especially in agile development processes, it may be decided to
introduce new roles. Then, at several places of the source code the new
group needs to be added, possibly leading to omissions and thus hard to
test errors. Another aspect are changing authorization requirements in
development or even after taking the application into production. Then,
privileges of certain roles need to be easily adjusted when the original
assumptions concerning access control prove unrealistic. In these
situations, a declarative approach as offered by this plugin increases the
development and maintenance efficiency.
</p>
<p>
Plugin features
</p>
<ul>
<li>Authorization at controller action level

</li>
<li>Authorization helpers for Views

</li>
<li>Authorization at model level

<ul>
<li>Authorize CRUD (Create, Read, Update, Delete) activities

</li>
<li>Query rewriting to automatically only fetch authorized records

</li>
</ul>
</li>
<li>DSL for specifying Authorization rules in an authorization configuration

</li>
</ul>
<p>
Requirements
</p>
<ul>
<li>An authentication mechanism

<ul>
<li>User object in Controller#current_user

</li>
<li>(For model security) Setting Authorization.current_user

</li>
</ul>
</li>
<li>User objects need to respond to a method :role_symbols that returns an
array of role symbols

</li>
</ul>
<p>
See below for installation instructions.
</p>
<h1>Authorization Data Model</h1>
<pre class="code">
 <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span> <span class='App constant id'>App</span> <span class='domain identifier id'>domain</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='bitor op'>|</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span> <span class='Authorization constant id'>Authorization</span> <span class='conf identifier id'>conf</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='bitor op'>|</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span> <span class='App constant id'>App</span> <span class='domain identifier id'>domain</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>

                       <span class='includes identifier id'>includes</span>                   <span class='includes identifier id'>includes</span>
                        <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>                        <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>
                        <span class='bitor op'>|</span>  <span class='v identifier id'>v</span>                        <span class='bitor op'>|</span>   <span class='v identifier id'>v</span>
  <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>  <span class='can_play identifier id'>can_play</span>  <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>  <span class='has_permission identifier id'>has_permission</span>  <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>  <span class='requires identifier id'>requires</span>  <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>
  <span class='bitor op'>|</span> <span class='User constant id'>User</span> <span class='bitor op'>|</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='gt op'>&gt;</span><span class='bitor op'>|</span> <span class='Role constant id'>Role</span> <span class='bitor op'>|</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='gt op'>&gt;</span><span class='bitor op'>|</span> <span class='Permission constant id'>Permission</span> <span class='bitor op'>|</span><span class='lt op'>&lt;</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='bitor op'>|</span> <span class='Activity constant id'>Activity</span> <span class='bitor op'>|</span>
  <span class='string val'>'------'</span> <span class='mult op'>*</span>        <span class='mult op'>*</span> <span class='string val'>'------'</span> <span class='mult op'>*</span>              <span class='mult op'>*</span> <span class='string val'>'------------'</span> <span class='integer val'>1</span>        <span class='mult op'>*</span> <span class='string val'>'----------'</span>
                                                      <span class='bitor op'>|</span>
                                              <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='plus op'>+</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>
                                           <span class='integer val'>1</span> <span class='div op'>/</span>        <span class='bitor op'>|</span> <span class='integer val'>1</span>     \ <span class='mult op'>*</span>
                                 <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>   <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>  <span class='dot token'>.</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='dot token'>.</span>
                                 <span class='bitor op'>|</span> <span class='Privilege constant id'>Privilege</span> <span class='bitor op'>|</span>   <span class='bitor op'>|</span> <span class='Context constant id'>Context</span> <span class='bitor op'>|</span>  <span class='bitor op'>|</span> <span class='Attribute constant id'>Attribute</span> <span class='bitor op'>|</span>
                                 <span class='string val'>'-----------'</span>   <span class='string val'>'---------'</span>  <span class='string val'>'-----------'</span>
</pre>
<p>
In the application domain, each <b>User</b> may be assigned to <b>Roles</b>
that should define the users&#8217; job in the application, such as
<em>Administrator</em>. On the right-hand side of this diagram, application
developers specify which <b>Permissions</b> are necessary for users to
perform activities, such as calling a controller action, viewing parts of a
View or acting on records in the database. Note that Permissions consist of
an <b>Privilege</b> that is to be performed, such as <em>read</em>, and a
<b>Context</b> in that the Operation takes place, such as
<em>companies</em>.
</p>
<p>
In the authorization configuration, Permissions are assigned to Roles and
Role and Permission hierarchies are defined. <b>Attributes</b> may be
employed to allow authorization according to dynamic information about the
context and the current user, e.g. &quot;only allow access on employees
that belong to the current user&#8217;s branch.&quot;
</p>
<h1>Examples</h1>
<p>
A fully functional example application can be found at
http://github.com/stffn/decl_auth_demo_app
</p>
<p>
Details on the demonstrated methods can be found in the API docs, either
generated yourself or at
http://www.tzi.org/~sbartsch/declarative_authorization
</p>
<h2>Controller</h2>
<p>
If authentication is in place, enabling user-specific access control may be
as simple as one call to filter_access_to :all which simply requires the
according privileges for present actions. E.g. the privilege index_users is
required for action index. This works as a first default configuration for
RESTful controllers, with these privileges easily handled in the
authorization configuration, which will be described below.
</p>
<pre class="code">
    <span class='class class kw'>class</span> <span class='EmployeesController constant id'>EmployeesController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span>
      <span class='filter_access_to identifier id'>filter_access_to</span> <span class='symbol val'>:all</span>
      <span class='def def kw'>def</span> <span class='index identifier id'>index</span>
        <span class='dot3 op'>...</span>
      <span class='end end kw'>end</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
</pre>
<p>
When custom actions are added to such a controller, it helps to define more
clearly which privileges are the respective requirements. That is when the
filter_access_to call may become more verbose:
</p>
<pre class="code">
    <span class='class class kw'>class</span> <span class='EmployeesController constant id'>EmployeesController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span>
      <span class='filter_access_to identifier id'>filter_access_to</span> <span class='symbol val'>:all</span>
      <span class='comment val'># this one would be included in :all, but :read seems to be</span>
      <span class='comment val'># a more suitable privilege than :auto_complete_for_user_name</span>
      <span class='filter_access_to identifier id'>filter_access_to</span> <span class='symbol val'>:auto_complete_for_employee_name</span><span class='comma token'>,</span> <span class='symbol val'>:require</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:read</span>
      <span class='def def kw'>def</span> <span class='auto_complete_for_employee_name identifier id'>auto_complete_for_employee_name</span>
        <span class='dot3 op'>...</span>
      <span class='end end kw'>end</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
</pre>
<p>
For some actions it might be necessary to check certain attributes of the
object the action is to be acting on. Then, the object needs to be loaded
before the action&#8217;s access control is evaluated. On the other hand,
some actions might prefer the authorization to ignore specific attribute
checks as the object is unknown at checking time, so attribute checks and
thus automatic loading of objects needs to be enabled explicitly.
</p>
<pre class="code">
    <span class='class class kw'>class</span> <span class='EmployeesController constant id'>EmployeesController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span>
      <span class='filter_access_to identifier id'>filter_access_to</span> <span class='symbol val'>:update</span><span class='comma token'>,</span> <span class='symbol val'>:attribute_check</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>
      <span class='def def kw'>def</span> <span class='update identifier id'>update</span>
        <span class='comment val'># @employee is already loaded from param[:id] because of :attribute_check</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
</pre>
<p>
You can provide the needed object through before_filters. This way, you
have full control over the object that the conditions are checked against.
Just make sure, your before_filters occur before any of the
filter_access_to calls.
</p>
<pre class="code">
    <span class='class class kw'>class</span> <span class='EmployeesController constant id'>EmployeesController</span> <span class='lt op'>&lt;</span> <span class='ApplicationController constant id'>ApplicationController</span>
      <span class='before_filter identifier id'>before_filter</span> <span class='symbol val'>:new_employee_from_params</span><span class='comma token'>,</span> <span class='symbol val'>:only</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:create</span>
      <span class='before_filter identifier id'>before_filter</span> <span class='symbol val'>:new_employee</span><span class='comma token'>,</span> <span class='symbol val'>:only</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:index</span><span class='comma token'>,</span> <span class='symbol val'>:new</span><span class='rbrack token'>]</span>
      <span class='filter_access_to identifier id'>filter_access_to</span> <span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:attribute_check</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='true true kw'>true</span>

      <span class='def def kw'>def</span> <span class='create identifier id'>create</span>
        <span class='@employee ivar id'>@employee</span><span class='dot token'>.</span><span class='save! fid id'>save!</span>
      <span class='end end kw'>end</span>

      <span class='protected identifier id'>protected</span>
      <span class='def def kw'>def</span> <span class='new_employee_from_params identifier id'>new_employee_from_params</span>
        <span class='@employee ivar id'>@employee</span> <span class='assign token'>=</span> <span class='Employee constant id'>Employee</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:employee</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
</pre>
<p>
If the access is denied, a <tt>permission_denied</tt> method is called on
the current_controller, if defined, and the issue is logged. For further
customization of the filters and object loading, have a look at the
complete API documentation of filter_access_to in
Authorization::AuthorizationInController::ClassMethods.
</p>
<h2>Views</h2>
<p>
In views, a simple permitted_to? helper makes showing blocks according to
the current user&#8217;s privileges easy:
</p>
<pre class="code">
    <span class='lt op'>&lt;</span><span class='string val'>% permitted_to? </span><span class='symbol val'>:create</span><span class='comma token'>,</span> <span class='symbol val'>:employees</span> <span class='do do kw'>do</span> <span class='string val'>%&gt;
    &lt;%= link_to 'New', new_employee_path %&gt;</span>
    <span class='lt op'>&lt;</span><span class='string val'>% end </span><span class='mod op'>%</span><span class='gt op'>&gt;</span>
</pre>
<p>
Only giving a symbol :employees as context prevents any checks of
attributes as there is no object to check against. For example, in case of
nested resources a new object may come in handy:
</p>
<pre class="code">
    <span class='lt op'>&lt;</span><span class='string val'>% permitted_to? </span><span class='symbol val'>:create</span><span class='comma token'>,</span> <span class='Branch constant id'>Branch</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='symbol val'>:company</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@company ivar id'>@company</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
            <span class='comment val'># or @company.branches.new</span>
            <span class='comment val'># or even @company.branches %&gt;</span>
    <span class='lt op'>&lt;</span><span class='string val'>%= link_to 'New', new_company_branch_path(@company) %&gt;
    &lt;% end %&gt;
</span></pre>
<p>
Lists are straight-forward:
</p>
<pre class="code">
    <span class='lt op'>&lt;</span><span class='string val'>% for </span><span class='employee identifier id'>employee</span> <span class='in in kw'>in</span> <span class='@employees ivar id'>@employees</span> <span class='mod op'>%</span><span class='gt op'>&gt;</span>
    <span class='lt op'>&lt;</span><span class='string val'>%= link_to 'Edit', edit_employee_path(employee) if permitted_to? :update, employee %&gt;
    &lt;% end %&gt;
</span></pre>
<p>
See also Authorization::AuthorizationHelper.
</p>
<h2>Models</h2>
<p>
There are two destinct features for model security built into this plugin:
authorizing CRUD operations on objects as well as query rewriting to limit
results according to certain privileges.
</p>
<p>
See also Authorization::AuthorizationInModel.
</p>
<h3>Model security for CRUD opterations</h3>
<p>
To activate model security, all it takes is an explicit enabling for each
model that model security should be enforced on, i.e.
</p>
<pre class="code">
    <span class='class class kw'>class</span> <span class='Employee constant id'>Employee</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
      <span class='using_access_control identifier id'>using_access_control</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
</pre>
<p>
Thus,
</p>
<pre class="code">
    <span class='Employee constant id'>Employee</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='dot3 op'>...</span><span class='rparen token'>)</span>
</pre>
<p>
fails, if the current user is not allowed to :create :employees according
to the authorization rules. For the application to find out about what
happened if an operation is denied, the filters throw
Authorization::NotAuthorized exceptions.
</p>
<p>
As access control on read are costly, with possibly lots of objects being
loaded at a time in one query, checks on read need to be actived explicitly
by adding the :include_read option.
</p>
<h3>Query rewriting using named scopes</h3>
<p>
When retrieving large sets of records from databases, any authorization
needs to be integrated into the query in order to prevent inefficient
filtering afterwards and to use LIMIT and OFFSET in SQL statements. To keep
authorization rules out of the source code, this plugin offers query
rewriting mechanisms through named scopes. Thus,
</p>
<pre class="code">
    <span class='Employee constant id'>Employee</span><span class='dot token'>.</span><span class='with_permissions_to identifier id'>with_permissions_to</span><span class='lparen token'>(</span><span class='symbol val'>:read</span><span class='rparen token'>)</span>
</pre>
<p>
returns all employee records that the current user is authorized to read.
In addition, just like normal named scopes, query rewriting may be chained
with the usual find method:
</p>
<pre class="code">
    <span class='Employee constant id'>Employee</span><span class='dot token'>.</span><span class='with_permissions_to identifier id'>with_permissions_to</span><span class='lparen token'>(</span><span class='symbol val'>:read</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dot3 op'>...</span><span class='rparen token'>)</span>
</pre>
<p>
If the current user is completely missing the permissions, an
Authorization::NotAuthorized exception is raised. Through
Model.obligation_conditions, application developers may retrieve the
conditions for manual rewrites.
</p>
<h2>Authorization Rules</h2>
<p>
Authorization rules are defined in config/authorization_rules.rb. E.g.
</p>
<pre class="code">
    <span class='authorization identifier id'>authorization</span> <span class='do do kw'>do</span>
      <span class='role identifier id'>role</span> <span class='symbol val'>:admin</span> <span class='do do kw'>do</span>
        <span class='has_permission_on identifier id'>has_permission_on</span> <span class='symbol val'>:employees</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='symbol val'>:create</span><span class='comma token'>,</span> <span class='symbol val'>:read</span><span class='comma token'>,</span> <span class='symbol val'>:update</span><span class='comma token'>,</span> <span class='symbol val'>:delete</span><span class='rbrack token'>]</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
</pre>
<p>
There is a default role :<tt>guest</tt> that is used if a request is not
associated with any user or with a user without any roles. So, if your
application has public pages, :<tt>guest</tt> can be used to allow access
for users that are not logged in. All other roles are application defined
and need to be associated with users by the application.
</p>
<p>
Privileges, such as :create, may be put into hierarchies to simplify
maintenance. So the example above has the same meaning as
</p>
<pre class="code">
    <span class='authorization identifier id'>authorization</span> <span class='do do kw'>do</span>
      <span class='role identifier id'>role</span> <span class='symbol val'>:admin</span> <span class='do do kw'>do</span>
        <span class='has_permission_on identifier id'>has_permission_on</span> <span class='symbol val'>:employees</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:manage</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='privileges identifier id'>privileges</span> <span class='do do kw'>do</span>
      <span class='privilege identifier id'>privilege</span> <span class='symbol val'>:manage</span> <span class='do do kw'>do</span>
        <span class='includes identifier id'>includes</span> <span class='symbol val'>:create</span><span class='comma token'>,</span> <span class='symbol val'>:read</span><span class='comma token'>,</span> <span class='symbol val'>:update</span><span class='comma token'>,</span> <span class='symbol val'>:delete</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
</pre>
<p>
Privilege hierarchies may be context-specific, e.g. applicable to
:employees.
</p>
<pre class="code">
    <span class='privileges identifier id'>privileges</span> <span class='do do kw'>do</span>
      <span class='privilege identifier id'>privilege</span> <span class='symbol val'>:manage</span><span class='comma token'>,</span> <span class='symbol val'>:employees</span><span class='comma token'>,</span> <span class='symbol val'>:includes</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:increase_salary</span>
    <span class='end end kw'>end</span>
</pre>
<p>
For more complex use cases, authorizations need to be based on attributes.
E.g. if a branch admin should manage only employees of his branch (see
Authorization::Reader in the API docs for a full list of available
operators):
</p>
<pre class="code">
    <span class='authorization identifier id'>authorization</span> <span class='do do kw'>do</span>
      <span class='role identifier id'>role</span> <span class='symbol val'>:branch_admin</span> <span class='do do kw'>do</span>
        <span class='has_permission_on identifier id'>has_permission_on</span> <span class='symbol val'>:employees</span> <span class='do do kw'>do</span>
          <span class='to identifier id'>to</span> <span class='symbol val'>:manage</span>
          <span class='comment val'># user refers to the current_user when evaluating</span>
          <span class='if_attribute identifier id'>if_attribute</span> <span class='symbol val'>:branch</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='is identifier id'>is</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='user identifier id'>user</span><span class='dot token'>.</span><span class='branch identifier id'>branch</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;
        end
      end
    end
</span></pre>
<p>
To reduce redundancy in has_permission_on blocks, a rule may depend on
permissions on associated objects:
</p>
<pre class="code">
    <span class='authorization identifier id'>authorization</span> <span class='do do kw'>do</span>
      <span class='role identifier id'>role</span> <span class='symbol val'>:branch_admin</span> <span class='do do kw'>do</span>
        <span class='has_permission_on identifier id'>has_permission_on</span> <span class='symbol val'>:branches</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:manage</span> <span class='do do kw'>do</span>
          <span class='if_attribute identifier id'>if_attribute</span> <span class='symbol val'>:managers</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='contains identifier id'>contains</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='user identifier id'>user</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;
        end

        has_permission_on :employees, :to =&gt; :manage do
          if_permitted_to :manage, :branch
          # instead of
          #if_attribute :branch =&gt; &lt;tt&gt;=&amp;gt; contains {user&lt;/</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='rbrace token'>}</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
</pre>
<p>
Lastly, not only privileges may be organized in a hierarchy but roles as
well. Here, project manager inherit the permissions of employees.
</p>
<pre class="code">
      <span class='role identifier id'>role</span> <span class='symbol val'>:project_manager</span> <span class='do do kw'>do</span>
        <span class='includes identifier id'>includes</span> <span class='symbol val'>:employee</span>
      <span class='end end kw'>end</span>
</pre>
<p>
See also Authorization::Reader.
</p>
<h2>Testing</h2>
<p>
declarative_authorization provides a few helpers to ease the testing with
authorization in mind.
</p>
<p>
In your test_helper.rb, to enable the helpers add
</p>
<pre class="code">
    <span class='require identifier id'>require</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='expand_path identifier id'>expand_path</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='__FILE__ __file__ kw'>__FILE__</span><span class='rparen token'>)</span> <span class='plus op'>+</span>
        <span class='string val'>&quot;/../vendor/plugins/declarative_authorization/lib/maintenance&quot;</span><span class='rparen token'>)</span>

    <span class='class class kw'>class</span> <span class='Test constant id'>Test</span><span class='colon2 op'>::</span><span class='Unit constant id'>Unit</span><span class='colon2 op'>::</span><span class='TestCase constant id'>TestCase</span>
      <span class='include identifier id'>include</span> <span class='Authorization constant id'>Authorization</span><span class='colon2 op'>::</span><span class='TestHelper constant id'>TestHelper</span>
      <span class='dot3 op'>...</span>
    <span class='end end kw'>end</span>
</pre>
<p>
Now, in unit tests, you may deactivate authorization if needed e.g. for
test setup and assume certain identities for tests:
</p>
<pre class="code">
    <span class='class class kw'>class</span> <span class='EmployeeTest constant id'>EmployeeTest</span> <span class='lt op'>&lt;</span> <span class='ActiveSupport constant id'>ActiveSupport</span><span class='colon2 op'>::</span><span class='TestCase constant id'>TestCase</span>
      <span class='def def kw'>def</span> <span class='test_should_read identifier id'>test_should_read</span>
        <span class='without_access_control identifier id'>without_access_control</span> <span class='do do kw'>do</span>
          <span class='Employee constant id'>Employee</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='dot3 op'>...</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>
        <span class='assert_nothing_raised identifier id'>assert_nothing_raised</span> <span class='do do kw'>do</span>
          <span class='with_user identifier id'>with_user</span><span class='lparen token'>(</span><span class='admin identifier id'>admin</span><span class='rparen token'>)</span> <span class='do do kw'>do</span>
            <span class='Employee constant id'>Employee</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:first</span><span class='rparen token'>)</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
</pre>
<p>
In functional tests, get, posts, etc. may be tested in the name of certain
users:
</p>
<pre class="code">
    <span class='get_with identifier id'>get_with</span> <span class='admin identifier id'>admin</span><span class='comma token'>,</span> <span class='symbol val'>:index</span>
    <span class='post_with identifier id'>post_with</span> <span class='admin identifier id'>admin</span><span class='comma token'>,</span> <span class='symbol val'>:update</span><span class='comma token'>,</span> <span class='symbol val'>:employee</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='dot3 op'>...</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;
</span></pre>
<p>
See Authorization::TestHelper for more information.
</p>
<h1>Installation of declarative_authorization</h1>
<p>
One of three options to install the plugin:
</p>
<ul>
<li>Install by Gem: Add to your environment.rb in the initializer block:

<pre class="code">
  <span class='config identifier id'>config</span><span class='dot token'>.</span><span class='gem identifier id'>gem</span> <span class='string val'>&quot;stffn-declarative_authorization&quot;</span><span class='comma token'>,</span> <span class='symbol val'>:lib</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;declarative_authorization&quot;</span>
</pre>
<p>
And call from your application&#8217;s root directory
</p>
<pre class="code">
  <span class='rake identifier id'>rake</span> <span class='gems identifier id'>gems</span><span class='symbol val'>:install</span>
</pre>
</li>
<li>Alternatively, to install from github, execute in your application&#8217;s
root directory

<pre class="code">
  <span class='cd identifier id'>cd</span> <span class='vendor identifier id'>vendor</span><span class='div op'>/</span><span class='plugins identifier id'>plugins</span> <span class='andop op'>&amp;&amp;</span> <span class='git identifier id'>git</span> <span class='clone identifier id'>clone</span> <span class='git identifier id'>git</span><span class='symbol val'>:/</span><span class='regexp val'>/github.com/s</span><span class='tffn identifier id'>tffn</span><span class='div op'>/</span><span class='declarative_authorization identifier id'>declarative_authorization</span><span class='dot token'>.</span><span class='git identifier id'>git</span>
</pre>
</li>
<li>Or, download one of the released versions from Github at
http://github.com/stffn/declarative_authorization/downloads

</li>
</ul>
<p>
Then,
</p>
<ul>
<li>provide the requirements as noted below,

</li>
<li>create a basic config/authorization_rules.rb--you might want to take
the provided example authorization_rules.dist.rb in the plugin root as a
starting point,

</li>
<li>add <tt>filter_access_to</tt>, <tt>permitted_to</tt>? and model security as
needed.

</li>
</ul>
<h2>Providing the Plugin&#8217;s Requirements</h2>
<p>
The requirements are
</p>
<ul>
<li>Rails &gt;= 2.1 and Ruby &gt;= 1.8.6, including 1.9

</li>
<li>An authentication mechanism

</li>
<li>A user object returned by Controller#current_user

</li>
<li>An array of role symbols returned by User#role_symbols

</li>
<li>(For model security) Setting Authorization.current_user to the
request&#8217;s user

</li>
</ul>
<p>
Of the various ways to provide these requirements, here is one way
employing restful_authentication.
</p>
<ul>
<li>Install restful_authentication

<pre class="code">
 <span class='cd identifier id'>cd</span> <span class='vendor identifier id'>vendor</span><span class='div op'>/</span><span class='plugins identifier id'>plugins</span> <span class='andop op'>&amp;&amp;</span> <span class='git identifier id'>git</span> <span class='clone identifier id'>clone</span> <span class='git identifier id'>git</span><span class='symbol val'>:/</span><span class='regexp val'>/github.com/</span><span class='technoweenie identifier id'>technoweenie</span><span class='div op'>/</span><span class='restful identifier id'>restful</span><span class='minus op'>-</span><span class='authentication identifier id'>authentication</span><span class='dot token'>.</span><span class='git identifier id'>git</span> <span class='restful_authentication identifier id'>restful_authentication</span>
 <span class='cd identifier id'>cd</span> <span class='dot2 op'>..</span><span class='regexp val'>/.. &amp;&amp; ruby script/</span><span class='generate identifier id'>generate</span> <span class='authenticated identifier id'>authenticated</span> <span class='user identifier id'>user</span> <span class='sessions identifier id'>sessions</span>
</pre>
</li>
<li>Move &quot;include AuthenticatedSystem&quot; to ApplicationController

</li>
<li>Add <tt>filter_access_to</tt> calls as described above.

</li>
<li>If you&#8217;d like to use model security, add a before_filter that sets
the user globally to your ApplicationController. This is thread-safe.

<pre class="code">
 <span class='before_filter identifier id'>before_filter</span> <span class='symbol val'>:set_current_user</span>
 <span class='protected identifier id'>protected</span>
 <span class='def def kw'>def</span> <span class='set_current_user identifier id'>set_current_user</span>
   <span class='Authorization constant id'>Authorization</span><span class='dot token'>.</span><span class='current_user identifier id'>current_user</span> <span class='assign token'>=</span> <span class='current_user identifier id'>current_user</span>
 <span class='end end kw'>end</span>
</pre>
</li>
<li>Add roles field to the User model through a :<tt>has_many</tt> association
(this is just one possible approach; you could just as easily use
:<tt>has_many</tt> :<tt>through</tt> or a serialized roles array):

<ul>
<li>create a migration for table roles

<pre class="code">
 <span class='class class kw'>class</span> <span class='CreateRoles constant id'>CreateRoles</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Migration constant id'>Migration</span>
   <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='up identifier id'>up</span>
     <span class='create_table identifier id'>create_table</span> <span class='string val'>&quot;roles&quot;</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='t identifier id'>t</span><span class='bitor op'>|</span>
       <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='column identifier id'>column</span> <span class='symbol val'>:title</span><span class='comma token'>,</span> <span class='symbol val'>:string</span>
       <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='references identifier id'>references</span> <span class='symbol val'>:user</span>
     <span class='end end kw'>end</span>
   <span class='end end kw'>end</span>

   <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='down identifier id'>down</span>
     <span class='drop_table identifier id'>drop_table</span> <span class='string val'>&quot;roles&quot;</span>
   <span class='end end kw'>end</span>
 <span class='end end kw'>end</span>
</pre>
</li>
<li>create a model Role,

<pre class="code">
 <span class='class class kw'>class</span> <span class='Role constant id'>Role</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
   <span class='belongs_to identifier id'>belongs_to</span> <span class='symbol val'>:user</span>
 <span class='end end kw'>end</span>
</pre>
</li>
<li>add <tt>has_many</tt> :<tt>roles</tt> to the User model and a roles method
that returns the roles as an Array of Symbols, e.g.

<pre class="code">
 <span class='class class kw'>class</span> <span class='User constant id'>User</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
   <span class='has_many identifier id'>has_many</span> <span class='symbol val'>:roles</span>
   <span class='def def kw'>def</span> <span class='role_symbols identifier id'>role_symbols</span>
     <span class='lparen token'>(</span><span class='roles identifier id'>roles</span> <span class='orop op'>||</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='r identifier id'>r</span><span class='dot token'>.</span><span class='title identifier id'>title</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span><span class='lt op'>&lt;</span><span class='regexp val'>/tt&gt;
   end
 end
</span></pre>
</li>
<li>add roles to your User objects using e.g.

<pre class="code">
 <span class='user identifier id'>user</span><span class='dot token'>.</span><span class='roles identifier id'>roles</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:title</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;admin&quot;</span><span class='rparen token'>)</span>
</pre>
</li>
</ul>
</li>
</ul>
<p>
Note: If you choose to generate an Account model for restful_authentication
instead of a User model as described above, you have to customize the
examples and create a ApplicationController#current_user method.
</p>
<h2>Debugging Authorization</h2>
<p>
Currently, the main means of debugging authorization decisions is logging
and exceptions. Denied access to actions is logged to <tt>warn</tt> or
<tt>info</tt>, including some hints about what went wrong.
</p>
<p>
All bang methods throw exceptions which may be used to retrieve more
information about a denied access than a Boolean value.
</p>
<h2>Authorization Browser</h2>
<p>
If your authorization rules become more complex, you might be glad to use
the authorization rules browser that comes with declarative_authorization.
It has a syntax-highlighted and a graphical view with filtering of the
current authorization rules.
</p>
<p>
By default, it will only be available in development mode. To use it, add
the following lines to your authorization_rules.rb for the appropriate
role:
</p>
<pre class="code">
  <span class='has_permission_on identifier id'>has_permission_on</span> <span class='symbol val'>:authorization_rules</span><span class='comma token'>,</span> <span class='symbol val'>:to</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:read</span>
</pre>
<p>
Then, point your browser to
</p>
<pre class="code">
  <span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/localhost/</span><span class='authorization_rules identifier id'>authorization_rules</span>
</pre>
<p>
The browser needs Rails 2.3 (for Engine support). The graphical view
requires Graphviz (which e.g. can be installed through the graphviz package
under Debian and Ubuntu) and has only been tested under Linux.
</p>
<h1>Help and Contact</h1>
<p>
We have an issue
tracker[http://stffn.lighthouseapp.com/projects/20733-declarative_authorization]
for bugs and feature requests as well as a Google
Group[http://groups.google.com/group/declarative_authorization] for
discussions on the usage of the plugin. You are very welcome to contribute.
Just fork the git repository and create a new issue, send a pull request or
contact me personally.
</p>
<p>
Maintained by
</p>
<p>
Steffen Bartsch TZI, Universität Bremen, Germany sbartsch at tzi.org
</p>
<h1>Contributors</h1>
<p>
Thanks to
</p>
<ul>
<li>Erik Dahlstrand

</li>
<li>Jeremy Friesen

</li>
<li>Brian Langenfeld

</li>
<li>Geoff Longman

</li>
<li>Mark Mansour

</li>
<li>Mike Vincent

</li>
</ul>
<h1>Licence</h1>
<p>
Copyright &#169; 2008 Steffen Bartsch, TZI, Universität Bremen, Germany
released under the MIT license
</p>

</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
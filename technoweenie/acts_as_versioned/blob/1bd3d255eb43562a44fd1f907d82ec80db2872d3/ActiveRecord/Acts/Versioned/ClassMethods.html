<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>technoweenie's acts_as_versioned - Module: ActiveRecord::Acts::Versioned::ClassMethods - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/technoweenie/commits/acts_as_versioned/master" rel="alternate" title="Recent Commits to acts_as_versioned:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../../../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("technoweenie", "acts_as_versioned", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='technoweenie/acts_as_versioned/blob/1bd3d255eb43562a44fd1f907d82ec80db2872d3' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='technoweenie/acts_as_versioned/blob/1bd3d255eb43562a44fd1f907d82ec80db2872d3' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("technoweenie", "acts_as_versioned", "1bd3d255eb43562a44fd1f907d82ec80db2872d3", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../../../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/technoweenie/acts_as_versioned/tree/">Source</a></li>
            <li class=""><a href="http://github.com/technoweenie/acts_as_versioned/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/technoweenie/acts_as_versioned/network">Network</a></li>            
            <li class=""><a href="http://github.com/technoweenie/acts_as_versioned/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/technoweenie/acts_as_versioned">Wiki</a></li>
            <li class=""><a href="http://github.com/technoweenie/acts_as_versioned/graphs">Graphs</a></li>                    
            <li class="active"><a href="/technoweenie/acts_as_versioned">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/technoweenie">technoweenie</a> / <b><a href="http://github.com/technoweenie/acts_as_versioned/tree">acts_as_versioned</a></b>        
                <a id="namespaces_button" rel="technoweenie/acts_as_versioned/blob/1bd3d255eb43562a44fd1f907d82ec80db2872d3" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="technoweenie/acts_as_versioned/blob/1bd3d255eb43562a44fd1f907d82ec80db2872d3" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section module ActiveRecord_Acts_Versioned_ClassMethods">
  <h1>Module: ActiveRecord::Acts::Versioned::ClassMethods</h1>
  <div class="section constants">
  
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#acts_as_versioned-instance_method">#acts_as_versioned</span><span class='args'>(options = {}, &amp;extension)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <h2>Configuration options.</h2>

        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>acts_as_versioned</h3>
</div><div id="acts_as_versioned-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>acts_as_versioned</span><span class='args'>(options = {}, &amp;extension)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <h2>Configuration options</h2>
<ul>
<li><tt>class_name</tt> - versioned model class name (default: PageVersion in
the above example)

</li>
<li><tt>table_name</tt> - versioned model table name (default: page_versions in
the above example)

</li>
<li><tt>foreign_key</tt> - foreign key used to relate the versioned model to
the original model (default: page_id in the above example)

</li>
<li><tt>inheritance_column</tt> - name of the column to save the model&#8217;s
inheritance_column value for STI. (default: versioned_type)

</li>
<li><tt>version_column</tt> - name of the column in the model that keeps the
version number (default: version)

</li>
<li><tt>sequence_name</tt> - name of the custom sequence to be used by the
versioned model.

</li>
<li><tt>limit</tt> - number of revisions to keep, defaults to unlimited

</li>
<li><tt>if</tt> - symbol of method to check before saving a new version. If
this method returns false, a new version is not saved. For finer control,
pass either a Proc or modify Model#version_condition_met?

<pre class="code">
  <span class='acts_as_versioned identifier id'>acts_as_versioned</span> <span class='symbol val'>:if</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='Proc constant id'>Proc</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='auction identifier id'>auction</span><span class='bitor op'>|</span> <span class='notop op'>!</span><span class='auction identifier id'>auction</span><span class='dot token'>.</span><span class='expired? fid id'>expired?</span> <span class='rbrace token'>}</span>
</pre>
<p>
or&#8230;
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Auction constant id'>Auction</span>
    <span class='def def kw'>def</span> <span class='version_condition_met? fid id'>version_condition_met?</span> <span class='comment val'># totally bypasses the &lt;tt&gt;:if&lt;/tt&gt; option</span>
      <span class='notop op'>!</span><span class='expired? fid id'>expired?</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
</li>
<li><tt>if_changed</tt> - Simple way of specifying attributes that are required
to be changed before saving a model. This takes either a symbol or array of
symbols.

</li>
<li><tt>extend</tt> - Lets you specify a module to be mixed in both the
original and versioned models. You can also just pass a block to create an
anonymous mixin:

<pre class="code">
  <span class='class class kw'>class</span> <span class='Auction constant id'>Auction</span>
    <span class='acts_as_versioned identifier id'>acts_as_versioned</span> <span class='do do kw'>do</span>
      <span class='def def kw'>def</span> <span class='started? fid id'>started?</span>
        <span class='notop op'>!</span><span class='started_at identifier id'>started_at</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
or&#8230;
</p>
<pre class="code">
  <span class='module module kw'>module</span> <span class='AuctionExtension constant id'>AuctionExtension</span>
    <span class='def def kw'>def</span> <span class='started? fid id'>started?</span>
      <span class='notop op'>!</span><span class='started_at identifier id'>started_at</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='class class kw'>class</span> <span class='Auction constant id'>Auction</span>
    <span class='acts_as_versioned identifier id'>acts_as_versioned</span> <span class='symbol val'>:extend</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='AuctionExtension constant id'>AuctionExtension</span>
  <span class='end end kw'>end</span>

 <span class='Example constant id'>Example</span> <span class='code identifier id'>code</span><span class='colon op'>:</span>

   <span class='@auction ivar id'>@auction</span> <span class='assign token'>=</span> <span class='Auction constant id'>Auction</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='integer val'>1</span><span class='rparen token'>)</span>
   <span class='@auction ivar id'>@auction</span><span class='dot token'>.</span><span class='started? fid id'>started?</span>
   <span class='@auction ivar id'>@auction</span><span class='dot token'>.</span><span class='versions identifier id'>versions</span><span class='dot token'>.</span><span class='first identifier id'>first</span><span class='dot token'>.</span><span class='started? fid id'>started?</span>
</pre>
</li>
</ul>
<h2>Database Schema</h2>
<p>
The model that you&#8217;re versioning needs to have a
&#8216;version&#8217; attribute. The model is versioned into a table called
#{model}_versions where the model name is singlular. The _versions table
should contain all the fields you want versioned, the same version column,
and a #{model}_id foreign key field.
</p>
<p>
A lock_version field is also accepted if your model uses Optimistic
Locking. If your table uses Single Table inheritance, then that field is
reflected in the versioned model as &#8216;versioned_type&#8217; by
default.
</p>
<p>
Acts_as_versioned comes prepared with the
ActiveRecord::Acts::Versioned::ActMethods::ClassMethods#create_versioned_table
method, perfect for a migration. It will also create the version column if
the main model does not already have it.
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='AddVersions constant id'>AddVersions</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Migration constant id'>Migration</span>
    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='up identifier id'>up</span>
      <span class='comment val'># create_versioned_table takes the same options hash</span>
      <span class='comment val'># that create_table does</span>
      <span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='create_versioned_table identifier id'>create_versioned_table</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='down identifier id'>down</span>
      <span class='Post constant id'>Post</span><span class='dot token'>.</span><span class='drop_versioned_table identifier id'>drop_versioned_table</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<h2>Changing What Fields Are Versioned</h2>
<p>
By default, acts_as_versioned will version all but these fields:
</p>
<pre class="code">
  <span class='lbrack token'>[</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='primary_key identifier id'>primary_key</span><span class='comma token'>,</span> <span class='inheritance_column identifier id'>inheritance_column</span><span class='comma token'>,</span> <span class='string val'>'version'</span><span class='comma token'>,</span> <span class='string val'>'lock_version'</span><span class='comma token'>,</span> <span class='versioned_inheritance_column identifier id'>versioned_inheritance_column</span><span class='rbrack token'>]</span>
</pre>
<p>
You can add or change those by modifying #non_versioned_columns. Note that
this takes strings and not symbols.
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='Post constant id'>Post</span> <span class='lt op'>&lt;</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span>
    <span class='acts_as_versioned identifier id'>acts_as_versioned</span>
    <span class='self self kw'>self</span><span class='dot token'>.</span><span class='non_versioned_columns identifier id'>non_versioned_columns</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>'comments_count'</span>
  <span class='end end kw'>end</span>
</pre>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/acts_as_versioned.rb', line 165</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/technoweenie/acts_as_versioned/blob/1bd3d255eb43562a44fd1f907d82ec80db2872d3/lib/acts_as_versioned.rb#L165">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='acts_as_versioned identifier id'>acts_as_versioned</span><span class='lparen token'>(</span><span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='bitand op'>&amp;</span><span class='extension identifier id'>extension</span><span class='rparen token'>)</span>
  <span class='comment val'># don't allow multiple calls</span>
  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='included_modules identifier id'>included_modules</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Acts constant id'>Acts</span><span class='colon2 op'>::</span><span class='Versioned constant id'>Versioned</span><span class='colon2 op'>::</span><span class='ActMethods constant id'>ActMethods</span><span class='rparen token'>)</span>

  <span class='send identifier id'>send</span> <span class='symbol val'>:include</span><span class='comma token'>,</span> <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Acts constant id'>Acts</span><span class='colon2 op'>::</span><span class='Versioned constant id'>Versioned</span><span class='colon2 op'>::</span><span class='ActMethods constant id'>ActMethods</span>

  <span class='cattr_accessor identifier id'>cattr_accessor</span> <span class='symbol val'>:versioned_class_name</span><span class='comma token'>,</span> <span class='symbol val'>:versioned_foreign_key</span><span class='comma token'>,</span> <span class='symbol val'>:versioned_table_name</span><span class='comma token'>,</span> <span class='symbol val'>:versioned_inheritance_column</span><span class='comma token'>,</span> 
    <span class='symbol val'>:version_column</span><span class='comma token'>,</span> <span class='symbol val'>:max_version_limit</span><span class='comma token'>,</span> <span class='symbol val'>:track_altered_attributes</span><span class='comma token'>,</span> <span class='symbol val'>:version_condition</span><span class='comma token'>,</span> <span class='symbol val'>:version_sequence_name</span><span class='comma token'>,</span> <span class='symbol val'>:non_versioned_columns</span><span class='comma token'>,</span>
    <span class='symbol val'>:version_association_options</span><span class='comma token'>,</span> <span class='symbol val'>:version_if_changed</span>

  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='versioned_class_name identifier id'>versioned_class_name</span>         <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:class_name</span><span class='rbrack token'>]</span>  <span class='orop op'>||</span> <span class='string val'>&quot;Version&quot;</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='versioned_foreign_key identifier id'>versioned_foreign_key</span>        <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:foreign_key</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='dot token'>.</span><span class='foreign_key identifier id'>foreign_key</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='versioned_table_name identifier id'>versioned_table_name</span>         <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:table_name</span><span class='rbrack token'>]</span>  <span class='orop op'>||</span> <span class='dstring node'>&quot;#{table_name_prefix}#{base_class.name.demodulize.underscore}_versions#{table_name_suffix}&quot;</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='versioned_inheritance_column identifier id'>versioned_inheritance_column</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:inheritance_column</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='dstring node'>&quot;versioned_#{inheritance_column}&quot;</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='version_column identifier id'>version_column</span>               <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:version_column</span><span class='rbrack token'>]</span>     <span class='orop op'>||</span> <span class='string val'>'version'</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='version_sequence_name identifier id'>version_sequence_name</span>        <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:sequence_name</span><span class='rbrack token'>]</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='max_version_limit identifier id'>max_version_limit</span>            <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:limit</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='version_condition identifier id'>version_condition</span>            <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:if</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='true true kw'>true</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='non_versioned_columns identifier id'>non_versioned_columns</span>        <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='primary_key identifier id'>primary_key</span><span class='comma token'>,</span> <span class='inheritance_column identifier id'>inheritance_column</span><span class='comma token'>,</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='version_column identifier id'>version_column</span><span class='comma token'>,</span> <span class='string val'>'lock_version'</span><span class='comma token'>,</span> <span class='versioned_inheritance_column identifier id'>versioned_inheritance_column</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:non_versioned_columns</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_a identifier id'>to_a</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='symbol val'>:to_s</span><span class='rparen token'>)</span>
  <span class='self self kw'>self</span><span class='dot token'>.</span><span class='version_association_options identifier id'>version_association_options</span>  <span class='assign token'>=</span> <span class='lbrace token'>{</span>
                                        <span class='symbol val'>:class_name</span>  <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;#{self.to_s}::#{versioned_class_name}&quot;</span><span class='comma token'>,</span>
                                        <span class='symbol val'>:foreign_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='versioned_foreign_key identifier id'>versioned_foreign_key</span><span class='comma token'>,</span>
                                        <span class='symbol val'>:dependent</span>   <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='symbol val'>:delete_all</span>
                                      <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:association_options</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>

  <span class='if if kw'>if</span> <span class='block_given? fid id'>block_given?</span>
    <span class='extension_module_name identifier id'>extension_module_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{versioned_class_name}Extension&quot;</span>
    <span class='silence_warnings identifier id'>silence_warnings</span> <span class='do do kw'>do</span>
      <span class='self self kw'>self</span><span class='dot token'>.</span><span class='const_set identifier id'>const_set</span><span class='lparen token'>(</span><span class='extension_module_name identifier id'>extension_module_name</span><span class='comma token'>,</span> <span class='Module constant id'>Module</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='bitand op'>&amp;</span><span class='extension identifier id'>extension</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:extend</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='const_get identifier id'>const_get</span><span class='lparen token'>(</span><span class='extension_module_name identifier id'>extension_module_name</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='class_eval identifier id'>class_eval</span> <span class='string val'>&quot;has_many :versions, version_association_options do\n# finds earliest version of this record\ndef earliest\n@earliest ||= find(:first, :order =&gt; '\#{version_column}')\nend\n\n# find latest version of this record\ndef latest\n@latest ||= find(:first, :order =&gt; '\#{version_column} desc')\nend\nend\nbefore_save  :set_new_version\nafter_save   :save_version\nafter_save   :clear_old_versions\n\nunless options[:if_changed].nil?\nself.track_altered_attributes = true\noptions[:if_changed] = [options[:if_changed]] unless options[:if_changed].is_a?(Array)\nself.version_if_changed = options[:if_changed].map(&amp;:to_s)\nend\n\ninclude options[:extend] if options[:extend].is_a?(Module)\n&quot;</span>

  <span class='comment val'># create the dynamic versioned model</span>
  <span class='const_set identifier id'>const_set</span><span class='lparen token'>(</span><span class='versioned_class_name identifier id'>versioned_class_name</span><span class='comma token'>,</span> <span class='Class constant id'>Class</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span><span class='rparen token'>)</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='class_eval identifier id'>class_eval</span> <span class='do do kw'>do</span>
    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='reloadable? fid id'>reloadable?</span> <span class='semicolon token'>;</span> <span class='false false kw'>false</span> <span class='semicolon token'>;</span> <span class='end end kw'>end</span>
    <span class='comment val'># find first version before the given version</span>
    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='before identifier id'>before</span><span class='lparen token'>(</span><span class='version identifier id'>version</span><span class='rparen token'>)</span>
      <span class='find identifier id'>find</span> <span class='symbol val'>:first</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'version desc'</span><span class='comma token'>,</span>
        <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='dstring node'>&quot;#{original_class.versioned_foreign_key} = ? and version &lt; ?&quot;</span><span class='comma token'>,</span> <span class='version identifier id'>version</span><span class='dot token'>.</span><span class='send identifier id'>send</span><span class='lparen token'>(</span><span class='original_class identifier id'>original_class</span><span class='dot token'>.</span><span class='versioned_foreign_key identifier id'>versioned_foreign_key</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='version identifier id'>version</span><span class='dot token'>.</span><span class='version identifier id'>version</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># find first version after the given version.</span>
    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='after identifier id'>after</span><span class='lparen token'>(</span><span class='version identifier id'>version</span><span class='rparen token'>)</span>
      <span class='find identifier id'>find</span> <span class='symbol val'>:first</span><span class='comma token'>,</span> <span class='symbol val'>:order</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'version'</span><span class='comma token'>,</span>
        <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrack token'>[</span><span class='dstring node'>&quot;#{original_class.versioned_foreign_key} = ? and version &gt; ?&quot;</span><span class='comma token'>,</span> <span class='version identifier id'>version</span><span class='dot token'>.</span><span class='send identifier id'>send</span><span class='lparen token'>(</span><span class='original_class identifier id'>original_class</span><span class='dot token'>.</span><span class='versioned_foreign_key identifier id'>versioned_foreign_key</span><span class='rparen token'>)</span><span class='comma token'>,</span> <span class='version identifier id'>version</span><span class='dot token'>.</span><span class='version identifier id'>version</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='previous identifier id'>previous</span>
      <span class='self self kw'>self</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='before identifier id'>before</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='next next kw'>next</span>
      <span class='self self kw'>self</span><span class='dot token'>.</span><span class='class identifier id'>class</span><span class='dot token'>.</span><span class='after identifier id'>after</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='versions_count identifier id'>versions_count</span>
      <span class='page identifier id'>page</span><span class='dot token'>.</span><span class='version identifier id'>version</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='versioned_class identifier id'>versioned_class</span><span class='dot token'>.</span><span class='cattr_accessor identifier id'>cattr_accessor</span> <span class='symbol val'>:original_class</span>
  <span class='versioned_class identifier id'>versioned_class</span><span class='dot token'>.</span><span class='original_class identifier id'>original_class</span> <span class='assign token'>=</span> <span class='self self kw'>self</span>
  <span class='versioned_class identifier id'>versioned_class</span><span class='dot token'>.</span><span class='set_table_name identifier id'>set_table_name</span> <span class='versioned_table_name identifier id'>versioned_table_name</span>
  <span class='versioned_class identifier id'>versioned_class</span><span class='dot token'>.</span><span class='belongs_to identifier id'>belongs_to</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='dot token'>.</span><span class='demodulize identifier id'>demodulize</span><span class='dot token'>.</span><span class='underscore identifier id'>underscore</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span><span class='comma token'>,</span> 
    <span class='symbol val'>:class_name</span>  <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;::#{self.to_s}&quot;</span><span class='comma token'>,</span> 
    <span class='symbol val'>:foreign_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='versioned_foreign_key identifier id'>versioned_foreign_key</span>
  <span class='versioned_class identifier id'>versioned_class</span><span class='dot token'>.</span><span class='send identifier id'>send</span> <span class='symbol val'>:include</span><span class='comma token'>,</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:extend</span><span class='rbrack token'>]</span>         <span class='if if_mod kw'>if</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:extend</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='is_a? fid id'>is_a?</span><span class='lparen token'>(</span><span class='Module constant id'>Module</span><span class='rparen token'>)</span>
  <span class='versioned_class identifier id'>versioned_class</span><span class='dot token'>.</span><span class='set_sequence_name identifier id'>set_sequence_name</span> <span class='version_sequence_name identifier id'>version_sequence_name</span> <span class='if if_mod kw'>if</span> <span class='version_sequence_name identifier id'>version_sequence_name</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
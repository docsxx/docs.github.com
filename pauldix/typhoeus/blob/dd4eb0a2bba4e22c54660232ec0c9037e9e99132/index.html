<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>pauldix's typhoeus - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/pauldix/commits/typhoeus/master" rel="alternate" title="Recent Commits to typhoeus:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("pauldix", "typhoeus", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='pauldix/typhoeus/blob/dd4eb0a2bba4e22c54660232ec0c9037e9e99132' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='pauldix/typhoeus/blob/dd4eb0a2bba4e22c54660232ec0c9037e9e99132' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("pauldix", "typhoeus", "dd4eb0a2bba4e22c54660232ec0c9037e9e99132", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/pauldix/typhoeus/tree/">Source</a></li>
            <li class=""><a href="http://github.com/pauldix/typhoeus/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/pauldix/typhoeus/network">Network</a></li>            
            <li class=""><a href="http://github.com/pauldix/typhoeus/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/pauldix/typhoeus">Wiki</a></li>
            <li class=""><a href="http://github.com/pauldix/typhoeus/graphs">Graphs</a></li>                    
            <li class="active"><a href="/pauldix/typhoeus">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/pauldix">pauldix</a> / <b><a href="http://github.com/pauldix/typhoeus/tree">typhoeus</a></b>        
                <a id="namespaces_button" rel="pauldix/typhoeus/blob/dd4eb0a2bba4e22c54660232ec0c9037e9e99132" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="pauldix/typhoeus/blob/dd4eb0a2bba4e22c54660232ec0c9037e9e99132" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>Typhoeus</h1>


	<p><a href="http://github.com/pauldix/typhoeus/tree/master">http://github.com/pauldix/typhoeus/tree/master</a></p>


	<p><a href="http://groups.google.com/group/typhoeus">the mailing list</a></p>


	<p>Thanks to my employer <a href="http://kgb.com">kgb</a> for allowing me to release this as open source. Btw, we&#8217;re hiring and we work on cool stuff like this every day. Get a hold of me if you rock at rails/js/html/css or if you have experience in search, information retrieval, and machine learning.</p>


	<p>I also wanted to thank Todd A. Fisher. I ripped a good chunk of the c libcurl-multi code from his update to Curb. Awesome stuff Todd!</p>


	<h2>Summary</h2>


	<p>Like a modern code version of the mythical beast with 100 serpent heads, Typhoeus runs <span class="caps">HTTP</span> requests in parallel while cleanly encapsulating handling logic. To be a little more specific, it&#8217;s a library for accessing web services in Ruby. It&#8217;s specifically designed for building RESTful service oriented architectures in Ruby that need to be fast enough to process calls to multiple services within the client&#8217;s <span class="caps">HTTP</span> request/response life cycle.</p>


	<p>Some of the awesome features are parallel request execution, memoization of request responses (so you don&#8217;t make the same request multiple times in a single group), built in support for caching responses to memcached (or whatever), and a nifty <span class="caps">DSL</span> for creating classes that make http calls and process responses. It uses libcurl and libcurl-multi to work this speedy magic. I wrote the c bindings myself so it&#8217;s yet another Ruby libcurl library, but with some extra awesomeness added in.</p>


	<h2>Installation</h2>


For now Typhoeus exists only on github. It requires you to have a current version of libcurl installed. I&#8217;ve tested this with 7.19.4.
<pre class="code">
<span class='gem identifier id'>gem</span> <span class='sources identifier id'>sources</span> <span class='minus op'>-</span><span class='a identifier id'>a</span> <span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/gems.github.com # if you haven't already
gem install pauldix-typhoeus
</span></pre>
If you&#8217;re on Debian or Ubuntu and getting errors while trying to install, it could be because you don&#8217;t have the latest version of libcurl installed. Do this to fix:
<pre class="code">
<span class='sudo identifier id'>sudo</span> <span class='apt identifier id'>apt</span><span class='minus op'>-</span><span class='get identifier id'>get</span> <span class='install identifier id'>install</span> <span class='libcurl4 identifier id'>libcurl4</span><span class='minus op'>-</span><span class='gnutls identifier id'>gnutls</span><span class='minus op'>-</span><span class='dev identifier id'>dev</span>
</pre>

	<p>Another problem could be if you are running Mac Ports and you have libcurl installed through there. You need to uninstall it for Typhoeus to work! The version in Mac Ports is old and doesn&#8217;t play nice. You should <a href="http://curl.haxx.se/download.html">download curl</a> and build from source. Then you&#8217;ll have to install the gem again.</p>


	<p>If you&#8217;re still having issues, please let me know on <a href="http://groups.google.com/group/typhoeus">the mailing list</a>.</p>


	<p>There&#8217;s one other thing you should know. The Easy object (which is just a libcurl thing) allows you to set timeout values in milliseconds. However, for this to work you need to build libcurl with c-ares support built in. Unfortunately, I still haven&#8217;t been able to get this to work on either my Mac or Linux. I&#8217;ll have to figure that out.</p>


	<h2>Usage</h2>


<pre class="code">
<span class='comment val'># here's an example for twitter search</span>
<span class='comment val'># Including Typhoeus adds http methods like get, put, post, and delete.</span>
<span class='comment val'># What's more interesting though is the stuff to build up what I call</span>
<span class='comment val'># remote_methods.</span>
<span class='class class kw'>class</span> <span class='Twitter constant id'>Twitter</span>
  <span class='include identifier id'>include</span> <span class='Typhoeus constant id'>Typhoeus</span>
  <span class='remote_defaults identifier id'>remote_defaults</span> <span class='symbol val'>:on_success</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lambda identifier id'>lambda</span> <span class='lt op'>&lt;</span><span class='tt identifier id'>tt</span><span class='gt op'>&gt;</span><span class='JSON constant id'>JSON</span><span class='dot token'>.</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='response identifier id'>response</span><span class='dot token'>.</span><span class='body identifier id'>body</span><span class='rparen token'>)</span><span class='lt op'>&lt;</span><span class='dregexp node'>/tt&gt;,
                  :on_failure =&gt; lambda &lt;tt&gt;puts &quot;error code: #{response.code&lt;/tt&gt;&quot;},
                  :base_uri   =&gt; &quot;http:/</span><span class='div op'>/</span><span class='search identifier id'>search</span><span class='dot token'>.</span><span class='twitter identifier id'>twitter</span><span class='dot token'>.</span><span class='com identifier id'>com</span><span class='string val'>&quot; 

  define_remote_method :search, :path =&gt; '/search.json'
  define_remote_method :trends, :path =&gt; '/trends/:time_frame.json'
end

tweets = Twitter.search(:params =&gt; &lt;tt&gt;=&amp;gt; &quot;</span><span class='railsconf identifier id'>railsconf</span><span class='string val'>&quot;&lt;/tt&gt;)

# if you look at the path argument for the :trends method, it has :time_frame.
# this tells it to add in a parameter called :time_frame that gets interpolated
# and inserted.
trends = Twitter.trends(:time_frame =&gt; :current)

# and then the calls don't actually happen until the first time you
# call a method on one of the objects returned from the remote_method
puts tweets.keys # it's a hash from parsed JSON

# you can also do things like override any of the default parameters
Twitter.search(:params =&gt; &lt;tt&gt;=&amp;gt; &quot;</span><span class='hi identifier id'>hi</span><span class='string val'>&quot;&lt;/tt&gt;, :on_success =&gt; lambda &lt;tt&gt;puts response.body&lt;/tt&gt;)

# on_success and on_failure lambdas take a response object. 
# It has four accesssors: code, body, headers, and time

# here's and example of memoization
twitter_searches = []
10.times do
  twitter_searches &lt;&lt; Twitter.search(:params =&gt; &lt;tt&gt;=&amp;gt; &quot;</span><span class='railsconf identifier id'>railsconf</span><span class='string val'>&quot;&lt;/tt&gt;)
end

# this next part will actually make the call. However, it only makes one
# http request and parses the response once. The rest are memoized.
twitter_searches.each &lt;tt&gt;puts s.keys&lt;/tt&gt;

# you can also have it cache responses and do gets automatically
# here we define a remote method that caches the responses for 60 seconds
klass = Class.new do
  include Typhoeus

  define_remote_method :foo, :base_uri =&gt; &quot;</span><span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/localhost:3001&quot;, :cache_responses =&gt; 60
end

klass.cache = some_memcached_instance_or_whatever
response = klass.foo 
puts response.body # makes the request

second_response = klass.foo
puts response.body # pulls from the cache without making a request

# you can also pass timeouts on the define_remote_method or as a parameter
# Note that timeouts are in milliseconds.
Twitter.trends(:time_frame =&gt; :current, :timeout =&gt; 2000)

# you also get the normal get, put, post, and delete methods
class Remote
  include Typhoeus
end

Remote.get(&quot;http:/</span><span class='div op'>/</span><span class='www identifier id'>www</span><span class='dot token'>.</span><span class='pauldix identifier id'>pauldix</span><span class='dot token'>.</span><span class='net identifier id'>net</span><span class='string val'>&quot;)
Remote.put(&quot;</span><span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/&quot;, :body =&gt; &quot;this is a request body&quot;)
Remote.post(&quot;http:/</span><span class='div op'>/</span><span class='localhost identifier id'>localhost</span><span class='symbol val'>:3001</span><span class='div op'>/</span><span class='posts identifier id'>posts</span><span class='dot token'>.</span><span class='xml identifier id'>xml</span><span class='string val'>&quot;, 
  &lt;tt&gt;=&amp;gt; {:post =&amp;gt; {:author =&amp;gt; &quot;</span><span class='paul identifier id'>paul</span><span class='string val'>&quot;, :title =&amp;gt; &quot;</span><span class='a identifier id'>a</span> <span class='title identifier id'>title</span><span class='string val'>&quot;, :body =&amp;gt; &quot;</span><span class='a identifier id'>a</span> <span class='body identifier id'>body</span><span class='string val'>&quot;&lt;/tt&gt;}})
Remote.delete(&quot;</span><span class='http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/localhost:3001/</span><span class='posts identifier id'>posts</span><span class='div op'>/</span><span class='integer val'>1</span><span class='string val'>&quot;)
</span></pre>

	<p>The best place to see the functionality of what including Typhoeus in a class gives you is to look at the &#8220;remote_spec.rb&#8221;</p>


	<h2>Benchmarks</h2>


	<p>I set up a benchmark to test how the parallel performance works vs Ruby&#8217;s built in <span class="caps">NET</span>::HTTP. The setup was a local evented <span class="caps">HTTP</span> server that would take a request, sleep for 500 milliseconds and then issued a blank response. I set up the client to call this 20 times. Here are the results:</p>


<pre class="code">
  <span class='net identifier id'>net</span><span class='colon2 op'>::</span><span class='http identifier id'>http</span>  <span class='integer val'>0</span><span class='integer val'>.030000</span>   <span class='integer val'>0</span><span class='integer val'>.010000</span>   <span class='integer val'>0</span><span class='integer val'>.040000</span> <span class='lparen token'>(</span> <span class='float val'>10.054327</span><span class='rparen token'>)</span>
  <span class='typhoeus identifier id'>typhoeus</span>   <span class='integer val'>0</span><span class='integer val'>.020000</span>   <span class='integer val'>0</span><span class='integer val'>.070000</span>   <span class='integer val'>0</span><span class='integer val'>.090000</span> <span class='lparen token'>(</span>  <span class='integer val'>0</span><span class='integer val'>.508817</span><span class='rparen token'>)</span>
</pre>

	<p>We can see from this that <span class="caps">NET</span>::HTTP performs as expected, taking 10 seconds to run 20 500ms requests. Typhoeus only takes 500ms (the time of the response that took the longest.) One other thing to note is that Typhoeus keeps a pool of libcurl Easy handles to use. For this benchmark I warmed the pool first. So if you test this out it may be a bit slower until the Easy handle pool has enough in it to run all the simultaneous requests. For some reason the easy handles can take quite some time to allocate.</p>


	<h2>Next Steps</h2>


	<ul>
	<li>Write up some more examples.</li>
		<li>Create a SimpleDB client library using Typhoeus.</li>
		<li>Create or get someone to create a CouchDB client library using Typhoeus.</li>
		<li>wire up a simple method to mock out remote requests.</li>
		<li>Add support for automatic retry, exponential back-off, and queuing for later.</li>
		<li>Add in the support for custom get and set methods on the cache.</li>
		<li>Add in support for integrated <span class="caps">HTTP</span> caching with Memcached.</li>
	</ul>


	<h2><span class="caps">LICENSE</span></h2>


	<p>(The <span class="caps">MIT</span> License)</p>


	<p>Copyright&#169; 2009:</p>


	<p><a href="http://pauldix.net">Paul Dix</a></p>


	<p>Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
&#8216;Software&#8217;), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:</p>


	<p>The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.</p>


	<p><span class="caps">THE SOFTWARE IS PROVIDED</span> &#8216;AS IS&#8217;, <span class="caps">WITHOUT WARRANTY OF ANY KIND</span>,
<span class="caps">EXPRESS OR IMPLIED</span>, INCLUDING <span class="caps">BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="caps">MERCHANTABILITY</span>, FITNESS <span class="caps">FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT</span>.
<span class="caps">IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY</span>
<span class="caps">CLAIM</span>, DAMAGES <span class="caps">OR OTHER LIABILITY</span>, WHETHER <span class="caps">IN AN ACTION OF CONTRACT</span>,
<span class="caps">TORT OR OTHERWISE</span>, ARISING <span class="caps">FROM</span>, OUT <span class="caps">OF OR IN CONNECTION WITH THE</span>
<span class="caps">SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE</span>.</p>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
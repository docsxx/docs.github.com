<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>evanphx's rubinius - Module: Gem::Security - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/evanphx/commits/rubinius/master" rel="alternate" title="Recent Commits to rubinius:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("evanphx", "rubinius", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("evanphx", "rubinius", "a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/evanphx/rubinius/tree/">Source</a></li>
            <li class=""><a href="http://github.com/evanphx/rubinius/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/evanphx/rubinius/network">Network</a></li>            
            <li class=""><a href="http://github.com/evanphx/rubinius/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/evanphx/rubinius">Wiki</a></li>
            <li class=""><a href="http://github.com/evanphx/rubinius/graphs">Graphs</a></li>                    
            <li class="active"><a href="/evanphx/rubinius">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/evanphx">evanphx</a> / <b><a href="http://github.com/evanphx/rubinius/tree">rubinius</a></b>        
                <a id="namespaces_button" rel="evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section module Gem_Security">
  <h1>Module: Gem::Security</h1>
  <div class="section docstring">
  <h1>Signed Gems README</h1>
<h2>Table of Contents</h2>
<ul>
<li>Overview

</li>
<li>Walkthrough

</li>
<li>Command-Line Options

</li>
<li>OpenSSL Reference

</li>
<li>Bugs/TODO

</li>
<li>About the Author

</li>
</ul>
<h2>Overview</h2>
<p>
Gem::Security implements cryptographic signatures in RubyGems. The section
below is a step-by-step guide to using signed gems and generating your own.
</p>
<h2>Walkthrough</h2>
<p>
In order to start signing your gems, you&#8217;ll need to build a private
key and a self-signed certificate. Here&#8217;s how:
</p>
<pre class="code">
  <span class='comment val'># build a private key and certificate for gemmaster@example.com</span>
  $ <span class='gem identifier id'>gem</span> <span class='cert identifier id'>cert</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='build identifier id'>build</span> <span class='gemmaster identifier id'>gemmaster</span><span class='@example ivar id'>@example</span><span class='dot token'>.</span><span class='com identifier id'>com</span>
</pre>
<p>
This could take anywhere from 5 seconds to 10 minutes, depending on the
speed of your computer (public key algorithms aren&#8217;t exactly the
speediest crypto algorithms in the world). When it&#8217;s finished,
you&#8217;ll see the files &quot;gem-private_key.pem&quot; and
&quot;gem-public_cert.pem&quot; in the current directory.
</p>
<p>
First things first: take the &quot;gem-private_key.pem&quot; file and move
it somewhere private, preferably a directory only you have access to, a
floppy (yuck!), a CD-ROM, or something comparably secure. Keep your private
key hidden; if it&#8217;s compromised, someone can sign packages as you
(note: PKI has ways of mitigating the risk of stolen keys; more on that
later).
</p>
<p>
Now, let&#8217;s sign an existing gem. I&#8217;ll be using my Imlib2-Ruby
bindings, but you can use whatever gem you&#8217;d like. Open up your
existing gemspec file and add the following lines:
</p>
<pre class="code">
  <span class='comment val'># signing key and certificate chain</span>
  <span class='s identifier id'>s</span><span class='dot token'>.</span><span class='signing_key identifier id'>signing_key</span> <span class='assign token'>=</span> <span class='string val'>'/mnt/floppy/gem-private_key.pem'</span>
  <span class='s identifier id'>s</span><span class='dot token'>.</span><span class='cert_chain identifier id'>cert_chain</span>  <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='string val'>'gem-public_cert.pem'</span><span class='rbrack token'>]</span>
</pre>
<p>
(Be sure to replace &quot;/mnt/floppy&quot; with the ultra-secret path to
your private key).
</p>
<p>
After that, go ahead and build your gem as usual. Congratulations,
you&#8217;ve just built your first signed gem! If you peek inside your gem
file, you&#8217;ll see a couple of new files have been added:
</p>
<pre class="code">
  $ <span class='tar identifier id'>tar</span> <span class='tf identifier id'>tf</span> <span class='tar identifier id'>tar</span> <span class='tf identifier id'>tf</span> <span class='Imlib2 constant id'>Imlib2</span><span class='minus op'>-</span><span class='Ruby constant id'>Ruby</span><span class='minus op'>-</span><span class='integer val'>0</span><span class='float val'>.5.0</span><span class='dot token'>.</span><span class='gem identifier id'>gem</span>
  <span class='data identifier id'>data</span><span class='dot token'>.</span><span class='tar identifier id'>tar</span><span class='dot token'>.</span><span class='gz identifier id'>gz</span>
  <span class='data identifier id'>data</span><span class='dot token'>.</span><span class='tar identifier id'>tar</span><span class='dot token'>.</span><span class='gz identifier id'>gz</span><span class='dot token'>.</span><span class='sig identifier id'>sig</span>
  <span class='metadata identifier id'>metadata</span><span class='dot token'>.</span><span class='gz identifier id'>gz</span>
  <span class='metadata identifier id'>metadata</span><span class='dot token'>.</span><span class='gz identifier id'>gz</span><span class='dot token'>.</span><span class='sig identifier id'>sig</span>
</pre>
<p>
Now let&#8217;s verify the signature. Go ahead and install the gem, but add
the following options: &quot;-P HighSecurity&quot;, like this:
</p>
<pre class="code">
  <span class='comment val'># install the gem with using the security policy &quot;HighSecurity&quot;</span>
  $ <span class='sudo identifier id'>sudo</span> <span class='gem identifier id'>gem</span> <span class='install identifier id'>install</span> <span class='Imlib2 constant id'>Imlib2</span><span class='minus op'>-</span><span class='Ruby constant id'>Ruby</span><span class='minus op'>-</span><span class='integer val'>0</span><span class='float val'>.5.0</span><span class='dot token'>.</span><span class='gem identifier id'>gem</span> <span class='minus op'>-</span><span class='P constant id'>P</span> <span class='HighSecurity constant id'>HighSecurity</span>
</pre>
<p>
The -P option sets your security policy &#8212; we&#8217;ll talk about that
in just a minute. Eh, what&#8217;s this?
</p>
<pre class="code">
  <span class='Attempting constant id'>Attempting</span> <span class='local identifier id'>local</span> <span class='installation identifier id'>installation</span> <span class='of identifier id'>of</span> <span class='string val'>'Imlib2-Ruby-0.5.0.gem'</span>
  <span class='ERROR constant id'>ERROR</span><span class='colon op'>:</span>  <span class='Error constant id'>Error</span> <span class='installing identifier id'>installing</span> <span class='gem identifier id'>gem</span> <span class='Imlib2 constant id'>Imlib2</span><span class='minus op'>-</span><span class='Ruby constant id'>Ruby</span><span class='minus op'>-</span><span class='integer val'>0</span><span class='float val'>.5.0</span><span class='dot token'>.</span><span class='gem identifier id'>gem</span><span class='lbrack token'>[</span><span class='dot token'>.</span><span class='gem identifier id'>gem</span><span class='rbrack token'>]</span><span class='colon op'>:</span> <span class='Couldn constant id'>Couldn</span><span class='string val'>'t
  verify data signature: Untrusted Signing Chain Root: cert =
  '</span><span class='div op'>/</span><span class='CN constant id'>CN</span><span class='assign token'>=</span><span class='gemmaster identifier id'>gemmaster</span><span class='div op'>/</span><span class='DC constant id'>DC</span><span class='assign token'>=</span><span class='example identifier id'>example</span><span class='div op'>/</span><span class='DC constant id'>DC</span><span class='assign token'>=</span><span class='com identifier id'>com</span><span class='string val'>', error = '</span><span class='path identifier id'>path</span>
  <span class='string val'>&quot;/root/.rubygems/trust/cert-15dbb43a6edf6a70a85d4e784e2e45312cff7030.pem&quot;</span>
  <span class='does identifier id'>does</span> <span class='not not kw'>not</span> <span class='exist identifier id'>exist</span><span class='string val'>'
</span></pre>
<p>
The culprit here is the security policy. RubyGems has several different
security policies. Let&#8217;s take a short break and go over the security
policies. Here&#8217;s a list of the available security policies, and a
brief description of each one:
</p>
<ul>
<li>NoSecurity - Well, no security at all. Signed packages are treated like
unsigned packages.

</li>
<li>LowSecurity - Pretty much no security. If a package is signed then RubyGems
will make sure the signature matches the signing certificate, and that the
signing certificate hasn&#8217;t expired, but that&#8217;s it. A malicious
user could easily circumvent this kind of security.

</li>
<li>MediumSecurity - Better than LowSecurity and NoSecurity, but still
fallible. Package contents are verified against the signing certificate,
and the signing certificate is checked for validity, and checked against
the rest of the certificate chain (if you don&#8217;t know what a
certificate chain is, stay tuned, we&#8217;ll get to that). The biggest
improvement over LowSecurity is that MediumSecurity won&#8217;t install
packages that are signed by untrusted sources. Unfortunately,
MediumSecurity still isn&#8217;t totally secure &#8212; a malicious user
can still unpack the gem, strip the signatures, and distribute the gem
unsigned.

</li>
<li>HighSecurity - Here&#8217;s the bugger that got us into this mess. The
HighSecurity policy is identical to the MediumSecurity policy, except that
it does not allow unsigned gems. A malicious user doesn&#8217;t have a
whole lot of options here; he can&#8217;t modify the package contents
without invalidating the signature, and he can&#8217;t modify or remove
signature or the signing certificate chain, or RubyGems will simply refuse
to install the package. Oh well, maybe he&#8217;ll have better luck causing
problems for CPAN users instead :).

</li>
</ul>
<p>
So, the reason RubyGems refused to install our shiny new signed gem was
because it was from an untrusted source. Well, my code is infallible
(hah!), so I&#8217;m going to add myself as a trusted source.
</p>
<p>
Here&#8217;s how:
</p>
<pre class="code">
    <span class='comment val'># add trusted certificate</span>
    <span class='gem identifier id'>gem</span> <span class='cert identifier id'>cert</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='add identifier id'>add</span> <span class='gem identifier id'>gem</span><span class='minus op'>-</span><span class='public_cert identifier id'>public_cert</span><span class='dot token'>.</span><span class='pem identifier id'>pem</span>
</pre>
<p>
I&#8217;ve added my public certificate as a trusted source. Now I can
install packages signed my private key without any hassle. Let&#8217;s try
the install command above again:
</p>
<pre class="code">
  <span class='comment val'># install the gem with using the HighSecurity policy (and this time</span>
  <span class='comment val'># without any shenanigans)</span>
  $ <span class='sudo identifier id'>sudo</span> <span class='gem identifier id'>gem</span> <span class='install identifier id'>install</span> <span class='Imlib2 constant id'>Imlib2</span><span class='minus op'>-</span><span class='Ruby constant id'>Ruby</span><span class='minus op'>-</span><span class='integer val'>0</span><span class='float val'>.5.0</span><span class='dot token'>.</span><span class='gem identifier id'>gem</span> <span class='minus op'>-</span><span class='P constant id'>P</span> <span class='HighSecurity constant id'>HighSecurity</span>
</pre>
<p>
This time RubyGems should accept your signed package and begin installing.
While you&#8217;re waiting for RubyGems to work it&#8217;s magic, have a
look at some of the other security commands:
</p>
<pre class="code">
  <span class='Usage constant id'>Usage</span><span class='colon op'>:</span> <span class='gem identifier id'>gem</span> <span class='cert identifier id'>cert</span> <span class='lbrack token'>[</span><span class='options identifier id'>options</span><span class='rbrack token'>]</span>

  <span class='Options constant id'>Options</span><span class='colon op'>:</span>
    <span class='minus op'>-</span><span class='a identifier id'>a</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='add identifier id'>add</span> <span class='CERT constant id'>CERT</span>          <span class='Add constant id'>Add</span> <span class='a identifier id'>a</span> <span class='trusted identifier id'>trusted</span> <span class='certificate identifier id'>certificate</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='l identifier id'>l</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='list identifier id'>list</span>              <span class='List constant id'>List</span> <span class='trusted identifier id'>trusted</span> <span class='certificates identifier id'>certificates</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='r identifier id'>r</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='remove identifier id'>remove</span> <span class='STRING constant id'>STRING</span>     <span class='Remove constant id'>Remove</span> <span class='trusted identifier id'>trusted</span> <span class='certificates identifier id'>certificates</span> <span class='containing identifier id'>containing</span> <span class='STRING constant id'>STRING</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='b identifier id'>b</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='build identifier id'>build</span> <span class='EMAIL_ADDR constant id'>EMAIL_ADDR</span>  <span class='Build constant id'>Build</span> <span class='private identifier id'>private</span> <span class='key identifier id'>key</span> <span class='and and kw'>and</span> <span class='self self kw'>self</span><span class='minus op'>-</span><span class='signed identifier id'>signed</span> <span class='certificate identifier id'>certificate</span>
                            <span class='for for kw'>for</span> <span class='EMAIL_ADDR constant id'>EMAIL_ADDR</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='C constant id'>C</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='certificate identifier id'>certificate</span> <span class='CERT constant id'>CERT</span>  <span class='Certificate constant id'>Certificate</span> <span class='for for kw'>for</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='sign identifier id'>sign</span> <span class='command identifier id'>command</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='K constant id'>K</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='private identifier id'>private</span><span class='minus op'>-</span><span class='key identifier id'>key</span> <span class='KEY constant id'>KEY</span>   <span class='Private constant id'>Private</span> <span class='key identifier id'>key</span> <span class='for for kw'>for</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='sign identifier id'>sign</span> <span class='command identifier id'>command</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='s identifier id'>s</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='sign identifier id'>sign</span> <span class='NEWCERT constant id'>NEWCERT</span>      <span class='Sign constant id'>Sign</span> <span class='a identifier id'>a</span> <span class='certificate identifier id'>certificate</span> <span class='with identifier id'>with</span> <span class='my identifier id'>my</span> <span class='key identifier id'>key</span> <span class='and and kw'>and</span> <span class='certificate identifier id'>certificate</span><span class='dot token'>.</span>
</pre>
<p>
(By the way, you can pull up this list any time you&#8217;d like by typing
&quot;gem cert --help&quot;)
</p>
<p>
Hmm. We&#8217;ve already covered the &quot;--build&quot; option, and
the &quot;--add&quot;, &quot;--list&quot;, and
&quot;--remove&quot; commands seem fairly straightforward; they allow
you to add, list, and remove the certificates in your trusted certificate
list. But what&#8217;s with this &quot;--sign&quot; option?
</p>
<p>
To answer that question, let&#8217;s take a look at &quot;certificate
chains&quot;, a concept I mentioned earlier. There are a couple of problems
with self-signed certificates: first of all, self-signed certificates
don&#8217;t offer a whole lot of security. Sure, the certificate says
Yukihiro Matsumoto, but how do I know it was actually generated and signed
by matz himself unless he gave me the certificate in person?
</p>
<p>
The second problem is scalability. Sure, if there are 50 gem authors, then
I have 50 trusted certificates, no problem. What if there are 500 gem
authors? 1000? Having to constantly add new trusted certificates is a pain,
and it actually makes the trust system less secure by encouraging RubyGems
users to blindly trust new certificates.
</p>
<p>
Here&#8217;s where certificate chains come in. A certificate chain
establishes an arbitrarily long chain of trust between an issuing
certificate and a child certificate. So instead of trusting certificates on
a per-developer basis, we use the PKI concept of certificate chains to
build a logical hierarchy of trust. Here&#8217;s a hypothetical example of
a trust hierarchy based (roughly) on geography:
</p>
<pre class="code">
                        <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
                        <span class='bitor op'>|</span> <span class='rubygems identifier id'>rubygems</span><span class='@rubyforge ivar id'>@rubyforge</span><span class='dot token'>.</span><span class='org identifier id'>org</span> <span class='bitor op'>|</span>
                        <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
                                    <span class='bitor op'>|</span>
                  <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
                  <span class='bitor op'>|</span>                                 <span class='bitor op'>|</span>
      <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>    <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
      <span class='bitor op'>|</span> <span class='seattle identifier id'>seattle</span><span class='dot token'>.</span><span class='rb identifier id'>rb</span><span class='@zenspider ivar id'>@zenspider</span><span class='dot token'>.</span><span class='com identifier id'>com</span> <span class='bitor op'>|</span>    <span class='bitor op'>|</span> <span class='dcrubyists identifier id'>dcrubyists</span><span class='@richkilmer ivar id'>@richkilmer</span><span class='dot token'>.</span><span class='com identifier id'>com</span> <span class='bitor op'>|</span>
      <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>    <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
           <span class='bitor op'>|</span>                <span class='bitor op'>|</span>                 <span class='bitor op'>|</span>             <span class='bitor op'>|</span>
    <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>   <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>   <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>   <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
    <span class='bitor op'>|</span> <span class='alf identifier id'>alf</span><span class='@seattle ivar id'>@seattle</span> <span class='bitor op'>|</span>   <span class='bitor op'>|</span> <span class='bob identifier id'>bob</span><span class='@portland ivar id'>@portland</span> <span class='bitor op'>|</span>   <span class='bitor op'>|</span> <span class='pabs identifier id'>pabs</span><span class='@dc ivar id'>@dc</span> <span class='bitor op'>|</span>   <span class='bitor op'>|</span> <span class='tomcope identifier id'>tomcope</span><span class='@dc ivar id'>@dc</span> <span class='bitor op'>|</span>
    <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>   <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>   <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>   <span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span><span class='minus op'>-</span>
</pre>
<p>
Now, rather than having 4 trusted certificates (one for alf@seattle,
bob@portland, pabs@dc, and tomecope@dc), a user could actually get by with
1 certificate: the &quot;rubygems@rubyforge.org&quot; certificate.
Here&#8217;s how it works:
</p>
<p>
I install &quot;Alf2000-Ruby-0.1.0.gem&quot;, a package signed by
&quot;alf@seattle&quot;. I&#8217;ve never heard of &quot;alf@seattle&quot;,
but his certificate has a valid signature from the
&quot;seattle.rb@zenspider.com&quot; certificate, which in turn has a valid
signature from the &quot;rubygems@rubyforge.org&quot; certificate. Voila!
At this point, it&#8217;s much more reasonable for me to trust a package
signed by &quot;alf@seattle&quot;, because I can establish a chain to
&quot;rubygems@rubyforge.org&quot;, which I do trust.
</p>
<p>
And the &quot;--sign&quot; option allows all this to happen. A
developer creates their build certificate with the &quot;--build&quot;
option, then has their certificate signed by taking it with them to their
next regional Ruby meetup (in our hypothetical example), and it&#8217;s
signed there by the person holding the regional RubyGems signing
certificate, which is signed at the next RubyConf by the holder of the
top-level RubyGems certificate. At each point the issuer runs the same
command:
</p>
<pre class="code">
  <span class='comment val'># sign a certificate with the specified key and certificate</span>
  <span class='comment val'># (note that this modifies client_cert.pem!)</span>
  $ <span class='gem identifier id'>gem</span> <span class='cert identifier id'>cert</span> <span class='minus op'>-</span><span class='K constant id'>K</span> <span class='regexp val'>/mnt/</span><span class='floppy identifier id'>floppy</span><span class='div op'>/</span><span class='issuer identifier id'>issuer</span><span class='minus op'>-</span><span class='priv_key identifier id'>priv_key</span><span class='dot token'>.</span><span class='pem identifier id'>pem</span> <span class='minus op'>-</span><span class='C constant id'>C</span> <span class='issuer identifier id'>issuer</span><span class='minus op'>-</span><span class='pub_cert identifier id'>pub_cert</span><span class='dot token'>.</span><span class='pem identifier id'>pem</span>
     <span class='minus op'>-</span><span class='minus op'>-</span><span class='sign identifier id'>sign</span> <span class='client_cert identifier id'>client_cert</span><span class='dot token'>.</span><span class='pem identifier id'>pem</span>
</pre>
<p>
Then the holder of issued certificate (in this case, our buddy
&quot;alf@seattle&quot;), can start using this signed certificate to sign
RubyGems. By the way, in order to let everyone else know about his new
fancy signed certificate, &quot;alf@seattle&quot; would change his gemspec
file to look like this:
</p>
<pre class="code">
  <span class='comment val'># signing key (still kept in an undisclosed location!)</span>
  <span class='s identifier id'>s</span><span class='dot token'>.</span><span class='signing_key identifier id'>signing_key</span> <span class='assign token'>=</span> <span class='string val'>'/mnt/floppy/alf-private_key.pem'</span>

  <span class='comment val'># certificate chain (includes the issuer certificate now too)</span>
  <span class='s identifier id'>s</span><span class='dot token'>.</span><span class='cert_chain identifier id'>cert_chain</span>  <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='string val'>'/home/alf/doc/seattlerb-public_cert.pem'</span><span class='comma token'>,</span>
                   <span class='string val'>'/home/alf/doc/alf_at_seattle-public_cert.pem'</span><span class='rbrack token'>]</span>
</pre>
<p>
Obviously, this RubyGems trust infrastructure doesn&#8217;t exist yet.
Also, in the &quot;real world&quot; issuers actually generate the child
certificate from a certificate request, rather than sign an existing
certificate. And our hypothetical infrastructure is missing a certificate
revocation system. These are that can be fixed in the future&#8230;
</p>
<p>
I&#8217;m sure your new signed gem has finished installing by now (unless
you&#8217;re installing rails and all it&#8217;s dependencies, that is ;D).
At this point you should know how to do all of these new and interesting
things:
</p>
<ul>
<li>build a gem signing key and certificate

</li>
<li>modify your existing gems to support signing

</li>
<li>adjust your security policy

</li>
<li>modify your trusted certificate list

</li>
<li>sign a certificate

</li>
</ul>
<p>
If you&#8217;ve got any questions, feel free to contact me at the email
address below. The next couple of sections
</p>
<h2>Command-Line Options</h2>
<p>
Here&#8217;s a brief summary of the certificate-related command line
options:
</p>
<pre class="code">
  <span class='gem identifier id'>gem</span> <span class='install identifier id'>install</span>
    <span class='minus op'>-</span><span class='P constant id'>P</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='trust identifier id'>trust</span><span class='minus op'>-</span><span class='policy identifier id'>policy</span> <span class='POLICY constant id'>POLICY</span>        <span class='Specify constant id'>Specify</span> <span class='gem identifier id'>gem</span> <span class='trust identifier id'>trust</span> <span class='policy identifier id'>policy</span><span class='dot token'>.</span>

  <span class='gem identifier id'>gem</span> <span class='cert identifier id'>cert</span>
    <span class='minus op'>-</span><span class='a identifier id'>a</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='add identifier id'>add</span> <span class='CERT constant id'>CERT</span>                   <span class='Add constant id'>Add</span> <span class='a identifier id'>a</span> <span class='trusted identifier id'>trusted</span> <span class='certificate identifier id'>certificate</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='l identifier id'>l</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='list identifier id'>list</span>                       <span class='List constant id'>List</span> <span class='trusted identifier id'>trusted</span> <span class='certificates identifier id'>certificates</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='r identifier id'>r</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='remove identifier id'>remove</span> <span class='STRING constant id'>STRING</span>              <span class='Remove constant id'>Remove</span> <span class='trusted identifier id'>trusted</span> <span class='certificates identifier id'>certificates</span> <span class='containing identifier id'>containing</span>
                                     <span class='STRING constant id'>STRING</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='b identifier id'>b</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='build identifier id'>build</span> <span class='EMAIL_ADDR constant id'>EMAIL_ADDR</span>           <span class='Build constant id'>Build</span> <span class='private identifier id'>private</span> <span class='key identifier id'>key</span> <span class='and and kw'>and</span> <span class='self self kw'>self</span><span class='minus op'>-</span><span class='signed identifier id'>signed</span>
                                     <span class='certificate identifier id'>certificate</span> <span class='for for kw'>for</span> <span class='EMAIL_ADDR constant id'>EMAIL_ADDR</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='C constant id'>C</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='certificate identifier id'>certificate</span> <span class='CERT constant id'>CERT</span>           <span class='Certificate constant id'>Certificate</span> <span class='for for kw'>for</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='sign identifier id'>sign</span> <span class='command identifier id'>command</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='K constant id'>K</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='private identifier id'>private</span><span class='minus op'>-</span><span class='key identifier id'>key</span> <span class='KEY constant id'>KEY</span>            <span class='Private constant id'>Private</span> <span class='key identifier id'>key</span> <span class='for for kw'>for</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='sign identifier id'>sign</span> <span class='command identifier id'>command</span><span class='dot token'>.</span>
    <span class='minus op'>-</span><span class='s identifier id'>s</span><span class='comma token'>,</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='sign identifier id'>sign</span> <span class='NEWCERT constant id'>NEWCERT</span>               <span class='Sign constant id'>Sign</span> <span class='a identifier id'>a</span> <span class='certificate identifier id'>certificate</span> <span class='with identifier id'>with</span> <span class='my identifier id'>my</span> <span class='key identifier id'>key</span> <span class='and and kw'>and</span>
                                     <span class='certificate identifier id'>certificate</span><span class='dot token'>.</span>
</pre>
<p>
A more detailed description of each options is available in the walkthrough
above.
</p>
<h2>OpenSSL Reference</h2>
<p>
The .pem files generated by --build and --sign are just basic
OpenSSL PEM files. Here&#8217;s a couple of useful commands for
manipulating them:
</p>
<pre class="code">
  <span class='comment val'># convert a PEM format X509 certificate into DER format:</span>
  <span class='comment val'># (note: Windows .cer files are X509 certificates in DER format)</span>
  $ <span class='openssl identifier id'>openssl</span> <span class='x509 identifier id'>x509</span> <span class='minus op'>-</span><span class='in in kw'>in</span> <span class='input identifier id'>input</span><span class='dot token'>.</span><span class='pem identifier id'>pem</span> <span class='minus op'>-</span><span class='outform identifier id'>outform</span> <span class='der identifier id'>der</span> <span class='minus op'>-</span><span class='out identifier id'>out</span> <span class='output identifier id'>output</span><span class='dot token'>.</span><span class='der identifier id'>der</span>

  <span class='comment val'># print out the certificate in a human-readable format:</span>
  $ <span class='openssl identifier id'>openssl</span> <span class='x509 identifier id'>x509</span> <span class='minus op'>-</span><span class='in in kw'>in</span> <span class='input identifier id'>input</span><span class='dot token'>.</span><span class='pem identifier id'>pem</span> <span class='minus op'>-</span><span class='noout identifier id'>noout</span> <span class='minus op'>-</span><span class='text identifier id'>text</span>
</pre>
<p>
And you can do the same thing with the private key file as well:
</p>
<pre class="code">
  <span class='comment val'># convert a PEM format RSA key into DER format:</span>
  $ <span class='openssl identifier id'>openssl</span> <span class='rsa identifier id'>rsa</span> <span class='minus op'>-</span><span class='in in kw'>in</span> <span class='input_key identifier id'>input_key</span><span class='dot token'>.</span><span class='pem identifier id'>pem</span> <span class='minus op'>-</span><span class='outform identifier id'>outform</span> <span class='der identifier id'>der</span> <span class='minus op'>-</span><span class='out identifier id'>out</span> <span class='output_key identifier id'>output_key</span><span class='dot token'>.</span><span class='der identifier id'>der</span>

  <span class='comment val'># print out the key in a human readable format:</span>
  $ <span class='openssl identifier id'>openssl</span> <span class='rsa identifier id'>rsa</span> <span class='minus op'>-</span><span class='in in kw'>in</span> <span class='input_key identifier id'>input_key</span><span class='dot token'>.</span><span class='pem identifier id'>pem</span> <span class='minus op'>-</span><span class='noout identifier id'>noout</span> <span class='minus op'>-</span><span class='text identifier id'>text</span>
</pre>
<h2>Bugs/TODO</h2>
<ul>
<li>There&#8217;s no way to define a system-wide trust list.

</li>
<li>custom security policies (from a YAML file, etc)

</li>
<li>Simple method to generate a signed certificate request

</li>
<li>Support for OCSP, SCVP, CRLs, or some other form of cert status check (list
is in order of preference)

</li>
<li>Support for encrypted private keys

</li>
<li>Some sort of semi-formal trust hierarchy (see long-winded explanation
above)

</li>
<li>Path discovery (for gem certificate chains that don&#8217;t have a
self-signed root) &#8212; by the way, since we don&#8217;t have this, THE
ROOT OF THE CERTIFICATE CHAIN MUST BE SELF SIGNED if Policy#verify_root is
true (and it is for the MediumSecurity and HighSecurity policies)

</li>
<li>Better explanation of X509 naming (ie, we don&#8217;t have to use email
addresses)

</li>
<li>Possible alternate signing mechanisms (eg, via PGP). this could be done
pretty easily by adding a :signing_type attribute to the gemspec, then add
the necessary support in other places

</li>
<li>Honor AIA field (see note about OCSP above)

</li>
<li>Maybe honor restriction extensions?

</li>
<li>Might be better to store the certificate chain as a PKCS#7 or PKCS#12 file,
instead of an array embedded in the metadata. ideas?

</li>
<li>Possibly embed signature and key algorithms into metadata (right now
they&#8217;re assumed to be the same as what&#8217;s set in
Gem::Security::OPT)

</li>
</ul>
<h2>About the Author</h2>
<p>
Paul Duncan &lt;pabs@pablotron.org&gt; http://pablotron.org/
</p>

</div><div class="section constants">
  <div class="thisclass">
  <h2>Constants</h2>
  <dl>
    
      <dt id="AlmostNoSecurity-constant">AlmostNoSecurity</dt>
      <dd>Policy.new(
  :verify_data      =&gt; true,
  :verify_signer    =&gt; false,
  :verify_chain     =&gt; false,
  :verify_root      =&gt; false,
  :only_trusted     =&gt; false,
  :only_signed      =&gt; false
)</dd>
    
      <dt id="HighSecurity-constant">HighSecurity</dt>
      <dd>Policy.new(
  :verify_data      =&gt; true,
  :verify_signer    =&gt; true,
  :verify_chain     =&gt; true,
  :verify_root      =&gt; true,
  :only_trusted     =&gt; true,
  :only_signed      =&gt; true
)</dd>
    
      <dt id="LowSecurity-constant">LowSecurity</dt>
      <dd>Policy.new(
  :verify_data      =&gt; true,
  :verify_signer    =&gt; true,
  :verify_chain     =&gt; false,
  :verify_root      =&gt; false,
  :only_trusted     =&gt; false,
  :only_signed      =&gt; false
)</dd>
    
      <dt id="MediumSecurity-constant">MediumSecurity</dt>
      <dd>Policy.new(
  :verify_data      =&gt; true,
  :verify_signer    =&gt; true,
  :verify_chain     =&gt; true,
  :verify_root      =&gt; true,
  :only_trusted     =&gt; true,
  :only_signed      =&gt; false
)</dd>
    
      <dt id="NoSecurity-constant">NoSecurity</dt>
      <dd>Policy.new(
  :verify_data      =&gt; false,
  :verify_signer    =&gt; false,
  :verify_chain     =&gt; false,
  :verify_root      =&gt; false,
  :only_trusted     =&gt; false,
  :only_signed      =&gt; false
)</dd>
    
      <dt id="OPT-constant">OPT</dt>
      <dd>{
  # private key options
  :key_algo   =&gt; Gem::SSL::PKEY_RSA,
  :key_size   =&gt; 2048,

  # public cert options
  :cert_age   =&gt; 365 * 24 * 3600, # 1 year
  :dgst_algo  =&gt; Gem::SSL::DIGEST_SHA1,

  # x509 certificate extensions
  :cert_exts  =&gt; {
    'basicConstraints'      =&gt; 'CA:FALSE',
    'subjectKeyIdentifier'  =&gt; 'hash',
    'keyUsage'              =&gt; 'keyEncipherment,dataEncipherment,digitalSignature',
},

# save the key and cert to a file in build_self_signed_cert()?
:save_key   =&gt; true,
:save_cert  =&gt; true,

# if you define either of these, then they'll be used instead of
# the output_fmt macro below
:save_key_path =&gt; nil,
:save_cert_path =&gt; nil,

# output name format for self-signed certs
:output_fmt =&gt; 'gem-%s.pem',
:munge_re   =&gt; Regexp.new(/[^a-z0-9_.-]+/),

# output directory for trusted certificate checksums
:trust_dir =&gt; File::join(Gem.user_home, '.gem', 'trust'),

# default permissions for trust directory and certs
:perms =&gt; {
  :trust_dir      =&gt; 0700,
  :trusted_cert   =&gt; 0600,
  :signing_cert   =&gt; 0600,
  :signing_key    =&gt; 0600,
},
}</dd>
    
      <dt id="Policies-constant">Policies</dt>
      <dd>{
  'NoSecurity'       =&gt; NoSecurity,
  'AlmostNoSecurity' =&gt; AlmostNoSecurity,
  'LowSecurity'      =&gt; LowSecurity,
  'MediumSecurity'   =&gt; MediumSecurity,
  'HighSecurity'     =&gt; HighSecurity,
}</dd>
    
  </dl>
</div>

</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Class Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#add_trusted_cert-class_method">add_trusted_cert</span><span class='args'>(cert, opt = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Add certificate to trusted cert list.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#build_cert-class_method">build_cert</span><span class='args'>(name, key, opt = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Build a certificate from the given DN and private key.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#build_self_signed_cert-class_method">build_self_signed_cert</span><span class='args'>(email_addr, opt = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Build a self-signed certificate for the given email address.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#sign_cert-class_method">sign_cert</span><span class='args'>(cert, signing_key, signing_cert, opt = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Sign the cert cert with @signing_key and @signing_cert, using the digest
algorithm opt[:dgst_algo].
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#verify_trust_dir-class_method">verify_trust_dir</span><span class='args'>(path, perms)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Make sure the trust directory exists.
</p>

        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Class Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>add_trusted_cert</h3>
</div><div id="add_trusted_cert-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>add_trusted_cert</span><span class='args'>(cert, opt = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Add certificate to trusted cert list.
</p>
<p>
Note: At the moment these are stored in OPT[:trust_dir], although that
directory may change in the future.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubygems/security.rb', line 727</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5/lib/rubygems/security.rb#L727">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='add_trusted_cert identifier id'>add_trusted_cert</span><span class='lparen token'>(</span><span class='cert identifier id'>cert</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='OPT constant id'>OPT</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='rparen token'>)</span>

  <span class='comment val'># get destination path</span>
  <span class='path identifier id'>path</span> <span class='assign token'>=</span> <span class='Gem constant id'>Gem</span><span class='colon2 op'>::</span><span class='Security constant id'>Security</span><span class='colon2 op'>::</span><span class='Policy constant id'>Policy</span><span class='dot token'>.</span><span class='trusted_cert_path identifier id'>trusted_cert_path</span><span class='lparen token'>(</span><span class='cert identifier id'>cert</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span><span class='rparen token'>)</span>

  <span class='comment val'># verify trust directory (can't write to nowhere, you know)</span>
  <span class='verify_trust_dir identifier id'>verify_trust_dir</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:trust_dir</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:perms</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:trust_dir</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

  <span class='comment val'># write cert to output file</span>
  <span class='File constant id'>File</span><span class='dot token'>.</span><span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='comma token'>,</span> <span class='string val'>'wb'</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='file identifier id'>file</span><span class='bitor op'>|</span>
    <span class='file identifier id'>file</span><span class='dot token'>.</span><span class='chmod identifier id'>chmod</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:perms</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:trusted_cert</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
    <span class='file identifier id'>file</span><span class='dot token'>.</span><span class='write identifier id'>write</span><span class='lparen token'>(</span><span class='cert identifier id'>cert</span><span class='dot token'>.</span><span class='to_pem identifier id'>to_pem</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># return nil</span>
  <span class='nil nil kw'>nil</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>build_cert</h3>
</div><div id="build_cert-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>build_cert</span><span class='args'>(name, key, opt = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Build a certificate from the given DN and private key.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubygems/security.rb', line 642</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5/lib/rubygems/security.rb#L642">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='build_cert identifier id'>build_cert</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='key identifier id'>key</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='Gem constant id'>Gem</span><span class='dot token'>.</span><span class='ensure_ssl_available identifier id'>ensure_ssl_available</span>
  <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='OPT constant id'>OPT</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='rparen token'>)</span>

  <span class='comment val'># create new cert</span>
  <span class='ret identifier id'>ret</span> <span class='assign token'>=</span> <span class='OpenSSL constant id'>OpenSSL</span><span class='colon2 op'>::</span><span class='X509 constant id'>X509</span><span class='colon2 op'>::</span><span class='Certificate constant id'>Certificate</span><span class='dot token'>.</span><span class='new identifier id'>new</span>

  <span class='comment val'># populate cert attributes</span>
  <span class='ret identifier id'>ret</span><span class='dot token'>.</span><span class='version identifier id'>version</span> <span class='assign token'>=</span> <span class='integer val'>2</span>
  <span class='ret identifier id'>ret</span><span class='dot token'>.</span><span class='serial identifier id'>serial</span> <span class='assign token'>=</span> <span class='integer val'>0</span>
  <span class='ret identifier id'>ret</span><span class='dot token'>.</span><span class='public_key identifier id'>public_key</span> <span class='assign token'>=</span> <span class='key identifier id'>key</span><span class='dot token'>.</span><span class='public_key identifier id'>public_key</span>
  <span class='ret identifier id'>ret</span><span class='dot token'>.</span><span class='not_before identifier id'>not_before</span> <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span>
  <span class='ret identifier id'>ret</span><span class='dot token'>.</span><span class='not_after identifier id'>not_after</span> <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span> <span class='plus op'>+</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:cert_age</span><span class='rbrack token'>]</span>
  <span class='ret identifier id'>ret</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span> <span class='assign token'>=</span> <span class='name identifier id'>name</span>

  <span class='comment val'># add certificate extensions</span>
  <span class='ef identifier id'>ef</span> <span class='assign token'>=</span> <span class='OpenSSL constant id'>OpenSSL</span><span class='colon2 op'>::</span><span class='X509 constant id'>X509</span><span class='colon2 op'>::</span><span class='ExtensionFactory constant id'>ExtensionFactory</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='ret identifier id'>ret</span><span class='rparen token'>)</span>
  <span class='ret identifier id'>ret</span><span class='dot token'>.</span><span class='extensions identifier id'>extensions</span> <span class='assign token'>=</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:cert_exts</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='k identifier id'>k</span><span class='comma token'>,</span> <span class='v identifier id'>v</span><span class='bitor op'>|</span> <span class='ef identifier id'>ef</span><span class='dot token'>.</span><span class='create_extension identifier id'>create_extension</span><span class='lparen token'>(</span><span class='k identifier id'>k</span><span class='comma token'>,</span> <span class='v identifier id'>v</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>

  <span class='comment val'># sign cert</span>
  <span class='i_key identifier id'>i_key</span><span class='comma token'>,</span> <span class='i_cert identifier id'>i_cert</span> <span class='assign token'>=</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:issuer_key</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='key identifier id'>key</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:issuer_cert</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='ret identifier id'>ret</span>
  <span class='ret identifier id'>ret</span> <span class='assign token'>=</span> <span class='sign_cert identifier id'>sign_cert</span><span class='lparen token'>(</span><span class='ret identifier id'>ret</span><span class='comma token'>,</span> <span class='i_key identifier id'>i_key</span><span class='comma token'>,</span> <span class='i_cert identifier id'>i_cert</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span><span class='rparen token'>)</span>

  <span class='comment val'># return cert</span>
  <span class='ret identifier id'>ret</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>build_self_signed_cert</h3>
</div><div id="build_self_signed_cert-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>build_self_signed_cert</span><span class='args'>(email_addr, opt = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Build a self-signed certificate for the given email address.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubygems/security.rb', line 672</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5/lib/rubygems/security.rb#L672">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='build_self_signed_cert identifier id'>build_self_signed_cert</span><span class='lparen token'>(</span><span class='email_addr identifier id'>email_addr</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='Gem constant id'>Gem</span><span class='dot token'>.</span><span class='ensure_ssl_available identifier id'>ensure_ssl_available</span>
  <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='OPT constant id'>OPT</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='rparen token'>)</span>
  <span class='path identifier id'>path</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span> <span class='symbol val'>:key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='symbol val'>:cert</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='nil nil kw'>nil</span> <span class='rbrace token'>}</span>

  <span class='comment val'># split email address up</span>
  <span class='cn identifier id'>cn</span><span class='comma token'>,</span> <span class='dcs identifier id'>dcs</span> <span class='assign token'>=</span> <span class='email_addr identifier id'>email_addr</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>'@'</span><span class='rparen token'>)</span>
  <span class='dcs identifier id'>dcs</span> <span class='assign token'>=</span> <span class='dcs identifier id'>dcs</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>'.'</span><span class='rparen token'>)</span>

  <span class='comment val'># munge email CN and DCs</span>
  <span class='cn identifier id'>cn</span> <span class='assign token'>=</span> <span class='cn identifier id'>cn</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:munge_re</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='string val'>'_'</span><span class='rparen token'>)</span>
  <span class='dcs identifier id'>dcs</span> <span class='assign token'>=</span> <span class='dcs identifier id'>dcs</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='dc identifier id'>dc</span><span class='bitor op'>|</span> <span class='dc identifier id'>dc</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:munge_re</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='string val'>'_'</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>

  <span class='comment val'># create DN</span>
  <span class='name identifier id'>name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;CN=#{cn}/&quot;</span> <span class='lshft op'>&lt;&lt;</span> <span class='dcs identifier id'>dcs</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='dc identifier id'>dc</span><span class='bitor op'>|</span> <span class='dstring node'>&quot;DC=#{dc}&quot;</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>'/'</span><span class='rparen token'>)</span>
  <span class='name identifier id'>name</span> <span class='assign token'>=</span> <span class='OpenSSL constant id'>OpenSSL</span><span class='colon2 op'>::</span><span class='X509 constant id'>X509</span><span class='colon2 op'>::</span><span class='Name constant id'>Name</span><span class='colon2 op'>::</span><span class='parse identifier id'>parse</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='rparen token'>)</span>

  <span class='comment val'># build private key</span>
  <span class='key identifier id'>key</span> <span class='assign token'>=</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:key_algo</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:key_size</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

  <span class='comment val'># method name pretty much says it all :)</span>
  <span class='verify_trust_dir identifier id'>verify_trust_dir</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:trust_dir</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:perms</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:trust_dir</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>

  <span class='comment val'># if we're saving the key, then write it out</span>
  <span class='if if kw'>if</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:save_key</span><span class='rbrack token'>]</span>
    <span class='path identifier id'>path</span><span class='lbrack token'>[</span><span class='symbol val'>:key</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:save_key_path</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:output_fmt</span><span class='rbrack token'>]</span> <span class='mod op'>%</span> <span class='string val'>'private_key'</span><span class='rparen token'>)</span>
    <span class='File constant id'>File</span><span class='dot token'>.</span><span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='lbrack token'>[</span><span class='symbol val'>:key</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='string val'>'wb'</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='file identifier id'>file</span><span class='bitor op'>|</span>
      <span class='file identifier id'>file</span><span class='dot token'>.</span><span class='chmod identifier id'>chmod</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:perms</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:signing_key</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='file identifier id'>file</span><span class='dot token'>.</span><span class='write identifier id'>write</span><span class='lparen token'>(</span><span class='key identifier id'>key</span><span class='dot token'>.</span><span class='to_pem identifier id'>to_pem</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># build self-signed public cert from key</span>
  <span class='cert identifier id'>cert</span> <span class='assign token'>=</span> <span class='build_cert identifier id'>build_cert</span><span class='lparen token'>(</span><span class='name identifier id'>name</span><span class='comma token'>,</span> <span class='key identifier id'>key</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span><span class='rparen token'>)</span>

  <span class='comment val'># if we're saving the cert, then write it out</span>
  <span class='if if kw'>if</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:save_cert</span><span class='rbrack token'>]</span>
    <span class='path identifier id'>path</span><span class='lbrack token'>[</span><span class='symbol val'>:cert</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:save_cert_path</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:output_fmt</span><span class='rbrack token'>]</span> <span class='mod op'>%</span> <span class='string val'>'public_cert'</span><span class='rparen token'>)</span>
    <span class='File constant id'>File</span><span class='dot token'>.</span><span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='lbrack token'>[</span><span class='symbol val'>:cert</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='string val'>'wb'</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='file identifier id'>file</span><span class='bitor op'>|</span>
      <span class='file identifier id'>file</span><span class='dot token'>.</span><span class='chmod identifier id'>chmod</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:perms</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:signing_cert</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
      <span class='file identifier id'>file</span><span class='dot token'>.</span><span class='write identifier id'>write</span><span class='lparen token'>(</span><span class='cert identifier id'>cert</span><span class='dot token'>.</span><span class='to_pem identifier id'>to_pem</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># return key, cert, and paths (if applicable)</span>
  <span class='lbrace token'>{</span> <span class='symbol val'>:key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='key identifier id'>key</span><span class='comma token'>,</span> <span class='symbol val'>:cert</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='cert identifier id'>cert</span><span class='comma token'>,</span>
    <span class='symbol val'>:key_path</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='path identifier id'>path</span><span class='lbrack token'>[</span><span class='symbol val'>:key</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='symbol val'>:cert_path</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='path identifier id'>path</span><span class='lbrack token'>[</span><span class='symbol val'>:cert</span><span class='rbrack token'>]</span> <span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>sign_cert</h3>
</div><div id="sign_cert-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>sign_cert</span><span class='args'>(cert, signing_key, signing_cert, opt = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Sign the cert cert with @signing_key and @signing_cert, using the digest
algorithm opt[:dgst_algo]. Returns the newly signed certificate.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubygems/security.rb', line 608</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5/lib/rubygems/security.rb#L608">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">608
609
610
611
612
613
614
615
616</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='sign_cert identifier id'>sign_cert</span><span class='lparen token'>(</span><span class='cert identifier id'>cert</span><span class='comma token'>,</span> <span class='signing_key identifier id'>signing_key</span><span class='comma token'>,</span> <span class='signing_cert identifier id'>signing_cert</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='OPT constant id'>OPT</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='rparen token'>)</span>

  <span class='comment val'># set up issuer information</span>
  <span class='cert identifier id'>cert</span><span class='dot token'>.</span><span class='issuer identifier id'>issuer</span> <span class='assign token'>=</span> <span class='signing_cert identifier id'>signing_cert</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span>
  <span class='cert identifier id'>cert</span><span class='dot token'>.</span><span class='sign identifier id'>sign</span><span class='lparen token'>(</span><span class='signing_key identifier id'>signing_key</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:dgst_algo</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='rparen token'>)</span>

  <span class='cert identifier id'>cert</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>verify_trust_dir</h3>
</div><div id="verify_trust_dir-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>verify_trust_dir</span><span class='args'>(path, perms)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Make sure the trust directory exists. If it does exist, make sure
it&#8217;s actually a directory. If not, then create it with the
appropriate permissions.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubygems/security.rb', line 623</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5/lib/rubygems/security.rb#L623">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">623
624
625
626
627
628
629
630
631
632
633
634
635
636
637</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='verify_trust_dir identifier id'>verify_trust_dir</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='comma token'>,</span> <span class='perms identifier id'>perms</span><span class='rparen token'>)</span>
  <span class='comment val'># if the directory exists, then make sure it is in fact a directory.  if</span>
  <span class='comment val'># it doesn't exist, then create it with the appropriate permissions</span>
  <span class='if if kw'>if</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
    <span class='comment val'># verify that the trust directory is actually a directory</span>
    <span class='unless unless kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='directory? fid id'>directory?</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
      <span class='err identifier id'>err</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;trust directory #{path} isn't a directory&quot;</span>
      <span class='raise identifier id'>raise</span> <span class='Gem constant id'>Gem</span><span class='colon2 op'>::</span><span class='Security constant id'>Security</span><span class='colon2 op'>::</span><span class='Exception constant id'>Exception</span><span class='comma token'>,</span> <span class='err identifier id'>err</span>
    <span class='end end kw'>end</span>
  <span class='else else kw'>else</span>
    <span class='comment val'># trust directory doesn't exist, so create it with permissions</span>
    <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='mkdir_p identifier id'>mkdir_p</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>
    <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='chmod identifier id'>chmod</span><span class='lparen token'>(</span><span class='perms identifier id'>perms</span><span class='comma token'>,</span> <span class='path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> 2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
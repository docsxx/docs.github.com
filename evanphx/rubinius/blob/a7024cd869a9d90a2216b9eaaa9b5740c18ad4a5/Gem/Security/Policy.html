<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>evanphx's rubinius - Class: Gem::Security::Policy - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/evanphx/commits/rubinius/master" rel="alternate" title="Recent Commits to rubinius:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("evanphx", "rubinius", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("evanphx", "rubinius", "a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/evanphx/rubinius/tree/">Source</a></li>
            <li class=""><a href="http://github.com/evanphx/rubinius/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/evanphx/rubinius/network">Network</a></li>            
            <li class=""><a href="http://github.com/evanphx/rubinius/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/evanphx/rubinius">Wiki</a></li>
            <li class=""><a href="http://github.com/evanphx/rubinius/graphs">Graphs</a></li>                    
            <li class="active"><a href="/evanphx/rubinius">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/evanphx">evanphx</a> / <b><a href="http://github.com/evanphx/rubinius/tree">rubinius</a></b>        
                <a id="namespaces_button" rel="evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section class Gem_Security_Policy">
  <h1>Class: Gem::Security::Policy</h1>
  <div class="section docstring">
  <p>
A Gem::Security::Policy object encapsulates the settings for verifying
signed gem files. This is the base class. You can either declare an
instance of this or use one of the preset security policies below.
</p>

</div><div class="section attributes">
  
    <div class="">
      <h2>Instance Attributes</h2>
      <table>
      
        <tr>
          <th class="name">only_signed</td>
          <td class="readwrite">
            [<span id='only_signed-instance_method'>R</span><span id='only_signed=-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Sets the attribute <tt>only_signed</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">only_trusted</td>
          <td class="readwrite">
            [<span id='only_trusted-instance_method'>R</span><span id='only_trusted=-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Sets the attribute <tt>only_trusted</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">verify_chain</td>
          <td class="readwrite">
            [<span id='verify_chain-instance_method'>R</span><span id='verify_chain=-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Sets the attribute <tt>verify_chain</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">verify_data</td>
          <td class="readwrite">
            [<span id='verify_data-instance_method'>R</span><span id='verify_data=-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Sets the attribute <tt>verify_data</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">verify_root</td>
          <td class="readwrite">
            [<span id='verify_root-instance_method'>R</span><span id='verify_root=-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Sets the attribute <tt>verify_root</tt>.
</p>

            
          </td>
        </tr>
      
        <tr>
          <th class="name">verify_signer</td>
          <td class="readwrite">
            [<span id='verify_signer-instance_method'>R</span><span id='verify_signer=-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Sets the attribute <tt>verify_signer</tt>.
</p>

            
          </td>
        </tr>
      
      </table>
    </div>
  
</div><div class="section constants">
  
</div><div class="section constructor">
<h2>Constructor</h2>
  <div id="initialize-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>initialize</span><span class='args'>(policy = {}, opt = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Create a new Gem::Security::Policy object with the given mode and options.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubygems/security.rb', line 381</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5/lib/rubygems/security.rb#L381">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='policy identifier id'>policy</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='comment val'># set options</span>
  <span class='@opt ivar id'>@opt</span> <span class='assign token'>=</span> <span class='Gem constant id'>Gem</span><span class='colon2 op'>::</span><span class='Security constant id'>Security</span><span class='colon2 op'>::</span><span class='OPT constant id'>OPT</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='rparen token'>)</span>

  <span class='comment val'># build policy</span>
  <span class='policy identifier id'>policy</span><span class='dot token'>.</span><span class='each_pair identifier id'>each_pair</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='key identifier id'>key</span><span class='comma token'>,</span> <span class='val identifier id'>val</span><span class='bitor op'>|</span>
    <span class='case case kw'>case</span> <span class='key identifier id'>key</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:verify_data</span>   <span class='then then kw'>then</span> <span class='@verify_data ivar id'>@verify_data</span>   <span class='assign token'>=</span> <span class='val identifier id'>val</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:verify_signer</span> <span class='then then kw'>then</span> <span class='@verify_signer ivar id'>@verify_signer</span> <span class='assign token'>=</span> <span class='val identifier id'>val</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:verify_chain</span>  <span class='then then kw'>then</span> <span class='@verify_chain ivar id'>@verify_chain</span>  <span class='assign token'>=</span> <span class='val identifier id'>val</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:verify_root</span>   <span class='then then kw'>then</span> <span class='@verify_root ivar id'>@verify_root</span>   <span class='assign token'>=</span> <span class='val identifier id'>val</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:only_trusted</span>  <span class='then then kw'>then</span> <span class='@only_trusted ivar id'>@only_trusted</span>  <span class='assign token'>=</span> <span class='val identifier id'>val</span>
    <span class='when when kw'>when</span> <span class='symbol val'>:only_signed</span>   <span class='then then kw'>then</span> <span class='@only_signed ivar id'>@only_signed</span>   <span class='assign token'>=</span> <span class='val identifier id'>val</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Class Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#trusted_cert_path-class_method">trusted_cert_path</span><span class='args'>(cert, opt = {})</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Get the path to the file for this cert.
</p>

        
      </td>
    </tr>
  
</table>
  </div>
  <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#verify_gem-instance_method">#verify_gem</span><span class='args'>(signature, data, chain, time = Time.now)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Verify that the gem data with the given signature and signing chain matched
this security policy at the specified time.
</p>

        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Class Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>trusted_cert_path</h3>
</div><div id="trusted_cert_path-class_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>trusted_cert_path</span><span class='args'>(cert, opt = {})</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Get the path to the file for this cert.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubygems/security.rb', line 401</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5/lib/rubygems/security.rb#L401">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">401
402
403
404
405
406
407
408
409
410
411
412
413</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='trusted_cert_path identifier id'>trusted_cert_path</span><span class='lparen token'>(</span><span class='cert identifier id'>cert</span><span class='comma token'>,</span> <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='opt identifier id'>opt</span> <span class='assign token'>=</span> <span class='Gem constant id'>Gem</span><span class='colon2 op'>::</span><span class='Security constant id'>Security</span><span class='colon2 op'>::</span><span class='OPT constant id'>OPT</span><span class='dot token'>.</span><span class='merge identifier id'>merge</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='rparen token'>)</span>

  <span class='comment val'># get digest algorithm, calculate checksum of root.subject</span>
  <span class='algo identifier id'>algo</span> <span class='assign token'>=</span> <span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:dgst_algo</span><span class='rbrack token'>]</span>
  <span class='dgst identifier id'>dgst</span> <span class='assign token'>=</span> <span class='algo identifier id'>algo</span><span class='dot token'>.</span><span class='hexdigest identifier id'>hexdigest</span><span class='lparen token'>(</span><span class='cert identifier id'>cert</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span>

  <span class='comment val'># build path to trusted cert file</span>
  <span class='name identifier id'>name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;cert-#{dgst}.pem&quot;</span>

  <span class='comment val'># join and return path components</span>
  <span class='File constant id'>File</span><span class='colon2 op'>::</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='opt identifier id'>opt</span><span class='lbrack token'>[</span><span class='symbol val'>:trust_dir</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='name identifier id'>name</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div><div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>verify_gem</h3>
</div><div id="verify_gem-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>verify_gem</span><span class='args'>(signature, data, chain, time = Time.now)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Verify that the gem data with the given signature and signing chain matched
this security policy at the specified time.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubygems/security.rb', line 419</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/evanphx/rubinius/blob/a7024cd869a9d90a2216b9eaaa9b5740c18ad4a5/lib/rubygems/security.rb#L419">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='verify_gem identifier id'>verify_gem</span><span class='lparen token'>(</span><span class='signature identifier id'>signature</span><span class='comma token'>,</span> <span class='data identifier id'>data</span><span class='comma token'>,</span> <span class='chain identifier id'>chain</span><span class='comma token'>,</span> <span class='time identifier id'>time</span> <span class='assign token'>=</span> <span class='Time constant id'>Time</span><span class='dot token'>.</span><span class='now identifier id'>now</span><span class='rparen token'>)</span>
  <span class='Gem constant id'>Gem</span><span class='dot token'>.</span><span class='ensure_ssl_available identifier id'>ensure_ssl_available</span>
  <span class='cert_class identifier id'>cert_class</span> <span class='assign token'>=</span> <span class='OpenSSL constant id'>OpenSSL</span><span class='colon2 op'>::</span><span class='X509 constant id'>X509</span><span class='colon2 op'>::</span><span class='Certificate constant id'>Certificate</span>
  <span class='exc identifier id'>exc</span> <span class='assign token'>=</span> <span class='Gem constant id'>Gem</span><span class='colon2 op'>::</span><span class='Security constant id'>Security</span><span class='colon2 op'>::</span><span class='Exception constant id'>Exception</span>
  <span class='chain identifier id'>chain</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='chain identifier id'>chain</span> <span class='assign token'>=</span> <span class='chain identifier id'>chain</span><span class='dot token'>.</span><span class='map identifier id'>map</span><span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='str identifier id'>str</span><span class='bitor op'>|</span> <span class='cert_class identifier id'>cert_class</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='str identifier id'>str</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
  <span class='signer identifier id'>signer</span><span class='comma token'>,</span> <span class='ch_len identifier id'>ch_len</span> <span class='assign token'>=</span> <span class='chain identifier id'>chain</span><span class='lbrack token'>[</span><span class='integer val'>-1</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='chain identifier id'>chain</span><span class='dot token'>.</span><span class='size identifier id'>size</span>

  <span class='comment val'># make sure signature is valid</span>
  <span class='if if kw'>if</span> <span class='@verify_data ivar id'>@verify_data</span>
    <span class='comment val'># get digest algorithm (TODO: this should be configurable)</span>
    <span class='dgst identifier id'>dgst</span> <span class='assign token'>=</span> <span class='@opt ivar id'>@opt</span><span class='lbrack token'>[</span><span class='symbol val'>:dgst_algo</span><span class='rbrack token'>]</span>

    <span class='comment val'># verify the data signature (this is the most important part, so don't</span>
    <span class='comment val'># screw it up :D)</span>
    <span class='v identifier id'>v</span> <span class='assign token'>=</span> <span class='signer identifier id'>signer</span><span class='dot token'>.</span><span class='public_key identifier id'>public_key</span><span class='dot token'>.</span><span class='verify identifier id'>verify</span><span class='lparen token'>(</span><span class='dgst identifier id'>dgst</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='comma token'>,</span> <span class='signature identifier id'>signature</span><span class='comma token'>,</span> <span class='data identifier id'>data</span><span class='rparen token'>)</span>
    <span class='raise identifier id'>raise</span> <span class='exc identifier id'>exc</span><span class='comma token'>,</span> <span class='string val'>&quot;Invalid Gem Signature&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='v identifier id'>v</span>

    <span class='comment val'># make sure the signer is valid</span>
    <span class='if if kw'>if</span> <span class='@verify_signer ivar id'>@verify_signer</span>
      <span class='comment val'># make sure the signing cert is valid right now</span>
      <span class='v identifier id'>v</span> <span class='assign token'>=</span> <span class='signer identifier id'>signer</span><span class='dot token'>.</span><span class='check_validity identifier id'>check_validity</span><span class='lparen token'>(</span><span class='nil nil kw'>nil</span><span class='comma token'>,</span> <span class='time identifier id'>time</span><span class='rparen token'>)</span>
      <span class='raise identifier id'>raise</span> <span class='exc identifier id'>exc</span><span class='comma token'>,</span> <span class='dstring node'>&quot;Invalid Signature: #{v[:desc]}&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='v identifier id'>v</span><span class='lbrack token'>[</span><span class='symbol val'>:is_valid</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># make sure the certificate chain is valid</span>
  <span class='if if kw'>if</span> <span class='@verify_chain ivar id'>@verify_chain</span>
    <span class='comment val'># iterate down over the chain and verify each certificate against it's</span>
    <span class='comment val'># issuer</span>
    <span class='lparen token'>(</span><span class='ch_len identifier id'>ch_len</span> <span class='minus op'>-</span> <span class='integer val'>1</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='downto identifier id'>downto</span><span class='lparen token'>(</span><span class='integer val'>1</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span>
      <span class='issuer identifier id'>issuer</span><span class='comma token'>,</span> <span class='cert identifier id'>cert</span> <span class='assign token'>=</span> <span class='chain identifier id'>chain</span><span class='lbrack token'>[</span><span class='i identifier id'>i</span> <span class='minus op'>-</span> <span class='integer val'>1</span><span class='comma token'>,</span> <span class='integer val'>2</span><span class='rbrack token'>]</span>
      <span class='v identifier id'>v</span> <span class='assign token'>=</span> <span class='cert identifier id'>cert</span><span class='dot token'>.</span><span class='check_validity identifier id'>check_validity</span><span class='lparen token'>(</span><span class='issuer identifier id'>issuer</span><span class='comma token'>,</span> <span class='time identifier id'>time</span><span class='rparen token'>)</span>
      <span class='raise identifier id'>raise</span> <span class='exc identifier id'>exc</span><span class='comma token'>,</span> <span class='string val'>&quot;%s: cert = '%s', error = '%s'&quot;</span> <span class='mod op'>%</span> <span class='lbrack token'>[</span>
          <span class='string val'>'Invalid Signing Chain'</span><span class='comma token'>,</span> <span class='cert identifier id'>cert</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span><span class='comma token'>,</span> <span class='v identifier id'>v</span><span class='lbrack token'>[</span><span class='symbol val'>:desc</span><span class='rbrack token'>]</span>
      <span class='rbrack token'>]</span> <span class='unless unless_mod kw'>unless</span> <span class='v identifier id'>v</span><span class='lbrack token'>[</span><span class='symbol val'>:is_valid</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># verify root of chain</span>
    <span class='if if kw'>if</span> <span class='@verify_root ivar id'>@verify_root</span>
      <span class='comment val'># make sure root is self-signed</span>
      <span class='root identifier id'>root</span> <span class='assign token'>=</span> <span class='chain identifier id'>chain</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>
      <span class='raise identifier id'>raise</span> <span class='exc identifier id'>exc</span><span class='comma token'>,</span> <span class='string val'>&quot;%s: %s (subject = '%s', issuer = '%s')&quot;</span> <span class='mod op'>%</span> <span class='lbrack token'>[</span>
          <span class='string val'>'Invalid Signing Chain Root'</span><span class='comma token'>,</span>
          <span class='string val'>'Subject does not match Issuer for Gem Signing Chain'</span><span class='comma token'>,</span>
          <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='comma token'>,</span>
          <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='issuer identifier id'>issuer</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='comma token'>,</span>
      <span class='rbrack token'>]</span> <span class='unless unless_mod kw'>unless</span> <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='issuer identifier id'>issuer</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span> <span class='eq op'>==</span> <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>

      <span class='comment val'># make sure root is valid</span>
      <span class='v identifier id'>v</span> <span class='assign token'>=</span> <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='check_validity identifier id'>check_validity</span><span class='lparen token'>(</span><span class='root identifier id'>root</span><span class='comma token'>,</span> <span class='time identifier id'>time</span><span class='rparen token'>)</span>
      <span class='raise identifier id'>raise</span> <span class='exc identifier id'>exc</span><span class='comma token'>,</span> <span class='string val'>&quot;%s: cert = '%s', error = '%s'&quot;</span> <span class='mod op'>%</span> <span class='lbrack token'>[</span>
          <span class='string val'>'Invalid Signing Chain Root'</span><span class='comma token'>,</span> <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span><span class='comma token'>,</span> <span class='v identifier id'>v</span><span class='lbrack token'>[</span><span class='symbol val'>:desc</span><span class='rbrack token'>]</span>
      <span class='rbrack token'>]</span> <span class='unless unless_mod kw'>unless</span> <span class='v identifier id'>v</span><span class='lbrack token'>[</span><span class='symbol val'>:is_valid</span><span class='rbrack token'>]</span>

      <span class='comment val'># verify that the chain root is trusted</span>
      <span class='if if kw'>if</span> <span class='@only_trusted ivar id'>@only_trusted</span>
        <span class='comment val'># get digest algorithm, calculate checksum of root.subject</span>
        <span class='algo identifier id'>algo</span> <span class='assign token'>=</span> <span class='@opt ivar id'>@opt</span><span class='lbrack token'>[</span><span class='symbol val'>:dgst_algo</span><span class='rbrack token'>]</span>
        <span class='path identifier id'>path</span> <span class='assign token'>=</span> <span class='Gem constant id'>Gem</span><span class='colon2 op'>::</span><span class='Security constant id'>Security</span><span class='colon2 op'>::</span><span class='Policy constant id'>Policy</span><span class='dot token'>.</span><span class='trusted_cert_path identifier id'>trusted_cert_path</span><span class='lparen token'>(</span><span class='root identifier id'>root</span><span class='comma token'>,</span> <span class='@opt ivar id'>@opt</span><span class='rparen token'>)</span>

        <span class='comment val'># check to make sure trusted path exists</span>
        <span class='raise identifier id'>raise</span> <span class='exc identifier id'>exc</span><span class='comma token'>,</span> <span class='string val'>&quot;%s: cert = '%s', error = '%s'&quot;</span> <span class='mod op'>%</span> <span class='lbrack token'>[</span>
            <span class='string val'>'Untrusted Signing Chain Root'</span><span class='comma token'>,</span>
            <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='comma token'>,</span>
            <span class='dstring node'>&quot;path \&quot;#{path}\&quot; does not exist&quot;</span><span class='comma token'>,</span>
        <span class='rbrack token'>]</span> <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exist? fid id'>exist?</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span>

        <span class='comment val'># load calculate digest from saved cert file</span>
        <span class='save_cert identifier id'>save_cert</span> <span class='assign token'>=</span> <span class='OpenSSL constant id'>OpenSSL</span><span class='colon2 op'>::</span><span class='X509 constant id'>X509</span><span class='colon2 op'>::</span><span class='Certificate constant id'>Certificate</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='path identifier id'>path</span><span class='rparen token'>)</span><span class='rparen token'>)</span>
        <span class='save_dgst identifier id'>save_dgst</span> <span class='assign token'>=</span> <span class='algo identifier id'>algo</span><span class='dot token'>.</span><span class='digest identifier id'>digest</span><span class='lparen token'>(</span><span class='save_cert identifier id'>save_cert</span><span class='dot token'>.</span><span class='public_key identifier id'>public_key</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span>

        <span class='comment val'># create digest of public key</span>
        <span class='pkey_str identifier id'>pkey_str</span> <span class='assign token'>=</span> <span class='root identifier id'>root</span><span class='dot token'>.</span><span class='public_key identifier id'>public_key</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span>
        <span class='cert_dgst identifier id'>cert_dgst</span> <span class='assign token'>=</span> <span class='algo identifier id'>algo</span><span class='dot token'>.</span><span class='digest identifier id'>digest</span><span class='lparen token'>(</span><span class='pkey_str identifier id'>pkey_str</span><span class='rparen token'>)</span>

        <span class='comment val'># now compare the two digests, raise exception</span>
        <span class='comment val'># if they don't match</span>
        <span class='raise identifier id'>raise</span> <span class='exc identifier id'>exc</span><span class='comma token'>,</span> <span class='string val'>&quot;%s: %s (saved = '%s', root = '%s')&quot;</span> <span class='mod op'>%</span> <span class='lbrack token'>[</span>
            <span class='string val'>'Invalid Signing Chain Root'</span><span class='comma token'>,</span>
            <span class='string val'>&quot;Saved checksum doesn't match root checksum&quot;</span><span class='comma token'>,</span>
            <span class='save_dgst identifier id'>save_dgst</span><span class='comma token'>,</span> <span class='cert_dgst identifier id'>cert_dgst</span><span class='comma token'>,</span>
        <span class='rbrack token'>]</span> <span class='unless unless_mod kw'>unless</span> <span class='save_dgst identifier id'>save_dgst</span> <span class='eq op'>==</span> <span class='cert_dgst identifier id'>cert_dgst</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># return the signing chain</span>
    <span class='chain identifier id'>chain</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='cert identifier id'>cert</span><span class='bitor op'>|</span> <span class='cert identifier id'>cert</span><span class='dot token'>.</span><span class='subject identifier id'>subject</span> <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
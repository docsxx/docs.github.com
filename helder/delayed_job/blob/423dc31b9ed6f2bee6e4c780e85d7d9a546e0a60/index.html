<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>helder's delayed_job - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/helder/commits/delayed_job/master" rel="alternate" title="Recent Commits to delayed_job:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("helder", "delayed_job", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='helder/delayed_job/blob/423dc31b9ed6f2bee6e4c780e85d7d9a546e0a60' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='helder/delayed_job/blob/423dc31b9ed6f2bee6e4c780e85d7d9a546e0a60' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("helder", "delayed_job", "423dc31b9ed6f2bee6e4c780e85d7d9a546e0a60", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/helder/delayed_job/tree/">Source</a></li>
            <li class=""><a href="http://github.com/helder/delayed_job/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/helder/delayed_job/network">Network</a></li>            
            <li class=""><a href="http://github.com/helder/delayed_job/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/helder/delayed_job">Wiki</a></li>
            <li class=""><a href="http://github.com/helder/delayed_job/graphs">Graphs</a></li>                    
            <li class="active"><a href="/helder/delayed_job">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/helder">helder</a> / <b><a href="http://github.com/helder/delayed_job/tree">delayed_job</a></b>        
                <a id="namespaces_button" rel="helder/delayed_job/blob/423dc31b9ed6f2bee6e4c780e85d7d9a546e0a60" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="helder/delayed_job/blob/423dc31b9ed6f2bee6e4c780e85d7d9a546e0a60" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="section docstring readme wikistyle">
  <h1>Delayed::Job</h1>
<p>Delated_job (or DJ) encapsulates the common pattern of asynchronously executing longer tasks in the background.</p>
<p>It is a direct extraction from Shopify where the job table is responsible for a multitude of core tasks. Amongst those tasks are:</p>
<ul>
	<li>sending massive newsletters</li>
	<li>image resizing</li>
	<li>http downloads</li>
	<li>updating smart collections</li>
	<li>updating solr, our search server, after product changes</li>
	<li>batch imports</li>
	<li>spam checks <br />
            <br />
h2. Setup<br />
            <br />
The library evolves around a delayed_jobs table which looks as follows:</li>
</ul>
create_table :delayed_jobs, :force =&gt; true do |table|
table.integer  :priority, :default =&gt; 0      # Allows some jobs to jump to the front of the queue
table.integer  :attempts, :default =&gt; 0      # Provides for retries, but still fail eventually.
table.text     :handler                      # <span class="caps">YAML</span>-encoded string of the object that will do work
table.string   :last_error                   # reason for last failure (See Note below)
table.datetime :run_at                       # When to run. Could be Time.now for immediately, or sometime in the future.
table.datetime :locked_at                    # Set when a client is working on this object
table.datetime :failed_at                    # Set when all retries have failed (actually, by default, the record is deleted instead)
table.string   :locked_by                    # Who is working on this object (if locked)
table.datetime :first_started_at		 # When first worker picked it up
table.datetime :last_started_at		 # When last worker picked it up (same as first_started_at when no retries)
table.datetime :finished_at			 # Used for statiscics / monitoring
table.timestamps
end
<p>On failure, the job is scheduled again in 5 seconds + N ** 4, where N is the number of retries.</p>
<p>The default MAX_ATTEMPTS is 25. After this, the job is either deleted (default), or left in the database with &#8220;failed_at&#8221; set.<br />
With the default of 25 attempts, the last retry will be 20 days later, with the last interval being almost 100 hours.</p>
<p>The default MAX_RUN_TIME is 4.hours. If your job takes longer than that, another computer could pick it up. It&#8217;s up to you to<br />
make sure your job doesn&#8217;t exceed this time. You should set this to the longest time you think the job could take.</p>
<p>By default, it will delete failed jobs. If you want to keep failed jobs, set<br />
<code>Delayed::Job.destroy_failed_jobs = false</code>. The failed jobs will be marked with non-null failed_at.</p>
<p>Same thing for successful jobs. They&#8217;re deleted by default and, to keep them, set <code>Delayed::Job.destroy_successful_jobs = false</code>. They will be marked with finished_at. This is useful for gathering statistics like how long a job took:</p>
<ul>
	<li>to be picked up by the first worker: first_started_at &#8211; created_at</li>
	<li>in one successful run (the last one that didn&#8217;t fail): finished_at &#8211; last_started_at</li>
	<li>in failed retries: last_started_at &#8211; first_started_at</li>
</ul>
<p>Here is an example of changing job parameters in Rails:</p>
<pre class="code">
  <span class='comment val'># config/initializers/delayed_job_config.rb</span>
  <span class='Delayed constant id'>Delayed</span><span class='colon2 op'>::</span><span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='destroy_failed_jobs identifier id'>destroy_failed_jobs</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='Delayed constant id'>Delayed</span><span class='colon2 op'>::</span><span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='destroy_successful_jobs identifier id'>destroy_successful_jobs</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='silence_warnings identifier id'>silence_warnings</span> <span class='do do kw'>do</span>
    <span class='Delayed constant id'>Delayed</span><span class='colon2 op'>::</span><span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='const_set identifier id'>const_set</span><span class='lparen token'>(</span><span class='string val'>&quot;MAX_ATTEMPTS&quot;</span><span class='comma token'>,</span> <span class='integer val'>3</span><span class='rparen token'>)</span>
    <span class='Delayed constant id'>Delayed</span><span class='colon2 op'>::</span><span class='Job constant id'>Job</span><span class='dot token'>.</span><span class='const_set identifier id'>const_set</span><span class='lparen token'>(</span><span class='string val'>&quot;MAX_RUN_TIME&quot;</span><span class='comma token'>,</span> <span class='float val'>5</span><span class='dot token'>.</span><span class='minutes identifier id'>minutes</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
</pre>
<p>Note: If your error messages are long, consider changing last_error field to a :text instead of a :string (255 character limit).</p>
<h2>Usage</h2>
<p>Jobs are simple ruby objects with a method called perform. Any object which responds to perform can be stuffed into the jobs table.<br />
Job objects are serialized to yaml so that they can later be resurrected by the job runner.</p>
class NewsletterJob &lt; Struct.new(:text, :emails)
def perform
emails.each { |e| NewsletterMailer.deliver_text_to_email(text, e) }
end
end

Delayed::Job.enqueue NewsletterJob.new(&#8216;lorem ipsum&#8230;&#8217;, Customers.find(:all).collect(&amp;:email))

<p>There is also a second way to get jobs in the queue: send_later.</p>

BatchImporter.new(Shop.find(1)).send_later(:import_massive_csv, massive_csv)

<p>This will simply create a Delayed::PerformableMethod job in the jobs table which serializes all the parameters you pass to it. There are some special smarts for active record objects<br />
which are stored as their text representation and loaded from the database fresh when the job is actually run later.<br />
                                                                                                                              <br />
                                                                                                                    <br />
h2. Running the jobs</p>
<p>You can invoke <code>rake jobs:work</code> which will start working off jobs. You can cancel the rake task with <code>CTRL-C</code>.</p>
<p>You can also run by writing a simple <code>script/job_runner</code>, and invoking it externally:<br />
  <br />
<pre class="code">
  <span class='comment val'>#!/usr/bin/env ruby</span>
  <span class='require identifier id'>require</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='__FILE__ __file__ kw'>__FILE__</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>'/../config/environment'</span>
  
  <span class='Delayed constant id'>Delayed</span><span class='colon2 op'>::</span><span class='Worker constant id'>Worker</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='dot token'>.</span><span class='start identifier id'>start</span>  
</pre></p>
<p>Workers can be running on any computer, as long as they have access to the database and their clock is in sync. You can even<br />
run multiple workers on per computer, but you must give each one a unique name. (<span class="caps">TODO</span>: put in an example)<br />
Keep in mind that each worker will check the database at least every 5 seconds.</p>
<p>Note: The rake task will exit if the database has any network connectivity problems.</p>
<h3>Cleaning up</h3>
<p>You can invoke <code>rake jobs:clear</code> to delete all jobs in the queue. There are also the self-explanatory <code>rake jobs:clear:finished</code> and <code>rake jobs:clear:failed</code>.</p>
<h3>Changes</h3>
<ul>
	<li>1.7.0: Added failed_at column which can optionally be set after a certain amount of failed job attempts. By default failed job attempts are destroyed after about a month.</li>
</ul>
<ul>
	<li>1.6.0: Renamed locked_until to locked_at. We now store when we start a given job instead of how long it will be locked by the worker. This allows us to get a reading on how long a job took to execute.</li>
</ul>
<ul>
	<li>1.5.0: Job runners can now be run in parallel. Two new database columns are needed: locked_until and locked_by. This allows us to use   pessimistic locking instead of relying on row level locks. This enables us to run as many worker processes as we need to speed up queue processing.</li>
</ul>
<ul>
	<li>1.2.0: Added #send_later to Object for simpler job creation</li>
</ul>
<ul>
	<li>1.0.0: Initial release</li>
</ul>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> Â©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
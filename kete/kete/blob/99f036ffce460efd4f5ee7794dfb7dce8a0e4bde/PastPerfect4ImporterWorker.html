<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>kete's kete - Class: PastPerfect4ImporterWorker - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/kete/commits/kete/master" rel="alternate" title="Recent Commits to kete:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    GitHubRepo.init("kete", "kete", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='kete/kete/blob/99f036ffce460efd4f5ee7794dfb7dce8a0e4bde' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='kete/kete/blob/99f036ffce460efd4f5ee7794dfb7dce8a0e4bde' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("kete", "kete", "99f036ffce460efd4f5ee7794dfb7dce8a0e4bde", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/kete/kete/tree/">Source</a></li>
            <li class=""><a href="http://github.com/kete/kete/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/kete/kete/network">Network</a></li>            
            <li class=""><a href="http://github.com/kete/kete/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/kete/kete">Wiki</a></li>
            <li class=""><a href="http://github.com/kete/kete/graphs">Graphs</a></li>                    
            <li class="active"><a href="/kete/kete">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/kete">kete</a> / <b><a href="http://github.com/kete/kete/tree">kete</a></b>        
                <a id="namespaces_button" rel="kete/kete/blob/99f036ffce460efd4f5ee7794dfb7dce8a0e4bde" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="kete/kete/blob/99f036ffce460efd4f5ee7794dfb7dce8a0e4bde" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section class PastPerfect4ImporterWorker">
  <h1>Class: PastPerfect4ImporterWorker</h1>
  <div class="section inheritance">
  <ul>
  <li>BackgrounDRb::MetaWorker</li><ul><li>PastPerfect4ImporterWorker</li>
  </ul></ul>
</div><div class="section mixins">
  <h2>Included Modules</h2>
  <p><a href="PastPerfect4ImporterWorker/Importer.html" title="Importer">Importer</a></p>
</div><div class="section docstring">
  <p>
past perfect 4 xml output importer only handling photos for the moment
needs accompanying archives.xml file to create topics to group photos by
review http://development.kete.net.nz/kete/tickets/66 for details right now
we create a topic for the collection (ACCESSNO from image) and add related
images to it see OBJECTID goes to user_reference
</p>

</div><div class="section constants">
  
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#create-instance_method">#create</span><span class='args'>(args = nil)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#create_new_item_from_record-instance_method">#create_new_item_from_record</span><span class='args'>(record, zoom_class, options = )</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
customized in this worker to override importer module version expects an
xml element of our record.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#determine_elements_used-instance_method">#determine_elements_used</span><span class='args'>(in_file)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
set up the correct xml paths to use based on what is in the source file.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#do_work-instance_method">#do_work</span><span class='args'>(args = nil)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#importer_process-instance_method">#importer_process</span><span class='args'>(record, params)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>create</h3>
</div><div id="create-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>create</span><span class='args'>(args = nil)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/workers/past_perfect4_importer_worker.rb', line 20</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/kete/kete/blob/master/lib/workers/past_perfect4_importer_worker.rb#L20">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">20
21
22
23
24
25</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='args identifier id'>args</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='rparen token'>)</span>
  <span class='importer_simple_setup identifier id'>importer_simple_setup</span>

  <span class='@last_related_topic ivar id'>@last_related_topic</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='@last_related_topic_pp4_objectid ivar id'>@last_related_topic_pp4_objectid</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>create_new_item_from_record</h3>
</div><div id="create_new_item_from_record-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>create_new_item_from_record</span><span class='args'>(record, zoom_class, options = )</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
customized in this worker to override importer module version expects an
xml element of our record
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/workers/past_perfect4_importer_worker.rb', line 303</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/kete/kete/blob/master/lib/workers/past_perfect4_importer_worker.rb#L303">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='create_new_item_from_record identifier id'>create_new_item_from_record</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='comma token'>,</span> <span class='zoom_class identifier id'>zoom_class</span><span class='comma token'>,</span> <span class='options identifier id'>options</span> <span class='assign token'>=</span> <span class='semicolon token'>;</span><span class='lbrace token'>{</span><span class='rbrace token'>}</span><span class='rparen token'>)</span>
  <span class='zoom_class_for_params identifier id'>zoom_class_for_params</span> <span class='assign token'>=</span> <span class='zoom_class identifier id'>zoom_class</span><span class='dot token'>.</span><span class='tableize identifier id'>tableize</span><span class='dot token'>.</span><span class='singularize identifier id'>singularize</span>

  <span class='params identifier id'>params</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:params</span><span class='rbrack token'>]</span>

  <span class='comment val'># initialize the subhash in params</span>
  <span class='comment val'># clears it out if it does already</span>
  <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='Hash constant id'>Hash</span><span class='dot token'>.</span><span class='new identifier id'>new</span>

  <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:basket_id</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='@current_basket ivar id'>@current_basket</span><span class='dot token'>.</span><span class='id identifier id'>id</span>

  <span class='comment val'># check extended_field.import_field_synonyms</span>
  <span class='comment val'># for which extended field to map the import_field to</span>
  <span class='comment val'># special cases for title, short_summary, and description</span>
  <span class='record_hash identifier id'>record_hash</span> <span class='assign token'>=</span> <span class='Hash constant id'>Hash</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='if if kw'>if</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='record_hash identifier id'>record_hash</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='record_hash identifier id'>record_hash</span> <span class='assign token'>=</span> <span class='Hash constant id'>Hash</span><span class='dot token'>.</span><span class='from_xml identifier id'>from_xml</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span>

    <span class='comment val'># HACK to go down one more level</span>
    <span class='record_hash identifier id'>record_hash</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='record_field identifier id'>record_field</span><span class='bitor op'>|</span>
      <span class='record_hash identifier id'>record_hash</span> <span class='assign token'>=</span> <span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='record_field identifier id'>record_field</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>
  <span class='else else kw'>else</span>
    <span class='record_hash identifier id'>record_hash</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:record_hash</span><span class='rbrack token'>]</span>
  <span class='end end kw'>end</span>

  <span class='field_count identifier id'>field_count</span> <span class='assign token'>=</span> <span class='integer val'>1</span>
  <span class='tag_list_array identifier id'>tag_list_array</span> <span class='assign token'>=</span> <span class='Array constant id'>Array</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='comment val'># add support for all items during this import getting a set of tags</span>
  <span class='comment val'># added to every item in addition to the specific ones for the item</span>
  <span class='tag_list_array identifier id'>tag_list_array</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='base_tags identifier id'>base_tags</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>&quot;,&quot;</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='base_tags identifier id'>base_tags</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>

  <span class='record_hash identifier id'>record_hash</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='record_field identifier id'>record_field</span><span class='bitor op'>|</span>
    <span class='value identifier id'>value</span> <span class='assign token'>=</span> <span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='record_field identifier id'>record_field</span><span class='rbrack token'>]</span>
    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='value identifier id'>value</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='value identifier id'>value</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span><span class='dot token'>.</span><span class='strip identifier id'>strip</span>
      <span class='comment val'># replace \r with \n</span>
      <span class='value identifier id'>value</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='regexp val'>/\r/</span><span class='comma token'>,</span> <span class='string val'>&quot;\n&quot;</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='value identifier id'>value</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>

      <span class='case case kw'>case</span> <span class='record_field identifier id'>record_field</span>
      <span class='when when kw'>when</span> <span class='string val'>&quot;TITLE&quot;</span>
        <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:title</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span>
      <span class='when when kw'>when</span> <span class='mult op'>*</span><span class='DESCRIPTION_SYNONYMS constant id'>DESCRIPTION_SYNONYMS</span>
        <span class='if if kw'>if</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='description identifier id'>description</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
          <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span>
        <span class='else else kw'>else</span>
          <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='opasgn op'>+=</span> <span class='string val'>&quot;\n\n&quot;</span> <span class='plus op'>+</span> <span class='value identifier id'>value</span>
        <span class='end end kw'>end</span>
      <span class='when when kw'>when</span> <span class='mult op'>*</span><span class='TAGS_SYNONYMS constant id'>TAGS_SYNONYMS</span>
        <span class='if if kw'>if</span> <span class='record_field identifier id'>record_field</span> <span class='eq op'>==</span> <span class='string val'>&quot;PEOPLE&quot;</span>
          <span class='comment val'># each person is in the form: last name, first names</span>
          <span class='comment val'># one name per line</span>
          <span class='comment val'># it may have things in parentheses which we ignore</span>
          <span class='people_in_lines identifier id'>people_in_lines</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>&quot;\n&quot;</span><span class='rparen token'>)</span>
          <span class='people_in_lines identifier id'>people_in_lines</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='person identifier id'>person</span><span class='bitor op'>|</span>
            <span class='names_array identifier id'>names_array</span> <span class='assign token'>=</span> <span class='person identifier id'>person</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>&quot;,&quot;</span><span class='rparen token'>)</span>
            <span class='first_names identifier id'>first_names</span> <span class='assign token'>=</span> <span class='String constant id'>String</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
            <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='names_array identifier id'>names_array</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
              <span class='first_names identifier id'>first_names</span> <span class='assign token'>=</span> <span class='names_array identifier id'>names_array</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>&quot;(&quot;</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='strip identifier id'>strip</span>
            <span class='end end kw'>end</span>
            <span class='last_names identifier id'>last_names</span> <span class='assign token'>=</span> <span class='names_array identifier id'>names_array</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='strip identifier id'>strip</span>
            <span class='name identifier id'>name</span> <span class='assign token'>=</span> <span class='first_names identifier id'>first_names</span> <span class='plus op'>+</span> <span class='string val'>&quot; &quot;</span> <span class='plus op'>+</span> <span class='last_names identifier id'>last_names</span>
            <span class='tag_list_array identifier id'>tag_list_array</span> <span class='lshft op'>&lt;&lt;</span> <span class='name identifier id'>name</span><span class='dot token'>.</span><span class='strip identifier id'>strip</span>
          <span class='end end kw'>end</span>
        <span class='else else kw'>else</span>
          <span class='tag_list_array identifier id'>tag_list_array</span> <span class='lshft op'>&lt;&lt;</span> <span class='value identifier id'>value</span><span class='dot token'>.</span><span class='gsub identifier id'>gsub</span><span class='lparen token'>(</span><span class='string val'>&quot;\n&quot;</span><span class='comma token'>,</span> <span class='string val'>&quot; &quot;</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>
      <span class='when when kw'>when</span> <span class='string val'>&quot;ADMIN&quot;</span>
        <span class='if if kw'>if</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'Topic'</span> <span class='or or kw'>or</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'Document'</span>
          <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:short_summary</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span>
        <span class='else else kw'>else</span>
          <span class='if if kw'>if</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='description identifier id'>description</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
            <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='value identifier id'>value</span>
          <span class='else else kw'>else</span>
            <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='opasgn op'>+=</span> <span class='string val'>&quot;\n&quot;</span> <span class='plus op'>+</span> <span class='value identifier id'>value</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
      <span class='when when kw'>when</span> <span class='string val'>&quot;IMAGEFILE&quot;</span>
        <span class='if if kw'>if</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'StillImage'</span>
          <span class='comment val'># we do a check earlier in the script for imagefile</span>
          <span class='comment val'># so we should have something to work with here</span>
          <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:image_file</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span> <span class='symbol val'>:uploaded_data</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='copy_and_load_to_temp_file identifier id'>copy_and_load_to_temp_file</span><span class='lparen token'>(</span><span class='importer_prepare_path_to_image_file identifier id'>importer_prepare_path_to_image_file</span><span class='lparen token'>(</span><span class='value identifier id'>value</span><span class='rparen token'>)</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>
        <span class='end end kw'>end</span>
      <span class='when when kw'>when</span> <span class='string val'>&quot;OBJECTID&quot;</span>
        <span class='if if kw'>if</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'Topic'</span>
          <span class='value identifier id'>value</span> <span class='assign token'>=</span> <span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;ACCESSNO&quot;</span><span class='rbrack token'>]</span>
        <span class='end end kw'>end</span>
        <span class='params identifier id'>params</span> <span class='assign token'>=</span> <span class='importer_prepare_extended_field identifier id'>importer_prepare_extended_field</span><span class='lparen token'>(</span><span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='value identifier id'>value</span><span class='comma token'>,</span> <span class='symbol val'>:field</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='record_field identifier id'>record_field</span><span class='comma token'>,</span> <span class='symbol val'>:zoom_class_for_params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='comma token'>,</span> <span class='symbol val'>:params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='params identifier id'>params</span><span class='rparen token'>)</span>
      <span class='else else kw'>else</span>
        <span class='params identifier id'>params</span> <span class='assign token'>=</span> <span class='importer_prepare_extended_field identifier id'>importer_prepare_extended_field</span><span class='lparen token'>(</span><span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='value identifier id'>value</span><span class='comma token'>,</span> <span class='symbol val'>:field</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='record_field identifier id'>record_field</span><span class='comma token'>,</span> <span class='symbol val'>:zoom_class_for_params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='comma token'>,</span> <span class='symbol val'>:params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='params identifier id'>params</span><span class='rparen token'>)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
    <span class='field_count identifier id'>field_count</span> <span class='opasgn op'>+=</span> <span class='integer val'>1</span>
  <span class='end end kw'>end</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after fields&quot;</span><span class='rparen token'>)</span>

  <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='description_beginning_template identifier id'>description_beginning_template</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
    <span class='comment val'># append the citation to the description field</span>
    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='description identifier id'>description</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
        <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='description_beginning_template identifier id'>description_beginning_template</span> <span class='plus op'>+</span> <span class='string val'>&quot;\n\n&quot;</span> <span class='plus op'>+</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span>
    <span class='else else kw'>else</span>
      <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='description_beginning_template identifier id'>description_beginning_template</span>
    <span class='end end kw'>end</span>
  <span class='elsif elsif kw'>elsif</span> <span class='notop op'>!</span><span class='DESCRIPTION_TEMPLATE constant id'>DESCRIPTION_TEMPLATE</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='description identifier id'>description</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='DESCRIPTION_TEMPLATE constant id'>DESCRIPTION_TEMPLATE</span> <span class='plus op'>+</span> <span class='string val'>&quot;\n\n&quot;</span> <span class='plus op'>+</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span>
    <span class='else else kw'>else</span>
      <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='DESCRIPTION_TEMPLATE constant id'>DESCRIPTION_TEMPLATE</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='description_end_template identifier id'>description_end_template</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='comment val'># append the description_end_template to the description field</span>
    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='description identifier id'>description</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='opasgn op'>+=</span> <span class='string val'>&quot;\n\n&quot;</span> <span class='plus op'>+</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:description_end_template</span><span class='rbrack token'>]</span>
    <span class='else else kw'>else</span>
      <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='options identifier id'>options</span><span class='lbrack token'>[</span><span class='symbol val'>:description_end_template</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after description_end_template&quot;</span><span class='rparen token'>)</span>

  <span class='description identifier id'>description</span> <span class='assign token'>=</span> <span class='String constant id'>String</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
  <span class='comment val'># used to give use better html output for descriptions</span>
  <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='description identifier id'>description</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='description identifier id'>description</span> <span class='assign token'>=</span> <span class='RedCloth constant id'>RedCloth</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span>
    <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='description identifier id'>description</span><span class='dot token'>.</span><span class='to_html identifier id'>to_html</span>
  <span class='end end kw'>end</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after redcloth&quot;</span><span class='rparen token'>)</span>

  <span class='if if kw'>if</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'Topic'</span> <span class='or or kw'>or</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'Document'</span> <span class='andop op'>&amp;&amp;</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='short_summary identifier id'>short_summary</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='description identifier id'>description</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
      <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:short_summary</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='importer_prepare_short_summary identifier id'>importer_prepare_short_summary</span><span class='lparen token'>(</span><span class='description identifier id'>description</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after short summary&quot;</span><span class='rparen token'>)</span>

  <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:tag_list</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='tag_list_array identifier id'>tag_list_array</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='string val'>&quot;,&quot;</span><span class='rparen token'>)</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after tag list&quot;</span><span class='rparen token'>)</span>

  <span class='comment val'># add the uniform license chosen at import to this item</span>
  <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:license_id</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='license identifier id'>license</span><span class='dot token'>.</span><span class='id identifier id'>id</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='license identifier id'>license</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after license&quot;</span><span class='rparen token'>)</span>

  <span class='comment val'># clear any lingering values for @fields</span>
  <span class='comment val'># and instantiate it, in case we need it</span>
  <span class='@fields ivar id'>@fields</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>

  <span class='if if kw'>if</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'Topic'</span>
    <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:topic_type_id</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='@related_topic_type ivar id'>@related_topic_type</span><span class='dot token'>.</span><span class='id identifier id'>id</span>

    <span class='@fields ivar id'>@fields</span> <span class='assign token'>=</span> <span class='@related_topic_type ivar id'>@related_topic_type</span><span class='dot token'>.</span><span class='topic_type_to_field_mappings identifier id'>topic_type_to_field_mappings</span>

    <span class='ancestors identifier id'>ancestors</span> <span class='assign token'>=</span> <span class='TopicType constant id'>TopicType</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='@related_topic_type ivar id'>@related_topic_type</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='ancestors identifier id'>ancestors</span>

    <span class='if if kw'>if</span> <span class='ancestors identifier id'>ancestors</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='gt op'>&gt;</span> <span class='integer val'>1</span>
      <span class='ancestors identifier id'>ancestors</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='ancestor identifier id'>ancestor</span><span class='bitor op'>|</span>
        <span class='@fields ivar id'>@fields</span> <span class='assign token'>=</span> <span class='@fields ivar id'>@fields</span> <span class='plus op'>+</span> <span class='ancestor identifier id'>ancestor</span><span class='dot token'>.</span><span class='topic_type_to_field_mappings identifier id'>topic_type_to_field_mappings</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='else else kw'>else</span>
    <span class='content_type identifier id'>content_type</span> <span class='assign token'>=</span> <span class='ContentType constant id'>ContentType</span><span class='dot token'>.</span><span class='find_by_class_name identifier id'>find_by_class_name</span><span class='lparen token'>(</span><span class='zoom_class identifier id'>zoom_class</span><span class='rparen token'>)</span>
    <span class='@fields ivar id'>@fields</span> <span class='assign token'>=</span> <span class='content_type identifier id'>content_type</span><span class='dot token'>.</span><span class='content_type_to_field_mappings identifier id'>content_type_to_field_mappings</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='@fields ivar id'>@fields</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
    <span class='comment val'># we use our version of this method</span>
    <span class='comment val'># that calls xml builder directly, rather than using partial template</span>
    <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='rbrack token'>]</span>
    <span class='params identifier id'>params</span> <span class='assign token'>=</span> <span class='importer_extended_fields_update_hash_for_item identifier id'>importer_extended_fields_update_hash_for_item</span><span class='lparen token'>(</span><span class='symbol val'>:item_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='comma token'>,</span> <span class='symbol val'>:params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='params identifier id'>params</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after field set up&quot;</span><span class='rparen token'>)</span>

  <span class='comment val'># replace with something that isn't reliant on params</span>
  <span class='replacement_zoom_item_hash identifier id'>replacement_zoom_item_hash</span> <span class='assign token'>=</span> <span class='importer_extended_fields_replacement_params_hash identifier id'>importer_extended_fields_replacement_params_hash</span><span class='lparen token'>(</span><span class='symbol val'>:item_key</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='zoom_class_for_params identifier id'>zoom_class_for_params</span><span class='comma token'>,</span> <span class='symbol val'>:item_class</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='zoom_class identifier id'>zoom_class</span><span class='comma token'>,</span> <span class='symbol val'>:params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='params identifier id'>params</span><span class='rparen token'>)</span>

  <span class='new_record identifier id'>new_record</span> <span class='assign token'>=</span> <span class='Module constant id'>Module</span><span class='dot token'>.</span><span class='class_eval identifier id'>class_eval</span><span class='lparen token'>(</span><span class='zoom_class identifier id'>zoom_class</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='replacement_zoom_item_hash identifier id'>replacement_zoom_item_hash</span><span class='rparen token'>)</span>

  <span class='comment val'># we need new_image_file's file, for our embedded metadata (if enabled)</span>
  <span class='comment val'># thus we have to create it before the still image</span>
  <span class='new_image_file identifier id'>new_image_file</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='new_image_file identifier id'>new_image_file</span> <span class='assign token'>=</span> <span class='importer_add_image identifier id'>importer_add_image</span><span class='lparen token'>(</span><span class='params identifier id'>params</span><span class='comma token'>,</span> <span class='zoom_class identifier id'>zoom_class</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:image_file</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>

  <span class='comment val'># only necessary for still images, because attachment is in a child model</span>
  <span class='comment val'># if we are allowing harvesting of embedded metadata from the image_file</span>
  <span class='comment val'># we need to grab it from the image_file's file path</span>
  <span class='if if kw'>if</span> <span class='ENABLE_EMBEDDED_SUPPORT constant id'>ENABLE_EMBEDDED_SUPPORT</span> <span class='andop op'>&amp;&amp;</span> <span class='notop op'>!</span><span class='new_image_file identifier id'>new_image_file</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='andop op'>&amp;&amp;</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'StillImage'</span>
    <span class='new_record identifier id'>new_record</span><span class='dot token'>.</span><span class='populate_attributes_from_embedded_in identifier id'>populate_attributes_from_embedded_in</span><span class='lparen token'>(</span><span class='new_image_file identifier id'>new_image_file</span><span class='dot token'>.</span><span class='full_filename identifier id'>full_filename</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># if still image and new_image failed, fail</span>
  <span class='new_record_added identifier id'>new_record_added</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>
  <span class='unless unless kw'>unless</span> <span class='zoom_class identifier id'>zoom_class</span> <span class='eq op'>==</span> <span class='string val'>'StillImage'</span>
    <span class='new_record_added identifier id'>new_record_added</span> <span class='assign token'>=</span> <span class='new_record identifier id'>new_record</span><span class='dot token'>.</span><span class='save identifier id'>save</span>
  <span class='else else kw'>else</span>
    <span class='new_record_added identifier id'>new_record_added</span> <span class='assign token'>=</span> <span class='new_record identifier id'>new_record</span><span class='dot token'>.</span><span class='save identifier id'>save</span> <span class='unless unless_mod kw'>unless</span> <span class='new_image_file identifier id'>new_image_file</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
  <span class='end end kw'>end</span>

  <span class='if if kw'>if</span> <span class='new_record_added identifier id'>new_record_added</span>
    <span class='importer_add_still_image_to identifier id'>importer_add_still_image_to</span><span class='lparen token'>(</span><span class='new_image_file identifier id'>new_image_file</span><span class='comma token'>,</span> <span class='new_record identifier id'>new_record</span><span class='comma token'>,</span> <span class='zoom_class identifier id'>zoom_class</span><span class='rparen token'>)</span> <span class='unless unless_mod kw'>unless</span> <span class='new_image_file identifier id'>new_image_file</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>

    <span class='new_record identifier id'>new_record</span><span class='dot token'>.</span><span class='creator identifier id'>creator</span> <span class='assign token'>=</span> <span class='@contributing_user ivar id'>@contributing_user</span>

    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;new_record: &quot;</span> <span class='plus op'>+</span> <span class='new_record identifier id'>new_record</span><span class='dot token'>.</span><span class='inspect identifier id'>inspect</span><span class='rparen token'>)</span>
    <span class='return return kw'>return</span> <span class='new_record identifier id'>new_record</span>
  <span class='else else kw'>else</span>
    <span class='comment val'># destroy images if the record wasn't added successfully</span>
    <span class='new_image_file identifier id'>new_image_file</span><span class='dot token'>.</span><span class='destroy identifier id'>destroy</span> <span class='unless unless_mod kw'>unless</span> <span class='new_image_file identifier id'>new_image_file</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>

    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;new_record not added - save failed:&quot;</span><span class='rparen token'>)</span>
    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;what are errors on save of new record: &quot;</span> <span class='plus op'>+</span> <span class='new_record identifier id'>new_record</span><span class='dot token'>.</span><span class='errors identifier id'>errors</span><span class='dot token'>.</span><span class='inspect identifier id'>inspect</span><span class='rparen token'>)</span>
    <span class='return return kw'>return</span> <span class='nil nil kw'>nil</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>determine_elements_used</h3>
</div><div id="determine_elements_used-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>determine_elements_used</span><span class='args'>(in_file)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
set up the correct xml paths to use based on what is in the source file
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/workers/past_perfect4_importer_worker.rb', line 529</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/kete/kete/blob/master/lib/workers/past_perfect4_importer_worker.rb#L529">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='determine_elements_used identifier id'>determine_elements_used</span><span class='lparen token'>(</span><span class='in_file identifier id'>in_file</span><span class='rparen token'>)</span>
  <span class='comment val'># assume original style root element and paths</span>
  <span class='@root_element_name ivar id'>@root_element_name</span> <span class='assign token'>=</span> <span class='string val'>'Root'</span>
  <span class='@record_element_path ivar id'>@record_element_path</span> <span class='assign token'>=</span> <span class='string val'>'Information/Record'</span>
  <span class='comment val'># this should tell us what we need to know by around the second line</span>
  <span class='IO constant id'>IO</span><span class='dot token'>.</span><span class='foreach identifier id'>foreach</span><span class='lparen token'>(</span><span class='in_file identifier id'>in_file</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='line identifier id'>line</span><span class='bitor op'>|</span>
    <span class='comment val'># if exported directly from Past Perfect, should match this</span>
    <span class='comment val'># empty means no match</span>
    <span class='if if kw'>if</span> <span class='line identifier id'>line</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='string val'>&quot;&lt;VFPData&gt;&quot;</span><span class='rparen token'>)</span>
      <span class='@root_element_name ivar id'>@root_element_name</span> <span class='assign token'>=</span> <span class='string val'>'VFPData'</span>
      <span class='@record_element_path ivar id'>@record_element_path</span> <span class='assign token'>=</span> <span class='string val'>'ppdata'</span>
      <span class='return return kw'>return</span>
    <span class='else else kw'>else</span>
      <span class='comment val'># we have matched the previous style, return without resetting vars</span>
      <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='line identifier id'>line</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='string val'>&quot;&lt;Record&gt;&quot;</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>do_work</h3>
</div><div id="do_work-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>do_work</span><span class='args'>(args = nil)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/workers/past_perfect4_importer_worker.rb', line 27</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/kete/kete/blob/master/lib/workers/past_perfect4_importer_worker.rb#L27">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='do_work identifier id'>do_work</span><span class='lparen token'>(</span><span class='args identifier id'>args</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span><span class='rparen token'>)</span>
  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;in worker&quot;</span><span class='rparen token'>)</span>
  <span class='begin begin kw'>begin</span>
    <span class='@zoom_class ivar id'>@zoom_class</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:zoom_class</span><span class='rbrack token'>]</span>
    <span class='@import ivar id'>@import</span> <span class='assign token'>=</span> <span class='Import constant id'>Import</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:import</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
    <span class='@related_topic_type ivar id'>@related_topic_type</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='topic_type identifier id'>topic_type</span>
    <span class='@import_type ivar id'>@import_type</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='xml_type identifier id'>xml_type</span>
    <span class='@import_dir_path ivar id'>@import_dir_path</span> <span class='assign token'>=</span> <span class='colon3 op'>::</span><span class='Import constant id'>Import</span><span class='colon2 op'>::</span><span class='IMPORTS_DIR constant id'>IMPORTS_DIR</span> <span class='plus op'>+</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='directory identifier id'>directory</span>
    <span class='@import_parent_dir_for_image_dirs ivar id'>@import_parent_dir_for_image_dirs</span> <span class='assign token'>=</span> <span class='@import_dir_path ivar id'>@import_dir_path</span> <span class='plus op'>+</span> <span class='string val'>'/images'</span>
    <span class='@contributing_user ivar id'>@contributing_user</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='user identifier id'>user</span>
    <span class='@import_request ivar id'>@import_request</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:import_request</span><span class='rbrack token'>]</span>
    <span class='@current_basket ivar id'>@current_basket</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='basket identifier id'>basket</span>
    <span class='@description_end_templates ivar id'>@description_end_templates</span><span class='lbrack token'>[</span><span class='string val'>'default'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='default_description_end_template identifier id'>default_description_end_template</span>
    <span class='@record_interval ivar id'>@record_interval</span> <span class='assign token'>=</span> <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='interval_between_records identifier id'>interval_between_records</span>

    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after description_end_template and var assigns&quot;</span><span class='rparen token'>)</span>
    <span class='comment val'># legacy support for kete horowhenua</span>
    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='@import_request ivar id'>@import_request</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='host identifier id'>host</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='scan identifier id'>scan</span><span class='lparen token'>(</span><span class='string val'>&quot;horowhenua&quot;</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
      <span class='@description_end_templates ivar id'>@description_end_templates</span><span class='lbrack token'>[</span><span class='string val'>'default'</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='string val'>&quot;Any use of this image must be accompanied by the credit \&quot;Horowhenua Historical Society Inc.\&quot;&quot;</span>
      <span class='@description_end_templates ivar id'>@description_end_templates</span><span class='lbrack token'>[</span><span class='regexp val'>/^f\d/</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='string val'>&quot;Any use of this image must be accompanied by the credit \&quot;Foxton Historical Society\&quot;&quot;</span>
      <span class='@description_end_templates ivar id'>@description_end_templates</span><span class='lbrack token'>[</span><span class='string val'>&quot;2000\.000\.&quot;</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='string val'>&quot;Any use of this image must be accompanied by the credit \&quot;Horowhenua District Council\&quot;&quot;</span>

      <span class='@collections_to_skip ivar id'>@collections_to_skip</span> <span class='lshft op'>&lt;&lt;</span> <span class='string val'>&quot;HHS Photograph Collection&quot;</span>
    <span class='end end kw'>end</span>

    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after description_end_template reassign&quot;</span><span class='rparen token'>)</span>

    <span class='@zoom_class_for_params ivar id'>@zoom_class_for_params</span> <span class='assign token'>=</span> <span class='@zoom_class ivar id'>@zoom_class</span><span class='dot token'>.</span><span class='tableize identifier id'>tableize</span><span class='dot token'>.</span><span class='singularize identifier id'>singularize</span>

    <span class='comment val'># this may not work because of scope</span>
    <span class='params identifier id'>params</span> <span class='assign token'>=</span> <span class='args identifier id'>args</span><span class='lbrack token'>[</span><span class='symbol val'>:params</span><span class='rbrack token'>]</span>

    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;params: &quot;</span> <span class='plus op'>+</span> <span class='params identifier id'>params</span><span class='dot token'>.</span><span class='inspect identifier id'>inspect</span><span class='rparen token'>)</span>

    <span class='@import_photos_file_path ivar id'>@import_photos_file_path</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{@import_dir_path}/records.xml&quot;</span>

    <span class='comment val'># this sets the instance vars that tell us what xml element paths we are using</span>
    <span class='comment val'># old style or new style</span>
    <span class='determine_elements_used identifier id'>determine_elements_used</span><span class='lparen token'>(</span><span class='@import_photos_file_path ivar id'>@import_photos_file_path</span><span class='rparen token'>)</span>

    <span class='comment val'># this gets rid of xml elements that have empty values</span>
    <span class='@path_to_trimmed_photos ivar id'>@path_to_trimmed_photos</span> <span class='assign token'>=</span> <span class='importer_trim_fat_from_xml_import_file identifier id'>importer_trim_fat_from_xml_import_file</span><span class='lparen token'>(</span><span class='@import_photos_file_path ivar id'>@import_photos_file_path</span><span class='comma token'>,</span><span class='dstring node'>&quot;#{RAILS_ROOT}/tmp/trimmed_photos_pp4.xml&quot;</span><span class='rparen token'>)</span>
    <span class='@import_photos_xml ivar id'>@import_photos_xml</span> <span class='assign token'>=</span> <span class='REXML constant id'>REXML</span><span class='colon2 op'>::</span><span class='Document constant id'>Document</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='@path_to_trimmed_photos ivar id'>@path_to_trimmed_photos</span><span class='rparen token'>)</span>

    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after first trim&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># TODO: test what happens when there isn't an accessions.xml file</span>
    <span class='@import_accessions_file_path ivar id'>@import_accessions_file_path</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{@import_dir_path}/accessions.xml&quot;</span>
    <span class='@path_to_trimmed_accessions ivar id'>@path_to_trimmed_accessions</span> <span class='assign token'>=</span> <span class='importer_trim_fat_from_xml_import_file identifier id'>importer_trim_fat_from_xml_import_file</span><span class='lparen token'>(</span><span class='@import_accessions_file_path ivar id'>@import_accessions_file_path</span><span class='comma token'>,</span><span class='dstring node'>&quot;#{RAILS_ROOT}/tmp/trimmed_accessions_pp4.xml&quot;</span><span class='comma token'>,</span><span class='true true kw'>true</span><span class='rparen token'>)</span>

    <span class='comment val'># open the accessions xml to search for a matching record later</span>
    <span class='@import_accessions_xml ivar id'>@import_accessions_xml</span> <span class='assign token'>=</span> <span class='REXML constant id'>REXML</span><span class='colon2 op'>::</span><span class='Document constant id'>Document</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='open identifier id'>open</span><span class='lparen token'>(</span><span class='@path_to_trimmed_accessions ivar id'>@path_to_trimmed_accessions</span><span class='rparen token'>)</span>
    <span class='comment val'># this gets the first matching accession record</span>
    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;opened accession&quot;</span><span class='rparen token'>)</span>

    <span class='@import_accessions_xml_root ivar id'>@import_accessions_xml_root</span> <span class='assign token'>=</span> <span class='@import_accessions_xml ivar id'>@import_accessions_xml</span><span class='dot token'>.</span><span class='root identifier id'>root</span>

    <span class='@import ivar id'>@import</span><span class='dot token'>.</span><span class='update_attributes identifier id'>update_attributes</span><span class='lparen token'>(</span><span class='symbol val'>:status</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'in progress'</span><span class='rparen token'>)</span>

    <span class='comment val'># we work from the photos</span>
    <span class='comment val'># and grab information from the accessions file</span>
    <span class='comment val'># bases on ACCESSNO as a kind of forein key</span>
    <span class='comment val'># as we need it</span>
    <span class='@import_photos_xml ivar id'>@import_photos_xml</span><span class='dot token'>.</span><span class='elements identifier id'>elements</span><span class='dot token'>.</span><span class='each identifier id'>each</span><span class='lparen token'>(</span><span class='@root_element_name ivar id'>@root_element_name</span> <span class='plus op'>+</span> <span class='string val'>'/'</span> <span class='plus op'>+</span> <span class='@record_element_path ivar id'>@record_element_path</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='record identifier id'>record</span><span class='bitor op'>|</span>
      <span class='comment val'># we override this locally for our customizations</span>
      <span class='importer_process identifier id'>importer_process</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='comma token'>,</span> <span class='params identifier id'>params</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>
    <span class='importer_update_processing_vars_at_end identifier id'>importer_update_processing_vars_at_end</span>
  <span class='rescue rescue kw'>rescue</span>
    <span class='importer_update_processing_vars_if_rescue identifier id'>importer_update_processing_vars_if_rescue</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>importer_process</h3>
</div><div id="importer_process-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>importer_process</span><span class='args'>(record, params)</span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/workers/past_perfect4_importer_worker.rb', line 100</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/kete/kete/blob/master/lib/workers/past_perfect4_importer_worker.rb#L100">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='importer_process identifier id'>importer_process</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='comma token'>,</span> <span class='params identifier id'>params</span><span class='rparen token'>)</span>
  <span class='current_record identifier id'>current_record</span> <span class='assign token'>=</span> <span class='@results ivar id'>@results</span><span class='lbrack token'>[</span><span class='symbol val'>:records_processed</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='integer val'>1</span>
  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='dstring node'>&quot;starting record #{current_record}&quot;</span><span class='rparen token'>)</span>

  <span class='comment val'># clear this out so last related_topic</span>
  <span class='comment val'># doesn't persist</span>
  <span class='related_topic identifier id'>related_topic</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='existing_item identifier id'>existing_item</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='image_file identifier id'>image_file</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='image_objectid identifier id'>image_objectid</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='objectid identifier id'>objectid</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>

  <span class='record_hash identifier id'>record_hash</span> <span class='assign token'>=</span> <span class='importer_xml_record_to_hash identifier id'>importer_xml_record_to_hash</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='comma token'>,</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>

  <span class='comment val'># make sure there is a imagefile value</span>
  <span class='comment val'># if not, log record to skipped photos file with reason skipped</span>
  <span class='image_file identifier id'>image_file</span> <span class='assign token'>=</span> <span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;IMAGEFILE&quot;</span><span class='rbrack token'>]</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;what is image_file: &quot;</span> <span class='plus op'>+</span> <span class='image_file identifier id'>image_file</span><span class='rparen token'>)</span>

  <span class='image_objectid identifier id'>image_objectid</span> <span class='assign token'>=</span> <span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;OBJECTID&quot;</span><span class='rbrack token'>]</span>

  <span class='reason_skipped identifier id'>reason_skipped</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>

  <span class='path_to_file_to_grab identifier id'>path_to_file_to_grab</span> <span class='assign token'>=</span> <span class='importer_prepare_path_to_image_file identifier id'>importer_prepare_path_to_image_file</span><span class='lparen token'>(</span><span class='image_file identifier id'>image_file</span><span class='rparen token'>)</span>

  <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='dstring node'>&quot;record #{current_record} : path_to_file_to_grab : &quot;</span> <span class='plus op'>+</span> <span class='path_to_file_to_grab identifier id'>path_to_file_to_grab</span><span class='rparen token'>)</span>

  <span class='if if kw'>if</span> <span class='image_file identifier id'>image_file</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span> <span class='or or kw'>or</span> <span class='notop op'>!</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span><span class='lparen token'>(</span><span class='path_to_file_to_grab identifier id'>path_to_file_to_grab</span><span class='rparen token'>)</span>
    <span class='comment val'># TODO: add check to see if image_file has a, b, c, versions associated with it</span>
    <span class='comment val'># and add them is if they exist</span>
    <span class='comment val'># change record imagefile accordingly for each and call importer_process on each</span>
    <span class='reason_skipped identifier id'>reason_skipped</span> <span class='assign token'>=</span>  <span class='string val'>'no image file specified or the image file isn\'t available'</span>
    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='dstring node'>&quot;record #{current_record} : reason skipped image&quot;</span><span class='rparen token'>)</span>
  <span class='else else kw'>else</span>
    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='dstring node'>&quot;record #{current_record} : looking for topic&quot;</span><span class='rparen token'>)</span>
    <span class='comment val'># grab the relate_to_topic_id</span>
    <span class='comment val'># by getting the ACCESSNO field's value</span>
    <span class='comment val'># see if there is a matching topic already</span>
    <span class='comment val'># if not, create one from match in @import_accessions_xml</span>
    <span class='comment val'># no match, log record to skipped photos file with reason skipped</span>
    <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span> <span class='assign token'>=</span> <span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;ACCESSNO&quot;</span><span class='rbrack token'>]</span>

    <span class='if if kw'>if</span> <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='comment val'># see if we can derive the accessno from the objectid</span>
      <span class='comment val'># if we can't derive the accessno, just stick it in without</span>
      <span class='comment val'># related topic</span>
      <span class='objectid_parts identifier id'>objectid_parts</span> <span class='assign token'>=</span> <span class='image_objectid identifier id'>image_objectid</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>&quot;.&quot;</span><span class='rparen token'>)</span>
      <span class='if if kw'>if</span> <span class='objectid_parts identifier id'>objectid_parts</span><span class='dot token'>.</span><span class='size identifier id'>size</span> <span class='gt op'>&gt;</span> <span class='integer val'>2</span>
        <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span> <span class='assign token'>=</span> <span class='objectid_parts identifier id'>objectid_parts</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='string val'>&quot;.&quot;</span> <span class='plus op'>+</span> <span class='objectid_parts identifier id'>objectid_parts</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span>
      <span class='else else kw'>else</span>
        <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span> <span class='assign token'>=</span> <span class='integer val'>0</span>
        <span class='related_topic identifier id'>related_topic</span> <span class='assign token'>=</span> <span class='integer val'>0</span>
        <span class='comment val'># reason_skipped.add_text 'no ACCESSNO specified'</span>
        <span class='comment val'># logger.info(&quot;record #{current_record} : reason skipped no ACCESSNO&quot;)</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='if if kw'>if</span> <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span> <span class='neq op'>!=</span> <span class='integer val'>0</span>
      <span class='comment val'># this item has the same related_topic as the last</span>
      <span class='comment val'># don't bother looking it up again</span>
      <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='@last_related_topic_pp4_objectid ivar id'>@last_related_topic_pp4_objectid</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='and and kw'>and</span> <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span> <span class='eq op'>==</span> <span class='@last_related_topic_pp4_objectid ivar id'>@last_related_topic_pp4_objectid</span>
        <span class='related_topic identifier id'>related_topic</span> <span class='assign token'>=</span> <span class='@last_related_topic ivar id'>@last_related_topic</span>
      <span class='else else kw'>else</span>
        <span class='related_topic identifier id'>related_topic</span> <span class='assign token'>=</span> <span class='Topic constant id'>Topic</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:first</span><span class='comma token'>,</span>
                                   <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;extended_content like \'%&lt;user_reference xml_element_name=\&quot;dc:identifier\&quot;&gt;#{related_topic_pp4_objectid}&lt;/user_reference&gt;%\' AND topic_type_id = #{@related_topic_type.id}&quot;</span><span class='rparen token'>)</span>

      <span class='end end kw'>end</span>

      <span class='related_accession_record identifier id'>related_accession_record</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>

      <span class='comment val'># no existing related topic</span>
      <span class='comment val'># find the record in accessions</span>
      <span class='comment val'># and create topic from it</span>
      <span class='if if kw'>if</span> <span class='related_topic identifier id'>related_topic</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
        <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='dstring node'>&quot;record #{current_record} : no kete topic found&quot;</span><span class='rparen token'>)</span>

        <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;in creation of accession record&quot;</span><span class='rparen token'>)</span>

        <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;accession we are looking for: &quot;</span> <span class='plus op'>+</span> <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span><span class='rparen token'>)</span>

        <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='@collections_to_skip ivar id'>@collections_to_skip</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;COLLECTION&quot;</span><span class='rbrack token'>]</span><span class='rparen token'>)</span>
          <span class='comment val'># file may time out</span>
          <span class='related_accession_record identifier id'>related_accession_record</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>

          <span class='related_accession_record identifier id'>related_accession_record</span> <span class='assign token'>=</span> <span class='@import_accessions_xml_root ivar id'>@import_accessions_xml_root</span><span class='dot token'>.</span><span class='elements identifier id'>elements</span><span class='lbrack token'>[</span><span class='dstring node'>&quot;#{@record_element_path}[@ACCESSNO=\'#{related_topic_pp4_objectid}\']&quot;</span><span class='rbrack token'>]</span>
          <span class='comment val'># we have some accesion record's that are mangled</span>
          <span class='comment val'># by being three sections</span>
          <span class='comment val'># rather than two</span>
          <span class='comment val'># grab only the first two elements</span>
          <span class='comment val'># and try again before giving up</span>
          <span class='if if kw'>if</span> <span class='related_accession_record identifier id'>related_accession_record</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
            <span class='cleaned_accessno_array identifier id'>cleaned_accessno_array</span> <span class='assign token'>=</span> <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span><span class='dot token'>.</span><span class='split identifier id'>split</span><span class='lparen token'>(</span><span class='string val'>&quot;.&quot;</span><span class='rparen token'>)</span>
            <span class='cleaned_up_accessno identifier id'>cleaned_up_accessno</span> <span class='assign token'>=</span> <span class='cleaned_accessno_array identifier id'>cleaned_accessno_array</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span> <span class='plus op'>+</span> <span class='string val'>&quot;.&quot;</span> <span class='plus op'>+</span> <span class='cleaned_accessno_array identifier id'>cleaned_accessno_array</span><span class='lbrack token'>[</span><span class='integer val'>1</span><span class='rbrack token'>]</span>

            <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;looking for cleaned up accession: &quot;</span> <span class='plus op'>+</span> <span class='cleaned_up_accessno identifier id'>cleaned_up_accessno</span><span class='rparen token'>)</span>

            <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='@last_related_topic_pp4_objectid ivar id'>@last_related_topic_pp4_objectid</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='and and kw'>and</span>  <span class='cleaned_up_accessno identifier id'>cleaned_up_accessno</span> <span class='eq op'>==</span> <span class='@last_related_topic_pp4_objectid ivar id'>@last_related_topic_pp4_objectid</span>
              <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;looking for cleaned up accession: last accessno match&quot;</span><span class='rparen token'>)</span>
              <span class='related_topic identifier id'>related_topic</span> <span class='assign token'>=</span> <span class='@last_related_topic ivar id'>@last_related_topic</span>
            <span class='else else kw'>else</span>
              <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;looking for cleaned up accession: looking for existing topic&quot;</span><span class='rparen token'>)</span>
              <span class='related_topic identifier id'>related_topic</span> <span class='assign token'>=</span> <span class='Topic constant id'>Topic</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:first</span><span class='comma token'>,</span>
                                         <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;extended_content like \'%&lt;user_reference xml_element_name=\&quot;dc:identifier\&quot;&gt;#{cleaned_up_accessno}&lt;/user_reference&gt;%\' AND topic_type_id = #{@related_topic_type.id}&quot;</span><span class='rparen token'>)</span>

            <span class='end end kw'>end</span>

            <span class='if if kw'>if</span> <span class='related_topic identifier id'>related_topic</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
              <span class='related_accession_record identifier id'>related_accession_record</span> <span class='assign token'>=</span> <span class='@import_accessions_xml_root ivar id'>@import_accessions_xml_root</span><span class='dot token'>.</span><span class='elements identifier id'>elements</span><span class='lbrack token'>[</span><span class='dstring node'>&quot;#{@record_element_path}[@ACCESSNO=\'#{cleaned_up_accessno}\']&quot;</span><span class='rbrack token'>]</span>
            <span class='end end kw'>end</span>
            <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span> <span class='assign token'>=</span> <span class='cleaned_up_accessno identifier id'>cleaned_up_accessno</span>
          <span class='end end kw'>end</span>

          <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='related_accession_record identifier id'>related_accession_record</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span> <span class='and and kw'>and</span> <span class='related_topic identifier id'>related_topic</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
            <span class='accession_record_hash identifier id'>accession_record_hash</span> <span class='assign token'>=</span> <span class='importer_xml_record_to_hash identifier id'>importer_xml_record_to_hash</span><span class='lparen token'>(</span><span class='related_accession_record identifier id'>related_accession_record</span><span class='comma token'>,</span> <span class='true true kw'>true</span><span class='rparen token'>)</span>

            <span class='comment val'># create a new topic from related_accession_record</span>
            <span class='comment val'># prepare user_reference for extended_content</span>
            <span class='accession_topic identifier id'>accession_topic</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span> <span class='string val'>&quot;topic&quot;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span> <span class='symbol val'>:topic_type_id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='@related_topic_type ivar id'>@related_topic_type</span><span class='dot token'>.</span><span class='id identifier id'>id</span><span class='comma token'>,</span>
                <span class='symbol val'>:title</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;COLLECTION&quot;</span><span class='rbrack token'>]</span><span class='rbrace token'>}</span> <span class='rbrace token'>}</span>

            <span class='descrip identifier id'>descrip</span> <span class='assign token'>=</span> <span class='RedCloth constant id'>RedCloth</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='accession_record_hash identifier id'>accession_record_hash</span><span class='lbrack token'>[</span><span class='string val'>'DESCRIP'</span><span class='rbrack token'>]</span>
            <span class='accession_topic identifier id'>accession_topic</span><span class='lbrack token'>[</span><span class='string val'>&quot;topic&quot;</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:description</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='descrip identifier id'>descrip</span><span class='dot token'>.</span><span class='to_html identifier id'>to_html</span>
            <span class='accession_topic identifier id'>accession_topic</span><span class='lbrack token'>[</span><span class='string val'>&quot;topic&quot;</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:short_summary</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='importer_prepare_short_summary identifier id'>importer_prepare_short_summary</span><span class='lparen token'>(</span><span class='descrip identifier id'>descrip</span><span class='rparen token'>)</span>

            <span class='topic_params identifier id'>topic_params</span> <span class='assign token'>=</span> <span class='importer_prepare_extended_field identifier id'>importer_prepare_extended_field</span><span class='lparen token'>(</span><span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span><span class='comma token'>,</span> <span class='symbol val'>:field</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'OBJECTID'</span><span class='comma token'>,</span> <span class='symbol val'>:zoom_class_for_params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'topic'</span><span class='comma token'>,</span> <span class='symbol val'>:params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='accession_topic identifier id'>accession_topic</span><span class='rparen token'>)</span>

            <span class='related_topic identifier id'>related_topic</span> <span class='assign token'>=</span> <span class='importer_create_related_topic identifier id'>importer_create_related_topic</span><span class='lparen token'>(</span><span class='topic_params identifier id'>topic_params</span><span class='rparen token'>)</span>
            <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;after related topic creation&quot;</span><span class='rparen token'>)</span>
          <span class='end end kw'>end</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># TODO: if there is an object with a matching exactly user_reference,</span>
    <span class='comment val'># and the modified date of the import record is later</span>
    <span class='comment val'># do an update instead</span>

    <span class='comment val'># base our check on OBJECTID</span>
    <span class='objectid identifier id'>objectid</span> <span class='assign token'>=</span> <span class='record_hash identifier id'>record_hash</span><span class='lbrack token'>[</span><span class='string val'>&quot;OBJECTID&quot;</span><span class='rbrack token'>]</span>

    <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;what is objectid: &quot;</span> <span class='plus op'>+</span> <span class='objectid identifier id'>objectid</span><span class='rparen token'>)</span>

    <span class='comment val'># this relies on user_reference extended_field</span>
    <span class='comment val'># being mapped to the particular kete content type (not content type in mime sense)</span>
    <span class='comment val'># Walter McGinnis, 2008-10-10</span>
    <span class='comment val'># User Reference may be used by multiple images (all under same parent record)</span>
    <span class='comment val'># they will have different filenames, but same user reference...</span>
    <span class='comment val'># so adding filename check as criteria</span>
    <span class='existing_item identifier id'>existing_item</span> <span class='assign token'>=</span> <span class='StillImage constant id'>StillImage</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:first</span><span class='comma token'>,</span> <span class='symbol val'>:joins</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'join image_files on still_images.id = image_files.still_image_id'</span><span class='comma token'>,</span>
                                    <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='dstring node'>&quot;filename = \'#{File.basename(path_to_file_to_grab)}\' and extended_content like \'%&lt;user_reference xml_element_name=\&quot;dc:identifier\&quot;&gt;#{objectid}&lt;/user_reference&gt;%\'&quot;</span><span class='rparen token'>)</span>

    <span class='new_record identifier id'>new_record</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
    <span class='if if kw'>if</span> <span class='existing_item identifier id'>existing_item</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='comment val'># figure out the description_end_template based on the objectid</span>
      <span class='description_end_template identifier id'>description_end_template</span> <span class='assign token'>=</span> <span class='@description_end_templates ivar id'>@description_end_templates</span><span class='lbrack token'>[</span><span class='string val'>'default'</span><span class='rbrack token'>]</span>
      <span class='@description_end_templates ivar id'>@description_end_templates</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='pattern identifier id'>pattern</span><span class='comma token'>,</span> <span class='text identifier id'>text</span><span class='bitor op'>|</span>
        <span class='if if kw'>if</span> <span class='pattern identifier id'>pattern</span> <span class='neq op'>!=</span> <span class='string val'>'default'</span>
          <span class='description_end_template identifier id'>description_end_template</span> <span class='assign token'>=</span> <span class='text identifier id'>text</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='image_objectid identifier id'>image_objectid</span><span class='dot token'>.</span><span class='scan identifier id'>scan</span><span class='lparen token'>(</span><span class='pattern identifier id'>pattern</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>

      <span class='new_record identifier id'>new_record</span> <span class='assign token'>=</span> <span class='create_new_item_from_record identifier id'>create_new_item_from_record</span><span class='lparen token'>(</span><span class='record identifier id'>record</span><span class='comma token'>,</span> <span class='@zoom_class ivar id'>@zoom_class</span><span class='comma token'>,</span> <span class='lbrace token'>{</span><span class='symbol val'>:params</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='params identifier id'>params</span><span class='comma token'>,</span> <span class='symbol val'>:record_hash</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='record_hash identifier id'>record_hash</span><span class='comma token'>,</span> <span class='symbol val'>:description_end_template</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='description_end_template identifier id'>description_end_template</span> <span class='rbrace token'>}</span><span class='rparen token'>)</span>
    <span class='else else kw'>else</span>
      <span class='logger identifier id'>logger</span><span class='dot token'>.</span><span class='info identifier id'>info</span><span class='lparen token'>(</span><span class='string val'>&quot;what is existing item: &quot;</span> <span class='plus op'>+</span> <span class='existing_item identifier id'>existing_item</span><span class='dot token'>.</span><span class='id identifier id'>id</span><span class='dot token'>.</span><span class='to_s identifier id'>to_s</span><span class='rparen token'>)</span>
      <span class='comment val'># record exists in kete already</span>
      <span class='reason_skipped identifier id'>reason_skipped</span> <span class='assign token'>=</span> <span class='string val'>'kete already has a copy of this record'</span>
    <span class='end end kw'>end</span>

    <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='new_record identifier id'>new_record</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='and and kw'>and</span> <span class='notop op'>!</span><span class='new_record identifier id'>new_record</span><span class='dot token'>.</span><span class='id identifier id'>id</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>
      <span class='comment val'># we may not have a related topic, only add the relation if we do</span>
      <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='related_topic identifier id'>related_topic</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='and and kw'>and</span> <span class='related_topic identifier id'>related_topic</span> <span class='neq op'>!=</span> <span class='integer val'>0</span>
        <span class='ContentItemRelation constant id'>ContentItemRelation</span><span class='dot token'>.</span><span class='new_relation_to_topic identifier id'>new_relation_to_topic</span><span class='lparen token'>(</span><span class='related_topic identifier id'>related_topic</span><span class='dot token'>.</span><span class='id identifier id'>id</span><span class='comma token'>,</span> <span class='new_record identifier id'>new_record</span><span class='rparen token'>)</span>
        <span class='if if kw'>if</span> <span class='@last_related_topic ivar id'>@last_related_topic</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='or or kw'>or</span> <span class='related_topic identifier id'>related_topic</span><span class='dot token'>.</span><span class='id identifier id'>id</span> <span class='neq op'>!=</span> <span class='@last_related_topic ivar id'>@last_related_topic</span><span class='dot token'>.</span><span class='id identifier id'>id</span>
          <span class='comment val'># update the last topic, since we are done adding things to it for now</span>
          <span class='importer_prepare_and_save_to_zoom identifier id'>importer_prepare_and_save_to_zoom</span><span class='lparen token'>(</span><span class='related_topic identifier id'>related_topic</span><span class='rparen token'>)</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>

      <span class='importer_prepare_and_save_to_zoom identifier id'>importer_prepare_and_save_to_zoom</span><span class='lparen token'>(</span><span class='new_record identifier id'>new_record</span><span class='rparen token'>)</span>
      <span class='sleep identifier id'>sleep</span><span class='lparen token'>(</span><span class='@record_interval ivar id'>@record_interval</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='@record_interval ivar id'>@record_interval</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>

      <span class='comment val'># now that we know that we have a valid related_topic</span>
      <span class='comment val'># update @last_related_topic and @last_related_topic_pp4_objectid</span>
      <span class='@last_related_topic ivar id'>@last_related_topic</span> <span class='assign token'>=</span> <span class='related_topic identifier id'>related_topic</span>
      <span class='@last_related_topic_pp4_objectid ivar id'>@last_related_topic_pp4_objectid</span> <span class='assign token'>=</span> <span class='related_topic_pp4_objectid identifier id'>related_topic_pp4_objectid</span>

      <span class='importer_update_records_processed_vars identifier id'>importer_update_records_processed_vars</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
  <span class='comment val'># if this record was skipped, add to skipped_records</span>
  <span class='if if kw'>if</span> <span class='notop op'>!</span><span class='reason_skipped identifier id'>reason_skipped</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
    <span class='importer_log_to_skipped_records identifier id'>importer_log_to_skipped_records</span><span class='lparen token'>(</span><span class='image_file identifier id'>image_file</span><span class='comma token'>,</span><span class='reason_skipped identifier id'>reason_skipped</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
  <span class='comment val'># will this help memory leaks</span>
  <span class='record identifier id'>record</span> <span class='assign token'>=</span> <span class='nil nil kw'>nil</span>
  <span class='comment val'># give zebra and our server a small break</span>
  <span class='sleep identifier id'>sleep</span><span class='lparen token'>(</span><span class='@record_interval ivar id'>@record_interval</span><span class='rparen token'>)</span> <span class='if if_mod kw'>if</span> <span class='@record_interval ivar id'>@record_interval</span> <span class='gt op'>&gt;</span> <span class='integer val'>0</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> 2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
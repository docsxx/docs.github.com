<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>kete's kete - Module: GoogleMap::ViewHelpers - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/kete/commits/kete/master" rel="alternate" title="Recent Commits to kete:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    GitHubRepo.init("kete", "kete", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='kete/kete/blob/99f036ffce460efd4f5ee7794dfb7dce8a0e4bde' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='kete/kete/blob/99f036ffce460efd4f5ee7794dfb7dce8a0e4bde' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("kete", "kete", "99f036ffce460efd4f5ee7794dfb7dce8a0e4bde", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/kete/kete/tree/">Source</a></li>
            <li class=""><a href="http://github.com/kete/kete/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/kete/kete/network">Network</a></li>            
            <li class=""><a href="http://github.com/kete/kete/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/kete/kete">Wiki</a></li>
            <li class=""><a href="http://github.com/kete/kete/graphs">Graphs</a></li>                    
            <li class="active"><a href="/kete/kete">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/kete">kete</a> / <b><a href="http://github.com/kete/kete/tree">kete</a></b>        
                <a id="namespaces_button" rel="kete/kete/blob/99f036ffce460efd4f5ee7794dfb7dce8a0e4bde" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="kete/kete/blob/99f036ffce460efd4f5ee7794dfb7dce8a0e4bde" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section module GoogleMap_ViewHelpers">
  <h1>Module: GoogleMap::ViewHelpers</h1>
  <div class="section constants">
  
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#google_map_initializers-instance_method">#google_map_initializers</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
We use this to generate the javascript to initialize each Google Map
instance.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#load_google_map_api-instance_method">#load_google_map_api</span><span class='args'></span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        
        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>google_map_initializers</h3>
</div><div id="google_map_initializers-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>google_map_initializers</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
We use this to generate the javascript to initialize each Google Map
instance
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/google_map.rb', line 214</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/kete/kete/blob/master/lib/google_map.rb#L214">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='google_map_initializers identifier id'>google_map_initializers</span>
  <span class='comment val'># Are there any google maps to initialize on this page?</span>
  <span class='unless unless kw'>unless</span> <span class='@google_maps_list ivar id'>@google_maps_list</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
    <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='assign token'>=</span> <span class='String constant id'>String</span><span class='dot token'>.</span><span class='new identifier id'>new</span>
    <span class='@google_maps_list ivar id'>@google_maps_list</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='google_map identifier id'>google_map</span><span class='bitor op'>|</span>
      <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='google_map identifier id'>google_map</span><span class='lbrack token'>[</span><span class='symbol val'>:no_map</span><span class='rbrack token'>]</span> <span class='andop op'>&amp;&amp;</span> <span class='@google_map_on_index_or_show_page ivar id'>@google_map_on_index_or_show_page</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='string val'>&quot;initialize_google_map(&quot;</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;'#{google_map[:map_id]}'&quot;</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;, '#{google_map[:map_type]}'&quot;</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='lparen token'>(</span><span class='google_map identifier id'>google_map</span><span class='lbrack token'>[</span><span class='symbol val'>:latitude</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span> <span class='integer val'>? </span><span class='string val'>&quot;, ''&quot;</span> <span class='colon op'>:</span> <span class='dstring node'>&quot;, #{google_map[:latitude]}&quot;</span><span class='rparen token'>)</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='lparen token'>(</span><span class='google_map identifier id'>google_map</span><span class='lbrack token'>[</span><span class='symbol val'>:longitude</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span> <span class='integer val'>? </span><span class='string val'>&quot;, ''&quot;</span> <span class='colon op'>:</span> <span class='dstring node'>&quot;, #{google_map[:longitude]}&quot;</span><span class='rparen token'>)</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='lparen token'>(</span><span class='google_map identifier id'>google_map</span><span class='lbrack token'>[</span><span class='symbol val'>:zoom_lvl</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span> <span class='integer val'>? </span><span class='string val'>&quot;, ''&quot;</span> <span class='colon op'>:</span> <span class='dstring node'>&quot;, #{google_map[:zoom_lvl]}&quot;</span><span class='rparen token'>)</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='lparen token'>(</span><span class='google_map identifier id'>google_map</span><span class='lbrack token'>[</span><span class='symbol val'>:address</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span> <span class='integer val'>? </span><span class='string val'>&quot;, ''&quot;</span> <span class='colon op'>:</span> <span class='dstring node'>&quot;, '#{google_map[:address]}'&quot;</span><span class='rparen token'>)</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;, '#{google_map[:coords_field]}'&quot;</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;, '#{google_map[:zoom_lvl_field]}'&quot;</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='dstring node'>&quot;, '#{google_map[:address_field]}'&quot;</span>
      <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='opasgn op'>+=</span> <span class='string val'>&quot;);\n&quot;</span>
    <span class='end end kw'>end</span>
    <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span>
  <span class='else else kw'>else</span>
    <span class='string val'>''</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>load_google_map_api</h3>
</div><div id="load_google_map_api-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>load_google_map_api</span><span class='args'></span>
    <span class='block'></span>
  </tt>
</div>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/google_map.rb', line 238</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/kete/kete/blob/master/lib/google_map.rb#L238">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='load_google_map_api identifier id'>load_google_map_api</span>
  <span class='comment val'># Only if we are using Google Maps on this page</span>
  <span class='comment val'># By default, the variable @using_google_maps is false (except on the Add Item AJAX forms)</span>
  <span class='comment val'># It is set to true when rendering the extended fields so we don't unnessesarily load the JS</span>
  <span class='comment val'># when no fields on the page actually need it</span>
  <span class='if if kw'>if</span> <span class='@using_google_maps ivar id'>@using_google_maps</span>
    <span class='comment val'># Google maps cannot run without a configuration so make sure, if they're using Google Maps, that they configure it.</span>
    <span class='@gma_config_path ivar id'>@gma_config_path</span> <span class='assign token'>=</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='join identifier id'>join</span><span class='lparen token'>(</span><span class='RAILS_ROOT constant id'>RAILS_ROOT</span><span class='comma token'>,</span> <span class='string val'>'config/google_map_api.yml'</span><span class='rparen token'>)</span>
    <span class='return return kw'>return</span> <span class='string val'>&quot;&lt;!-- Error: Trying to use Google Maps without configuation (config/google_map_api.yml) --&gt;&quot;</span> <span class='unless unless_mod kw'>unless</span> <span class='File constant id'>File</span><span class='dot token'>.</span><span class='exists? fid id'>exists?</span><span class='lparen token'>(</span><span class='@gma_config_path ivar id'>@gma_config_path</span><span class='rparen token'>)</span>
    <span class='@gma_config ivar id'>@gma_config</span> <span class='assign token'>=</span> <span class='YAML constant id'>YAML</span><span class='dot token'>.</span><span class='load identifier id'>load</span><span class='lparen token'>(</span><span class='IO constant id'>IO</span><span class='dot token'>.</span><span class='read identifier id'>read</span><span class='lparen token'>(</span><span class='@gma_config_path ivar id'>@gma_config_path</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

    <span class='comment val'># Prepare the Google Maps needing to load</span>
    <span class='@google_maps_initializers ivar id'>@google_maps_initializers</span> <span class='assign token'>=</span> <span class='google_map_initializers identifier id'>google_map_initializers</span>

    <span class='comment val'># Get the default latitude, longitude, and zoom level just in case we need them later</span>
    <span class='unless unless kw'>unless</span> <span class='@gma_config ivar id'>@gma_config</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='google_map_api identifier id'>google_map_api</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='default_latitude identifier id'>default_latitude</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span> <span class='orop op'>||</span> <span class='@gma_config ivar id'>@gma_config</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='google_map_api identifier id'>google_map_api</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='default_longitude identifier id'>default_longitude</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
      <span class='@default_latitude ivar id'>@default_latitude</span> <span class='assign token'>=</span> <span class='@gma_config ivar id'>@gma_config</span><span class='lbrack token'>[</span><span class='symbol val'>:google_map_api</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:default_latitude</span><span class='rbrack token'>]</span>
      <span class='@default_longitude ivar id'>@default_longitude</span> <span class='assign token'>=</span> <span class='@gma_config ivar id'>@gma_config</span><span class='lbrack token'>[</span><span class='symbol val'>:google_map_api</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:default_longitude</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>
    <span class='unless unless kw'>unless</span> <span class='@gma_config ivar id'>@gma_config</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='google_map_api identifier id'>google_map_api</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='colon op'>:</span><span class='default_zoom_lvl identifier id'>default_zoom_lvl</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='blank? fid id'>blank?</span>
      <span class='@default_zoom_lvl ivar id'>@default_zoom_lvl</span> <span class='assign token'>=</span> <span class='@gma_config ivar id'>@gma_config</span><span class='lbrack token'>[</span><span class='symbol val'>:google_map_api</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:default_zoom_lvl</span><span class='rbrack token'>]</span>
    <span class='end end kw'>end</span>

    <span class='comment val'># This works, but rails tries to add a .js on the end, which invalidated the api key, so we add the format= to hackishly fix this</span>
    <span class='html identifier id'>html</span> <span class='assign token'>=</span> <span class='javascript_include_tag identifier id'>javascript_include_tag</span><span class='lparen token'>(</span><span class='dstring node'>&quot;http://www.google.com/jsapi?key=#{@gma_config[:google_map_api][:api_key]}&amp;amp;format=&quot;</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;\n&quot;</span>
    <span class='comment val'># This is where the real action happens. It's confusing so I've commented as much as possible.</span>
    <span class='html identifier id'>html</span> <span class='opasgn op'>+=</span> <span class='javascript_tag identifier id'>javascript_tag</span><span class='lparen token'>(</span><span class='dstring node'>&quot;
      // this initiates the Google Map API (version 2)
      google.load('maps', '2', {'other_params':'sensor=true'});

      // the function run when the page finishes loading, to initiate the google map
      function initialize_google_map(map_id, map_type, latitude, longitude, zoom_lvl, address, latlng_text_field, zoom_text_field, address_text_field) {
        // make sure we don't do any google map code unless the browser supports it
        if (!google.maps.BrowserIsCompatible()) {
          alert('Google Maps is not compatible with this browser. Try using Firefox 3, Internet Explorer 7, or Safari 3.'); return;
        }
        // check the google map div is present on the page before continuing
        if (!$(map_id)) {
          alert('You are trying to initiate the google map api on a non-existant div (' + map_id + '). Debug this!'); return;
        }
        // clear/resize the div on both displays, and replace the warning/hide the fields
        $(map_id).value = '';
        #{@google_map_on_index_or_show_page ? '$(map_id).setStyle({height: \'220px\'});
                                               $(latlng_text_field + \'_display\').hide();
                                               $(latlng_text_field + \'_display\').hidden_status = \'hidden\';
                                               $(latlng_text_field + \'_display_label\').hide();
                                               $(latlng_text_field + \'_show_hide\').show();
                                               $(latlng_text_field + \'_show_hide\').observe(\'click\', function(event) {
                                                 if ($(latlng_text_field + \'_display\').hidden_status == \'hidden\') {
                                                   $(latlng_text_field + \'_display\').show();
                                                   $(latlng_text_field + \'_display\').hidden_status = \'showing\';
                                                   $(latlng_text_field + \'_show_hide\').update(\'&lt;small&gt;Hide Latitude/Longitude&lt;/small&gt;\');
                                                 } else {
                                                   $(latlng_text_field + \'_display\').hide();
                                                   $(latlng_text_field + \'_display\').hidden_status = \'hidden\';
                                                   $(latlng_text_field + \'_show_hide\').update(\'&lt;small&gt;Show Latitude/Longitude&lt;/small&gt;\');
                                                 }
                                                 event.stop();
                                               });
                                               $(map_id + \'_address\').hide();' :
                                              '$(map_id).setStyle({height: \'380px\'});
                                               $(map_id + \'_warning\').hide();
                                               $(map_id + \'_fields\').hide();'}
        // initialize the google map
        var map = new google.maps.Map2($(map_id));
        // store the several objects/values in the map object for easy access
        // it also makes it possible to have different maps on the same page
        map.geocoder_obj = new google.maps.ClientGeocoder();
        map.map_type = map_type;
        map.latitude_value = latitude;
        map.longitude_value = longitude;
        map.zoom_lvl_value = zoom_lvl;
        map.latlng_text_field = latlng_text_field;
        map.zoom_text_field = zoom_text_field;
        if (map.map_type == 'map_address') {
          map.address_text_field = address;
          map.address = map_id + \'_address\';
        }
        // Make sure we have the nessesary fields present
        if (!verify_all_fields_present(map)) { return; }
        // center the map on the default latitude, longitude and zoom level
        // (comes from either params, the item being edited, or config)
        map.setCenter(new google.maps.LatLng(map.latitude_value, map.longitude_value), map.zoom_lvl_value);
        // add the small controls in the top left of the map (for moving and zooming)
        map.addControl(new google.maps.SmallMapControl());
        // if we are on the index/show page, dont show search controls, dont make markers draggable
        // else if we are on the new/edit pages, bind a search control to the map, and allow dragging
        #{@google_map_on_index_or_show_page ? 'remove_all_markers_and_add_one_to(map, map.latitude_value, map.longitude_value, false, \'\', false, map.address);' :
                                              'map.addControl(new google.maps.LocalSearch({suppressInitialResultSelection : true}),
                                               new GControlPosition(G_ANCHOR_BOTTOM_RIGHT, new GSize(10,25)));
                                               remove_all_markers_and_add_one_to(map, map.latitude_value, map.longitude_value, true);'}
        // the code from this point only executes on new/edit pages, not the show pages
        if ($(map.latlng_text_field) &amp;&amp; $(map.zoom_text_field) &amp;&amp; (map.map_type == 'map' || (map.map_type == 'map_address' &amp;&amp; $(map.address_text_field)))) {
          // make readonly
          $(map.latlng_text_field).readonly = true;
          $(map.zoom_text_field).readonly = true;
          if (map.map_type == 'map_address') {
            $(map.address_text_field).readonly = true;
          }
          // when a user clicks the map, add a marker and update the coords and zoom level
          google.maps.Event.addListener(map, 'click', function(overlay, latlng) {
            // make sure that a latitude and longitude is passed in
            if (latlng) {
              // update the map data field
              update_map_data(map, latlng);
            }
          });
          // when a user stops dragging/zooming, update the zoom level (not the coords, thats what the pinpoint is for)
          google.maps.Event.addListener(map, 'moveend', function() {
            $(map.zoom_text_field).value = map.getZoom();
          });
        }
      }

      // make sure the fields are filled in, and error out if they arn't at the end
      function verify_all_fields_present(map) {
        // If these values are blank, make one last attempt to add values to them
        // Do this by first seeing if we can get the users location, and if not
        // Use the default lat/lng/zoom in the kete's google api config file
        if (map.latitude_value == '') {
          if (google.loader.ClientLocation.latitude) { map.latitude_value = google.loader.ClientLocation.latitude; }
          else { map.latitude_value = #{@default_latitude}; }
        }
        if (map.longitude_value == '') {
          if (google.loader.ClientLocation.longitude) { map.longitude_value = google.loader.ClientLocation.longitude; }
          else { map.longitude_value = #{@default_longitude}; }
        }
        if (map.zoom_lvl_value == '') { map.zoom_lvl_value = #{@default_zoom_lvl}; }
        // If the values arn't populated by now (after 4 different sources), something went wrong.
        if (map.latitude_value == '' || map.longitude_value == '' || map.zoom_lvl_value == '') {
          alert('ERROR: One of latitude, longitude, or zoom level has not been set. Debug this!'); return false;
        }
        if ($(map.latlng_text_field) &amp;&amp; $(map.latlng_text_field).value == '') {
          $(map.latlng_text_field).value = map.latitude_value + ',' + map.longitude_value;
        }
        if ($(map.zoom_text_field) &amp;&amp; $(map.zoom_text_field).value == '') {
          $(map.zoom_text_field).value = map.zoom_lvl_value;
        }
        return true;
      }

      // remove all existing markers and one at specified latitude and longitude
      function remove_all_markers_and_add_one_to(map, latitude, longitude, draggable, text, auto_open, address_id) {
        // clears all overlays (info boxes, markers etc)
        map.clearOverlays();
        // create the marker (draggable is passed in as either true or false)
        map.current_marker = new GMarker(new GLatLng(latitude, longitude), {draggable: draggable});
        // add the marker to the map
        map.addOverlay(map.current_marker);
        // add a text bubble if needed
        if (address_id) {
          google.maps.Event.addListener(map.current_marker, 'click', function() {
            $(map.address).toggle();
          });
        } else if (text) {
           if (auto_open) {
            map.current_marker.openInfoWindowHtml(text);
          } else {
            map.current_marker.bindInfoWindowHtml(text);
          }
        }
        // when a user stops dragging the marker, update the coords and zoom level
        google.maps.Event.addListener(map.current_marker, 'dragend', function() {
          // update the map data field
          update_map_data(map, map.current_marker.getLatLng());
        });
      }

      // updates the map with a marker and text bubble with street address
      function update_map_data(map, latlng_obj) {
        // Form a a string like   -45.861836,127.398373  (which is the format we use)
        $(map.latlng_text_field).value = latlng_obj.y + ',' + latlng_obj.x;
        // the current maps zoom level
        $(map.zoom_text_field).value = map.getZoom();
        // add a marker on where the user just clicked/drag marker to
        remove_all_markers_and_add_one_to(map, latlng_obj.y, latlng_obj.x, true);
        // Attempt to get the address. When it succeeds, it'll reposition the marker to the location
        // the address corresponds to, and update the text/fields as well (to keep data current)
        map.geocoder_obj.getLocations(latlng_obj, function(response) {
          if (!response || response.Status.code != 200) {
            // if something went wrong, give the status code. This should rarely happen.
            if (response.Status.code == '602') {
              text = 'Error ' + response.Status.code + ': Something has happened.&lt;br /&gt;' +
                     'Google Maps cannot determine the location where you placed the marker.&lt;br /&gt;' +
                     'Try repositioning it nearer to a road.';
            } else {
              text = 'Error ' + response.Status.code + ': Something has happened. Please try again.'
            }
            remove_all_markers_and_add_one_to(map, latlng_obj.y, latlng_obj.x, true, text, true);
          } else {
            // get the place
            place = response.Placemark[0];
            // if the place result is accurate enough (6-10 accuracy)
            // if it isn't, we end up clicking and getting sent half way across the country
            if (place.AddressDetails.Accuracy &gt; 5) {
              // create the text used in a bubble soon
              text = '&lt;b&gt;Address:&lt;/b&gt;' + place.address + '&lt;br&gt;' +
                     '&lt;b&gt;Accuracy:&lt;/b&gt;' + place.AddressDetails.Accuracy + '&lt;br&gt;' +
                     '&lt;b&gt;Country code:&lt;/b&gt; ' + place.AddressDetails.Country.CountryNameCode;
              // remove the marker set earlier and reposition it to the results location
              remove_all_markers_and_add_one_to(map, place.Point.coordinates[1], place.Point.coordinates[0], true, text, true);
              // Form a a string like   -45.861836,127.398373  (which is the format we use)
              $(map.latlng_text_field).value = place.Point.coordinates[1] + ',' + place.Point.coordinates[0];
              // the current maps zoom level
              $(map.zoom_text_field).value = map.getZoom();
              if (map.map_type == 'map_address') {
                // the address details from the result
                $(map.address_text_field).value = place.address;
              }
            } else {
              text = 'Error: The marker wasn\\'t close enough to a&lt;br /&gt;' +
                     'road to determine the street address. Please try again'
              remove_all_markers_and_add_one_to(map, latlng_obj.y, latlng_obj.x, true, text, true);
            }
          }
        });
      }

      #{'// when the page has finished loading, then initiate the google map
        document.observe(\'dom:loaded\', function() { ' + @google_maps_initializers + ' });' unless @do_not_load_google_maps_on_page_load}
    &quot;</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;\n&quot;</span>
    <span class='comment val'># We don't need the search controls and stylesheets on the index/show, only new/edit</span>
    <span class='unless unless kw'>unless</span> <span class='@google_map_on_index_or_show_page ivar id'>@google_map_on_index_or_show_page</span>
      <span class='html identifier id'>html</span> <span class='opasgn op'>+=</span> <span class='javascript_include_tag identifier id'>javascript_include_tag</span><span class='lparen token'>(</span><span class='dstring node'>&quot;http://www.google.com/uds/api?file=uds.js&amp;amp;v=1.0&amp;amp;key=#{@gma_config[:google_map_api][:api_key]}&quot;</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;\n&quot;</span>
      <span class='html identifier id'>html</span> <span class='opasgn op'>+=</span> <span class='javascript_include_tag identifier id'>javascript_include_tag</span><span class='lparen token'>(</span><span class='string val'>&quot;http://www.google.com/uds/solutions/localsearch/gmlocalsearch&quot;</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;\n&quot;</span>
      <span class='html identifier id'>html</span> <span class='opasgn op'>+=</span> <span class='stylesheet_link_tag identifier id'>stylesheet_link_tag</span><span class='lparen token'>(</span><span class='string val'>&quot;http://www.google.com/uds/css/gsearch.css&quot;</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;\n&quot;</span>
      <span class='html identifier id'>html</span> <span class='opasgn op'>+=</span> <span class='stylesheet_link_tag identifier id'>stylesheet_link_tag</span><span class='lparen token'>(</span><span class='string val'>&quot;http://www.google.com/uds/solutions/localsearch/gmlocalsearch.css&quot;</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='string val'>&quot;\n&quot;</span>
    <span class='end end kw'>end</span>
    <span class='html identifier id'>html</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> ©2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
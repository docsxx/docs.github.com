<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>rubyrep's rubyrep - Module: RR::ReplicationExtenders::MysqlReplication - GitHub Documentation</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="">

<link rel="search" type="application/opensearchdescription+xml" href="http://github.com/opensearch.xml" title="GitHub">
<link rel="fluid-icon" href="http://github.com/fluidicon.png" title="GitHub">
<link href="http://assets0.github.com/stylesheets/bundle.css" media="screen" rel="stylesheet" type="text/css">
<link href="http://github.com/feeds/rubyrep/commits/rubyrep/master" rel="alternate" title="Recent Commits to rubyrep:master" type="application/atom+xml">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
<script type="text/javascript" src="http://assets3.github.com/javascripts/bundle.js"></script>              
<script src="../../app.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="http://docs.github.com/javascripts/md5.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/repos.js"></script>
<script type="text/javascript" src="http://docs.github.com/javascripts/commits.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    if (typeof skipHeaders != 'undefined') return;
    
    GitHubRepo.init("rubyrep", "rubyrep", function(){ 
      GitHubRepo.links = " <a id='namespaces_button' rel='rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44' href='#'><img class='button' src='http://docs.github.com/namespaces_button.png' alt='Modules and Classes'/></a> ";
      GitHubRepo.links += " <a id='methods_button' rel='rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44' href='#'><img class='button' src='http://docs.github.com/methods_button.png' alt='Methods'/></a> ";
      $("#repo").html(GitHubRepo.content());
      $('#namespaces_button').click(function(){
        var url="/"+$(this).attr('rel')+"/namespaces/";
        $.gitbox(url);
        return false;
      });    
      $('#methods_button').click(function(){
        var url="/"+$(this).attr('rel')+"/methods/";
        $.gitbox(url);
        return false;
      });        
    });
    GitHubCommit.init("rubyrep", "rubyrep", "e04c9574786262147337a9366fa8f0e77a01cc44", function(){ 
      $("#commit").html(GitHubCommit.content());
    });
  });
</script>

    <link rel="stylesheet" href="../../style.css" type="text/css" charset="utf-8" />
  </head>
  <body>    
    
    
    
        <div id="main" style="padding-bottom:8em;">
      <div id="header">
        <div class="site">
          <div class="logo">
            <a href="http://github.com/"><img src="http://github.com/images/modules/header/logov3.png" alt="github"></a>
          </div>          
          <div class="topsearch">
            <form action="http://github.com/search" id="top_search_form" method="get">
              <input class="search" name="q" type="search"> <input value="Search" type="submit">
            </form>
            <div class="links">
              <a href="http://github.com/repositories">Browse</a> | <a href="http://github.com/guides">Guides</a> | <a href="http://github.com/search">Advanced</a>
            </div>
          </div>
          <div class="actions">
            <a href="http://github.com">Home</a>
            <a href="http://github.com/plans"><b><u>Pricing and Signup</u></b></a>
            <a href="http://docs.github.com/">Documentation</a>
            <a href="https://github.com/login">Login</a>
          </div>                  
        </div>
      </div>    
                                                  
      <div id="repo_menu">
        <div class="site">
          <ul>          
            <li class=""><a href="http://github.com/rubyrep/rubyrep/tree/">Source</a></li>
            <li class=""><a href="http://github.com/rubyrep/rubyrep/commits/">Commits</a></li>            
            <li class=""><a href="http://github.com/rubyrep/rubyrep/network">Network</a></li>            
            <li class=""><a href="http://github.com/rubyrep/rubyrep/issues">Issues</a></li>
            <li class=""><a href="http://wiki.github.com/rubyrep/rubyrep">Wiki</a></li>
            <li class=""><a href="http://github.com/rubyrep/rubyrep/graphs">Graphs</a></li>                    
            <li class="active"><a href="/rubyrep/rubyrep">Documentation</a></li>
          </ul>
        </div>
      </div>

      <div id="repo_sub_menu">
        <div class="site">
          <div class="joiner"></div>      
        </div>
      </div>

      <div class="site">  
        <div id="repos">
          <div id="repo" class="repo public">
            <div class="title">
              <div class="path">
                <a href="http://github.com/rubyrep">rubyrep</a> / <b><a href="http://github.com/rubyrep/rubyrep/tree">rubyrep</a></b>        
                <a id="namespaces_button" rel="rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44" href="#"><img class="button" src="http://docs.github.com/namespaces_button.png" alt="Modules and Classes"/></a>
                <a id="methods_button" rel="rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44" href="#"><img class="button" src="http://docs.github.com/methods_button.png" alt="Methods"/></a>
              </div>
            </div>            
          </div>
          <div id="commit">
          </div> 
          <br/>                                       
          <div id="content">
            <div class="wikistyle">
  <div class="section module RR_ReplicationExtenders_MysqlReplication">
  <h1>Module: RR::ReplicationExtenders::MysqlReplication</h1>
  <div class="section docstring">
  <p>
Provides Mysql specific functionality for database replication
</p>

</div><div class="section constants">
  
</div>  <div class="section visibilitygroup">
      <div class="section methodsummary">
    <h2>Public Instance Method Summary</h2>
<table class="summary">
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#add_big_primary_key-instance_method">#add_big_primary_key</span><span class='args'>(table_name, key_name)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Adds a big (8 byte value), auto-incrementing primary key column to the
specified table.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#clear_sequence_setup-instance_method">#clear_sequence_setup</span><span class='args'>(rep_prefix, table_name)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Removes the custom sequence setup for the specified table.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#create_or_replace_replication_trigger_function-instance_method">#create_or_replace_replication_trigger_function</span><span class='args'>(params)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Creates or replaces the replication trigger function.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#create_replication_trigger-instance_method">#create_replication_trigger</span><span class='args'>(params)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Creates a trigger to log all changes for the given table.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#drop_replication_trigger-instance_method">#drop_replication_trigger</span><span class='args'>(trigger_name, table_name)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Removes a trigger and related trigger procedure.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#replication_trigger_exists-3F-instance_method">#replication_trigger_exists?</span><span class='args'>(trigger_name, table_name)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Returns <tt>true</tt> if the named trigger exists for the named table.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#sequence_values-instance_method">#sequence_values</span><span class='args'>(rep_prefix, table_name)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Returns all unadjusted sequences of the given table.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        <span class='name'><a href="#update_sequences-instance_method">#update_sequences</span><span class='args'>(rep_prefix, table_name, increment, offset, left_sequence_values, right_sequence_values, adjustment_buffer)</span>
        <span class='block'></span>
        
      </th>
      <td class="docstring">
        <p>
Ensures that the sequences of the named table (normally the primary key
column) are generated with the correct increment and offset.
</p>

        
      </td>
    </tr>
  
</table>
  </div>
<div class="section methoddetails">
  <h2>Public Instance Method Details</h2>
  
    <div class="method">
      <div class="method_header">
  <h3>add_big_primary_key</h3>
</div><div id="add_big_primary_key-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>add_big_primary_key</span><span class='args'>(table_name, key_name)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Adds a big (8 byte value), auto-incrementing primary key column to the
specified table.
</p>
<ul>
<li>table_name: name of the target table

</li>
<li>key_name: name of the primary key column

</li>
</ul>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubyrep/replication_extenders/mysql_replication.rb', line 251</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44/lib/rubyrep/replication_extenders/mysql_replication.rb#L251">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">251
252
253</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='add_big_primary_key identifier id'>add_big_primary_key</span><span class='lparen token'>(</span><span class='table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='key_name identifier id'>key_name</span><span class='rparen token'>)</span>
  <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;alter table \#{table_name} add column \#{key_name} bigint not null auto_increment primary key\n&quot;</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>clear_sequence_setup</h3>
</div><div id="clear_sequence_setup-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>clear_sequence_setup</span><span class='args'>(rep_prefix, table_name)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Removes the custom sequence setup for the specified table. If no more
rubyrep sequences are left, removes the sequence table.
</p>
<ul>
<li><tt>rep_prefix</tt>: not used (necessary) for the Postgres

</li>
<li><tt>table_name</tt>: name of the table

</li>
</ul>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubyrep/replication_extenders/mysql_replication.rb', line 262</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44/lib/rubyrep/replication_extenders/mysql_replication.rb#L262">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">262
263
264
265
266
267
268
269
270
271
272
273
274
275
276</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='clear_sequence_setup identifier id'>clear_sequence_setup</span><span class='lparen token'>(</span><span class='rep_prefix identifier id'>rep_prefix</span><span class='comma token'>,</span> <span class='table_name identifier id'>table_name</span><span class='rparen token'>)</span>
    <span class='sequence_table_name identifier id'>sequence_table_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{rep_prefix}_sequences&quot;</span>
    <span class='if if kw'>if</span> <span class='tables identifier id'>tables</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='sequence_table_name identifier id'>sequence_table_name</span><span class='rparen token'>)</span>
      <span class='trigger_name identifier id'>trigger_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{rep_prefix}_#{table_name}_sequence&quot;</span>
      <span class='trigger_row identifier id'>trigger_row</span> <span class='assign token'>=</span> <span class='select_one identifier id'>select_one</span><span class='lparen token'>(</span><span class='string val'>&quot;select * from information_schema.triggers\nwhere trigger_schema = database()\nand trigger_name = '\#{trigger_name}'\n&quot;</span><span class='rparen token'>)</span>
      <span class='if if kw'>if</span> <span class='trigger_row identifier id'>trigger_row</span>
      <span class='execute identifier id'>execute</span> <span class='dstring node'>&quot;DROP TRIGGER `#{trigger_name}`&quot;</span>
      <span class='execute identifier id'>execute</span> <span class='dstring node'>&quot;delete from #{sequence_table_name} where name = '#{table_name}'&quot;</span>
      <span class='unless unless kw'>unless</span> <span class='select_one identifier id'>select_one</span><span class='lparen token'>(</span><span class='dstring node'>&quot;select * from #{sequence_table_name}&quot;</span><span class='rparen token'>)</span>
        <span class='comment val'># no more sequences left --&gt; delete sequence table</span>
        <span class='drop_table identifier id'>drop_table</span> <span class='sequence_table_name identifier id'>sequence_table_name</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>create_or_replace_replication_trigger_function</h3>
</div><div id="create_or_replace_replication_trigger_function-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>create_or_replace_replication_trigger_function</span><span class='args'>(params)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Creates or replaces the replication trigger function. See
#create_replication_trigger for a descriptions of the <tt>params</tt> hash.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubyrep/replication_extenders/mysql_replication.rb', line 10</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44/lib/rubyrep/replication_extenders/mysql_replication.rb#L10">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">10
11
12
13
14
15
16
17
18
19
20</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='create_or_replace_replication_trigger_function identifier id'>create_or_replace_replication_trigger_function</span><span class='lparen token'>(</span><span class='params identifier id'>params</span><span class='rparen token'>)</span>
  <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;DROP PROCEDURE IF EXISTS `\#{params[:trigger_name]}`;\n&quot;</span><span class='rparen token'>)</span>
  
  <span class='activity_check identifier id'>activity_check</span> <span class='assign token'>=</span> <span class='string val'>&quot;&quot;</span>
  <span class='if if kw'>if</span> <span class='params identifier id'>params</span><span class='lbrack token'>[</span><span class='symbol val'>:exclude_rr_activity</span><span class='rbrack token'>]</span> <span class='then then kw'>then</span>
    <span class='activity_check identifier id'>activity_check</span> <span class='assign token'>=</span> <span class='string val'>&quot;DECLARE active INT;\nSELECT count(*) INTO active FROM \#{params[:activity_table]};\nIF active &lt;&gt; 0 THEN\nLEAVE p;\nEND IF;\n&quot;</span>
  <span class='end end kw'>end</span>

  <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;CREATE PROCEDURE `\#{params[:trigger_name]}`(change_key varchar(2000), change_new_key varchar(2000), change_type varchar(1))\np: BEGIN\n\#{activity_check}\nINSERT INTO \#{params[:log_table]}(change_table, change_key, change_new_key, change_type, change_time)\nVALUES('\#{params[:table]}', change_key, change_new_key, change_type, now());\nEND;\n&quot;</span><span class='rparen token'>)</span>
  
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>create_replication_trigger</h3>
</div><div id="create_replication_trigger-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>create_replication_trigger</span><span class='args'>(params)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Creates a trigger to log all changes for the given table. <tt>params</tt>
is a hash with all necessary information:
</p>
<ul>
<li>:<tt>trigger_name</tt>: name of the trigger

</li>
<li>:<tt>table</tt>: name of the table that should be monitored

</li>
<li>:<tt>keys</tt>: array of names of the key columns of the monitored table

</li>
<li>:<tt>log_table</tt>: name of the table receiving all change notifications

</li>
<li>:<tt>activity_table</tt>: name of the table receiving the rubyrep activity
information

</li>
<li>:<tt>key_sep</tt>: column seperator to be used in the key column of the log
table

</li>
<li>:<tt>exclude_rr_activity</tt>: if true, the trigger will check and filter
out changes initiated by RubyRep

</li>
</ul>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubyrep/replication_extenders/mysql_replication.rb', line 60</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44/lib/rubyrep/replication_extenders/mysql_replication.rb#L60">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='create_replication_trigger identifier id'>create_replication_trigger</span><span class='lparen token'>(</span><span class='params identifier id'>params</span><span class='rparen token'>)</span>
  <span class='create_or_replace_replication_trigger_function identifier id'>create_or_replace_replication_trigger_function</span> <span class='params identifier id'>params</span>

  <span class='dstring node'>%w(insert update delete)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='action identifier id'>action</span><span class='bitor op'>|</span>
    <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;DROP TRIGGER IF EXISTS `\#{params[:trigger_name]}_\#{action}`;\n&quot;</span><span class='rparen token'>)</span>

    <span class='comment val'># The created triggers can handle the case where the trigger procedure</span>
    <span class='comment val'># is updated (that is: temporarily deleted and recreated) while the</span>
    <span class='comment val'># trigger is running.</span>
    <span class='comment val'># For that an MySQL internal exception is raised if the trigger</span>
    <span class='comment val'># procedure cannot be found. The exception is caught by an trigger</span>
    <span class='comment val'># internal handler. </span>
    <span class='comment val'># The handler causes the trigger to retry calling the</span>
    <span class='comment val'># trigger procedure several times with short breaks in between.</span>

    <span class='trigger_var identifier id'>trigger_var</span> <span class='assign token'>=</span> <span class='action identifier id'>action</span> <span class='eq op'>==</span> <span class='string val'>'delete'</span> <span class='question op'>?</span> <span class='string val'>'OLD'</span> <span class='colon op'>:</span> <span class='string val'>'NEW'</span>
    <span class='if if kw'>if</span> <span class='action identifier id'>action</span> <span class='eq op'>==</span> <span class='string val'>'update'</span>
      <span class='call_statement identifier id'>call_statement</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;CALL `#{params[:trigger_name]}`(#{key_clause('OLD', params)}, #{key_clause('NEW', params)}, '#{action[0,1].upcase}');&quot;</span>
    <span class='else else kw'>else</span>
      <span class='call_statement identifier id'>call_statement</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;CALL `#{params[:trigger_name]}`(#{key_clause(trigger_var, params)}, null, '#{action[0,1].upcase}');&quot;</span>
    <span class='end end kw'>end</span>
    <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;CREATE TRIGGER `\#{params[:trigger_name]}_\#{action}`\nAFTER \#{action} ON `\#{params[:table]}` FOR EACH ROW BEGIN\nDECLARE number_attempts INT DEFAULT 0;\nDECLARE failed INT;\nDECLARE CONTINUE HANDLER FOR 1305 BEGIN\nDO SLEEP(0.05);\nSET failed = 1;\nSET number_attempts = number_attempts + 1;\nEND;\nREPEAT\nSET failed = 0;\n\#{call_statement}\nUNTIL failed = 0 OR number_attempts &gt;= 40 END REPEAT;\nEND;\n&quot;</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>drop_replication_trigger</h3>
</div><div id="drop_replication_trigger-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>drop_replication_trigger</span><span class='args'>(trigger_name, table_name)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Removes a trigger and related trigger procedure.
</p>
<ul>
<li><tt>trigger_name</tt>: name of the trigger

</li>
<li><tt>table_name</tt>: name of the table for which the trigger exists

</li>
</ul>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubyrep/replication_extenders/mysql_replication.rb', line 108</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44/lib/rubyrep/replication_extenders/mysql_replication.rb#L108">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">108
109
110
111
112
113</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='drop_replication_trigger identifier id'>drop_replication_trigger</span><span class='lparen token'>(</span><span class='trigger_name identifier id'>trigger_name</span><span class='comma token'>,</span> <span class='table_name identifier id'>table_name</span><span class='rparen token'>)</span>
  <span class='dstring node'>%w(insert update delete)</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='action identifier id'>action</span><span class='bitor op'>|</span>
    <span class='execute identifier id'>execute</span> <span class='dstring node'>&quot;DROP TRIGGER `#{trigger_name}_#{action}`;&quot;</span>
  <span class='end end kw'>end</span>
  <span class='execute identifier id'>execute</span> <span class='dstring node'>&quot;DROP PROCEDURE `#{trigger_name}`;&quot;</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>replication_trigger_exists?</h3>
</div><div id="replication_trigger_exists-3F-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>replication_trigger_exists?</span><span class='args'>(trigger_name, table_name)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Returns <tt>true</tt> if the named trigger exists for the named table.
</p>
<ul>
<li><tt>trigger_name</tt>: name of the trigger

</li>
<li><tt>table_name</tt>: name of the table

</li>
</ul>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubyrep/replication_extenders/mysql_replication.rb', line 118</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44/lib/rubyrep/replication_extenders/mysql_replication.rb#L118">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">118
119
120</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='replication_trigger_exists? fid id'>replication_trigger_exists?</span><span class='lparen token'>(</span><span class='trigger_name identifier id'>trigger_name</span><span class='comma token'>,</span> <span class='table_name identifier id'>table_name</span><span class='rparen token'>)</span>
  <span class='notop op'>!</span><span class='select_all identifier id'>select_all</span><span class='lparen token'>(</span><span class='dstring node'>&quot;select 1 from information_schema.triggers where trigger_schema = database() and trigger_name = '#{trigger_name}_insert' and event_object_table = '#{table_name}'&quot;</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>sequence_values</h3>
</div><div id="sequence_values-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>sequence_values</span><span class='args'>(rep_prefix, table_name)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Returns all unadjusted sequences of the given table. Parameters:
</p>
<ul>
<li><tt>rep_prefix</tt>: The prefix put in front of all replication related
database objects as specified via Configuration#options. Is used to create
the sequences table.

</li>
<li><tt>table_name</tt>: name of the table

</li>
</ul>
<p>
Return value: a hash with
</p>
<ul>
<li>key: sequence name

</li>
<li>value: a hash with

<ul>
<li>:<tt>increment</tt>: current sequence increment

</li>
<li>:<tt>value</tt>: current value

</li>
</ul>
</li>
</ul>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubyrep/replication_extenders/mysql_replication.rb', line 134</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44/lib/rubyrep/replication_extenders/mysql_replication.rb#L134">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='sequence_values identifier id'>sequence_values</span><span class='lparen token'>(</span><span class='rep_prefix identifier id'>rep_prefix</span><span class='comma token'>,</span> <span class='table_name identifier id'>table_name</span><span class='rparen token'>)</span>
  <span class='comment val'># check if the table has an auto_increment column, return if not</span>
  <span class='sequence_row identifier id'>sequence_row</span> <span class='assign token'>=</span> <span class='select_one identifier id'>select_one</span><span class='lparen token'>(</span><span class='string val'>&quot;show columns from `\#{table_name}` where extra = 'auto_increment'\n&quot;</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span> <span class='unless unless_mod kw'>unless</span> <span class='sequence_row identifier id'>sequence_row</span>
  <span class='column_name identifier id'>column_name</span> <span class='assign token'>=</span> <span class='sequence_row identifier id'>sequence_row</span><span class='lbrack token'>[</span><span class='string val'>'Field'</span><span class='rbrack token'>]</span>

  <span class='comment val'># check if the sequences table exists, create if necessary</span>
  <span class='sequence_table_name identifier id'>sequence_table_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{rep_prefix}_sequences&quot;</span>
  <span class='unless unless kw'>unless</span> <span class='tables identifier id'>tables</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='sequence_table_name identifier id'>sequence_table_name</span><span class='rparen token'>)</span>
    <span class='create_table identifier id'>create_table</span> <span class='dstring node'>&quot;#{sequence_table_name}&quot;</span><span class='dot token'>.</span><span class='to_sym identifier id'>to_sym</span><span class='comma token'>,</span>
      <span class='symbol val'>:id</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='false false kw'>false</span><span class='comma token'>,</span> <span class='symbol val'>:options</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'ENGINE=MyISAM'</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='t identifier id'>t</span><span class='bitor op'>|</span>
      <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='column identifier id'>column</span> <span class='symbol val'>:name</span><span class='comma token'>,</span> <span class='symbol val'>:string</span>
      <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='column identifier id'>column</span> <span class='symbol val'>:current_value</span><span class='comma token'>,</span> <span class='symbol val'>:integer</span>
      <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='column identifier id'>column</span> <span class='symbol val'>:increment</span><span class='comma token'>,</span> <span class='symbol val'>:integer</span>
      <span class='t identifier id'>t</span><span class='dot token'>.</span><span class='column identifier id'>column</span> <span class='symbol val'>:offset</span><span class='comma token'>,</span> <span class='symbol val'>:integer</span>
    <span class='end end kw'>end</span>
    <span class='ActiveRecord constant id'>ActiveRecord</span><span class='colon2 op'>::</span><span class='Base constant id'>Base</span><span class='dot token'>.</span><span class='connection identifier id'>connection</span><span class='dot token'>.</span><span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;ALTER TABLE \&quot;\#{sequence_table_name}\&quot;\nADD CONSTRAINT \#{sequence_table_name}_pkey\nPRIMARY KEY (name)\n&quot;</span><span class='rparen token'>)</span> <span class='rescue rescue kw'>rescue</span> <span class='nil nil kw'>nil</span>
  <span class='end end kw'>end</span>

  <span class='sequence_row identifier id'>sequence_row</span> <span class='assign token'>=</span> <span class='select_one identifier id'>select_one</span><span class='lparen token'>(</span><span class='dstring node'>&quot;select current_value, increment, offset from #{sequence_table_name} where name = '#{table_name}'&quot;</span><span class='rparen token'>)</span>
  <span class='if if kw'>if</span> <span class='sequence_row identifier id'>sequence_row</span> <span class='eq op'>==</span> <span class='nil nil kw'>nil</span>
    <span class='current_max identifier id'>current_max</span> <span class='assign token'>=</span> <span class='select_one identifier id'>select_one</span><span class='lparen token'>(</span><span class='string val'>&quot;select max(`\#{column_name}`) as current_max from `\#{table_name}`\n&quot;</span><span class='rparen token'>)</span><span class='lbrack token'>[</span><span class='string val'>'current_max'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
    <span class='return return kw'>return</span> <span class='lbrace token'>{</span><span class='column_name identifier id'>column_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span>
        <span class='symbol val'>:increment</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='integer val'>1</span><span class='comma token'>,</span>
        <span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='current_max identifier id'>current_max</span>
      <span class='rbrace token'>}</span>
    <span class='rbrace token'>}</span>
  <span class='else else kw'>else</span>
    <span class='return return kw'>return</span> <span class='lbrace token'>{</span><span class='column_name identifier id'>column_name</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lbrace token'>{</span>
        <span class='symbol val'>:increment</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='sequence_row identifier id'>sequence_row</span><span class='lbrack token'>[</span><span class='string val'>'increment'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span><span class='comma token'>,</span>
        <span class='symbol val'>:value</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='sequence_row identifier id'>sequence_row</span><span class='lbrack token'>[</span><span class='string val'>'offset'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span>
      <span class='rbrace token'>}</span>
    <span class='rbrace token'>}</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>update_sequences</h3>
</div><div id="update_sequences-instance_method" class="section method">
  <div class="details_title">
  <div class='section methodsignature'>
  <tt class='def'>
    <span class='visibility'>public</span>
    <span class='return_types'></span>
    <span class='name'>update_sequences</span><span class='args'>(rep_prefix, table_name, increment, offset, left_sequence_values, right_sequence_values, adjustment_buffer)</span>
    <span class='block'></span>
  </tt>
</div>

</div><div class="section docstring">
  <p>
Ensures that the sequences of the named table (normally the primary key
column) are generated with the correct increment and offset.
</p>
<ul>
<li><tt>rep_prefix</tt>: not used (necessary) for the Postgres

</li>
<li><tt>table_name</tt>: name of the table (not used for Postgres)

</li>
<li><tt>increment</tt>: increment of the sequence

</li>
<li><tt>offset</tt>: offset

</li>
<li><tt>left_sequence_values</tt>:

<pre class="code">
 <span class='hash identifier id'>hash</span> <span class='as identifier id'>as</span> <span class='returned identifier id'>returned</span> <span class='by identifier id'>by</span> <span class='comment val'>#sequence_values for the left database</span>
</pre>
</li>
<li><tt>right_sequence_values</tt>:

<pre class="code">
 <span class='hash identifier id'>hash</span> <span class='as identifier id'>as</span> <span class='returned identifier id'>returned</span> <span class='by identifier id'>by</span> <span class='comment val'>#sequence_values for the right database</span>
</pre>
</li>
<li><tt>adjustment_buffer</tt>:

<pre class="code">
 <span class='the identifier id'>the</span> <span class='string val'>&quot;gap&quot;</span> <span class='that identifier id'>that</span> <span class='is identifier id'>is</span> <span class='created identifier id'>created</span> <span class='during identifier id'>during</span> <span class='sequence identifier id'>sequence</span> <span class='update identifier id'>update</span> <span class='to identifier id'>to</span> <span class='avoid identifier id'>avoid</span> <span class='concurrency identifier id'>concurrency</span> <span class='problems identifier id'>problems</span>
</pre>
</li>
</ul>
<ol>
<li type="A">g. an increment of 2 and offset of 1 will lead to generation of odd

</li>
</ol>
<p>
numbers.
</p>

</div></div>
<div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="files" style="display:none">
    <div class="file">
      <div class="meta">
        <div class="info">
          <span>File 'lib/rubyrep/replication_extenders/mysql_replication.rb', line 195</span>
        </div>
        <div class="actions">      
          <a id="raw-url" href="http://github.com/rubyrep/rubyrep/blob/e04c9574786262147337a9366fa8f0e77a01cc44/lib/rubyrep/replication_extenders/mysql_replication.rb#L195">raw</a>      
        </div>
      </div>
            
      <div class="data syntax">    
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td>            
                <pre class="line_numbers">195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221</pre>
              </td>
              <td width="100%">                    
                <div class="highlight"><pre class="code"><span class='def def kw'>def</span> <span class='update_sequences identifier id'>update_sequences</span><span class='lparen token'>(</span>
    <span class='rep_prefix identifier id'>rep_prefix</span><span class='comma token'>,</span> <span class='table_name identifier id'>table_name</span><span class='comma token'>,</span> <span class='increment identifier id'>increment</span><span class='comma token'>,</span> <span class='offset identifier id'>offset</span><span class='comma token'>,</span>
    <span class='left_sequence_values identifier id'>left_sequence_values</span><span class='comma token'>,</span> <span class='right_sequence_values identifier id'>right_sequence_values</span><span class='comma token'>,</span> <span class='adjustment_buffer identifier id'>adjustment_buffer</span><span class='rparen token'>)</span>
  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='left_sequence_values identifier id'>left_sequence_values</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
  <span class='column_name identifier id'>column_name</span> <span class='assign token'>=</span> <span class='left_sequence_values identifier id'>left_sequence_values</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='lbrack token'>[</span><span class='integer val'>0</span><span class='rbrack token'>]</span>

  <span class='comment val'># check if the sequences table exists, create if necessary</span>
  <span class='sequence_table_name identifier id'>sequence_table_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{rep_prefix}_sequences&quot;</span>
  <span class='current_max identifier id'>current_max</span> <span class='assign token'>=</span>
    <span class='lbrack token'>[</span><span class='left_sequence_values identifier id'>left_sequence_values</span><span class='lbrack token'>[</span><span class='column_name identifier id'>column_name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:value</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='right_sequence_values identifier id'>right_sequence_values</span><span class='lbrack token'>[</span><span class='column_name identifier id'>column_name</span><span class='rbrack token'>]</span><span class='lbrack token'>[</span><span class='symbol val'>:value</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='max identifier id'>max</span> <span class='plus op'>+</span>
    <span class='adjustment_buffer identifier id'>adjustment_buffer</span>
  <span class='new_start identifier id'>new_start</span> <span class='assign token'>=</span> <span class='current_max identifier id'>current_max</span> <span class='minus op'>-</span> <span class='lparen token'>(</span><span class='current_max identifier id'>current_max</span> <span class='mod op'>%</span> <span class='increment identifier id'>increment</span><span class='rparen token'>)</span> <span class='plus op'>+</span> <span class='increment identifier id'>increment</span> <span class='plus op'>+</span> <span class='offset identifier id'>offset</span>

  <span class='sequence_row identifier id'>sequence_row</span> <span class='assign token'>=</span> <span class='select_one identifier id'>select_one</span><span class='lparen token'>(</span><span class='dstring node'>&quot;select current_value, increment, offset from #{sequence_table_name} where name = '#{table_name}'&quot;</span><span class='rparen token'>)</span>
  <span class='if if kw'>if</span> <span class='sequence_row identifier id'>sequence_row</span> <span class='eq op'>==</span> <span class='nil nil kw'>nil</span>
    <span class='comment val'># no sequence exists yet for the table, create it and the according</span>
    <span class='comment val'># sequence trigger</span>
    <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;insert into \#{sequence_table_name}(name, current_value, increment, offset)\nvalues('\#{table_name}', \#{new_start}, \#{increment}, \#{offset})\n&quot;</span><span class='rparen token'>)</span>
    <span class='trigger_name identifier id'>trigger_name</span> <span class='assign token'>=</span> <span class='dstring node'>&quot;#{rep_prefix}_#{table_name}_sequence&quot;</span>
    <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;DROP TRIGGER IF EXISTS `\#{trigger_name}`;\n&quot;</span><span class='rparen token'>)</span>

    <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;CREATE TRIGGER `\#{trigger_name}`\nBEFORE INSERT ON `\#{table_name}` FOR EACH ROW BEGIN\nIF NEW.`\#{column_name}` = 0 THEN\nUPDATE \#{sequence_table_name}\nSET current_value = LAST_INSERT_ID(current_value + increment)\nWHERE name = '\#{table_name}';\nSET NEW.`\#{column_name}` = LAST_INSERT_ID();\nEND IF;\nEND;\n&quot;</span><span class='rparen token'>)</span>
  <span class='elsif elsif kw'>elsif</span> <span class='sequence_row identifier id'>sequence_row</span><span class='lbrack token'>[</span><span class='string val'>'increment'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='neq op'>!=</span> <span class='increment identifier id'>increment</span> <span class='or or kw'>or</span> <span class='sequence_row identifier id'>sequence_row</span><span class='lbrack token'>[</span><span class='string val'>'offset'</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='to_i identifier id'>to_i</span> <span class='neq op'>!=</span> <span class='offset identifier id'>offset</span>
    <span class='comment val'># sequence exists but with incorrect values; update it</span>
    <span class='execute identifier id'>execute</span><span class='lparen token'>(</span><span class='string val'>&quot;update \#{sequence_table_name}\nset current_value = \#{new_start},\nincrement = \#{increment}, offset = \#{offset}\nwhere name = '\#{table_name}'\n&quot;</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre></div>          
              </td>
            </tr>
          </tbody>
        </table>    
      </div>
    </div>  
  </div>
</div>
<div>
</div>
    </div>
  
</div>
  </div>

</div>
</div>
          </div>
        </div>
      </div>                    
    </div>

    <div id="footer">
      <div class="site">
        <div class="info">
          <div class="links">
            <a href="http://github.com/blog/148-github-shirts-now-available">Shirts</a> |
            <a href="http://github.com/blog">Blog</a> |
            <a href="http://support.github.com/">Support</a> |
            <a href="http://github.com/training">Training</a> |
            <a href="http://github.com/contact">Contact</a> |
            <a href="http://groups.google.com/group/github/">Google Group</a> |
            <a href="http://develop.github.com/">API</a> |
            <a href="http://twitter.com/github">Status</a>
          </div>
          <div class="company">
            <span id="_rrt" title="0.64509s from xc88-s00039">GitHub</span>
            is <a href="http://logicalawesome.com/">Logical Awesome</a> 2009 | <a href="http://github.com/site/terms">Terms of Service</a> | <a href="http://github.com/site/privacy">Privacy Policy</a>
          </div>
        </div>
        <div class="sponsor">
          <a href="http://engineyard.com/"><img src="http://github.com/images/modules/footer/engine_yard_logo.png" alt="Engine Yard"></a>
          <div>
            Hosting provided by our<br> partners at Engine Yard
          </div>
        </div>
      </div>
    </div>
    
    <div id="coming_soon" style="display: none;">
      This feature is coming soon.  Sit tight!
    </div>

    <div id="facebox" style="display: none;">       
      <div class="popup">         
        <table>           
          <tbody>             
            <tr>               
              <td class="tl"></td>
              <td class="b"></td>
              <td class="tr"></td>             
            </tr>             
          <tr>               
            <td class="b"></td>               
            <td class="body">                 
              <div class="content"></div>                 
              <div class="footer">                   
                <a href="#" class="close"><img src="http://github.com/facebox/closelabel.gif" title="close" class="close_image"></a>                 
              </div>               
            </td>               
            <td class="b"></td>             
          </tr>             
          <tr>               
            <td class="bl"></td>
            <td class="b"></td>
            <td class="br"></td>             
          </tr>           
        </tbody>         
      </table>       
    </div>     


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
    var pageTracker = _gat._getTracker("UA-8689483-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>

  </body>
</html>
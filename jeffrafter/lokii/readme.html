<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
<link rel="stylesheet" href="syntax_highlight.css" type="text/css" charset="utf-8" />

    <title>README</title>
  </head>
  <body>
    <div id="content">
      <div class="section docstring readme">
        <p>
h1. Lokii
</p>
<p>
Lokii is a simple framework for handling SMS queues on a local computer. It
does not communicate with your phone or send SMS messages through the
internet by default. Instead, you are expected to use gnokii and smsd (or
some other phone interface) to interact with a cell phone and populate the
queue. This may change in the future as Ruby bindings for gnokii are
currently in development.
</p>
<p>
h2. Setup
</p>
<p>
Cloning the repository (or downloading th tarball) should get you most of
the way. You are going to need to install Ruby, the daemons gem and you
will currently need Active Record and Active Support for the database
interaction. Once you have these requirements you will need to setup the
databases:
</p>
<pre class="code">
  <span class='mysql identifier id'>mysql</span> <span class='minus op'>-</span><span class='u identifier id'>u</span> <span class='root identifier id'>root</span>
  <span class='gt op'>&gt;</span> <span class='CREATE constant id'>CREATE</span> <span class='DATABASE constant id'>DATABASE</span> <span class='lokii_develoment identifier id'>lokii_develoment</span><span class='semicolon token'>;</span>
  <span class='gt op'>&gt;</span> <span class='CREATE constant id'>CREATE</span> <span class='DATABASE constant id'>DATABASE</span> <span class='lokii_test identifier id'>lokii_test</span><span class='semicolon token'>;</span>
  <span class='gt op'>&gt;</span> <span class='CREATE constant id'>CREATE</span> <span class='DATABASE constant id'>DATABASE</span> <span class='smsd identifier id'>smsd</span><span class='semicolon token'>;</span>
  <span class='gt op'>&gt;</span> <span class='GRANT constant id'>GRANT</span> <span class='SELECT constant id'>SELECT</span><span class='comma token'>,</span> <span class='INSERT constant id'>INSERT</span><span class='comma token'>,</span> <span class='UPDATE constant id'>UPDATE</span><span class='comma token'>,</span> <span class='DELETE constant id'>DELETE</span> <span class='ON constant id'>ON</span> <span class='smsd identifier id'>smsd</span><span class='dot token'>.</span><span class='mult op'>*</span> <span class='TO constant id'>TO</span> <span class='string val'>'smsd'</span>@<span class='string val'>'localhost'</span> <span class='IDENTIFIED constant id'>IDENTIFIED</span> <span class='BY constant id'>BY</span> <span class='string val'>'smsd'</span><span class='semicolon token'>;</span>
</pre>
<p>
Then you will need to copy and update the example configuration files to
your particular setup:
</p>
<pre class="code">
  <span class='cp identifier id'>cp</span> <span class='config identifier id'>config</span><span class='div op'>/</span><span class='database identifier id'>database</span><span class='dot token'>.</span><span class='example identifier id'>example</span><span class='dot token'>.</span><span class='yml identifier id'>yml</span> <span class='config identifier id'>config</span><span class='div op'>/</span><span class='database identifier id'>database</span><span class='dot token'>.</span><span class='yml identifier id'>yml</span>
  <span class='cp identifier id'>cp</span> <span class='config identifier id'>config</span><span class='div op'>/</span><span class='settings identifier id'>settings</span><span class='dot token'>.</span><span class='example identifier id'>example</span><span class='dot token'>.</span><span class='yml identifier id'>yml</span> <span class='config identifier id'>config</span><span class='div op'>/</span><span class='settings identifier id'>settings</span><span class='dot token'>.</span><span class='yml identifier id'>yml</span>
  <span class='cp identifier id'>cp</span> <span class='config identifier id'>config</span><span class='div op'>/</span><span class='smsd identifier id'>smsd</span><span class='dot token'>.</span><span class='example identifier id'>example</span><span class='dot token'>.</span><span class='yml identifier id'>yml</span> <span class='config identifier id'>config</span><span class='div op'>/</span><span class='smsd identifier id'>smsd</span><span class='dot token'>.</span><span class='yml identifier id'>yml</span>
</pre>
<p>
Before the framework will process any messages, you&#8217;ll need to add
some workers. Essentially, each number you expect to receive a SMS from
should have a corresponding Worker:
</p>
<pre class="code">
  <span class='script identifier id'>script</span><span class='div op'>/</span><span class='console identifier id'>console</span>
  <span class='gt op'>&gt;</span> <span class='Lokii constant id'>Lokii</span><span class='colon2 op'>::</span><span class='Server constant id'>Server</span><span class='dot token'>.</span><span class='setup identifier id'>setup</span>
  <span class='gt op'>&gt;</span> <span class='Worker constant id'>Worker</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:number</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>'+1951NNNNNNN'</span><span class='rparen token'>)</span>
</pre>
<p>
h2. Scripts
</p>
<p>
Lokii comes with several scripts, <tt>lokii</tt>, <tt>run</tt>,
<tt>console</tt> and <tt>smsd</tt>. The console script is a simple wrapper
around irb and is nice for interacting on the command line. It loads the
main Lokii library (and all of the corresponding application files), but if
you want to interact with the database or the server you will need run
+Lokii::Server.setup+ inside the console.
</p>
<p>
The <tt>run</tt> script allows you to actually start the processing loop of
Lokii. It will initialize, and check every <tt>interval</tt> seconds
(default is 1) for new SMS messages. All of the output is sent to STDOUT as
well as the log (which by default is log/development.log).
</p>
<p>
The <tt>lokii</tt> script allows you to run Lokii in daemon mode:
</p>
<pre class="code">
  <span class='script identifier id'>script</span><span class='div op'>/</span><span class='daemon identifier id'>daemon</span> <span class='lbrack token'>[</span><span class='start identifier id'>start</span><span class='bitor op'>|</span><span class='stop identifier id'>stop</span><span class='bitor op'>|</span><span class='restart identifier id'>restart</span><span class='rbrack token'>]</span>
</pre>
<p>
It only allows a single instance of the application to run at a time. Log
information is sent to log/development.log and tmp/pids/lokii.output (which
is used primarily for daemon debugging).
</p>
<p>
The <tt>smsd</tt> script is simply a shortcut to invoke the SMS daemon that
is part of gnokii. For more information on installing gnokii and the sms
daemon go to http://neverlet.be/2008/10/22/phone-meet-computer.
</p>
<p>
h2. Writing Handlers
</p>
<p>
Writing handlers is currently very simple. Simply create the file in the
app/handlers folder and implement the <tt>process</tt> method:
</p>
<pre class="code">
  <span class='class class kw'>class</span> <span class='ILoveYouHandler constant id'>ILoveYouHandler</span> <span class='lt op'>&lt;</span> <span class='Lokii constant id'>Lokii</span><span class='colon2 op'>::</span><span class='Handler constant id'>Handler</span>
    <span class='def def kw'>def</span> <span class='process identifier id'>process</span>
      <span class='Lokii constant id'>Lokii</span><span class='colon2 op'>::</span><span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='string val'>&quot;Processing message with the I love you handler&quot;</span>
      <span class='reply identifier id'>reply</span> <span class='string val'>&quot;I love you too&quot;</span> <span class='if if_mod kw'>if</span> <span class='message identifier id'>message</span><span class='dot token'>.</span><span class='text identifier id'>text</span><span class='dot token'>.</span><span class='downcase identifier id'>downcase</span> <span class='eq op'>==</span> <span class='string val'>&quot;i love you&quot;</span> <span class='orop op'>||</span> <span class='message identifier id'>message</span><span class='dot token'>.</span><span class='text identifier id'>text</span><span class='dot token'>.</span><span class='downcase identifier id'>downcase</span> <span class='eq op'>==</span> <span class='string val'>&quot;i love u&quot;</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
</pre>
<p>
This is the most basic kind of handler that will respond to speicifc
commands or requests with a reply. In order for Lokii to recognize this
handler you have to register it. Currently this is just a modification to
the lib/lokii.rb file:
</p>
<pre class="code">
  <span class='Lokii constant id'>Lokii</span><span class='colon2 op'>::</span><span class='Server constant id'>Server</span><span class='dot token'>.</span><span class='handlers identifier id'>handlers</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span> <span class='PongHandler constant id'>PongHandler</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='comma token'>,</span> <span class='ILoveYouHandler constant id'>ILoveYouHandler</span><span class='dot token'>.</span><span class='new identifier id'>new</span> <span class='rbrack token'>]</span>
</pre>
<p>
The handlers will be called for each message in the order you list them. If
you want to halt the processing of a message that has already been handled,
simply call the <tt>complete</tt> method.
</p>
<p>
h2. Modifying the Server
</p>
<p>
The server is currently a polling based server that checks for new messages
in the inbox table of the specified smsd database. Replies are simple
messages added to the outbox. Message completion is nothing more than
marking the processed flag and re-saving the record.
</p>
<pre class="code">
    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='say identifier id'>say</span><span class='lparen token'>(</span><span class='text identifier id'>text</span><span class='comma token'>,</span> <span class='number identifier id'>number</span><span class='rparen token'>)</span>
      <span class='Outbox constant id'>Outbox</span><span class='dot token'>.</span><span class='create identifier id'>create</span><span class='lparen token'>(</span><span class='symbol val'>:text</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='text identifier id'>text</span><span class='comma token'>,</span> <span class='symbol val'>:number</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='number identifier id'>number</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='complete identifier id'>complete</span><span class='lparen token'>(</span><span class='message identifier id'>message</span><span class='rparen token'>)</span>
      <span class='Lokii constant id'>Lokii</span><span class='colon2 op'>::</span><span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='string val'>&quot;Message processing complete&quot;</span>
      <span class='message identifier id'>message</span><span class='dot token'>.</span><span class='processed identifier id'>processed</span> <span class='assign token'>=</span> <span class='integer val'>1</span>
      <span class='message identifier id'>message</span><span class='dot token'>.</span><span class='save! fid id'>save!</span>
    <span class='end end kw'>end</span>

    <span class='def def kw'>def</span> <span class='self self kw'>self</span><span class='dot token'>.</span><span class='check identifier id'>check</span>
      <span class='Lokii constant id'>Lokii</span><span class='colon2 op'>::</span><span class='Logger constant id'>Logger</span><span class='dot token'>.</span><span class='debug identifier id'>debug</span> <span class='string val'>&quot;Checking for incoming messages&quot;</span> <span class='if if_mod kw'>if</span> <span class='Lokii constant id'>Lokii</span><span class='colon2 op'>::</span><span class='Config constant id'>Config</span><span class='dot token'>.</span><span class='verbose identifier id'>verbose</span>
      <span class='messages identifier id'>messages</span> <span class='assign token'>=</span> <span class='Inbox constant id'>Inbox</span><span class='dot token'>.</span><span class='find identifier id'>find</span><span class='lparen token'>(</span><span class='symbol val'>:all</span><span class='comma token'>,</span> <span class='symbol val'>:conditions</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='string val'>&quot;processed = 0&quot;</span><span class='rparen token'>)</span>
      <span class='messages identifier id'>messages</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span><span class='bitor op'>|</span><span class='message identifier id'>message</span><span class='bitor op'>|</span>
        <span class='self self kw'>self</span><span class='dot token'>.</span><span class='handle identifier id'>handle</span><span class='lparen token'>(</span><span class='message identifier id'>message</span><span class='rparen token'>)</span>
      <span class='rbrace token'>}</span>
    <span class='end end kw'>end</span>
</pre>
<p>
Modifying these three methods (and possibly the setup method) you could
easily convert the server to use a file based queue. This would allow you
to use the smsd file module or any other program (such as FrontlineSMS) in
file mode and still use Lokii to do the processing/handling of messages.
</p>
<p>
h2. Background
</p>
<p>
Lokii was written to allow someone to quickly build SMS forms using an open
toolkit. Ideally this project will be used for developing world healthcare,
banking, commerce applications.
</p>
<p>
h3. Thanks
</p>
<p>
Thanks to Darcy Laycock (sutto) as much of this is based on his work on
Marvin. Thanks also to the gnokii folks Daniele Forsi (dforsi) and Paweł
Kot (oftokpik). Thanks to Josh Nesbit and Ken Banks for their SMS work in
Malawi.
</p>

      </div>
    </div>
  </body>
</html>